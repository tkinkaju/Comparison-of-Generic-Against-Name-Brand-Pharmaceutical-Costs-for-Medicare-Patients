{"version":3,"file":"EXT_meshopt_compression.js","names":["DEFAULT_MESHOPT_OPTIONS","byteOffset","filter","EXT_MESHOPT_COMPRESSION","name","decode","gltfData","options","scenegraph","GLTFScenegraph","gltf","decompressMeshes","promises","json","bufferViews","bufferViewIndex","push","decodeMeshoptBufferView","Promise","all","removeExtension","bufferView","meshoptExtension","getObjectExtension","byteLength","byteStride","count","mode","bufferIndex","buffer","buffers","source","Uint8Array","arrayBuffer","result","meshoptDecodeGltfBuffer"],"sources":["../../../../src/lib/extensions/EXT_meshopt_compression.ts"],"sourcesContent":["/* eslint-disable camelcase */\nimport type {GLTF, GLTFBufferView, GLTF_EXT_meshopt_compression} from '../types/gltf-types';\nimport type {GLTFLoaderOptions} from '../../gltf-loader';\nimport GLTFScenegraph from '../api/gltf-scenegraph';\nimport {meshoptDecodeGltfBuffer} from '../../meshopt/meshopt-decoder';\n\n// @ts-ignore\n// eslint-disable-next-line\nconst DEFAULT_MESHOPT_OPTIONS = {\n  byteOffset: 0,\n  filter: 'NONE'\n};\n\n/** Extension name */\nconst EXT_MESHOPT_COMPRESSION = 'EXT_meshopt_compression';\n\nexport const name = EXT_MESHOPT_COMPRESSION;\n\nexport async function decode(gltfData: {json: GLTF}, options: GLTFLoaderOptions) {\n  const scenegraph = new GLTFScenegraph(gltfData);\n\n  if (!options?.gltf?.decompressMeshes) {\n    return;\n  }\n\n  const promises: Promise<any>[] = [];\n  for (const bufferViewIndex of gltfData.json.bufferViews || []) {\n    promises.push(decodeMeshoptBufferView(scenegraph, bufferViewIndex));\n  }\n\n  // Decompress meshes in parallel\n  await Promise.all(promises);\n\n  // We have now decompressed all primitives, so remove the top-level extension\n  scenegraph.removeExtension(EXT_MESHOPT_COMPRESSION);\n}\n\n/** Decode one meshopt buffer view */\nasync function decodeMeshoptBufferView(\n  scenegraph: GLTFScenegraph,\n  bufferView: GLTFBufferView\n): Promise<ArrayBuffer | null> {\n  const meshoptExtension = scenegraph.getObjectExtension<GLTF_EXT_meshopt_compression>(\n    bufferView,\n    EXT_MESHOPT_COMPRESSION\n  );\n  if (meshoptExtension) {\n    const {\n      byteOffset = 0,\n      byteLength = 0,\n      byteStride,\n      count,\n      mode,\n      filter = 'NONE',\n      buffer: bufferIndex\n    } = meshoptExtension;\n    const buffer = scenegraph.gltf.buffers[bufferIndex];\n\n    const source = new Uint8Array(buffer.arrayBuffer, buffer.byteOffset + byteOffset, byteLength);\n    const result = new Uint8Array(\n      scenegraph.gltf.buffers[bufferView.buffer].arrayBuffer,\n      bufferView.byteOffset,\n      bufferView.byteLength\n    );\n    await meshoptDecodeGltfBuffer(result, count, byteStride, source, mode, filter);\n    return result;\n  }\n\n  return null;\n}\n"],"mappings":";;;;;;;;;;AAGA;AACA;AAAsE;AAAA;AAAA;AAItE,IAAMA,uBAAuB,GAAG;EAC9BC,UAAU,EAAE,CAAC;EACbC,MAAM,EAAE;AACV,CAAC;;AAGD,IAAMC,uBAAuB,GAAG,yBAAyB;AAElD,IAAMC,IAAI,GAAGD,uBAAuB;AAAC;AAAA,SAEtBE,MAAM;EAAA;AAAA;AAAA;EAAA,oEAArB,iBAAsBC,QAAsB,EAAEC,OAA0B;IAAA;IAAA;IAAA;MAAA;QAAA;UAAA;YACvEC,UAAU,GAAG,IAAIC,uBAAc,CAACH,QAAQ,CAAC;YAAA,IAE1CC,OAAO,aAAPA,OAAO,gCAAPA,OAAO,CAAEG,IAAI,0CAAb,cAAeC,gBAAgB;cAAA;cAAA;YAAA;YAAA;UAAA;YAI9BC,QAAwB,GAAG,EAAE;YAAA,uCACLN,QAAQ,CAACO,IAAI,CAACC,WAAW,IAAI,EAAE;YAAA;cAA7D,oDAA+D;gBAApDC,eAAe;gBACxBH,QAAQ,CAACI,IAAI,CAACC,uBAAuB,CAACT,UAAU,EAAEO,eAAe,CAAC,CAAC;cACrE;;YAAC;cAAA;YAAA;cAAA;YAAA;YAAA;YAAA,OAGKG,OAAO,CAACC,GAAG,CAACP,QAAQ,CAAC;UAAA;YAG3BJ,UAAU,CAACY,eAAe,CAACjB,uBAAuB,CAAC;UAAC;UAAA;YAAA;QAAA;MAAA;IAAA;EAAA,CACrD;EAAA;AAAA;AAAA,SAGcc,uBAAuB;EAAA;AAAA;AAAA;EAAA,qFAAtC,kBACET,UAA0B,EAC1Ba,UAA0B;IAAA;IAAA;MAAA;QAAA;UAAA;YAEpBC,gBAAgB,GAAGd,UAAU,CAACe,kBAAkB,CACpDF,UAAU,EACVlB,uBAAuB,CACxB;YAAA,KACGmB,gBAAgB;cAAA;cAAA;YAAA;YAAA,wBASdA,gBAAgB,CAPlBrB,UAAU,EAAVA,UAAU,sCAAG,CAAC,mDAOZqB,gBAAgB,CANlBE,UAAU,EAAVA,UAAU,uCAAG,CAAC,2BACdC,UAAU,GAKRH,gBAAgB,CALlBG,UAAU,EACVC,KAAK,GAIHJ,gBAAgB,CAJlBI,KAAK,EACLC,IAAI,GAGFL,gBAAgB,CAHlBK,IAAI,0BAGFL,gBAAgB,CAFlBpB,MAAM,EAANA,MAAM,sCAAG,MAAM,0BACP0B,WAAW,GACjBN,gBAAgB,CADlBO,MAAM;YAEFA,MAAM,GAAGrB,UAAU,CAACE,IAAI,CAACoB,OAAO,CAACF,WAAW,CAAC;YAE7CG,MAAM,GAAG,IAAIC,UAAU,CAACH,MAAM,CAACI,WAAW,EAAEJ,MAAM,CAAC5B,UAAU,GAAGA,UAAU,EAAEuB,UAAU,CAAC;YACvFU,MAAM,GAAG,IAAIF,UAAU,CAC3BxB,UAAU,CAACE,IAAI,CAACoB,OAAO,CAACT,UAAU,CAACQ,MAAM,CAAC,CAACI,WAAW,EACtDZ,UAAU,CAACpB,UAAU,EACrBoB,UAAU,CAACG,UAAU,CACtB;YAAA;YAAA,OACK,IAAAW,uCAAuB,EAACD,MAAM,EAAER,KAAK,EAAED,UAAU,EAAEM,MAAM,EAAEJ,IAAI,EAAEzB,MAAM,CAAC;UAAA;YAAA,kCACvEgC,MAAM;UAAA;YAAA,kCAGR,IAAI;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA;EAAA,CACZ;EAAA;AAAA"}