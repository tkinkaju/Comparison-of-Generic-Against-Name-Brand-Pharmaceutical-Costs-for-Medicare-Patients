{"version":3,"file":"wrap.js","names":["wrap","features","options","buffer","extent","merged","left","clip","right","shiftFeatureCoords","concat","offset","newFeatures","i","length","feature","type","newGeometry","shiftCoords","geometry","line","push","polygon","newPolygon","createFeature","id","tags","Points","Array","points","newPoints","size","start","undefined","end"],"sources":["../../../../src/lib/geojson-tiler/wrap.ts"],"sourcesContent":["// loaders.gl, MIT license\n// Forked from https://github.com/mapbox/geojson-vt under compatible ISC license\n\nimport type {GeoJSONTileFeature} from './tile';\nimport {clip} from './clip';\nimport {createFeature} from './feature';\n\n/**\n * Options for wrap()\n */\nexport type WrapOptions = {\n  buffer: number /** number of pixels of buffer for the tile */;\n  extent: number /** extent of each tile */;\n  lineMetrics: boolean;\n};\n\n/**\n * Wrap across antemeridian, by clipping into two tiles, shifting the overflowing x coordinates\n * @param features list of features to be wrapped\n * @param options buffer and extent\n * @returns\n */\nexport function wrap(features: GeoJSONTileFeature[], options: WrapOptions) {\n  const buffer = options.buffer / options.extent;\n  let merged: GeoJSONTileFeature[] = features;\n  const left = clip(features, 1, -1 - buffer, buffer, 0, -1, 2, options); // left world copy\n  const right = clip(features, 1, 1 - buffer, 2 + buffer, 0, -1, 2, options); // right world copy\n\n  if (left || right) {\n    merged = clip(features, 1, -buffer, 1 + buffer, 0, -1, 2, options) || []; // center world copy\n\n    if (left) {\n      merged = shiftFeatureCoords(left, 1).concat(merged); // merge left into center\n    }\n    if (right) {\n      merged = merged.concat(shiftFeatureCoords(right, -1)); // merge right into center\n    }\n  }\n\n  return merged;\n}\n\n/**\n * Shift the x coordinates of a list of features\n * @param features list of features to shift x coordinates for\n * @param offset\n * @returns\n */\nfunction shiftFeatureCoords(features: GeoJSONTileFeature[], offset: number): GeoJSONTileFeature[] {\n  const newFeatures: GeoJSONTileFeature[] = [];\n\n  for (let i = 0; i < features.length; i++) {\n    const feature = features[i];\n    const type = feature.type;\n\n    let newGeometry;\n\n    if (type === 'Point' || type === 'MultiPoint' || type === 'LineString') {\n      newGeometry = shiftCoords(feature.geometry, offset);\n    } else if (type === 'MultiLineString' || type === 'Polygon') {\n      newGeometry = [];\n      for (const line of feature.geometry) {\n        newGeometry.push(shiftCoords(line, offset));\n      }\n    } else if (type === 'MultiPolygon') {\n      newGeometry = [];\n      for (const polygon of feature.geometry) {\n        const newPolygon: Points = [];\n        for (const line of polygon) {\n          // @ts-expect-error TODO\n          newPolygon.push(shiftCoords(line, offset));\n        }\n        newGeometry.push(newPolygon);\n      }\n    }\n\n    newFeatures.push(createFeature(feature.id, type, newGeometry, feature.tags));\n  }\n\n  return newFeatures;\n}\n\nclass Points extends Array<number> {\n  size?: number;\n  start?: number;\n  end?: number;\n}\n\n/**\n * Shift the x coordinate of every point\n * @param points\n * @param offset\n * @returns\n */\nfunction shiftCoords(points: Points, offset: number): Points {\n  const newPoints: Points = [];\n  newPoints.size = points.size;\n\n  if (points.start !== undefined) {\n    newPoints.start = points.start;\n    newPoints.end = points.end;\n  }\n\n  for (let i = 0; i < points.length; i += 3) {\n    newPoints.push(points[i] + offset, points[i + 1], points[i + 2]);\n  }\n  return newPoints;\n}\n"],"mappings":"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"}