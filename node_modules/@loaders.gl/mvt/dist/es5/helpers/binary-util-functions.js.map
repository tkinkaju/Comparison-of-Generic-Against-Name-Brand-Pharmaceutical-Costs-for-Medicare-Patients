{"version":3,"file":"binary-util-functions.js","names":["classifyRings","geom","len","indices","length","type","data","areas","getPolygonSignedArea","polygons","ringAreas","polygon","ccw","offset","endIndex","i","startIndex","shape","slice","area","before","after","concat","undefined","push","project","x0","y0","size","j","jl","y2","Math","PI","atan","exp","readFeature","tag","feature","pbf","id","readVarint","readTag","_geometry","pos","end","key","_keys","value","_values","properties"],"sources":["../../../src/helpers/binary-util-functions.ts"],"sourcesContent":["import Protobuf from 'pbf';\nimport {getPolygonSignedArea} from '@math.gl/polygon';\nimport {FlatIndexedGeometry, FlatPolygon} from '@loaders.gl/schema';\nimport VectorTileFeature from '../lib/binary-vector-tile/vector-tile-feature';\n\n/**\n * Classifies an array of rings into polygons with outer rings and holes\n * The function also detects holes which have zero area and\n * removes them. In doing so it modifies the input\n * `geom.data` array to remove the unneeded data\n *\n * @param geometry\n * @returns object\n */\n// eslint-disable-next-line max-statements\nexport function classifyRings(geom: FlatIndexedGeometry): FlatPolygon {\n  const len = geom.indices.length;\n  const type = 'Polygon';\n\n  if (len <= 1) {\n    return {\n      type,\n      data: geom.data,\n      areas: [[getPolygonSignedArea(geom.data)]],\n      indices: [geom.indices]\n    };\n  }\n\n  const areas: any[] = [];\n  const polygons: any[] = [];\n  let ringAreas: number[] = [];\n  let polygon: number[] = [];\n  let ccw: boolean | undefined;\n  let offset = 0;\n\n  for (let endIndex: number, i = 0, startIndex: number; i < len; i++) {\n    startIndex = geom.indices[i] - offset;\n\n    endIndex = geom.indices[i + 1] - offset || geom.data.length;\n    const shape = geom.data.slice(startIndex, endIndex);\n    const area = getPolygonSignedArea(shape);\n\n    if (area === 0) {\n      // This polygon has no area, so remove it from the shape\n      // Remove the section from the data array\n      const before = geom.data.slice(0, startIndex);\n      const after = geom.data.slice(endIndex);\n      geom.data = before.concat(after);\n\n      // Need to offset any remaining indices as we have\n      // modified the data buffer\n      offset += endIndex - startIndex;\n\n      // Do not add this index to the output and process next shape\n      continue; // eslint-disable-line no-continue\n    }\n\n    if (ccw === undefined) ccw = area < 0;\n\n    if (ccw === area < 0) {\n      if (polygon.length) {\n        areas.push(ringAreas);\n        polygons.push(polygon);\n      }\n      polygon = [startIndex];\n      ringAreas = [area];\n    } else {\n      ringAreas.push(area);\n      polygon.push(startIndex);\n    }\n  }\n  if (ringAreas) areas.push(ringAreas);\n  if (polygon.length) polygons.push(polygon);\n\n  return {type, areas, indices: polygons, data: geom.data};\n}\n\n/**\n *\n * @param data\n * @param x0\n * @param y0\n * @param size\n */\nexport function project(data: number[], x0: number, y0: number, size: number): void {\n  for (let j = 0, jl = data.length; j < jl; j += 2) {\n    data[j] = ((data[j] + x0) * 360) / size - 180;\n    const y2 = 180 - ((data[j + 1] + y0) * 360) / size;\n    data[j + 1] = (360 / Math.PI) * Math.atan(Math.exp((y2 * Math.PI) / 180)) - 90;\n  }\n}\n\n/**\n * All code below is unchanged from the original Mapbox implemenation\n *\n * @param tag\n * @param feature\n * @param pbf\n */\nexport function readFeature(tag: number, feature?: VectorTileFeature, pbf?: Protobuf): void {\n  if (feature && pbf) {\n    if (tag === 1) feature.id = pbf.readVarint();\n    else if (tag === 2) readTag(pbf, feature);\n    else if (tag === 3) feature.type = pbf.readVarint();\n    else if (tag === 4) feature._geometry = pbf.pos;\n  }\n}\n\n/**\n * @param pbf\n * @param feature\n */\nexport function readTag(pbf: Protobuf, feature: VectorTileFeature): void {\n  const end = pbf.readVarint() + pbf.pos;\n\n  while (pbf.pos < end) {\n    const key = feature._keys[pbf.readVarint()];\n    const value = feature._values[pbf.readVarint()];\n    feature.properties[key] = value;\n  }\n}\n"],"mappings":"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"}