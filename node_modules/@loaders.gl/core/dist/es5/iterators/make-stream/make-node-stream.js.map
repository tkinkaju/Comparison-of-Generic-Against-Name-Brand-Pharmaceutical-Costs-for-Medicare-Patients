{"version":3,"file":"make-node-stream.js","names":["_Readable","Readable","Stream","makeStream","source","options","iterator","Symbol","asyncIterator","AsyncIterableReadable","it","_iterator","_pulling","_bytesMode","objectMode","size","_pull","error","cb","throw","return","bm","r","readable","next","done","ArrayBuffer","isView","value","byteLength","push","Uint8Array"],"sources":["../../../../src/iterators/make-stream/make-node-stream.ts"],"sourcesContent":["import type {ReadableOptions} from 'stream';\nimport * as Stream from 'stream';\n\nclass _Readable {}\n\ntype ReadableType = Stream.Readable | _Readable;\nconst Readable = Stream.Readable || _Readable;\n\nexport type MakeStreamOptions = ReadableOptions;\n\n/** Builds a node stream from an iterator */\nexport function makeStream<ArrayBuffer>(\n  source: Iterable<ArrayBuffer> | AsyncIterable<ArrayBuffer>,\n  options?: ReadableOptions\n): ReadableType {\n  const iterator = source[Symbol.asyncIterator]\n    ? source[Symbol.asyncIterator]()\n    : source[Symbol.iterator]();\n  return new AsyncIterableReadable(iterator, options);\n}\n\nclass AsyncIterableReadable extends Readable {\n  private _pulling: boolean;\n  private _bytesMode: boolean;\n  private _iterator: AsyncIterator<ArrayBuffer>;\n\n  constructor(it: AsyncIterator<ArrayBuffer>, options?: ReadableOptions) {\n    super(options);\n    this._iterator = it;\n    this._pulling = false;\n    this._bytesMode = !options || !options.objectMode;\n  }\n\n  async _read(size: number): Promise<void> {\n    if (!this._pulling) {\n      this._pulling = true;\n      this._pulling = await this._pull(size, this._iterator);\n    }\n  }\n\n  async _destroy(error: Error | null, cb: (e: Error | null) => void): Promise<void> {\n    if (!this._iterator) {\n      return;\n    }\n    if (error) {\n      await this._iterator?.throw?.(error);\n    } else {\n      await this._iterator?.return?.(error);\n    }\n    cb?.(null);\n  }\n\n  // eslint-disable-next-line complexity\n  private async _pull(size: number, it: AsyncIterator<ArrayBuffer>): Promise<boolean> {\n    const bm = this._bytesMode;\n    let r: IteratorResult<ArrayBuffer> | null = null;\n    // while (this.readable && !(r = await it.next(bm ? size : null)).done) {\n    while (this.readable && !(r = await it.next()).done) {\n      if (size !== null) {\n        size -= bm && ArrayBuffer.isView(r.value) ? r.value.byteLength : 1;\n      }\n      if (!this.push(new Uint8Array(r.value)) || size <= 0) {\n        break;\n      }\n    }\n    if ((r?.done || !this.readable) && (this.push(null) || true)) {\n      it?.return?.();\n    }\n    return !this.readable;\n  }\n}\n"],"mappings":"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"}