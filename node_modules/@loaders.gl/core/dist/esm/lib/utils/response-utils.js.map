{"version":3,"file":"response-utils.js","names":["isResponse","getResourceContentLength","getResourceUrlAndType","makeResponse","resource","headers","contentLength","String","url","type","initialDataUrl","getInitialDataUrl","TextEncoder","encode","response","Response","Object","defineProperty","value","checkResponse","ok","message","getResponseError","Error","checkResponseSync","status","statusText","length","slice","contentType","get","text","includes","error","INITIAL_DATA_LENGTH","Blob","blobSlice","Promise","resolve","reader","FileReader","onload","event","target","result","readAsDataURL","ArrayBuffer","base64","arrayBufferToBase64","buffer","binary","bytes","Uint8Array","i","byteLength","fromCharCode","btoa"],"sources":["../../../../src/lib/utils/response-utils.ts"],"sourcesContent":["import {isResponse} from '../../javascript-utils/is-type';\nimport {getResourceContentLength, getResourceUrlAndType} from './resource-utils';\n\n/**\n * Returns a Response object\n * Adds content-length header when possible\n *\n * @param resource\n */\nexport async function makeResponse(resource: any): Promise<Response> {\n  if (isResponse(resource)) {\n    return resource;\n  }\n\n  // Add content-length header if possible\n  const headers: {[header: string]: string} = {};\n\n  const contentLength = getResourceContentLength(resource);\n  if (contentLength >= 0) {\n    headers['content-length'] = String(contentLength);\n  }\n\n  // `new Response(File)` does not preserve content-type and URL\n  // so we add them here\n  const {url, type} = getResourceUrlAndType(resource);\n  if (type) {\n    headers['content-type'] = type;\n  }\n\n  // Add a custom header with initial bytes if available\n  const initialDataUrl = await getInitialDataUrl(resource);\n  if (initialDataUrl) {\n    headers['x-first-bytes'] = initialDataUrl;\n  }\n\n  // TODO - is this the best way of handling strings?\n  // Maybe package as data URL instead?\n  if (typeof resource === 'string') {\n    // Convert to ArrayBuffer to avoid Response treating it as a URL\n    resource = new TextEncoder().encode(resource);\n  }\n\n  // Attempt to create a Response from the resource, adding headers and setting url\n  const response = new Response(resource, {headers});\n  // We can't control `Response.url` via constructor, use a property override to record URL.\n  Object.defineProperty(response, 'url', {value: url});\n  return response;\n}\n\n/**\n * Checks response status (async) and throws a helpful error message if status is not OK.\n * @param response\n */\nexport async function checkResponse(response: Response): Promise<void> {\n  if (!response.ok) {\n    const message = await getResponseError(response);\n    throw new Error(message);\n  }\n}\n\n/**\n * Checks response status (sync) and throws a helpful error message if status is not OK.\n * @param response\n */\nexport function checkResponseSync(response: Response): void {\n  if (!response.ok) {\n    let message = `${response.status} ${response.statusText}`;\n    message = message.length > 60 ? `${message.slice(0, 60)}...` : message;\n    throw new Error(message);\n  }\n}\n\n// HELPERS\n\nasync function getResponseError(response): Promise<string> {\n  let message = `Failed to fetch resource ${response.url} (${response.status}): `;\n  try {\n    const contentType = response.headers.get('Content-Type');\n    let text = response.statusText;\n    if (contentType.includes('application/json')) {\n      text += ` ${await response.text()}`;\n    }\n    message += text;\n    message = message.length > 60 ? `${message.slice(0, 60)}...` : message;\n  } catch (error) {\n    // eslint forbids return in a finally statement, so we just catch here\n  }\n  return message;\n}\n\nasync function getInitialDataUrl(resource): Promise<string | null> {\n  const INITIAL_DATA_LENGTH = 5;\n  if (typeof resource === 'string') {\n    return `data:,${resource.slice(0, INITIAL_DATA_LENGTH)}`;\n  }\n  if (resource instanceof Blob) {\n    const blobSlice = resource.slice(0, 5);\n    return await new Promise((resolve) => {\n      const reader = new FileReader();\n      reader.onload = (event) => resolve(event?.target?.result as string);\n      reader.readAsDataURL(blobSlice);\n    });\n  }\n  if (resource instanceof ArrayBuffer) {\n    const slice = resource.slice(0, INITIAL_DATA_LENGTH);\n    const base64 = arrayBufferToBase64(slice);\n    return `data:base64,${base64}`;\n  }\n  return null;\n}\n\n// https://stackoverflow.com/questions/9267899/arraybuffer-to-base64-encoded-string\nfunction arrayBufferToBase64(buffer) {\n  let binary = '';\n  const bytes = new Uint8Array(buffer);\n  for (let i = 0; i < bytes.byteLength; i++) {\n    binary += String.fromCharCode(bytes[i]);\n  }\n  return btoa(binary);\n}\n"],"mappings":"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"}