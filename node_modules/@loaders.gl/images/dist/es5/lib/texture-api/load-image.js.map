{"version":3,"file":"load-image.js","names":["loadImage","getUrl","options","getImageUrls","imageUrls","deepLoad","parseImage","urlOptions","mipLevels","image","getMipmappedImageUrls","generateUrl","urls","url","lod","shallowLoad","getImageSize","width","height","getMipLevels","push","assert","mipLevel","length","Math","floor","log2","max"],"sources":["../../../../src/lib/texture-api/load-image.ts"],"sourcesContent":["import {assert} from '@loaders.gl/loader-utils';\nimport parseImage from '../parsers/parse-image';\nimport {getImageSize} from '../category-api/parsed-image-api';\nimport {generateUrl} from './generate-url';\nimport {deepLoad, shallowLoad} from './deep-load';\n\nexport async function loadImage(getUrl, options = {}) {\n  const imageUrls = await getImageUrls(getUrl, options);\n  return await deepLoad(imageUrls, parseImage, options);\n}\n\nexport async function getImageUrls(getUrl, options, urlOptions = {}) {\n  const mipLevels = (options && options.image && options.image.mipLevels) || 0;\n  return mipLevels !== 0\n    ? await getMipmappedImageUrls(getUrl, mipLevels, options, urlOptions)\n    : generateUrl(getUrl, options, urlOptions);\n}\n\nasync function getMipmappedImageUrls(getUrl, mipLevels, options, urlOptions) {\n  const urls: string[] = [];\n\n  // If no mip levels supplied, we need to load the level 0 image and calculate based on size\n  if (mipLevels === 'auto') {\n    const url = generateUrl(getUrl, options, {...urlOptions, lod: 0});\n    const image = await shallowLoad(url, parseImage, options);\n\n    const {width, height} = getImageSize(image);\n    mipLevels = getMipLevels({width, height});\n\n    // TODO - push image and make `deepLoad` pass through non-url values, avoid loading twice?\n    urls.push(url);\n  }\n\n  // We now know how many mipLevels we need, remaining image urls can now be constructed\n  assert(mipLevels > 0);\n\n  for (let mipLevel = urls.length; mipLevel < mipLevels; ++mipLevel) {\n    const url = generateUrl(getUrl, options, {...urlOptions, lod: mipLevel});\n    urls.push(url);\n  }\n\n  return urls;\n}\n\n// Calculates number of mipmaps based on texture size (log2)\nexport function getMipLevels({width, height}) {\n  return 1 + Math.floor(Math.log2(Math.max(width, height)));\n}\n"],"mappings":";;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AAAkD;AAAA;AAAA,SAE5BA,SAAS;EAAA;AAAA;AAAA;EAAA,uEAAxB,iBAAyBC,MAAM;IAAA;MAAA;MAAA;IAAA;MAAA;QAAA;UAAA;YAAEC,OAAO,2DAAG,CAAC,CAAC;YAAA;YAAA,OAC1BC,YAAY,CAACF,MAAM,EAAEC,OAAO,CAAC;UAAA;YAA/CE,SAAS;YAAA;YAAA,OACF,IAAAC,kBAAQ,EAACD,SAAS,EAAEE,mBAAU,EAAEJ,OAAO,CAAC;UAAA;YAAA;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA;EAAA,CACtD;EAAA;AAAA;AAAA,SAEqBC,YAAY;EAAA;AAAA;AAAA;EAAA,0EAA3B,kBAA4BF,MAAM,EAAEC,OAAO;IAAA;MAAA;MAAA;IAAA;MAAA;QAAA;UAAA;YAAEK,UAAU,8DAAG,CAAC,CAAC;YAC3DC,SAAS,GAAIN,OAAO,IAAIA,OAAO,CAACO,KAAK,IAAIP,OAAO,CAACO,KAAK,CAACD,SAAS,IAAK,CAAC;YAAA,MACrEA,SAAS,KAAK,CAAC;cAAA;cAAA;YAAA;YAAA;YAAA,OACZE,qBAAqB,CAACT,MAAM,EAAEO,SAAS,EAAEN,OAAO,EAAEK,UAAU,CAAC;UAAA;YAAA;YAAA;YAAA;UAAA;YAAA,eACnE,IAAAI,wBAAW,EAACV,MAAM,EAAEC,OAAO,EAAEK,UAAU,CAAC;UAAA;YAAA;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA;EAAA,CAC7C;EAAA;AAAA;AAAA,SAEcG,qBAAqB;EAAA;AAAA;AAAA;EAAA,mFAApC,kBAAqCT,MAAM,EAAEO,SAAS,EAAEN,OAAO,EAAEK,UAAU;IAAA;IAAA;MAAA;QAAA;UAAA;YACnEK,IAAc,GAAG,EAAE;YAAA,MAGrBJ,SAAS,KAAK,MAAM;cAAA;cAAA;YAAA;YAChBK,GAAG,GAAG,IAAAF,wBAAW,EAACV,MAAM,EAAEC,OAAO,kCAAMK,UAAU;cAAEO,GAAG,EAAE;YAAC,GAAE;YAAA;YAAA,OAC7C,IAAAC,qBAAW,EAACF,GAAG,EAAEP,mBAAU,EAAEJ,OAAO,CAAC;UAAA;YAAnDO,KAAK;YAAA,gBAEa,IAAAO,4BAAY,EAACP,KAAK,CAAC,EAApCQ,KAAK,iBAALA,KAAK,EAAEC,MAAM,iBAANA,MAAM;YACpBV,SAAS,GAAGW,YAAY,CAAC;cAACF,KAAK,EAALA,KAAK;cAAEC,MAAM,EAANA;YAAM,CAAC,CAAC;;YAGzCN,IAAI,CAACQ,IAAI,CAACP,GAAG,CAAC;UAAC;YAIjB,IAAAQ,mBAAM,EAACb,SAAS,GAAG,CAAC,CAAC;YAErB,KAASc,QAAQ,GAAGV,IAAI,CAACW,MAAM,EAAED,QAAQ,GAAGd,SAAS,EAAE,EAAEc,QAAQ,EAAE;cAC3DT,IAAG,GAAG,IAAAF,wBAAW,EAACV,MAAM,EAAEC,OAAO,kCAAMK,UAAU;gBAAEO,GAAG,EAAEQ;cAAQ,GAAE;cACxEV,IAAI,CAACQ,IAAI,CAACP,IAAG,CAAC;YAChB;YAAC,kCAEMD,IAAI;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA;EAAA,CACZ;EAAA;AAAA;AAGM,SAASO,YAAY,OAAkB;EAAA,IAAhBF,KAAK,QAALA,KAAK;IAAEC,MAAM,QAANA,MAAM;EACzC,OAAO,CAAC,GAAGM,IAAI,CAACC,KAAK,CAACD,IAAI,CAACE,IAAI,CAACF,IAAI,CAACG,GAAG,CAACV,KAAK,EAAEC,MAAM,CAAC,CAAC,CAAC;AAC3D"}