{"version":3,"file":"parse-wms.js","names":["parseWMSCapabilities","text","options","parsedXML","XMLLoader","parseTextSync","xmlCapabilities","WMT_MS_Capabilities","WMS_Capabilities","extractCapabilities","xml","capabilities","name","Service","Name","title","Title","keywords","requests","layer","extractLayer","Capability","Layer","raw","KeywordList","Keyword","keyword","push","Object","entries","Request","xmlRequest","extractRequest","format","Format","mimeTypes","Array","isArray","xmlLayer","srs","SRS","layers","xmlLayers","getXMLArray","xmlSubLayer","xmlValue","parseWMSFeatureInfo","xmlFeatureInfo","FeatureInfoResponse","FIELDS","xmlFeatures","features","map","xmlFeature","extractFeature","xmlFields","attributes","type","bounds","bottom","top","left","right","parseWMSLayerDescription","parseWMSError","serviceExceptionXML","ServiceExceptionReport","ServiceException","message","code"],"sources":["../../../../src/lib/wms/parse-wms.ts"],"sourcesContent":["// loaders.gl, MIT license\n\nimport type {\n  WMSCapabilities,\n  WMSLayer,\n  WMSRequest,\n  WMSFeatureInfo,\n  WMSLayerDescription\n  // WMSFeature,\n  // WMSLayerDescription\n} from './wms-types';\n\nimport {XMLLoader} from '@loaders.gl/xml';\n\n// GetCapabilities\n\n/**\n * Parses a typed data structure from raw XML for `GetCapabilities` response\n * @note Error handlings is fairly weak\n */\nexport function parseWMSCapabilities(text: string, options): WMSCapabilities {\n  const parsedXML = XMLLoader.parseTextSync(text, options);\n  const xmlCapabilities: any =\n    parsedXML.WMT_MS_Capabilities || parsedXML.WMS_Capabilities || parsedXML;\n  return extractCapabilities(xmlCapabilities);\n}\n\n/** Extract typed capability data from XML */\nfunction extractCapabilities(xml: any): WMSCapabilities {\n  const capabilities: WMSCapabilities = {\n    name: xml.Service?.Name || 'unnamed',\n    title: xml.Service?.Title,\n    keywords: [],\n    requests: {},\n    layer: extractLayer(xml.Capability?.Layer),\n    raw: xml\n  };\n\n  for (const keyword of xml.Service?.KeywordList?.Keyword || []) {\n    capabilities.keywords.push(keyword);\n  }\n\n  for (const [name, xmlRequest] of Object.entries(xml.Capability?.Request || {})) {\n    capabilities.requests[name] = extractRequest(name, xmlRequest);\n  }\n\n  return capabilities;\n}\n\n/** Extract typed request data from XML */\nfunction extractRequest(name: string, xmlRequest: any): WMSRequest {\n  const format: string | string[] = xmlRequest?.Format;\n  const mimeTypes: string[] = Array.isArray(format) ? format : [format];\n  return {name, mimeTypes};\n}\n\n/** Extract request data */\nfunction extractLayer(xmlLayer: any): WMSLayer {\n  const layer: WMSLayer = {\n    name: xmlLayer?.Name,\n    title: xmlLayer?.Title,\n    srs: xmlLayer?.SRS || [],\n    layers: []\n  };\n\n  // Single layer is not represented as array in XML\n  const xmlLayers = getXMLArray(xmlLayer?.Layer);\n\n  for (const xmlSubLayer of xmlLayers) {\n    layer.layers?.push(extractLayer(xmlSubLayer));\n  }\n\n  return layer;\n}\n\nfunction getXMLArray(xmlValue: any) {\n  if (Array.isArray(xmlValue)) {\n    return xmlValue;\n  }\n  if (xmlValue) {\n    return [xmlValue];\n  }\n  return [];\n}\n\n// GetFeatureInfo\n\n/**\n * Parses a typed data structure from raw XML for `GetFeatureInfo` response\n * @note Error handlings is fairly weak\n */\nexport function parseWMSFeatureInfo(text: string, options): WMSFeatureInfo {\n  const parsedXML = XMLLoader.parseTextSync(text, options);\n  const xmlFeatureInfo: any = parsedXML.FeatureInfoResponse?.FIELDS || [];\n\n  const xmlFeatures = Array.isArray(xmlFeatureInfo) ? xmlFeatureInfo : [xmlFeatureInfo];\n\n  return {\n    features: xmlFeatures.map((xmlFeature) => extractFeature(xmlFeature))\n  };\n}\n\nfunction extractFeature(xmlFeature: any) {\n  const xmlFields = xmlFeature || {};\n  // TODO - not correct\n  return {\n    attributes: xmlFields,\n    type: '',\n    bounds: {bottom: 0, top: 0, left: 0, right: 0}\n  };\n}\n\n// GetFeatureInfo\n\n/**\n * Parses a typed data structure from raw XML for `GetFeatureInfo` response\n * @note Error handlings is fairly weak\n */\nexport function parseWMSLayerDescription(text: string, options): WMSLayerDescription {\n  const parsedXML = XMLLoader.parseTextSync(text, options);\n  // TODO - implement parser\n  return parsedXML as unknown as WMSLayerDescription;\n}\n\n/**\n * Extract an error message from WMS error response XML\n * @param text\n * @param options\n * @returns a string with a human readable message\n */\nexport function parseWMSError(text: string, options): string {\n  const parsedXML = XMLLoader.parseTextSync?.(text, options);\n  const serviceExceptionXML =\n    parsedXML?.ServiceExceptionReport?.ServiceException ||\n    parsedXML?.['ogc:ServiceExceptionReport']?.['ogc:ServiceException'];\n  // Sigh, can be either a string or an object\n  const message =\n    typeof serviceExceptionXML === 'string'\n      ? serviceExceptionXML\n      : serviceExceptionXML['#text'] || serviceExceptionXML.code || 'Unknown error';\n  return message;\n}\n"],"mappings":"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"}