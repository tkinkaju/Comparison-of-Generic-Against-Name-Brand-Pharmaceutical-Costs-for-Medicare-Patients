{"version":3,"file":"tile-3d-feature-table.js","names":["Tile3DFeatureTable","featureTableJson","featureTableBinary","json","buffer","extensionName","extensions","propertyName","Boolean","componentType","GL","UNSIGNED_INT","componentLength","jsonValue","Number","isFinite","byteOffset","_getTypedArrayFromBinary","GLType","fromName","featuresLength","_getTypedArrayFromArray","featureId","result","typedArray","getPropertyArray","i","count","cachedTypedArrays","_cachedTypedArrays","createTypedArray","array"],"sources":["../../../../src/lib/classes/tile-3d-feature-table.ts"],"sourcesContent":["// This file is derived from the Cesium code base under Apache 2 license\n// See LICENSE.md and https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md\n\nimport {GL, GLType} from '@loaders.gl/math';\n\n// Reference:\n// https://github.com/AnalyticalGraphicsInc/cesium/blob/1de96d087f0b17575eb1a3f736407b348c765d59/Source/Scene/Cesium3DTileFeatureTable.js\nexport default class Tile3DFeatureTable {\n  json;\n  buffer;\n  featuresLength = 0;\n  _cachedTypedArrays = {};\n\n  constructor(featureTableJson, featureTableBinary) {\n    this.json = featureTableJson;\n    this.buffer = featureTableBinary;\n  }\n\n  getExtension(extensionName) {\n    return this.json.extensions && this.json.extensions[extensionName];\n  }\n\n  hasProperty(propertyName) {\n    return Boolean(this.json[propertyName]);\n  }\n\n  getGlobalProperty(propertyName, componentType = GL.UNSIGNED_INT, componentLength = 1) {\n    const jsonValue = this.json[propertyName];\n\n    if (jsonValue && Number.isFinite(jsonValue.byteOffset)) {\n      return this._getTypedArrayFromBinary(\n        propertyName,\n        componentType,\n        componentLength,\n        1,\n        jsonValue.byteOffset\n      );\n    }\n\n    return jsonValue;\n  }\n\n  getPropertyArray(propertyName, componentType, componentLength) {\n    const jsonValue = this.json[propertyName];\n\n    if (jsonValue && Number.isFinite(jsonValue.byteOffset)) {\n      if ('componentType' in jsonValue) {\n        componentType = GLType.fromName(jsonValue.componentType);\n      }\n      return this._getTypedArrayFromBinary(\n        propertyName,\n        componentType,\n        componentLength,\n        this.featuresLength,\n        jsonValue.byteOffset\n      );\n    }\n\n    return this._getTypedArrayFromArray(propertyName, componentType, jsonValue);\n  }\n\n  getProperty(propertyName, componentType, componentLength, featureId, result) {\n    const jsonValue = this.json[propertyName];\n    if (!jsonValue) {\n      return jsonValue;\n    }\n\n    const typedArray = this.getPropertyArray(propertyName, componentType, componentLength);\n\n    if (componentLength === 1) {\n      return typedArray[featureId];\n    }\n\n    for (let i = 0; i < componentLength; ++i) {\n      result[i] = typedArray[componentLength * featureId + i];\n    }\n\n    return result;\n  }\n\n  // HELPERS\n\n  _getTypedArrayFromBinary(propertyName, componentType, componentLength, count, byteOffset) {\n    const cachedTypedArrays = this._cachedTypedArrays;\n    let typedArray = cachedTypedArrays[propertyName];\n    if (!typedArray) {\n      typedArray = GLType.createTypedArray(\n        componentType,\n        this.buffer.buffer,\n        this.buffer.byteOffset + byteOffset,\n        count * componentLength\n      );\n      cachedTypedArrays[propertyName] = typedArray;\n    }\n    return typedArray;\n  }\n\n  _getTypedArrayFromArray(propertyName, componentType, array) {\n    const cachedTypedArrays = this._cachedTypedArrays;\n    let typedArray = cachedTypedArrays[propertyName];\n    if (!typedArray) {\n      typedArray = GLType.createTypedArray(componentType, array);\n      cachedTypedArrays[propertyName] = typedArray;\n    }\n    return typedArray;\n  }\n}\n"],"mappings":"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"}