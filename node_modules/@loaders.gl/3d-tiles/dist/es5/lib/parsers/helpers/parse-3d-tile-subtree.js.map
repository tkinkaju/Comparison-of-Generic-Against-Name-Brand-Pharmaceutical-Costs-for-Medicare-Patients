{"version":3,"file":"parse-3d-tile-subtree.js","names":["SUBTREE_FILE_MAGIC","SUBTREE_FILE_VERSION","parse3DTilesSubtree","data","options","context","magic","Uint32Array","slice","Error","version","jsonByteLength","parseUint64Value","stringAttribute","Uint8Array","textDecoder","TextDecoder","string","decode","subtree","JSON","parse","binaryByteLength","internalBinaryBuffer","ArrayBuffer","tileAvailability","getExplicitBitstream","explicitBitstream","contentAvailability","childSubtreeAvailability","resolveBufferUri","bitstreamRelativeUri","basePath","hasProtocol","startsWith","resolvedUri","URL","decodeURI","toString","basePathWithProtocol","host","pathname","name","bufferViewIndex","bufferView","bufferViews","buffer","buffers","url","fetch","uri","bufferUri","response","arrayBuffer","byteOffset","byteLength","dataView","DataView","left","getUint32","right"],"sources":["../../../../../src/lib/parsers/helpers/parse-3d-tile-subtree.ts"],"sourcesContent":["import type {Subtree, ExplicitBitstream} from '../../../types';\nimport type {LoaderContext, LoaderOptions} from '@loaders.gl/loader-utils';\n\nconst SUBTREE_FILE_MAGIC = 0x74627573;\nconst SUBTREE_FILE_VERSION = 1;\n\n/**\n * Parse subtree file\n * Spec - https://github.com/CesiumGS/3d-tiles/tree/main/extensions/3DTILES_implicit_tiling#subtree-file-format\n * @param data\n * @returns\n */\n// eslint-disable-next-line max-statements\nexport default async function parse3DTilesSubtree(\n  data: ArrayBuffer,\n  options: LoaderOptions | undefined,\n  context: LoaderContext | undefined\n): Promise<Subtree> {\n  const magic = new Uint32Array(data.slice(0, 4));\n\n  if (magic[0] !== SUBTREE_FILE_MAGIC) {\n    throw new Error('Wrong subtree file magic number');\n  }\n\n  const version = new Uint32Array(data.slice(4, 8));\n\n  if (version[0] !== SUBTREE_FILE_VERSION) {\n    throw new Error('Wrong subtree file verson, must be 1');\n  }\n\n  const jsonByteLength = parseUint64Value(data.slice(8, 16));\n  const stringAttribute = new Uint8Array(data, 24, jsonByteLength);\n\n  const textDecoder = new TextDecoder('utf8');\n  const string = textDecoder.decode(stringAttribute);\n  const subtree = JSON.parse(string);\n\n  const binaryByteLength = parseUint64Value(data.slice(16, 24));\n  let internalBinaryBuffer = new ArrayBuffer(0);\n\n  if (binaryByteLength) {\n    internalBinaryBuffer = data.slice(24 + jsonByteLength);\n  }\n\n  if ('bufferView' in subtree.tileAvailability) {\n    subtree.tileAvailability.explicitBitstream = await getExplicitBitstream(\n      subtree,\n      'tileAvailability',\n      internalBinaryBuffer,\n      context\n    );\n  }\n\n  if ('bufferView' in subtree.contentAvailability) {\n    subtree.contentAvailability.explicitBitstream = await getExplicitBitstream(\n      subtree,\n      'contentAvailability',\n      internalBinaryBuffer,\n      context\n    );\n  }\n\n  if ('bufferView' in subtree.childSubtreeAvailability) {\n    subtree.childSubtreeAvailability.explicitBitstream = await getExplicitBitstream(\n      subtree,\n      'childSubtreeAvailability',\n      internalBinaryBuffer,\n      context\n    );\n  }\n\n  return subtree;\n}\n\n/**\n * Get url for bitstream downloading\n * @param bitstreamRelativeUri\n * @param baseUri\n * @returns\n */\nfunction resolveBufferUri(bitstreamRelativeUri: string, basePath: string): string {\n  const hasProtocol = basePath.startsWith('http');\n\n  if (hasProtocol) {\n    const resolvedUri = new URL(bitstreamRelativeUri, basePath);\n    return decodeURI(resolvedUri.toString());\n  }\n\n  /**\n   * Adding http protocol only for new URL constructor usage.\n   * It allows to resolve relative paths like ../../example with basePath.\n   */\n  const basePathWithProtocol = `http://${basePath}`;\n  const resolvedUri = new URL(bitstreamRelativeUri, basePathWithProtocol);\n  /**\n   * Drop protocol and use just relative path.\n   */\n  return `/${resolvedUri.host}${resolvedUri.pathname}`;\n}\n\n/**\n * Get explicit bitstream for subtree availability data.\n * @param subtree\n * @param name\n * @param internalBinaryBuffer\n */\nasync function getExplicitBitstream(\n  subtree: Subtree,\n  name: string,\n  internalBinaryBuffer: ArrayBuffer,\n  context: LoaderContext | undefined\n): Promise<ExplicitBitstream> {\n  const bufferViewIndex = subtree[name].bufferView;\n  const bufferView = subtree.bufferViews[bufferViewIndex];\n  const buffer = subtree.buffers[bufferView.buffer];\n\n  if (!context?.url || !context.fetch) {\n    throw new Error('Url is not provided');\n  }\n\n  if (!context.fetch) {\n    throw new Error('fetch is not provided');\n  }\n\n  // External bitstream loading\n  if (buffer.uri) {\n    const bufferUri = resolveBufferUri(buffer.uri, context?.url);\n    const response = await context.fetch(bufferUri);\n    const data = await response.arrayBuffer();\n    // Return view of bitstream.\n    return new Uint8Array(data, bufferView.byteOffset, bufferView.byteLength);\n  }\n  // Return view of bitstream.\n  return new Uint8Array(internalBinaryBuffer, bufferView.byteOffset, bufferView.byteLength);\n}\n\n/**\n * Parse buffer to return uint64 value\n * @param buffer\n * @returns 64-bit value until precision is lost after Number.MAX_SAFE_INTEGER\n */\nfunction parseUint64Value(buffer: ArrayBuffer): number {\n  const dataView = new DataView(buffer);\n  const left = dataView.getUint32(0, true);\n  const right = dataView.getUint32(4, true);\n  // combine the two 32-bit values\n  return left + 2 ** 32 * right;\n}\n"],"mappings":"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"}