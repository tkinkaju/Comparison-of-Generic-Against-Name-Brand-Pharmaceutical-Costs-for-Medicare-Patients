// Copyright (c) 2022 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.coordHasLength4 = coordHasLength4;
exports.containValidTime = containValidTime;
exports.isTripGeoJsonField = isTripGeoJsonField;
exports.parseTripGeoJsonTimestamp = parseTripGeoJsonTimestamp;
exports.getAnimationDomainFromTimestamps = getAnimationDomainFromTimestamps;

var _typeAnalyzer = require("type-analyzer");

var _geojsonUtils = require("../geojson-layer/geojson-utils");

var _utils = require("@kepler.gl/utils");/**
 * Parse geojson from string
 * @param {array} samples feature object values
 * @returns whether the geometry coordinates has length of 4
 */
function coordHasLength4(samples) {
  var hasLength4 = true;

  for (var i = 0; i < samples.length; i += 1) {
    var _samples$i, _samples$i$geometry;

    hasLength4 = Array.isArray((_samples$i = samples[i]) === null || _samples$i === void 0 ? void 0 : (_samples$i$geometry = _samples$i.geometry) === null || _samples$i$geometry === void 0 ? void 0 : _samples$i$geometry.coordinates) && !samples[i].geometry.coordinates.find(function (c) {
      return c.length < 4;
    });

    if (!hasLength4) {
      break;
    }
  }

  return hasLength4;
}
/**
 * Check whether geojson linestring's 4th coordinate is 1) not timestamp 2) unix time stamp 3) real date time
 * @param timestamps array to be tested if its elements are timestamp
 * @returns the type of timestamp: unix/datetime/invalid(not timestamp)
 */


function containValidTime(timestamps) {
  var formattedTimeStamps = timestamps.map(function (ts) {
    return {
      ts: ts
    };
  });
  var ignoredDataTypes = Object.keys(_typeAnalyzer.DATA_TYPES).filter(function (type) {
    return ![_typeAnalyzer.DATA_TYPES.TIME, _typeAnalyzer.DATA_TYPES.DATETIME].includes(type);
  }); // ignore all types but TIME to improve performance

  var analyzedType = _typeAnalyzer.Analyzer.computeColMeta(formattedTimeStamps, [], {
    ignoredDataTypes: ignoredDataTypes
  })[0];

  if (!analyzedType || analyzedType.category !== 'TIME') {
    return null;
  }

  return analyzedType;
}
/**
 * Check if geojson features are trip layer animatable by meeting 3 conditions
 * @param dataContainer geojson feature objects container
 * @param {object} field array of geojson feature objects
 * @returns whether it is trip layer animatable
 */


function isTripGeoJsonField(dataContainer, field) {
  if (dataContainer.numRows() < 1) {
    return false;
  }

  var maxCount = 10000;
  var sampleRawFeatures = dataContainer.numRows() > maxCount ? (0, _utils.getSampleContainerData)(dataContainer, maxCount) : dataContainer;
  var features = sampleRawFeatures.mapIndex(field.valueAccessor).map(_geojsonUtils.parseGeoJsonRawFeature).filter(_utils.notNullorUndefined);
  var featureTypes = (0, _geojsonUtils.getGeojsonFeatureTypes)(features); // condition 1: contain line string
  // @ts-expect-error

  if (!featureTypes.line) {
    return false;
  } // condition 2:sample line strings contain 4 coordinates


  if (!coordHasLength4(features)) {
    return false;
  } // condition 3:the 4th coordinate of the first feature line strings is valid time
  // @ts-expect-error


  var tsHolder = features[0].geometry.coordinates.map(function (coord) {
    return coord[3];
  });
  return Boolean(containValidTime(tsHolder));
}
/**
 * Get unix timestamp from animatable geojson for deck.gl trip layer
 * @param dataToFeature array of geojson feature objects, can be null
 * @returns
 */


function parseTripGeoJsonTimestamp(dataToFeature) {
  // Analyze type based on coordinates of the 1st lineString
  // select a sample trip to analyze time format
  var empty = {
    dataToTimeStamp: [],
    animationDomain: null
  };
  var sampleTrip = dataToFeature.find(function (f) {
    return f && f.geometry && f.geometry.coordinates && f.geometry.coordinates.length >= 3;
  }); // if no valid geometry

  if (!sampleTrip) {
    return empty;
  }

  var analyzedType = containValidTime(sampleTrip.geometry.coordinates.map(function (coord) {
    return coord[3];
  }));

  if (!analyzedType) {
    return empty;
  }

  var format = analyzedType.format;

  var getTimeValue = function getTimeValue(coord) {
    return coord && (0, _utils.notNullorUndefined)(coord[3]) ? (0, _utils.timeToUnixMilli)(coord[3], format) : null;
  };

  var dataToTimeStamp = dataToFeature.map(function (f) {
    return f && f.geometry && Array.isArray(f.geometry.coordinates) ? f.geometry.coordinates.map(getTimeValue) : null;
  });
  var animationDomain = getAnimationDomainFromTimestamps(dataToTimeStamp);
  return {
    dataToTimeStamp: dataToTimeStamp,
    animationDomain: animationDomain
  };
}

function findMinFromSorted(list) {
  // check if list is null since the default value [] will only be applied when the param is undefined
  return (list === null || list === void 0 ? void 0 : list.find(function (d) {
    return (0, _utils.notNullorUndefined)(d) && Number.isFinite(d);
  })) || null;
}

function findMaxFromSorted() {
  var list = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var i = list.length - 1;

  while (i > 0) {
    if ((0, _utils.notNullorUndefined)(list[i]) && Number.isFinite(list[i])) {
      return list[i];
    }

    i--;
  }

  return null;
}

function getAnimationDomainFromTimestamps() {
  var dataToTimeStamp = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  return dataToTimeStamp.reduce(function (accu, tss) {
    var tsMin = findMinFromSorted(tss);
    var tsMax = findMaxFromSorted(tss);

    if ((0, _utils.notNullorUndefined)(tsMin) && (0, _utils.notNullorUndefined)(tsMax) && Number.isFinite(tsMin) && Number.isFinite(tsMax)) {
      accu[0] = Math.min(accu[0], tsMin);
      accu[1] = Math.max(accu[1], tsMax);
    }

    return accu;
  }, [Infinity, -Infinity]);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cmlwLWxheWVyL3RyaXAtdXRpbHMudHMiXSwibmFtZXMiOlsiY29vcmRIYXNMZW5ndGg0Iiwic2FtcGxlcyIsImhhc0xlbmd0aDQiLCJpIiwibGVuZ3RoIiwiQXJyYXkiLCJpc0FycmF5IiwiZ2VvbWV0cnkiLCJjb29yZGluYXRlcyIsImZpbmQiLCJjIiwiY29udGFpblZhbGlkVGltZSIsInRpbWVzdGFtcHMiLCJmb3JtYXR0ZWRUaW1lU3RhbXBzIiwibWFwIiwidHMiLCJpZ25vcmVkRGF0YVR5cGVzIiwiT2JqZWN0Iiwia2V5cyIsIkRBVEFfVFlQRVMiLCJmaWx0ZXIiLCJ0eXBlIiwiVElNRSIsIkRBVEVUSU1FIiwiaW5jbHVkZXMiLCJhbmFseXplZFR5cGUiLCJBbmFseXplciIsImNvbXB1dGVDb2xNZXRhIiwiY2F0ZWdvcnkiLCJpc1RyaXBHZW9Kc29uRmllbGQiLCJkYXRhQ29udGFpbmVyIiwiZmllbGQiLCJudW1Sb3dzIiwibWF4Q291bnQiLCJzYW1wbGVSYXdGZWF0dXJlcyIsImZlYXR1cmVzIiwibWFwSW5kZXgiLCJ2YWx1ZUFjY2Vzc29yIiwicGFyc2VHZW9Kc29uUmF3RmVhdHVyZSIsIm5vdE51bGxvclVuZGVmaW5lZCIsImZlYXR1cmVUeXBlcyIsImxpbmUiLCJ0c0hvbGRlciIsImNvb3JkIiwiQm9vbGVhbiIsInBhcnNlVHJpcEdlb0pzb25UaW1lc3RhbXAiLCJkYXRhVG9GZWF0dXJlIiwiZW1wdHkiLCJkYXRhVG9UaW1lU3RhbXAiLCJhbmltYXRpb25Eb21haW4iLCJzYW1wbGVUcmlwIiwiZiIsImZvcm1hdCIsImdldFRpbWVWYWx1ZSIsImdldEFuaW1hdGlvbkRvbWFpbkZyb21UaW1lc3RhbXBzIiwiZmluZE1pbkZyb21Tb3J0ZWQiLCJsaXN0IiwiZCIsIk51bWJlciIsImlzRmluaXRlIiwiZmluZE1heEZyb21Tb3J0ZWQiLCJyZWR1Y2UiLCJhY2N1IiwidHNzIiwidHNNaW4iLCJ0c01heCIsIk1hdGgiLCJtaW4iLCJt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Q0FmSyxDQUFQO0FBaUJEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDIyIFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cblxuaW1wb3J0IHtBbmFseXplciwgREFUQV9UWVBFU30gZnJvbSAndHlwZS1hbmFseXplcic7XG5cbmltcG9ydCB7RmllbGR9IGZyb20gJ0BrZXBsZXIuZ2wvdHlwZXMnO1xuXG5pbXBvcnQge3BhcnNlR2VvSnNvblJhd0ZlYXR1cmUsIGdldEdlb2pzb25GZWF0dXJlVHlwZXN9IGZyb20gJy4uL2dlb2pzb24tbGF5ZXIvZ2VvanNvbi11dGlscyc7XG5pbXBvcnQge1xuICBEYXRhQ29udGFpbmVySW50ZXJmYWNlLFxuICBnZXRTYW1wbGVDb250YWluZXJEYXRhLFxuICBub3ROdWxsb3JVbmRlZmluZWQsXG4gIHRpbWVUb1VuaXhNaWxsaVxufSBmcm9tICdAa2VwbGVyLmdsL3V0aWxzJztcbmltcG9ydCB7RmVhdHVyZX0gZnJvbSAnQHR1cmYvaGVscGVycyc7XG5pbXBvcnQge0dlb0pzb25Qcm9wZXJ0aWVzLCBHZW9tZXRyeX0gZnJvbSAnZ2VvanNvbic7XG5cbi8qKlxuICogUGFyc2UgZ2VvanNvbiBmcm9tIHN0cmluZ1xuICogQHBhcmFtIHthcnJheX0gc2FtcGxlcyBmZWF0dXJlIG9iamVjdCB2YWx1ZXNcbiAqIEByZXR1cm5zIHdoZXRoZXIgdGhlIGdlb21ldHJ5IGNvb3JkaW5hdGVzIGhhcyBsZW5ndGggb2YgNFxuICovXG5leHBvcnQgZnVuY3Rpb24gY29vcmRIYXNMZW5ndGg0KHNhbXBsZXMpOiBib29sZWFuIHtcbiAgbGV0IGhhc0xlbmd0aDQgPSB0cnVlO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHNhbXBsZXMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICBoYXNMZW5ndGg0ID1cbiAgICAgIEFycmF5LmlzQXJyYXkoc2FtcGxlc1tpXT8uZ2VvbWV0cnk/LmNvb3JkaW5hdGVzKSAmJlxuICAgICAgIXNhbXBsZXNbaV0uZ2VvbWV0cnkuY29vcmRpbmF0ZXMuZmluZChjID0+IGMubGVuZ3RoIDwgNCk7XG5cbiAgICBpZiAoIWhhc0xlbmd0aDQpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuICByZXR1cm4gaGFzTGVuZ3RoNDtcbn1cblxuLyoqXG4gKiBDaGVjayB3aGV0aGVyIGdlb2pzb24gbGluZXN0cmluZydzIDR0aCBjb29yZGluYXRlIGlzIDEpIG5vdCB0aW1lc3RhbXAgMikgdW5peCB0aW1lIHN0YW1wIDMpIHJlYWwgZGF0ZSB0aW1lXG4gKiBAcGFyYW0gdGltZXN0YW1wcyBhcnJheSB0byBiZSB0ZXN0ZWQgaWYgaXRzIGVsZW1lbnRzIGFyZSB0aW1lc3RhbXBcbiAqIEByZXR1cm5zIHRoZSB0eXBlIG9mIHRpbWVzdGFtcDogdW5peC9kYXRldGltZS9pbnZhbGlkKG5vdCB0aW1lc3RhbXApXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb250YWluVmFsaWRUaW1lKHRpbWVzdGFtcHM6IHN0cmluZ1tdKTogRmllbGQgfCBudWxsIHtcbiAgY29uc3QgZm9ybWF0dGVkVGltZVN0YW1wcyA9IHRpbWVzdGFtcHMubWFwKHRzID0+ICh7dHN9KSk7XG4gIGNvbnN0IGlnbm9yZWREYXRhVHlwZXMgPSBPYmplY3Qua2V5cyhEQVRBX1RZUEVTKS5maWx0ZXIoXG4gICAgdHlwZSA9PiAhW0RBVEFfVFlQRVMuVElNRSwgREFUQV9UWVBFUy5EQVRFVElNRV0uaW5jbHVkZXModHlwZSlcbiAgKTtcblxuICAvLyBpZ25vcmUgYWxsIHR5cGVzIGJ1dCBUSU1FIHRvIGltcHJvdmUgcGVyZm9ybWFuY2VcbiAgY29uc3QgYW5hbHl6ZWRUeXBlID0gQW5hbHl6ZXIuY29tcHV0ZUNvbE1ldGEoZm9ybWF0dGVkVGltZVN0YW1wcywgW10sIHtpZ25vcmVkRGF0YVR5cGVzfSlbMF07XG5cbiAgaWYgKCFhbmFseXplZFR5cGUgfHwgYW5hbHl6ZWRUeXBlLmNhdGVnb3J5ICE9PSAnVElNRScpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICByZXR1cm4gYW5hbHl6ZWRUeXBlO1xufVxuXG4vKipcbiAqIENoZWNrIGlmIGdlb2pzb24gZmVhdHVyZXMgYXJlIHRyaXAgbGF5ZXIgYW5pbWF0YWJsZSBieSBtZWV0aW5nIDMgY29uZGl0aW9uc1xuICogQHBhcmFtIGRhdGFDb250YWluZXIgZ2VvanNvbiBmZWF0dXJlIG9iamVjdHMgY29udGFpbmVyXG4gKiBAcGFyYW0ge29iamVjdH0gZmllbGQgYXJyYXkgb2YgZ2VvanNvbiBmZWF0dXJlIG9iamVjdHNcbiAqIEByZXR1cm5zIHdoZXRoZXIgaXQgaXMgdHJpcCBsYXllciBhbmltYXRhYmxlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1RyaXBHZW9Kc29uRmllbGQoZGF0YUNvbnRhaW5lcjogRGF0YUNvbnRhaW5lckludGVyZmFjZSwgZmllbGQpOiBib29sZWFuIHtcbiAgaWYgKGRhdGFDb250YWluZXIubnVtUm93cygpIDwgMSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGNvbnN0IG1heENvdW50ID0gMTAwMDA7XG4gIGNvbnN0IHNhbXBsZVJhd0ZlYXR1cmVzID1cbiAgICBkYXRhQ29udGFpbmVyLm51bVJvd3MoKSA+IG1heENvdW50XG4gICAgICA/IGdldFNhbXBsZUNvbnRhaW5lckRhdGEoZGF0YUNvbnRhaW5lciwgbWF4Q291bnQpXG4gICAgICA6IGRhdGFDb250YWluZXI7XG5cbiAgY29uc3QgZmVhdHVyZXM6IEZlYXR1cmU8R2VvbWV0cnksIEdlb0pzb25Qcm9wZXJ0aWVzPltdID0gc2FtcGxlUmF3RmVhdHVyZXNcbiAgICAubWFwSW5kZXgoZmllbGQudmFsdWVBY2Nlc3NvcilcbiAgICAubWFwKHBhcnNlR2VvSnNvblJhd0ZlYXR1cmUpXG4gICAgLmZpbHRlcihub3ROdWxsb3JVbmRlZmluZWQpO1xuICBjb25zdCBmZWF0dXJlVHlwZXMgPSBnZXRHZW9qc29uRmVhdHVyZVR5cGVzKGZlYXR1cmVzKTtcblxuICAvLyBjb25kaXRpb24gMTogY29udGFpbiBsaW5lIHN0cmluZ1xuICAvLyBAdHMtZXhwZWN0LWVycm9yXG4gIGlmICghZmVhdHVyZVR5cGVzLmxpbmUpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyBjb25kaXRpb24gMjpzYW1wbGUgbGluZSBzdHJpbmdzIGNvbnRhaW4gNCBjb29yZGluYXRlc1xuICBpZiAoIWNvb3JkSGFzTGVuZ3RoNChmZWF0dXJlcykpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyBjb25kaXRpb24gMzp0aGUgNHRoIGNvb3JkaW5hdGUgb2YgdGhlIGZpcnN0IGZlYXR1cmUgbGluZSBzdHJpbmdzIGlzIHZhbGlkIHRpbWVcbiAgLy8gQHRzLWV4cGVjdC1lcnJvclxuICBjb25zdCB0c0hvbGRlciA9IGZlYXR1cmVzWzBdLmdlb21ldHJ5LmNvb3JkaW5hdGVzLm1hcChjb29yZCA9PiBjb29yZFszXSk7XG5cbiAgcmV0dXJuIEJvb2xlYW4oY29udGFpblZhbGlkVGltZSh0c0hvbGRlcikpO1xufVxuXG4vKipcbiAqIEdldCB1bml4IHRpbWVzdGFtcCBmcm9tIGFuaW1hdGFibGUgZ2VvanNvbiBmb3IgZGVjay5nbCB0cmlwIGxheWVyXG4gKiBAcGFyYW0gZGF0YVRvRmVhdHVyZSBhcnJheSBvZiBnZW9qc29uIGZlYXR1cmUgb2JqZWN0cywgY2FuIGJlIG51bGxcbiAqIEByZXR1cm5zXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVRyaXBHZW9Kc29uVGltZXN0YW1wKGRhdGFUb0ZlYXR1cmU6IGFueVtdKSB7XG4gIC8vIEFuYWx5emUgdHlwZSBiYXNlZCBvbiBjb29yZGluYXRlcyBvZiB0aGUgMXN0IGxpbmVTdHJpbmdcbiAgLy8gc2VsZWN0IGEgc2FtcGxlIHRyaXAgdG8gYW5hbHl6ZSB0aW1lIGZvcm1hdFxuICBjb25zdCBlbXB0eSA9IHtkYXRhVG9UaW1lU3RhbXA6IFtdLCBhbmltYXRpb25Eb21haW46IG51bGx9O1xuICBjb25zdCBzYW1wbGVUcmlwID0gZGF0YVRvRmVhdHVyZS5maW5kKFxuICAgIGYgPT4gZiAmJiBmLmdlb21ldHJ5ICYmIGYuZ2VvbWV0cnkuY29vcmRpbmF0ZXMgJiYgZi5nZW9tZXRyeS5jb29yZGluYXRlcy5sZW5ndGggPj0gM1xuICApO1xuXG4gIC8vIGlmIG5vIHZhbGlkIGdlb21ldHJ5XG4gIGlmICghc2FtcGxlVHJpcCkge1xuICAgIHJldHVybiBlbXB0eTtcbiAgfVxuXG4gIGNvbnN0IGFuYWx5emVkVHlwZSA9IGNvbnRhaW5WYWxpZFRpbWUoc2FtcGxlVHJpcC5nZW9tZXRyeS5jb29yZGluYXRlcy5tYXAoY29vcmQgPT4gY29vcmRbM10pKTtcblxuICBpZiAoIWFuYWx5emVkVHlwZSkge1xuICAgIHJldHVybiBlbXB0eTtcbiAgfVxuXG4gIGNvbnN0IHtmb3JtYXR9ID0gYW5hbHl6ZWRUeXBlO1xuICBjb25zdCBnZXRUaW1lVmFsdWUgPSBjb29yZCA9PlxuICAgIGNvb3JkICYmIG5vdE51bGxvclVuZGVmaW5lZChjb29yZFszXSkgPyB0aW1lVG9Vbml4TWlsbGkoY29vcmRbM10sIGZvcm1hdCkgOiBudWxsO1xuXG4gIGNvbnN0IGRhdGFUb1RpbWVTdGFtcDogbnVtYmVyW11bXSA9IGRhdGFUb0ZlYXR1cmUubWFwKGYgPT5cbiAgICBmICYmIGYuZ2VvbWV0cnkgJiYgQXJyYXkuaXNBcnJheShmLmdlb21ldHJ5LmNvb3JkaW5hdGVzKVxuICAgICAgPyBmLmdlb21ldHJ5LmNvb3JkaW5hdGVzLm1hcChnZXRUaW1lVmFsdWUpXG4gICAgICA6IG51bGxcbiAgKTtcblxuICBjb25zdCBhbmltYXRpb25Eb21haW4gPSBnZXRBbmltYXRpb25Eb21haW5Gcm9tVGltZXN0YW1wcyhkYXRhVG9UaW1lU3RhbXApO1xuXG4gIHJldHVybiB7ZGF0YVRvVGltZVN0YW1wLCBhbmltYXRpb25Eb21haW59O1xufVxuXG5mdW5jdGlvbiBmaW5kTWluRnJvbVNvcnRlZChsaXN0OiBudW1iZXJbXSkge1xuICAvLyBjaGVjayBpZiBsaXN0IGlzIG51bGwgc2luY2UgdGhlIGRlZmF1bHQgdmFsdWUgW10gd2lsbCBvbmx5IGJlIGFwcGxpZWQgd2hlbiB0aGUgcGFyYW0gaXMgdW5kZWZpbmVkXG4gIHJldHVybiBsaXN0Py5maW5kKGQgPT4gbm90TnVsbG9yVW5kZWZpbmVkKGQpICYmIE51bWJlci5pc0Zpbml0ZShkKSkgfHwgbnVsbDtcbn1cblxuZnVuY3Rpb24gZmluZE1heEZyb21Tb3J0ZWQobGlzdDogbnVtYmVyW10gPSBbXSkge1xuICBsZXQgaSA9IGxpc3QubGVuZ3RoIC0gMTtcbiAgd2hpbGUgKGkgPiAwKSB7XG4gICAgaWYgKG5vdE51bGxvclVuZGVmaW5lZChsaXN0W2ldKSAmJiBOdW1iZXIuaXNGaW5pdGUobGlzdFtpXSkpIHtcbiAgICAgIHJldHVybiBsaXN0W2ldO1xuICAgIH1cbiAgICBpLS07XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRBbmltYXRpb25Eb21haW5Gcm9tVGltZXN0YW1wcyhkYXRhVG9UaW1lU3RhbXA6IG51bWJlcltdW10gPSBbXSkge1xuICByZXR1cm4gZGF0YVRvVGltZVN0YW1wLnJlZHVjZShcbiAgICAoYWNjdTogW251bWJlciwgbnVtYmVyXSwgdHNzKSA9PiB7XG4gICAgICBjb25zdCB0c01pbiA9IGZpbmRNaW5Gcm9tU29ydGVkKHRzcyk7XG4gICAgICBjb25zdCB0c01heCA9IGZpbmRNYXhGcm9tU29ydGVkKHRzcyk7XG4gICAgICBpZiAoXG4gICAgICAgIG5vdE51bGxvclVuZGVmaW5lZCh0c01pbikgJiZcbiAgICAgICAgbm90TnVsbG9yVW5kZWZpbmVkKHRzTWF4KSAmJlxuICAgICAgICBOdW1iZXIuaXNGaW5pdGUodHNNaW4pICYmXG4gICAgICAgIE51bWJlci5pc0Zpbml0ZSh0c01heClcbiAgICAgICkge1xuICAgICAgICBhY2N1WzBdID0gTWF0aC5taW4oYWNjdVswXSwgdHNNaW4pO1xuICAgICAgICBhY2N1WzFdID0gTWF0aC5tYXgoYWNjdVsxXSwgdHNNYXgpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFjY3U7XG4gICAgfSxcbiAgICBbSW5maW5pdHksIC1JbmZpbml0eV1cbiAgKTtcbn1cbiJdfQ==