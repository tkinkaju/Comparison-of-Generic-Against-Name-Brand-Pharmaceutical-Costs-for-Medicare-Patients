// Copyright (c) 2022 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = FloatingTimeDisplayFactory;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _classnames = _interopRequireDefault(require("classnames"));

var _icons = require("../icons");

var _constants = require("@kepler.gl/constants");

var _styledComponents2 = require("../../common/styled-components");

var _utils = require("@kepler.gl/utils");

var _templateObject, _templateObject2, _templateObject3, _templateObject4, _templateObject5, _templateObject6, _templateObject7, _templateObject8;

var StyledTimeDisplayWrapper = _styledComponents["default"].div.attrs({
  className: 'floating-time-display'
})(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  bottom: ", ";\n  display: flex;\n  position: absolute;\n  width: 100%;\n  margin-left: -", "px;\n  justify-content: center;\n  pointer-events: none; /* prevent padding from blocking input */\n  & > * {\n    /* all children should allow input */\n    pointer-events: all;\n  }\n"])), function (props) {
  return "calc(100% + ".concat(props.theme.bottomPanelGap, "px)");
}, function (props) {
  return props.theme.bottomInnerPdSide;
});

var StyledTimeDisplay = _styledComponents["default"].div.attrs(function (props) {
  return {
    className: (0, _classnames["default"])('floating-time-display__inner', props.className)
  };
})(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["\n  background-color: ", ";\n  border-radius: ", "px;\n  color: ", ";\n  display: flex;\n  height: ", "px;\n  justify-content: center;\n  min-width: ", "px;\n  opacity: ", ";\n  padding: ", ";\n"])), function (props) {
  return props.theme.panelBackground;
}, function (props) {
  return props.theme.timeDisplayBorderRadius;
}, function (props) {
  return props.theme.titleTextColor;
}, function (props) {
  return props.theme.timeDisplayHeight;
}, function (props) {
  return props.theme.timeDisplayMinWidth;
}, function (props) {
  return props.theme.timeDisplayOpacity;
}, function (props) {
  return props.theme.timeDisplayPadding;
});

var StyledTimeDisplayGroups = _styledComponents["default"].div(_templateObject3 || (_templateObject3 = (0, _taggedTemplateLiteral2["default"])(["\n  align-items: center;\n  display: flex;\n  flex-direction: row;\n"])));

var StyledTimeDisplayRows = _styledComponents["default"].div(_templateObject4 || (_templateObject4 = (0, _taggedTemplateLiteral2["default"])(["\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n"])));

var StyledTimeDisplayTop = _styledComponents["default"].div.attrs({
  className: 'animation-control__time-display__top'
})(_templateObject5 || (_templateObject5 = (0, _taggedTemplateLiteral2["default"])(["\n  color: ", ";\n  display: flex;\n  font-size: 12px;\n  font-weight: 500;\n  justify-content: center;\n"])), function (props) {
  return props.theme.textColor;
});

var StyledTimeDisplayBottom = _styledComponents["default"].div.attrs({
  className: 'animation-control__time-display__bottom'
})(_templateObject6 || (_templateObject6 = (0, _taggedTemplateLiteral2["default"])(["\n  color: ", ";\n  display: flex;\n  font-size: 14px;\n  font-weight: 500;\n  justify-content: center;\n"])), function (props) {
  return props.theme.titleTextColor;
});

var StyledTimeValueGroup = _styledComponents["default"].div.attrs({
  className: 'animation-control__time-value-group'
})(_templateObject7 || (_templateObject7 = (0, _taggedTemplateLiteral2["default"])(["\n  display: flex;\n  flex-direction: column;\n"])));

var StyledHorizontalBar = _styledComponents["default"].div.attrs({
  className: 'animation-control__horizontal-bar'
})(_templateObject8 || (_templateObject8 = (0, _taggedTemplateLiteral2["default"])(["\n  margin: 0 12px;\n"])));

var TimeDivider = function TimeDivider() {
  return /*#__PURE__*/_react["default"].createElement(StyledHorizontalBar, null, /*#__PURE__*/_react["default"].createElement(_icons.Minus, {
    height: "12px"
  }));
};

var TimeDisplayRow = function TimeDisplayRow(_ref) {
  var _ref$timeValues = _ref.timeValues,
      timeValues = _ref$timeValues === void 0 ? [] : _ref$timeValues;
  return /*#__PURE__*/_react["default"].createElement(_styledComponents2.CenterFlexbox, null, /*#__PURE__*/_react["default"].createElement("div", {
    className: "time-value"
  }, timeValues[0]), timeValues[1] ? /*#__PURE__*/_react["default"].createElement(TimeDivider, null) : null, timeValues[1] ? /*#__PURE__*/_react["default"].createElement("div", {
    className: "time-value"
  }, timeValues[1]) : null);
};

function FloatingTimeDisplayFactory() {
  var FloatingTimeDisplay = function FloatingTimeDisplay(_ref2) {
    var currentTime = _ref2.currentTime,
        defaultTimeFormat = _ref2.defaultTimeFormat,
        timeFormat = _ref2.timeFormat,
        timezone = _ref2.timezone;

    var _useMemo = (0, _react.useMemo)(function () {
      var groupTime = Array.isArray(currentTime) ? currentTime : [currentTime];
      var hasUserFormat = typeof timeFormat === 'string';
      var currentFormat = (hasUserFormat ? timeFormat : defaultTimeFormat) || _constants.DEFAULT_TIME_FORMAT;
      var dateFunc = (0, _utils.datetimeFormatter)(timezone);

      if (hasUserFormat) {
        // dont split time if user defined it
        return {
          displayDate: groupTime.map(dateFunc(currentFormat)),
          displayTime: []
        };
      }

      return groupTime.reduce(function (accu, curr) {
        var _currentFormat$split = currentFormat.split(' '),
            _currentFormat$split2 = (0, _slicedToArray2["default"])(_currentFormat$split, 2),
            dateFormat = _currentFormat$split2[0],
            datetimeFormat = _currentFormat$split2[1];

        var dateString = dateFunc(dateFormat)(curr);
        var timeString = datetimeFormat ? dateFunc(datetimeFormat)(curr) : null;

        if (!accu.displayDate.includes(dateString)) {
          accu.displayDate.push(dateString);
        }

        if (timeString) {
          accu.displayTime.push(timeString);
        }

        return accu;
      }, {
        displayDate: [],
        displayTime: []
      });
    }, [currentTime, timeFormat, defaultTimeFormat, timezone]),
        displayDate = _useMemo.displayDate,
        displayTime = _useMemo.displayTime;

    var twoGroups = displayDate.length === 2 && displayTime.length === 2;
    var bottomRow = displayTime.length ? displayTime : displayDate.length ? displayDate : null;
    var topRow = displayDate.length && displayTime.length ? displayDate : null;
    return /*#__PURE__*/_react["default"].createElement(StyledTimeDisplayWrapper, null, /*#__PURE__*/_react["default"].createElement(StyledTimeDisplay, {
      className: "animation-control__time-display"
    }, twoGroups ? /*#__PURE__*/_react["default"].createElement(StyledTimeDisplayGroups, null, /*#__PURE__*/_react["default"].createElement(StyledTimeValueGroup, null, /*#__PURE__*/_react["default"].createElement(StyledTimeDisplayTop, null, displayDate[0]), /*#__PURE__*/_react["default"].createElement(StyledTimeDisplayBottom, null, displayTime[0])), /*#__PURE__*/_react["default"].createElement(TimeDivider, null), /*#__PURE__*/_react["default"].createElement(StyledTimeValueGroup, null, /*#__PURE__*/_react["default"].createElement(StyledTimeDisplayTop, null, displayDate[1]), /*#__PURE__*/_react["default"].createElement(StyledTimeDisplayBottom, null, displayTime[1]))) : /*#__PURE__*/_react["default"].createElement(StyledTimeDisplayRows, null, topRow ? /*#__PURE__*/_react["default"].createElement(StyledTimeDisplayTop, null, /*#__PURE__*/_react["default"].createElement(TimeDisplayRow, {
      timeValues: topRow
    })) : null, bottomRow ? /*#__PURE__*/_react["default"].createElement(StyledTimeDisplayBottom, null, /*#__PURE__*/_react["default"].createElement(TimeDisplayRow, {
      timeValues: bottomRow
    })) : null)));
  };

  return FloatingTimeDisplay;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tb24vYW5pbWF0aW9uLWNvbnRyb2wvZmxvYXRpbmctdGltZS1kaXNwbGF5LnRzeCJdLCJuYW1lcyI6WyJTdHlsZWRUaW1lRGlzcGxheVdyYXBwZXIiLCJzdHlsZWQiLCJkaXYiLCJhdHRycyIsImNsYXNzTmFtZSIsInByb3BzIiwidGhlbWUiLCJib3R0b21QYW5lbEdhcCIsImJvdHRvbUlubmVyUGRTaWRlIiwiU3R5bGVkVGltZURpc3BsYXkiLCJwYW5lbEJhY2tncm91bmQiLCJ0aW1lRGlzcGxheUJvcmRlclJhZGl1cyIsInRpdGxlVGV4dENvbG9yIiwidGltZURpc3BsYXlIZWlnaHQiLCJ0aW1lRGlzcGxheU1pbldpZHRoIiwidGltZURpc3BsYXlPcGFjaXR5IiwidGltZURpc3BsYXlQYWRkaW5nIiwiU3R5bGVkVGltZURpc3BsYXlHcm91cHMiLCJTdHlsZWRUaW1lRGlzcGxheVJvd3MiLCJTdHlsZWRUaW1lRGlzcGxheVRvcCIsInRleHRDb2xvciIsIlN0eWxlZFRpbWVEaXNwbGF5Qm90dG9tIiwiU3R5bGVkVGltZVZhbHVlR3JvdXAiLCJTdHlsZWRIb3Jpem9udGFsQmFyIiwiVGltZURpdmlkZXIiLCJUaW1lRGlzcGxheVJvdyIsInRpbWVWYWx1ZXMiLCJGbG9hdGluZ1RpbWVEaXNwbGF5RmFjdG9yeSIsIkZsb2F0aW5nVGltZURpc3BsYXkiLCJjdXJyZW50VGltZSIsImRlZmF1bHRUaW1lRm9ybWF0IiwidGltZUZvcm1hdCIsInRpbWV6b25lIiwiZ3JvdXBUaW1lIiwiQXJyYXkiLCJpc0FycmF5IiwiaGFzVXNlckZvcm1hdCIsImN1cnJlbnRGb3JtYXQiLCJERUZBVUxUX1RJTUVfRk9STUFUIiwiZGF0ZUZ1bmMiLCJkaXNwbGF5RGF0ZSIsIm1hcCIsImRpc3BsYXlUaW1lIiwicmVkdWNlIiwiYWNjdSIsImN1cnIiLCJzcGxpdCIsImRhdGVGb3JtYXQiLCJkYXRldGltZUZvcm1hdCIsImRhdGVTdHJpbmciLCJ0aW1lU3Ry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QVcsQ0FBQ2MsTUFBWixHQUFxQmQsV0FBckIsR0FBbUMsSUFBeEY7QUFDQSxRQUFNZ0IsTUFBTSxHQUFHaEIsV0FBVyxDQUFDYyxNQUFaLElBQXNCWixXQUFXLENBQUNZLE1BQWxDLEdBQTJDZCxXQUEzQyxHQUF5RCxJQUF4RTtBQUVBLHdCQUNFLGdDQUFDLHdCQUFELHFCQUNFLGdDQUFDLGlCQUFEO0FBQW1CLE1BQUEsU0FBUyxFQUFDO0FBQTdCLE9BQ0dhLFNBQVMsZ0JBQ1IsZ0NBQUMsdUJBQUQscUJBQ0UsZ0NBQUMsb0JBQUQscUJBRUUsZ0NBQUMsb0JBQUQsUUFBdUJiLFdBQVcsQ0FBQyxDQUFELENBQWxDLENBRkYsZUFHRSxnQ0FBQyx1QkFBRCxRQUEwQkUsV0FBVyxDQUFDLENBQUQsQ0FBckMsQ0FIRixDQURGLGVBTUUsZ0NBQUMsV0FBRCxPQU5GLGVBT0UsZ0NBQUMsb0JBQUQscUJBRUUsZ0NBQUMsb0JBQUQsUUFBdUJGLFdBQVcsQ0FBQyxDQUFELENBQWxDLENBRkYsZUFHRSxnQ0FBQyx1QkFBRCxRQUEwQkUsV0FBVyxDQUFDLENBQUQsQ0FBckMsQ0FIRixDQVBGLENBRFEsZ0JBZVIsZ0NBQUMscUJBQUQsUUFDR2MsTUFBTSxnQkFDTCxnQ0FBQyxvQkFBRCxxQkFDRSxnQ0FBQyxjQUFEO0FBQWdCLE1BQUEsVUFBVSxFQUFFQTtBQUE1QixNQURGLENBREssR0FJSCxJQUxOLEVBTUdELFNBQVMsZ0JBQ1IsZ0NBQUMsdUJBQUQscUJBQ0UsZ0NBQUMsY0FBRDtBQUFnQixNQUFBLFVBQVUsRUFBRUE7QUFBNUIsTUFERixDQURRLEdBSU4sSUFWTixDQWhCSixDQURGLENBREY7QUFrQ0QsR0E1RUQ7O0FBOEVBLFNBQU8zQixtQkFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDIyIFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cblxuaW1wb3J0IFJlYWN0LCB7dXNlTWVtb30gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQgY2xhc3NuYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCB7TWludXN9IGZyb20gJy4uL2ljb25zJztcbmltcG9ydCB7REVGQVVMVF9USU1FX0ZPUk1BVH0gZnJvbSAnQGtlcGxlci5nbC9jb25zdGFudHMnO1xuaW1wb3J0IHtDZW50ZXJGbGV4Ym94fSBmcm9tICcuLi8uLi9jb21tb24vc3R5bGVkLWNvbXBvbmVudHMnO1xuaW1wb3J0IHtkYXRldGltZUZvcm1hdHRlcn0gZnJvbSAnQGtlcGxlci5nbC91dGlscyc7XG5cbmNvbnN0IFN0eWxlZFRpbWVEaXNwbGF5V3JhcHBlciA9IHN0eWxlZC5kaXYuYXR0cnMoe1xuICBjbGFzc05hbWU6ICdmbG9hdGluZy10aW1lLWRpc3BsYXknXG59KWBcbiAgYm90dG9tOiAke3Byb3BzID0+IGBjYWxjKDEwMCUgKyAke3Byb3BzLnRoZW1lLmJvdHRvbVBhbmVsR2FwfXB4KWB9O1xuICBkaXNwbGF5OiBmbGV4O1xuICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gIHdpZHRoOiAxMDAlO1xuICBtYXJnaW4tbGVmdDogLSR7cHJvcHMgPT4gcHJvcHMudGhlbWUuYm90dG9tSW5uZXJQZFNpZGV9cHg7XG4gIGp1c3RpZnktY29udGVudDogY2VudGVyO1xuICBwb2ludGVyLWV2ZW50czogbm9uZTsgLyogcHJldmVudCBwYWRkaW5nIGZyb20gYmxvY2tpbmcgaW5wdXQgKi9cbiAgJiA+ICoge1xuICAgIC8qIGFsbCBjaGlsZHJlbiBzaG91bGQgYWxsb3cgaW5wdXQgKi9cbiAgICBwb2ludGVyLWV2ZW50czogYWxsO1xuICB9XG5gO1xuXG5jb25zdCBTdHlsZWRUaW1lRGlzcGxheSA9IHN0eWxlZC5kaXYuYXR0cnMocHJvcHMgPT4gKHtcbiAgY2xhc3NOYW1lOiBjbGFzc25hbWVzKCdmbG9hdGluZy10aW1lLWRpc3BsYXlfX2lubmVyJywgcHJvcHMuY2xhc3NOYW1lKVxufSkpYFxuICBiYWNrZ3JvdW5kLWNvbG9yOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLnBhbmVsQmFja2dyb3VuZH07XG4gIGJvcmRlci1yYWRpdXM6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUudGltZURpc3BsYXlCb3JkZXJSYWRpdXN9cHg7XG4gIGNvbG9yOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLnRpdGxlVGV4dENvbG9yfTtcbiAgZGlzcGxheTogZmxleDtcbiAgaGVpZ2h0OiAke3Byb3BzID0+IHByb3BzLnRoZW1lLnRpbWVEaXNwbGF5SGVpZ2h0fXB4O1xuICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjtcbiAgbWluLXdpZHRoOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLnRpbWVEaXNwbGF5TWluV2lkdGh9cHg7XG4gIG9wYWNpdHk6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUudGltZURpc3BsYXlPcGFjaXR5fTtcbiAgcGFkZGluZzogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS50aW1lRGlzcGxheVBhZGRpbmd9O1xuYDtcblxuY29uc3QgU3R5bGVkVGltZURpc3BsYXlHcm91cHMgPSBzdHlsZWQuZGl2YFxuICBhbGlnbi1pdGVtczogY2VudGVyO1xuICBkaXNwbGF5OiBmbGV4O1xuICBmbGV4LWRpcmVjdGlvbjogcm93O1xuYDtcblxuY29uc3QgU3R5bGVkVGltZURpc3BsYXlSb3dzID0gc3R5bGVkLmRpdmBcbiAgZGlzcGxheTogZmxleDtcbiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjtcbiAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7XG5gO1xuXG5jb25zdCBTdHlsZWRUaW1lRGlzcGxheVRvcCA9IHN0eWxlZC5kaXYuYXR0cnMoe1xuICBjbGFzc05hbWU6ICdhbmltYXRpb24tY29udHJvbF9fdGltZS1kaXNwbGF5X190b3AnXG59KWBcbiAgY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUudGV4dENvbG9yfTtcbiAgZGlzcGxheTogZmxleDtcbiAgZm9udC1zaXplOiAxMnB4O1xuICBmb250LXdlaWdodDogNTAwO1xuICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjtcbmA7XG5cbmNvbnN0IFN0eWxlZFRpbWVEaXNwbGF5Qm90dG9tID0gc3R5bGVkLmRpdi5hdHRycyh7XG4gIGNsYXNzTmFtZTogJ2FuaW1hdGlvbi1jb250cm9sX190aW1lLWRpc3BsYXlfX2JvdHRvbSdcbn0pYFxuICBjb2xvcjogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS50aXRsZVRleHRDb2xvcn07XG4gIGRpc3BsYXk6IGZsZXg7XG4gIGZvbnQtc2l6ZTogMTRweDtcbiAgZm9udC13ZWlnaHQ6IDUwMDtcbiAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7XG5gO1xuXG5jb25zdCBTdHlsZWRUaW1lVmFsdWVHcm91cCA9IHN0eWxlZC5kaXYuYXR0cnMoe1xuICBjbGFzc05hbWU6ICdhbmltYXRpb24tY29udHJvbF9fdGltZS12YWx1ZS1ncm91cCdcbn0pYFxuICBkaXNwbGF5OiBmbGV4O1xuICBmbGV4LWRpcmVjdGlvbjogY29sdW1uO1xuYDtcblxuY29uc3QgU3R5bGVkSG9yaXpvbnRhbEJhciA9IHN0eWxlZC5kaXYuYXR0cnMoe1xuICBjbGFzc05hbWU6ICdhbmltYXRpb24tY29udHJvbF9faG9yaXpvbnRhbC1iYXInXG59KWBcbiAgbWFyZ2luOiAwIDEycHg7XG5gO1xuXG5jb25zdCBUaW1lRGl2aWRlciA9ICgpID0+IChcbiAgPFN0eWxlZEhvcml6b250YWxCYXI+XG4gICAgPE1pbnVzIGhlaWdodD1cIjEycHhcIiAvPlxuICA8L1N0eWxlZEhvcml6b250YWxCYXI+XG4pO1xuXG5pbnRlcmZhY2UgVGltZURpc3BsYXlSb3dQcm9wcyB7XG4gIHRpbWVWYWx1ZXM/OiBzdHJpbmdbXTtcbn1cblxuY29uc3QgVGltZURpc3BsYXlSb3cgPSAoe3RpbWVWYWx1ZXMgPSBbXX06IFRpbWVEaXNwbGF5Um93UHJvcHMpID0+IChcbiAgPENlbnRlckZsZXhib3g+XG4gICAgPGRpdiBjbGFzc05hbWU9XCJ0aW1lLXZhbHVlXCI+e3RpbWVWYWx1ZXNbMF19PC9kaXY+XG4gICAge3RpbWVWYWx1ZXNbMV0gPyA8VGltZURpdmlkZXIgLz4gOiBudWxsfVxuICAgIHt0aW1lVmFsdWVzWzFdID8gPGRpdiBjbGFzc05hbWU9XCJ0aW1lLXZhbHVlXCI+e3RpbWVWYWx1ZXNbMV19PC9kaXY+IDogbnVsbH1cbiAgPC9DZW50ZXJGbGV4Ym94PlxuKTtcblxuaW50ZXJmYWNlIEZsb2F0aW5nVGltZURpc3BsYXlQcm9wcyB7XG4gIGN1cnJlbnRUaW1lOiBudW1iZXIgfCBudW1iZXJbXTtcbiAgZGVmYXVsdFRpbWVGb3JtYXQ/OiBzdHJpbmcgfCBudWxsO1xuICB0aW1lRm9ybWF0Pzogc3RyaW5nIHwgbnVsbDtcbiAgdGltZXpvbmU/OiBzdHJpbmcgfCBudWxsO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBGbG9hdGluZ1RpbWVEaXNwbGF5RmFjdG9yeSgpIHtcbiAgY29uc3QgRmxvYXRpbmdUaW1lRGlzcGxheSA9ICh7XG4gICAgY3VycmVudFRpbWUsXG4gICAgZGVmYXVsdFRpbWVGb3JtYXQsXG4gICAgdGltZUZvcm1hdCxcbiAgICB0aW1lem9uZVxuICB9OiBGbG9hdGluZ1RpbWVEaXNwbGF5UHJvcHMpID0+IHtcbiAgICBjb25zdCB7ZGlzcGxheURhdGUsIGRpc3BsYXlUaW1lfSA9IHVzZU1lbW8oKCkgPT4ge1xuICAgICAgY29uc3QgZ3JvdXBUaW1lID0gQXJyYXkuaXNBcnJheShjdXJyZW50VGltZSkgPyBjdXJyZW50VGltZSA6IFtjdXJyZW50VGltZV07XG4gICAgICBjb25zdCBoYXNVc2VyRm9ybWF0ID0gdHlwZW9mIHRpbWVGb3JtYXQgPT09ICdzdHJpbmcnO1xuICAgICAgY29uc3QgY3VycmVudEZvcm1hdCA9IChoYXNVc2VyRm9ybWF0ID8gdGltZUZvcm1hdCA6IGRlZmF1bHRUaW1lRm9ybWF0KSB8fCBERUZBVUxUX1RJTUVfRk9STUFUO1xuICAgICAgY29uc3QgZGF0ZUZ1bmMgPSBkYXRldGltZUZvcm1hdHRlcih0aW1lem9uZSk7XG5cbiAgICAgIGlmIChoYXNVc2VyRm9ybWF0KSB7XG4gICAgICAgIC8vIGRvbnQgc3BsaXQgdGltZSBpZiB1c2VyIGRlZmluZWQgaXRcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBkaXNwbGF5RGF0ZTogZ3JvdXBUaW1lLm1hcChkYXRlRnVuYyhjdXJyZW50Rm9ybWF0KSksXG4gICAgICAgICAgZGlzcGxheVRpbWU6IFtdXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgICByZXR1cm4gZ3JvdXBUaW1lLnJlZHVjZTx7ZGlzcGxheURhdGU6IHN0cmluZ1tdOyBkaXNwbGF5VGltZTogc3RyaW5nW119PihcbiAgICAgICAgKGFjY3UsIGN1cnIpID0+IHtcbiAgICAgICAgICBjb25zdCBbZGF0ZUZvcm1hdCwgZGF0ZXRpbWVGb3JtYXRdID0gY3VycmVudEZvcm1hdC5zcGxpdCgnICcpO1xuICAgICAgICAgIGNvbnN0IGRhdGVTdHJpbmcgPSBkYXRlRnVuYyhkYXRlRm9ybWF0KShjdXJyKTtcbiAgICAgICAgICBjb25zdCB0aW1lU3RyaW5nID0gZGF0ZXRpbWVGb3JtYXQgPyBkYXRlRnVuYyhkYXRldGltZUZvcm1hdCkoY3VycikgOiBudWxsO1xuXG4gICAgICAgICAgaWYgKCFhY2N1LmRpc3BsYXlEYXRlLmluY2x1ZGVzKGRhdGVTdHJpbmcpKSB7XG4gICAgICAgICAgICBhY2N1LmRpc3BsYXlEYXRlLnB1c2goZGF0ZVN0cmluZyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh0aW1lU3RyaW5nKSB7XG4gICAgICAgICAgICBhY2N1LmRpc3BsYXlUaW1lLnB1c2godGltZVN0cmluZyk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIGFjY3U7XG4gICAgICAgIH0sXG4gICAgICAgIHtkaXNwbGF5RGF0ZTogW10sIGRpc3BsYXlUaW1lOiBbXX1cbiAgICAgICk7XG4gICAgfSwgW2N1cnJlbnRUaW1lLCB0aW1lRm9ybWF0LCBkZWZhdWx0VGltZUZvcm1hdCwgdGltZXpvbmVdKTtcblxuICAgIGNvbnN0IHR3b0dyb3VwcyA9IGRpc3BsYXlEYXRlLmxlbmd0aCA9PT0gMiAmJiBkaXNwbGF5VGltZS5sZW5ndGggPT09IDI7XG4gICAgY29uc3QgYm90dG9tUm93ID0gZGlzcGxheVRpbWUubGVuZ3RoID8gZGlzcGxheVRpbWUgOiBkaXNwbGF5RGF0ZS5sZW5ndGggPyBkaXNwbGF5RGF0ZSA6IG51bGw7XG4gICAgY29uc3QgdG9wUm93ID0gZGlzcGxheURhdGUubGVuZ3RoICYmIGRpc3BsYXlUaW1lLmxlbmd0aCA/IGRpc3BsYXlEYXRlIDogbnVsbDtcblxuICAgIHJldHVybiAoXG4gICAgICA8U3R5bGVkVGltZURpc3BsYXlXcmFwcGVyPlxuICAgICAgICA8U3R5bGVkVGltZURpc3BsYXkgY2xhc3NOYW1lPVwiYW5pbWF0aW9uLWNvbnRyb2xfX3RpbWUtZGlzcGxheVwiPlxuICAgICAgICAgIHt0d29Hcm91cHMgPyAoXG4gICAgICAgICAgICA8U3R5bGVkVGltZURpc3BsYXlHcm91cHM+XG4gICAgICAgICAgICAgIDxTdHlsZWRUaW1lVmFsdWVHcm91cD5cbiAgICAgICAgICAgICAgICB7LyogVGltZSBTdGFydCAqL31cbiAgICAgICAgICAgICAgICA8U3R5bGVkVGltZURpc3BsYXlUb3A+e2Rpc3BsYXlEYXRlWzBdfTwvU3R5bGVkVGltZURpc3BsYXlUb3A+XG4gICAgICAgICAgICAgICAgPFN0eWxlZFRpbWVEaXNwbGF5Qm90dG9tPntkaXNwbGF5VGltZVswXX08L1N0eWxlZFRpbWVEaXNwbGF5Qm90dG9tPlxuICAgICAgICAgICAgICA8L1N0eWxlZFRpbWVWYWx1ZUdyb3VwPlxuICAgICAgICAgICAgICA8VGltZURpdmlkZXIgLz5cbiAgICAgICAgICAgICAgPFN0eWxlZFRpbWVWYWx1ZUdyb3VwPlxuICAgICAgICAgICAgICAgIHsvKiBUaW1lIEVuZCAqL31cbiAgICAgICAgICAgICAgICA8U3R5bGVkVGltZURpc3BsYXlUb3A+e2Rpc3BsYXlEYXRlWzFdfTwvU3R5bGVkVGltZURpc3BsYXlUb3A+XG4gICAgICAgICAgICAgICAgPFN0eWxlZFRpbWVEaXNwbGF5Qm90dG9tPntkaXNwbGF5VGltZVsxXX08L1N0eWxlZFRpbWVEaXNwbGF5Qm90dG9tPlxuICAgICAgICAgICAgICA8L1N0eWxlZFRpbWVWYWx1ZUdyb3VwPlxuICAgICAgICAgICAgPC9TdHlsZWRUaW1lRGlzcGxheUdyb3Vwcz5cbiAgICAgICAgICApIDogKFxuICAgICAgICAgICAgPFN0eWxlZFRpbWVEaXNwbGF5Um93cz5cbiAgICAgICAgICAgICAge3RvcFJvdyA/IChcbiAgICAgICAgICAgICAgICA8U3R5bGVkVGltZURpc3BsYXlUb3A+XG4gICAgICAgICAgICAgICAgICA8VGltZURpc3BsYXlSb3cgdGltZVZhbHVlcz17dG9wUm93fSAvPlxuICAgICAgICAgICAgICAgIDwvU3R5bGVkVGltZURpc3BsYXlUb3A+XG4gICAgICAgICAgICAgICkgOiBudWxsfVxuICAgICAgICAgICAgICB7Ym90dG9tUm93ID8gKFxuICAgICAgICAgICAgICAgIDxTdHlsZWRUaW1lRGlzcGxheUJvdHRvbT5cbiAgICAgICAgICAgICAgICAgIDxUaW1lRGlzcGxheVJvdyB0aW1lVmFsdWVzPXtib3R0b21Sb3d9IC8+XG4gICAgICAgICAgICAgICAgPC9TdHlsZWRUaW1lRGlzcGxheUJvdHRvbT5cbiAgICAgICAgICAgICAgKSA6IG51bGx9XG4gICAgICAgICAgICA8L1N0eWxlZFRpbWVEaXNwbGF5Um93cz5cbiAgICAgICAgICApfVxuICAgICAgICA8L1N0eWxlZFRpbWVEaXNwbGF5PlxuICAgICAgPC9TdHlsZWRUaW1lRGlzcGxheVdyYXBwZXI+XG4gICAgKTtcbiAgfTtcblxuICByZXR1cm4gRmxvYXRpbmdUaW1lRGlzcGxheTtcbn1cbiJdfQ==