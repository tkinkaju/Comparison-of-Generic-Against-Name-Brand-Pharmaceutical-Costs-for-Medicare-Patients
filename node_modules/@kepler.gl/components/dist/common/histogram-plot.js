// Copyright (c) 2022 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _d3Scale = require("d3-scale");

var _d3Array = require("d3-array");

var _d3Color = require("d3-color");

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _templateObject;

var histogramStyle = {
  highlightW: 0.7,
  unHighlightedW: 0.4
};

var HistogramWrapper = _styledComponents["default"].svg(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  overflow: visible;\n"])));

var BarUnmemoized = _styledComponents["default"].rect(function (_ref) {
  var theme = _ref.theme,
      inRange = _ref.inRange,
      color = _ref.color;
  return "\n  ".concat(inRange ? "fill: ".concat(color !== null && color !== void 0 ? color : theme.histogramFillInRange, ";") : "fill: ".concat(color ? (0, _d3Color.hcl)(color).darker() : theme.histogramFillOutRange, ";"), "\n");
});

var Bar = /*#__PURE__*/_react["default"].memo(BarUnmemoized);

Bar.displayName = 'Bar';

function HistogramPlotFactory() {
  var HistogramPlot = function HistogramPlot(_ref2) {
    var width = _ref2.width,
        height = _ref2.height,
        margin = _ref2.margin,
        isRanged = _ref2.isRanged,
        histogram = _ref2.histogram,
        value = _ref2.value,
        brushComponent = _ref2.brushComponent;

    var undefinedToZero = function undefinedToZero(x) {
      return x ? x : 0;
    };

    var domain = (0, _react.useMemo)(function () {
      return [histogram[0].x0, histogram[histogram.length - 1].x1].map(function (item) {
        return undefinedToZero(item);
      });
    }, [histogram]);
    var dataId = Object.keys(histogram[0]).filter(function (k) {
      return k !== 'x0' && k !== 'x1';
    })[0]; // use 1st for now

    var getValue = (0, _react.useMemo)(function () {
      return function (d) {
        return d[dataId];
      };
    }, [dataId]);
    var x = (0, _react.useMemo)(function () {
      return (0, _d3Scale.scaleLinear)().domain(domain).range([0, width]);
    }, [domain, width]);
    var y = (0, _react.useMemo)(function () {
      return (0, _d3Scale.scaleLinear)().domain([0, Number((0, _d3Array.max)(histogram, getValue))]).range([0, height]);
    }, [histogram, height, getValue]);
    var barWidth = width / histogram.length;
    return /*#__PURE__*/_react["default"].createElement(HistogramWrapper, {
      width: width,
      height: height,
      style: {
        marginTop: "".concat(margin.top, "px")
      }
    }, /*#__PURE__*/_react["default"].createElement("g", {
      className: "histogram-bars"
    }, histogram.map(function (bar) {
      var inRange = undefinedToZero(bar.x1) <= value[1] && undefinedToZero(bar.x0) >= value[0];
      var wRatio = inRange ? histogramStyle.highlightW : histogramStyle.unHighlightedW;
      return /*#__PURE__*/_react["default"].createElement(Bar, {
        inRange: inRange,
        key: bar.x0,
        height: y(getValue(bar)),
        width: barWidth * wRatio,
        x: x(undefinedToZero(bar.x0)) + barWidth * (1 - wRatio) / 2,
        rx: 1,
        ry: 1,
        y: height - y(getValue(bar))
      });
    })), /*#__PURE__*/_react["default"].createElement("g", {
      transform: "translate(".concat(isRanged ? 0 : barWidth / 2, ", 0)")
    }, brushComponent));
  };

  var EmpptyOrPlot = function EmpptyOrPlot(props) {
    return !props.histogram || !props.histogram.length ? null : /*#__PURE__*/_react["default"].createElement(HistogramPlot, props);
  };

  return EmpptyOrPlot;
}

var _default = HistogramPlotFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tb24vaGlzdG9ncmFtLXBsb3QudHN4Il0sIm5hbWVzIjpbImhpc3RvZ3JhbVN0eWxlIiwiaGlnaGxpZ2h0VyIsInVuSGlnaGxpZ2h0ZWRXIiwiSGlzdG9ncmFtV3JhcHBlciIsInN0eWxlZCIsInN2ZyIsIkJhclVubWVtb2l6ZWQiLCJyZWN0IiwidGhlbWUiLCJpblJhbmdlIiwiY29sb3IiLCJoaXN0b2dyYW1GaWxsSW5SYW5nZSIsImRhcmtlciIsImhpc3RvZ3JhbUZpbGxPdXRSYW5nZSIsIkJhciIsIlJlYWN0IiwibWVtbyIsImRpc3BsYXlOYW1lIiwiSGlzdG9ncmFtUGxvdEZhY3RvcnkiLCJIaXN0b2dyYW1QbG90Iiwid2lkdGgiLCJoZWlnaHQiLCJtYXJnaW4iLCJpc1JhbmdlZCIsImhpc3RvZ3JhbSIsInZhbHVlIiwiYnJ1c2hDb21wb25lbnQiLCJ1bmRlZmluZWRUb1plcm8iLCJ4IiwiZG9tYWluIiwieDAiLCJsZW5ndGgiLCJ4MSIsIm1hcCIsIml0ZW0iLCJkYXRhSWQiLCJPYmplY3QiLCJrZXlzIiwiZmlsdGVyIiwiayIsImdldFZhbHVlIiwiZCIsInJhbmdlIiwieSIsIk51bWJlciIsImJhcldpZHRoIiwibWFyZ2luVG9wIiwidG9wIiwiYmFyIiwid1JhdGlvIiwiRW1wcHR5T3JQbG90IiwicHJvcHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFvQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFHQSxJQUFNQSxjQUFjLEdBQUc7QUFDckJDLEVBQUFBLFVBQVUsRUFBRSxHQURTO0FBRXJCQyxFQUFBQSxjQUFjLEVBQUU7QUFGSyxDQUF2Qjs7QUFLQSxJQUFNQyxnQkFBZ0IsR0FBR0MsNkJBQU9DLEdBQVYsOEdBQXRCOztBQU9BLElBQU1DLGFBQWEsR0FBR0YsNkJBQU9HLElBQVAsQ0FDcEI7QUFBQSxNQUFFQyxLQUFGLFFBQUVBLEtBQUY7QUFBQSxNQUFTQyxPQUFULFFBQVNBLE9BQVQ7QUFBQSxNQUFr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QWZBLFlBQWUsQ0FBQUMsS0FBSztBQUFBLFdBQ3hCLENBQUNBLEtBQUssQ0FBQzNCLFNBQVAsSUFBb0IsQ0FBQzJCLEtBQUssQ0FBQzNCLFNBQU4sQ0FBZ0JPLE1BQXJDLEdBQThDLElBQTlDLGdCQUFxRCxnQ0FBQyxhQUFELEVBQW1Cb0IsS0FBbkIsQ0FEN0I7QUFBQSxHQUExQjs7QUFHQSxTQUFPRCxZQUFQO0FBQ0Q7O2VBQ2NoQyxvQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgMjAyMiBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbmltcG9ydCBSZWFjdCwge1JlYWN0RWxlbWVudCwgdXNlTWVtb30gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHtzY2FsZUxpbmVhcn0gZnJvbSAnZDMtc2NhbGUnO1xuaW1wb3J0IHttYXh9IGZyb20gJ2QzLWFycmF5JztcbmltcG9ydCB7aGNsfSBmcm9tICdkMy1jb2xvcic7XG5pbXBvcnQgc3R5bGVkIGZyb20gJ3N0eWxlZC1jb21wb25lbnRzJztcbmltcG9ydCB7SGlzdG9ncmFtQmlufSBmcm9tICdAa2VwbGVyLmdsL3R5cGVzJztcblxuY29uc3QgaGlzdG9ncmFtU3R5bGUgPSB7XG4gIGhpZ2hsaWdodFc6IDAuNyxcbiAgdW5IaWdobGlnaHRlZFc6IDAuNFxufTtcblxuY29uc3QgSGlzdG9ncmFtV3JhcHBlciA9IHN0eWxlZC5zdmdgXG4gIG92ZXJmbG93OiB2aXNpYmxlO1xuYDtcblxudHlwZSBCYXJUeXBlID0ge1xuICBpblJhbmdlOiBib29sZWFuO1xufTtcbmNvbnN0IEJhclVubWVtb2l6ZWQgPSBzdHlsZWQucmVjdDxCYXJUeXBlPihcbiAgKHt0aGVtZSwgaW5SYW5nZSwgY29sb3J9KSA9PiBgXG4gICR7XG4gICAgaW5SYW5nZVxuICAgICAgPyBgZmlsbDogJHtjb2xvciA/PyB0aGVtZS5oaXN0b2dyYW1GaWxsSW5SYW5nZX07YFxuICAgICAgOiBgZmlsbDogJHtjb2xvciA/IGhjbChjb2xvcikuZGFya2VyKCkgOiB0aGVtZS5oaXN0b2dyYW1GaWxsT3V0UmFuZ2V9O2BcbiAgfVxuYFxuKTtcbmNvbnN0IEJhciA9IFJlYWN0Lm1lbW8oQmFyVW5tZW1vaXplZCk7XG5CYXIuZGlzcGxheU5hbWUgPSAnQmFyJztcblxuaW50ZXJmYWNlIEhpc3RvZ3JhbVBsb3RQcm9wcyB7XG4gIHdpZHRoOiBudW1iZXI7XG4gIGhlaWdodDogbnVtYmVyO1xuICBtYXJnaW46IHt0b3A6IG51bWJlcjsgYm90dG9tOiBudW1iZXI7IGxlZnQ6IG51bWJlcjsgcmlnaHQ6IG51bWJlcn07XG4gIGlzUmFuZ2VkPzogYm9vbGVhbjtcbiAgaGlzdG9ncmFtOiBIaXN0b2dyYW1CaW5bXTtcbiAgdmFsdWU6IG51bWJlcltdO1xuICBicnVzaENvbXBvbmVudD86IFJlYWN0RWxlbWVudDtcbn1cblxuZnVuY3Rpb24gSGlzdG9ncmFtUGxvdEZhY3RvcnkoKSB7XG4gIGNvbnN0IEhpc3RvZ3JhbVBsb3QgPSAoe1xuICAgIHdpZHRoLFxuICAgIGhlaWdodCxcbiAgICBtYXJnaW4sXG4gICAgaXNSYW5nZWQsXG4gICAgaGlzdG9ncmFtLFxuICAgIHZhbHVlLFxuICAgIGJydXNoQ29tcG9uZW50XG4gIH06IEhpc3RvZ3JhbVBsb3RQcm9wcykgPT4ge1xuICAgIGNvbnN0IHVuZGVmaW5lZFRvWmVybyA9ICh4OiBudW1iZXIgfCB1bmRlZmluZWQpID0+ICh4ID8geCA6IDApO1xuICAgIGNvbnN0IGRvbWFpbiA9IHVzZU1lbW8oXG4gICAgICAoKSA9PlxuICAgICAgICBbaGlzdG9ncmFtWzBdLngwLCBoaXN0b2dyYW1baGlzdG9ncmFtLmxlbmd0aCAtIDFdLngxXS5tYXAoaXRlbSA9PiB1bmRlZmluZWRUb1plcm8oaXRlbSkpLFxuICAgICAgW2hpc3RvZ3JhbV1cbiAgICApO1xuICAgIGNvbnN0IGRhdGFJZCA9IE9iamVjdC5rZXlzKGhpc3RvZ3JhbVswXSkuZmlsdGVyKGsgPT4gayAhPT0gJ3gwJyAmJiBrICE9PSAneDEnKVswXTtcblxuICAgIC8vIHVzZSAxc3QgZm9yIG5vd1xuICAgIGNvbnN0IGdldFZhbHVlID0gdXNlTWVtbygoKSA9PiBkID0+IGRbZGF0YUlkXSwgW2RhdGFJZF0pO1xuXG4gICAgY29uc3QgeCA9IHVzZU1lbW8oXG4gICAgICAoKSA9PlxuICAgICAgICBzY2FsZUxpbmVhcigpXG4gICAgICAgICAgLmRvbWFpbihkb21haW4pXG4gICAgICAgICAgLnJhbmdlKFswLCB3aWR0aF0pLFxuICAgICAgW2RvbWFpbiwgd2lkdGhdXG4gICAgKTtcblxuICAgIGNvbnN0IHkgPSB1c2VNZW1vKFxuICAgICAgKCkgPT5cbiAgICAgICAgc2NhbGVMaW5lYXIoKVxuICAgICAgICAgIC5kb21haW4oWzAsIE51bWJlcihtYXgoaGlzdG9ncmFtLCBnZXRWYWx1ZSkpXSlcbiAgICAgICAgICAucmFuZ2UoWzAsIGhlaWdodF0pLFxuICAgICAgW2hpc3RvZ3JhbSwgaGVpZ2h0LCBnZXRWYWx1ZV1cbiAgICApO1xuXG4gICAgY29uc3QgYmFyV2lkdGggPSB3aWR0aCAvIGhpc3RvZ3JhbS5sZW5ndGg7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPEhpc3RvZ3JhbVdyYXBwZXIgd2lkdGg9e3dpZHRofSBoZWlnaHQ9e2hlaWdodH0gc3R5bGU9e3ttYXJnaW5Ub3A6IGAke21hcmdpbi50b3B9cHhgfX0+XG4gICAgICAgIDxnIGNsYXNzTmFtZT1cImhpc3RvZ3JhbS1iYXJzXCI+XG4gICAgICAgICAge2hpc3RvZ3JhbS5tYXAoYmFyID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGluUmFuZ2UgPVxuICAgICAgICAgICAgICB1bmRlZmluZWRUb1plcm8oYmFyLngxKSA8PSB2YWx1ZVsxXSAmJiB1bmRlZmluZWRUb1plcm8oYmFyLngwKSA+PSB2YWx1ZVswXTtcbiAgICAgICAgICAgIGNvbnN0IHdSYXRpbyA9IGluUmFuZ2UgPyBoaXN0b2dyYW1TdHlsZS5oaWdobGlnaHRXIDogaGlzdG9ncmFtU3R5bGUudW5IaWdobGlnaHRlZFc7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICA8QmFyXG4gICAgICAgICAgICAgICAgaW5SYW5nZT17aW5SYW5nZX1cbiAgICAgICAgICAgICAgICBrZXk9e2Jhci54MH1cbiAgICAgICAgICAgICAgICBoZWlnaHQ9e3koZ2V0VmFsdWUoYmFyKSl9XG4gICAgICAgICAgICAgICAgd2lkdGg9e2JhcldpZHRoICogd1JhdGlvfVxuICAgICAgICAgICAgICAgIHg9e3godW5kZWZpbmVkVG9aZXJvKGJhci54MCkpICsgKGJhcldpZHRoICogKDEgLSB3UmF0aW8pKSAvIDJ9XG4gICAgICAgICAgICAgICAgcng9ezF9XG4gICAgICAgICAgICAgICAgcnk9ezF9XG4gICAgICAgICAgICAgICAgeT17aGVpZ2h0IC0geShnZXRWYWx1ZShiYXIpKX1cbiAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSl9XG4gICAgICAgIDwvZz5cbiAgICAgICAgPGcgdHJhbnNmb3JtPXtgdHJhbnNsYXRlKCR7aXNSYW5nZWQgPyAwIDogYmFyV2lkdGggLyAyfSwgMClgfT57YnJ1c2hDb21wb25lbnR9PC9nPlxuICAgICAgPC9IaXN0b2dyYW1XcmFwcGVyPlxuICAgICk7XG4gIH07XG5cbiAgY29uc3QgRW1wcHR5T3JQbG90ID0gcHJvcHMgPT5cbiAgICAhcHJvcHMuaGlzdG9ncmFtIHx8ICFwcm9wcy5oaXN0b2dyYW0ubGVuZ3RoID8gbnVsbCA6IDxIaXN0b2dyYW1QbG90IHsuLi5wcm9wc30gLz47XG5cbiAgcmV0dXJuIEVtcHB0eU9yUGxvdDtcbn1cbmV4cG9ydCBkZWZhdWx0IEhpc3RvZ3JhbVBsb3RGYWN0b3J5O1xuIl19