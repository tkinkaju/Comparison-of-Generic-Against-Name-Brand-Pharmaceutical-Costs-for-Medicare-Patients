// Copyright (c) 2022 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getTickFormat = getTickFormat;
exports.getXAxis = getXAxis;
exports.updateAxis = updateAxis;
exports["default"] = void 0;

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _momentTimezone = _interopRequireDefault(require("moment-timezone"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _d3Scale = require("d3-scale");

var _d3Selection = require("d3-selection");

var _d3Axis = require("d3-axis");

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _utils = require("@kepler.gl/utils");

var _templateObject;

var MIN_TICK_WIDTH_LARGE = 80;
var MIN_TICK_WIDTH_SMALL = 50;
var HEIGHT = 30;

var TimeSliderContainer = _styledComponents["default"].svg(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  pointer-events: none;\n  position: absolute;\n  top: 0;\n  overflow: visible;\n  margin-top: 6px;\n\n  .axis text {\n    font-size: ", ";\n    fill: ", ";\n  }\n\n  .axis line,\n  .axis path {\n    fill: none;\n    stroke: ", ";\n    shape-rendering: crispEdges;\n    stroke-width: 2;\n  }\n\n  .axis .domain {\n    display: none;\n  }\n\n  .value {\n    fill: ", ";\n    font-size: ", ";\n\n    &.start {\n      text-anchor: start;\n    }\n\n    &.end {\n      text-anchor: end;\n    }\n  }\n"])), function (props) {
  return props.theme.axisFontSize;
}, function (props) {
  return props.theme.axisFontColor;
}, function (props) {
  return props.theme.sliderBarBgd;
}, function (props) {
  return props.theme.axisFontColor;
}, function (props) {
  return props.theme.axisFontSize;
});

var TICK_FORMATS = {
  millisecond: '.SSS',
  second: ':ss',
  minute: 'HH:ss',
  hour: 'HH A',
  day: 'ddd DD',
  week: 'MMM DD',
  month: 'MMM',
  year: 'YYYY'
}; // timezone sensitive tick formatter based on moment
// adapted based on d3 time scale tick format https://github.com/d3/d3-scale/blob/master/src/time.js#L59

function getTickFormat(timezone) {
  // date is js date object
  var toMoment = timezone ? function (date) {
    return (0, _momentTimezone["default"])(date).tz(timezone);
  } : _momentTimezone["default"];
  var formatter = (0, _utils.datetimeFormatter)(timezone);
  return function (date) {
    return (toMoment(date).startOf('second') < date ? formatter(TICK_FORMATS.millisecond) : toMoment(date).startOf('minute') < date ? formatter(TICK_FORMATS.second) : toMoment(date).startOf('hour') < date ? formatter(TICK_FORMATS.minute) : toMoment(date).startOf('day') < date ? formatter(TICK_FORMATS.hour) : toMoment(date).startOf('month') < date ? toMoment(date).startOf('isoWeek') < date ? formatter(TICK_FORMATS.day) : formatter(TICK_FORMATS.week) : toMoment(date).startOf('year') < date ? formatter(TICK_FORMATS.month) : formatter(TICK_FORMATS.year))(date);
  };
} // create a helper function so we can test it


function getXAxis(domain, width, isEnlarged, timezone) {
  if (!Array.isArray(domain) || !domain.every(Number.isFinite)) {
    return null;
  }

  var scale = (0, _d3Scale.scaleUtc)().domain(domain).range([0, width]);

  if (!scale) {
    return null;
  }

  var ticks = Math.floor(width / (isEnlarged ? MIN_TICK_WIDTH_LARGE : MIN_TICK_WIDTH_SMALL));
  var tickFormat = timezone ? getTickFormat(timezone) : null;
  var xAxis = (0, _d3Axis.axisBottom)(scale).ticks(ticks).tickSize(0).tickPadding(12);

  if (tickFormat) {
    xAxis.tickFormat(tickFormat);
  }

  return xAxis;
}

function updateAxis(xAxisRef, xAxis) {
  if (!xAxis) {
    return;
  }

  (0, _d3Selection.select)(xAxisRef.current).call(xAxis);
}

function TimeSliderMarkerFactory() {
  var TimeSliderMarker = function TimeSliderMarker(_ref) {
    var width = _ref.width,
        domain = _ref.domain,
        _ref$isEnlarged = _ref.isEnlarged,
        isEnlarged = _ref$isEnlarged === void 0 ? true : _ref$isEnlarged,
        _ref$height = _ref.height,
        height = _ref$height === void 0 ? HEIGHT : _ref$height,
        timezone = _ref.timezone;
    var xAxisRef = (0, _react.useRef)(null);
    var xAxis = (0, _react.useMemo)(function () {
      return getXAxis(domain, width, isEnlarged, timezone);
    }, [domain, width, isEnlarged, timezone]);
    (0, _react.useEffect)(function () {
      updateAxis(xAxisRef, xAxis);
    }, [xAxisRef, xAxis]);
    return /*#__PURE__*/_react["default"].createElement(TimeSliderContainer, {
      className: "time-slider-marker",
      width: width,
      height: height
    }, /*#__PURE__*/_react["default"].createElement("g", {
      className: "x axis",
      ref: xAxisRef,
      transform: "translate(0, 0)"
    }));
  };

  TimeSliderMarker.propTypes = {
    domain: _propTypes["default"].arrayOf(_propTypes["default"].any).isRequired,
    width: _propTypes["default"].number.isRequired
  };
  return /*#__PURE__*/_react["default"].memo(TimeSliderMarker);
}

var _default = TimeSliderMarkerFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tb24vdGltZS1zbGlkZXItbWFya2VyLnRzeCJdLCJuYW1lcyI6WyJNSU5fVElDS19XSURUSF9MQVJHRSIsIk1JTl9USUNLX1dJRFRIX1NNQUxMIiwiSEVJR0hUIiwiVGltZVNsaWRlckNvbnRhaW5lciIsInN0eWxlZCIsInN2ZyIsInByb3BzIiwidGhlbWUiLCJheGlzRm9udFNpemUiLCJheGlzRm9udENvbG9yIiwic2xpZGVyQmFyQmdkIiwiVElDS19GT1JNQVRTIiwibWlsbGlzZWNvbmQiLCJzZWNvbmQiLCJtaW51dGUiLCJob3VyIiwiZGF5Iiwid2VlayIsIm1vbnRoIiwieWVhciIsImdldFRpY2tGb3JtYXQiLCJ0aW1lem9uZSIsInRvTW9tZW50IiwiZGF0ZSIsInR6IiwibW9tZW50IiwiZm9ybWF0dGVyIiwic3RhcnRPZiIsImdldFhBeGlzIiwiZG9tYWluIiwid2lkdGgiLCJpc0VubGFyZ2VkIiwiQXJyYXkiLCJpc0FycmF5IiwiZXZlcnkiLCJOdW1iZXIiLCJpc0Zpbml0ZSIsInNjYWxlIiwicmFuZ2UiLCJ0aWNrcyIsIk1hdGgiLCJmbG9vciIsInRpY2tGb3JtYXQiLCJ4QXhpcyIsInRpY2tTaXplIiwidGlja1BhZGRpbmciLCJ1cGRhdGVBeGlzIiwieEF4aXNSZWYiLCJjdXJyZW50IiwiY2FsbCIsIlRpbWVTbGlkZXJNYXJrZXJGYWN0b3J5IiwiVGltZVNsaWRlck1hcmtlciIsImhlaWdodCIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsImFycmF5T2YiLCJhbnkiLCJpc1JlcXVpcmVkIiwibnVtYmVyIiwiUmVhY3QiLCJtZW1vIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBb0JBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsSUFBTUEsb0JBQW9CLEdBQUcsRUFBN0I7QUFDQSxJQUFNQyxvQkFBb0IsR0FBRyxFQUE3QjtBQUNBLElBQU1DLE1BQU0sR0FBRyxFQUFm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MkI7QUFBQSxRQUYzQkEsTUFFMkIsNEJBRmxCbEQsTUFFa0I7QUFBQSxRQUQzQm1CLFFBQzJCLFFBRDNCQSxRQUMyQjtBQUMzQixRQUFNMEIsUUFBUSxHQUFHLG1CQUFPLElBQVAsQ0FBakI7QUFDQSxRQUFNSixLQUFLLEdBQUcsb0JBQVE7QUFBQSxhQUFNZixRQUFRLENBQUNDLE1BQUQsRUFBU0MsS0FBVCxFQUFnQkMsVUFBaEIsRUFBNEJWLFFBQTVCLENBQWQ7QUFBQSxLQUFSLEVBQTZELENBQ3pFUSxNQUR5RSxFQUV6RUMsS0FGeUUsRUFHekVDLFVBSHlFLEVBSXpFVixRQUp5RSxDQUE3RCxDQUFkO0FBTUEsMEJBQVUsWUFBTTtBQUNkeUIsTUFBQUEsVUFBVSxDQUFDQyxRQUFELEVBQVdKLEtBQVgsQ0FBVjtBQUNELEtBRkQsRUFFRyxDQUFDSSxRQUFELEVBQVdKLEtBQVgsQ0FGSDtBQUdBLHdCQUNFLGdDQUFDLG1CQUFEO0FBQXFCLE1BQUEsU0FBUyxFQUFDLG9CQUEvQjtBQUFvRCxNQUFBLEtBQUssRUFBRWIsS0FBM0Q7QUFBa0UsTUFBQSxNQUFNLEVBQUVzQjtBQUExRSxvQkFDRTtBQUFHLE1BQUEsU0FBUyxFQUFDLFFBQWI7QUFBc0IsTUFBQSxHQUFHLEVBQUVMLFFBQTNCO0FBQXFDLE1BQUEsU0FBUyxFQUFDO0FBQS9DLE1BREYsQ0FERjtBQUtELEdBdEJEOztBQXdCQUksRUFBQUEsZ0JBQWdCLENBQUNFLFNBQWpCLEdBQTZCO0FBQzNCeEIsSUFBQUEsTUFBTSxFQUFFeUIsc0JBQVVDLE9BQVYsQ0FBa0JELHNCQUFVRSxHQUE1QixFQUFpQ0MsVUFEZDtBQUUzQjNCLElBQUFBLEtBQUssRUFBRXdCLHNCQUFVSSxNQUFWLENBQWlCRDtBQUZHLEdBQTdCO0FBS0Esc0JBQU9FLGtCQUFNQyxJQUFOLENBQVdULGdCQUFYLENBQVA7QUFDRDs7ZUFFY0QsdUIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIDIwMjIgVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuXG5pbXBvcnQgUmVhY3QsIHt1c2VSZWYsIHVzZUVmZmVjdCwgdXNlTWVtb30gZnJvbSAncmVhY3QnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQtdGltZXpvbmUnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCB7TnVtYmVyVmFsdWUsIHNjYWxlVXRjfSBmcm9tICdkMy1zY2FsZSc7XG5pbXBvcnQge3NlbGVjdH0gZnJvbSAnZDMtc2VsZWN0aW9uJztcbmltcG9ydCB7YXhpc0JvdHRvbX0gZnJvbSAnZDMtYXhpcyc7XG5pbXBvcnQgc3R5bGVkIGZyb20gJ3N0eWxlZC1jb21wb25lbnRzJztcbmltcG9ydCB7ZGF0ZXRpbWVGb3JtYXR0ZXJ9IGZyb20gJ0BrZXBsZXIuZ2wvdXRpbHMnO1xuXG5jb25zdCBNSU5fVElDS19XSURUSF9MQVJHRSA9IDgwO1xuY29uc3QgTUlOX1RJQ0tfV0lEVEhfU01BTEwgPSA1MDtcbmNvbnN0IEhFSUdIVCA9IDMwO1xuXG5jb25zdCBUaW1lU2xpZGVyQ29udGFpbmVyID0gc3R5bGVkLnN2Z2BcbiAgcG9pbnRlci1ldmVudHM6IG5vbmU7XG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgdG9wOiAwO1xuICBvdmVyZmxvdzogdmlzaWJsZTtcbiAgbWFyZ2luLXRvcDogNnB4O1xuXG4gIC5heGlzIHRleHQge1xuICAgIGZvbnQtc2l6ZTogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5heGlzRm9udFNpemV9O1xuICAgIGZpbGw6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuYXhpc0ZvbnRDb2xvcn07XG4gIH1cblxuICAuYXhpcyBsaW5lLFxuICAuYXhpcyBwYXRoIHtcbiAgICBmaWxsOiBub25lO1xuICAgIHN0cm9rZTogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5zbGlkZXJCYXJCZ2R9O1xuICAgIHNoYXBlLXJlbmRlcmluZzogY3Jpc3BFZGdlcztcbiAgICBzdHJva2Utd2lkdGg6IDI7XG4gIH1cblxuICAuYXhpcyAuZG9tYWluIHtcbiAgICBkaXNwbGF5OiBub25lO1xuICB9XG5cbiAgLnZhbHVlIHtcbiAgICBmaWxsOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLmF4aXNGb250Q29sb3J9O1xuICAgIGZvbnQtc2l6ZTogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5heGlzRm9udFNpemV9O1xuXG4gICAgJi5zdGFydCB7XG4gICAgICB0ZXh0LWFuY2hvcjogc3RhcnQ7XG4gICAgfVxuXG4gICAgJi5lbmQge1xuICAgICAgdGV4dC1hbmNob3I6IGVuZDtcbiAgICB9XG4gIH1cbmA7XG5cbmNvbnN0IFRJQ0tfRk9STUFUUyA9IHtcbiAgbWlsbGlzZWNvbmQ6ICcuU1NTJyxcbiAgc2Vjb25kOiAnOnNzJyxcbiAgbWludXRlOiAnSEg6c3MnLFxuICBob3VyOiAnSEggQScsXG4gIGRheTogJ2RkZCBERCcsXG4gIHdlZWs6ICdNTU0gREQnLFxuICBtb250aDogJ01NTScsXG4gIHllYXI6ICdZWVlZJ1xufTtcblxuLy8gdGltZXpvbmUgc2Vuc2l0aXZlIHRpY2sgZm9ybWF0dGVyIGJhc2VkIG9uIG1vbWVudFxuLy8gYWRhcHRlZCBiYXNlZCBvbiBkMyB0aW1lIHNjYWxlIHRpY2sgZm9ybWF0IGh0dHBzOi8vZ2l0aHViLmNvbS9kMy9kMy1zY2FsZS9ibG9iL21hc3Rlci9zcmMvdGltZS5qcyNMNTlcbmV4cG9ydCBmdW5jdGlvbiBnZXRUaWNrRm9ybWF0KHRpbWV6b25lOiBzdHJpbmcpIHtcbiAgLy8gZGF0ZSBpcyBqcyBkYXRlIG9iamVjdFxuICBjb25zdCB0b01vbWVudCA9IHRpbWV6b25lID8gZGF0ZSA9PiBtb21lbnQoZGF0ZSkudHoodGltZXpvbmUpIDogbW9tZW50O1xuICBjb25zdCBmb3JtYXR0ZXIgPSBkYXRldGltZUZvcm1hdHRlcih0aW1lem9uZSk7XG5cbiAgcmV0dXJuIGRhdGUgPT5cbiAgICAodG9Nb21lbnQoZGF0ZSkuc3RhcnRPZignc2Vjb25kJykgPCBkYXRlXG4gICAgICA/IGZvcm1hdHRlcihUSUNLX0ZPUk1BVFMubWlsbGlzZWNvbmQpXG4gICAgICA6IHRvTW9tZW50KGRhdGUpLnN0YXJ0T2YoJ21pbnV0ZScpIDwgZGF0ZVxuICAgICAgPyBmb3JtYXR0ZXIoVElDS19GT1JNQVRTLnNlY29uZClcbiAgICAgIDogdG9Nb21lbnQoZGF0ZSkuc3RhcnRPZignaG91cicpIDwgZGF0ZVxuICAgICAgPyBmb3JtYXR0ZXIoVElDS19GT1JNQVRTLm1pbnV0ZSlcbiAgICAgIDogdG9Nb21lbnQoZGF0ZSkuc3RhcnRPZignZGF5JykgPCBkYXRlXG4gICAgICA/IGZvcm1hdHRlcihUSUNLX0ZPUk1BVFMuaG91cilcbiAgICAgIDogdG9Nb21lbnQoZGF0ZSkuc3RhcnRPZignbW9udGgnKSA8IGRhdGVcbiAgICAgID8gdG9Nb21lbnQoZGF0ZSkuc3RhcnRPZignaXNvV2VlaycpIDwgZGF0ZVxuICAgICAgICA/IGZvcm1hdHRlcihUSUNLX0ZPUk1BVFMuZGF5KVxuICAgICAgICA6IGZvcm1hdHRlcihUSUNLX0ZPUk1BVFMud2VlaylcbiAgICAgIDogdG9Nb21lbnQoZGF0ZSkuc3RhcnRPZigneWVhcicpIDwgZGF0ZVxuICAgICAgPyBmb3JtYXR0ZXIoVElDS19GT1JNQVRTLm1vbnRoKVxuICAgICAgOiBmb3JtYXR0ZXIoVElDS19GT1JNQVRTLnllYXIpKShkYXRlKTtcbn1cblxuLy8gY3JlYXRlIGEgaGVscGVyIGZ1bmN0aW9uIHNvIHdlIGNhbiB0ZXN0IGl0XG5leHBvcnQgZnVuY3Rpb24gZ2V0WEF4aXMoXG4gIGRvbWFpbjogRGF0ZVtdIHwgTnVtYmVyVmFsdWVbXSxcbiAgd2lkdGg6IG51bWJlcixcbiAgaXNFbmxhcmdlZDogYm9vbGVhbixcbiAgdGltZXpvbmU6IHN0cmluZ1xuKSB7XG4gIGlmICghQXJyYXkuaXNBcnJheShkb21haW4pIHx8ICFkb21haW4uZXZlcnkoTnVtYmVyLmlzRmluaXRlKSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIGNvbnN0IHNjYWxlID0gc2NhbGVVdGMoKVxuICAgIC5kb21haW4oZG9tYWluKVxuICAgIC5yYW5nZShbMCwgd2lkdGhdKTtcbiAgaWYgKCFzY2FsZSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgY29uc3QgdGlja3MgPSBNYXRoLmZsb29yKHdpZHRoIC8gKGlzRW5sYXJnZWQgPyBNSU5fVElDS19XSURUSF9MQVJHRSA6IE1JTl9USUNLX1dJRFRIX1NNQUxMKSk7XG4gIGNvbnN0IHRpY2tGb3JtYXQgPSB0aW1lem9uZSA/IGdldFRpY2tGb3JtYXQodGltZXpvbmUpIDogbnVsbDtcbiAgY29uc3QgeEF4aXMgPSBheGlzQm90dG9tKHNjYWxlKVxuICAgIC50aWNrcyh0aWNrcylcbiAgICAudGlja1NpemUoMClcbiAgICAudGlja1BhZGRpbmcoMTIpO1xuICBpZiAodGlja0Zvcm1hdCkge1xuICAgIHhBeGlzLnRpY2tGb3JtYXQodGlja0Zvcm1hdCk7XG4gIH1cblxuICByZXR1cm4geEF4aXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVBeGlzKHhBeGlzUmVmLCB4QXhpcykge1xuICBpZiAoIXhBeGlzKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgc2VsZWN0KHhBeGlzUmVmLmN1cnJlbnQpLmNhbGwoeEF4aXMpO1xufVxuXG5pbnRlcmZhY2UgVGltZVNsaWRlck1hcmtlclByb3BzIHtcbiAgd2lkdGg6IG51bWJlcjtcbiAgZG9tYWluOiBEYXRlW10gfCBOdW1iZXJWYWx1ZVtdO1xuICBpc0VubGFyZ2VkPzogYm9vbGVhbjtcbiAgaGVpZ2h0PzogbnVtYmVyO1xuICB0aW1lem9uZTogc3RyaW5nO1xufVxuXG5mdW5jdGlvbiBUaW1lU2xpZGVyTWFya2VyRmFjdG9yeSgpIHtcbiAgY29uc3QgVGltZVNsaWRlck1hcmtlciA9ICh7XG4gICAgd2lkdGgsXG4gICAgZG9tYWluLFxuICAgIGlzRW5sYXJnZWQgPSB0cnVlLFxuICAgIGhlaWdodCA9IEhFSUdIVCxcbiAgICB0aW1lem9uZVxuICB9OiBUaW1lU2xpZGVyTWFya2VyUHJvcHMpID0+IHtcbiAgICBjb25zdCB4QXhpc1JlZiA9IHVzZVJlZihudWxsKTtcbiAgICBjb25zdCB4QXhpcyA9IHVzZU1lbW8oKCkgPT4gZ2V0WEF4aXMoZG9tYWluLCB3aWR0aCwgaXNFbmxhcmdlZCwgdGltZXpvbmUpLCBbXG4gICAgICBkb21haW4sXG4gICAgICB3aWR0aCxcbiAgICAgIGlzRW5sYXJnZWQsXG4gICAgICB0aW1lem9uZVxuICAgIF0pO1xuICAgIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICB1cGRhdGVBeGlzKHhBeGlzUmVmLCB4QXhpcyk7XG4gICAgfSwgW3hBeGlzUmVmLCB4QXhpc10pO1xuICAgIHJldHVybiAoXG4gICAgICA8VGltZVNsaWRlckNvbnRhaW5lciBjbGFzc05hbWU9XCJ0aW1lLXNsaWRlci1tYXJrZXJcIiB3aWR0aD17d2lkdGh9IGhlaWdodD17aGVpZ2h0fT5cbiAgICAgICAgPGcgY2xhc3NOYW1lPVwieCBheGlzXCIgcmVmPXt4QXhpc1JlZn0gdHJhbnNmb3JtPVwidHJhbnNsYXRlKDAsIDApXCIgLz5cbiAgICAgIDwvVGltZVNsaWRlckNvbnRhaW5lcj5cbiAgICApO1xuICB9O1xuXG4gIFRpbWVTbGlkZXJNYXJrZXIucHJvcFR5cGVzID0ge1xuICAgIGRvbWFpbjogUHJvcFR5cGVzLmFycmF5T2YoUHJvcFR5cGVzLmFueSkuaXNSZXF1aXJlZCxcbiAgICB3aWR0aDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkXG4gIH07XG5cbiAgcmV0dXJuIFJlYWN0Lm1lbW8oVGltZVNsaWRlck1hcmtlcik7XG59XG5cbmV4cG9ydCBkZWZhdWx0IFRpbWVTbGlkZXJNYXJrZXJGYWN0b3J5O1xuIl19