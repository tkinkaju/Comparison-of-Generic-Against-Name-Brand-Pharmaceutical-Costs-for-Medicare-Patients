// Copyright (c) 2022 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _chickletedInput = require("../../../common/item-selector/chickleted-input");

var _icons = require("../../../common/icons");

var _dropdownList = _interopRequireDefault(require("../../../common/item-selector/dropdown-list"));

var _localization = require("@kepler.gl/localization");

var _reactOnclickoutside = _interopRequireDefault(require("react-onclickoutside"));

var _constants = require("@kepler.gl/constants");

var _utils = require("@kepler.gl/utils");

var _tippyTooltip = _interopRequireDefault(require("../../../common/tippy-tooltip"));

var _templateObject, _templateObject2, _templateObject3, _templateObject4;

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2["default"])(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2["default"])(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var TIME_DISPLAY = '2020-05-11 14:00';

var getValue = function getValue(fmt) {
  return fmt[_constants.TOOLTIP_KEY];
};

var addDTimeLabel = function addDTimeLabel(formats) {
  return formats.map(function (f) {
    return _objectSpread(_objectSpread({}, f), {}, {
      label: f.type === _constants.TOOLTIP_FORMAT_TYPES.DATE_TIME || f.type === _constants.TOOLTIP_FORMAT_TYPES.DATE ? (0, _utils.getFormatter)(getValue(f))(TIME_DISPLAY) : f.label
    });
  });
};

function getFormatLabels(fields, fieldName) {
  var fieldType = fields.find(function (f) {
    return f.name === fieldName;
  }).type;
  var tooltipTypes = fieldType && _constants.FIELD_OPTS[fieldType].format.tooltip || [];
  var formatLabels = Object.values(_constants.TOOLTIP_FORMATS).filter(function (t) {
    return tooltipTypes.includes(t.type);
  });
  return addDTimeLabel(formatLabels);
}

var ChickletAddonWrapper = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  position: relative;\n"])));

var ChickletAddon = _styledComponents["default"].div(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["\n  margin-right: 4px;\n"])));

var StyledPopover = _styledComponents["default"].div(_templateObject3 || (_templateObject3 = (0, _taggedTemplateLiteral2["default"])(["\n  margin-left: -64px;\n  position: absolute;\n  top: 20px;\n  width: 140px;\n  z-index: 101;\n"])));

var hashStyles = {
  SHOW: 'SHOW',
  ACTIVE: 'ACTIVE'
};

var IconDiv = _styledComponents["default"].div.attrs({
  className: 'tooltip-chicklet__icon'
})(_templateObject4 || (_templateObject4 = (0, _taggedTemplateLiteral2["default"])(["\n  color: ", ";\n"])), function (props) {
  return props.status === hashStyles.SHOW ? props.theme.subtextColorActive : props.status === hashStyles.ACTIVE ? props.theme.activeColor : props.theme.textColor;
});

function getFormatTooltip(formatLabels, format) {
  if (!format) {
    return null;
  }

  var formatLabel = formatLabels.find(function (fl) {
    return getValue(fl) === format;
  });

  if (formatLabel) {
    return formatLabel.label;
  }

  return (0, _typeof2["default"])(format) === 'object' ? JSON.stringify(format, null, 2) : String(format);
}

function TooltipChickletFactory(dataId, config, onChange, fields) {
  var TooltipChicklet = /*#__PURE__*/function (_Component) {
    (0, _inherits2["default"])(TooltipChicklet, _Component);

    var _super = _createSuper(TooltipChicklet);

    function TooltipChicklet() {
      var _this;

      (0, _classCallCheck2["default"])(this, TooltipChicklet);

      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      _this = _super.call.apply(_super, [this].concat(args));
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {
        show: false
      });
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "node", void 0);
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "handleClickOutside", function (e) {
        if (_this.node.contains(e.target)) {
          return;
        }
      });
      return _this;
    }

    (0, _createClass2["default"])(TooltipChicklet, [{
      key: "componentDidMount",
      value: function componentDidMount() {
        document.addEventListener('mousedown', this.handleClickOutside, false);
      }
    }, {
      key: "componentWillUnmount",
      value: function componentWillUnmount() {
        document.removeEventListener('mousedown', this.handleClickOutside, false);
      }
    }, {
      key: "render",
      value: function render() {
        var _this2 = this;

        var _this$props = this.props,
            disabled = _this$props.disabled,
            item = _this$props.item,
            displayOption = _this$props.displayOption,
            remove = _this$props.remove;
        var show = this.state.show;
        var tooltipField = config.fieldsToShow[dataId].find(function (fieldToShow) {
          return fieldToShow.name === item.name;
        });

        if (!tooltipField) {
          return null;
        }

        var formatLabels = getFormatLabels(fields, tooltipField.name);
        var hasFormat = Boolean(tooltipField.format);
        var selectionIndex = formatLabels.findIndex(function (fl) {
          return getValue(fl) === tooltipField.format;
        });
        var hashStyle = show ? hashStyles.SHOW : hasFormat ? hashStyles.ACTIVE : null;
        return /*#__PURE__*/_react["default"].createElement(_chickletedInput.ChickletButton, {
          ref: function ref(node) {
            return _this2.node = node;
          }
        }, /*#__PURE__*/_react["default"].createElement(_chickletedInput.ChickletTag, null, displayOption(item)), formatLabels.length > 1 && /*#__PURE__*/_react["default"].createElement(ChickletAddonWrapper, null, /*#__PURE__*/_react["default"].createElement(_tippyTooltip["default"], {
          placement: "top",
          render: function render() {
            return /*#__PURE__*/_react["default"].createElement("span", null, hasFormat ? getFormatTooltip(formatLabels, tooltipField.format) : /*#__PURE__*/_react["default"].createElement(_localization.FormattedMessage, {
              id: 'fieldSelector.formatting'
            }));
          }
        }, /*#__PURE__*/_react["default"].createElement(ChickletAddon, null, /*#__PURE__*/_react["default"].createElement(IconDiv, {
          status: hashStyle
        }, /*#__PURE__*/_react["default"].createElement(_icons.Hash, {
          height: "8px",
          onClick: function onClick(e) {
            e.stopPropagation();

            _this2.setState({
              show: Boolean(!show)
            });
          }
        })))), show && /*#__PURE__*/_react["default"].createElement(StyledPopover, null, /*#__PURE__*/_react["default"].createElement(_dropdownList["default"], {
          options: formatLabels,
          selectionIndex: selectionIndex,
          displayOption: function displayOption(_ref) {
            var label = _ref.label;
            return label;
          },
          onOptionSelected: function onOptionSelected(result, e) {
            e.stopPropagation();

            _this2.setState({
              show: false
            });

            var oldFieldsToShow = config.fieldsToShow[dataId];
            var fieldsToShow = oldFieldsToShow.map(function (fieldToShow) {
              return fieldToShow.name === tooltipField.name ? {
                name: tooltipField.name,
                format: getValue(result)
              } : fieldToShow;
            });

            var newConfig = _objectSpread(_objectSpread({}, config), {}, {
              fieldsToShow: _objectSpread(_objectSpread({}, config.fieldsToShow), {}, (0, _defineProperty2["default"])({}, dataId, fieldsToShow))
            });

            onChange(newConfig);
          }
        }))), /*#__PURE__*/_react["default"].createElement(_icons.Delete, {
          onClick: disabled ? null : remove
        }));
      }
    }]);
    return TooltipChicklet;
  }(_react.Component);

  return (0, _reactOnclickoutside["default"])(TooltipChicklet);
}

var _default = TooltipChickletFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zaWRlLXBhbmVsL2ludGVyYWN0aW9uLXBhbmVsL3Rvb2x0aXAtY29uZmlnL3Rvb2x0aXAtY2hpY2tsZXQudHN4Il0sIm5hbWVzIjpbIlRJTUVfRElTUExBWSIsImdldFZhbHVlIiwiZm10IiwiVE9PTFRJUF9LRVkiLCJhZGREVGltZUxhYmVsIiwiZm9ybWF0cyIsIm1hcCIsImYiLCJsYWJlbCIsInR5cGUiLCJUT09MVElQX0ZPUk1BVF9UWVBFUyIsIkRBVEVfVElNRSIsIkRBVEUiLCJnZXRGb3JtYXRMYWJlbHMiLCJmaWVsZHMiLCJmaWVsZE5hbWUiLCJmaWVsZFR5cGUiLCJmaW5kIiwibmFtZSIsInRvb2x0aXBUeXBlcyIsIkZJRUxEX09QVFMiLCJmb3JtYXQiLCJ0b29sdGlwIiwiZm9ybWF0TGFiZWxzIiwiT2JqZWN0IiwidmFsdWVzIiwiVE9PTFRJUF9GT1JNQVRTIiwiZmlsdGVyIiwidCIsImluY2x1ZGVzIiwiQ2hpY2tsZXRBZGRvbldyYXBwZXIiLCJzdHlsZWQiLCJkaXYiLCJDaGlja2xldEFkZG9uIiwiU3R5bGVkUG9wb3ZlciIsImhhc2hTdHlsZXMiLCJTSE9XIiwiQUNUSVZFIiwiSWNvbkRpdiIsImF0dHJzIiwiY2xhc3NOYW1lIiwicHJvcHMiLCJzdGF0dXMiLCJ0aGVtZSIsInN1YnRleHRDb2xvckFjdGl2ZSIsImFjdGl2ZUNvbG9yIiwidGV4dENvbG9yIiwiZ2V0Rm9ybWF0VG9vbHRpcCIsImZvcm1hdExhYmVsIiwiZmwiLCJKU09OIiwic3RyaW5naWZ5IiwiU3RyaW5nIiwiVG9vbHRpcENoaWNrbGV0RmFjdG9yeSIsImRhdGFJZCIsImNvbmZpZyIsIm9uQ2hhbmdlIiwiVG9vbHRpcENoaWNrbGV0Iiwic2hvdyIsImUiLCJub2RlIiwiY29udGFpbnMiLCJ0YXJnZXQiLCJkb2N1bWVudCIsImFkZEV2ZW50TGlzdGVuZXIiLCJoYW5kbGVDbGlja091dHNpZGUiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiZGlzYWJsZWQiLCJpdGVtIiwiZGlzcGxheU9wdGlvbiIsInJlbW92ZSIsInN0YXRlIiwidG9vbHRpcEZpZWxkIiwiZmllbGRzVG9TaG93IiwiZmllbGRUb1Nob3ciLCJoYXNGb3JtYXQiLCJCb29sZWFuIiwic2VsZWN0aW9uSW5kZXgiLCJmaW5kSW5kZXgiLCJoYXNoU3R5bGUiLCJsZW5ndGgiLCJzdG9wUHJvcGFnYXRpb24iLCJzZXRTdGF0ZSIsInJlc3VsdCIsIm9sZEZpZWxkc1RvU2hvdyIsIm5ld0NvbmZpZyIsIkNvbXBvbmVudCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFvQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBTUE7O0FBQ0E7Ozs7Ozs7Ozs7OztBQW9DQSxJQUFNQSxZQUFZLEdBQUcsa0JBQXJCOztBQUNBLElBQU1DLFFBQVEsR0FBRyxTQUFYQSxRQUFXLENBQUFDLEdBQUc7QUFBQSxTQUFJQSxHQUFHLENBQUNDLHNCQUFELENBQVA7QUFBQSxDQUFwQjs7QUFFQSxJQUFNQyxhQUFhLEdBQUcsU0FBaEJBLGFBQWdCLENBQUNDLE9BQUQ7QUFBQSxTQUNwQkEsT0FBTyxDQUFDQyxHQUFSLENBQVksVUFBQUMsQ0FBQztBQUFBLDJDQUNSQSxDQURRO0FBRVhDLE1BQUFBLEtBQUssRUFDSEQsQ0FBQyxDQUFDRSxJQUFGLEtBQVdDLGdDQUFxQkMsU0FBaEMsSUFBNkNKLENBQUMsQ0FBQ0UsSUFBRixLQUFXQyxnQ0FBcUJFLElBQTdFLEdBQ0kseUJBQWFYLFFBQVEsQ0FBQ00sQ0FBRCxDQUFyQixFQUEwQlAsWUFBMUIsQ0FESixHQUVJTyxDQUFDLENBQUNDO0FBTEc7QUFBQSxHQUFiLENBRG9CO0FBQUEsQ0FBdEI7O0FBU0EsU0FBU0ssZUFBVCxDQUF5QkMsTUFBekIsRUFBc0NDLFNBQXRDLEVBQXlEO0FBQ3ZELE1BQU1DLFNBQVMsR0FBR0YsTUFBTSxDQUFDRyxJQUFQLENBQVksVUFBQ1YsQ0FBRDtBQUFBLFdBQXNCQSxDQUFD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QWM7QUFDWnhCLGNBQUFBLElBQUksRUFBRTtBQURNLGFBQWQ7O0FBSUEsZ0JBQU0wQixlQUFlLEdBQUc3QixNQUFNLENBQUNrQixZQUFQLENBQW9CbkIsTUFBcEIsQ0FBeEI7QUFDQSxnQkFBTW1CLFlBQVksR0FBR1csZUFBZSxDQUFDOUUsR0FBaEIsQ0FBb0IsVUFBQW9FLFdBQVcsRUFBSTtBQUN0RCxxQkFBT0EsV0FBVyxDQUFDeEQsSUFBWixLQUFxQnNELFlBQVksQ0FBQ3RELElBQWxDLEdBQ0g7QUFDRUEsZ0JBQUFBLElBQUksRUFBRXNELFlBQVksQ0FBQ3RELElBRHJCO0FBRUVHLGdCQUFBQSxNQUFNLEVBQUVwQixRQUFRLENBQUNrRixNQUFEO0FBRmxCLGVBREcsR0FLSFQsV0FMSjtBQU1ELGFBUG9CLENBQXJCOztBQVFBLGdCQUFNVyxTQUFTLG1DQUNWOUIsTUFEVTtBQUVia0IsY0FBQUEsWUFBWSxrQ0FDUGxCLE1BQU0sQ0FBQ2tCLFlBREEsNENBRVRuQixNQUZTLEVBRUFtQixZQUZBO0FBRkMsY0FBZjs7QUFPQWpCLFlBQUFBLFFBQVEsQ0FBQzZCLFNBQUQsQ0FBUjtBQUNEO0FBM0JILFVBREYsQ0ExQkosQ0FISixlQStERSxnQ0FBQyxhQUFEO0FBQVEsVUFBQSxPQUFPLEVBQUVsQixRQUFRLEdBQUcsSUFBSCxHQUFVRztBQUFuQyxVQS9ERixDQURGO0FBbUVEO0FBdEdrQztBQUFBO0FBQUEsSUFDUGdCLGdCQURPOztBQXdHckMsU0FBTyxxQ0FBZTdCLGVBQWYsQ0FBUDtBQUNEOztlQUVjSixzQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgMjAyMiBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbmltcG9ydCBSZWFjdCwge0NvbXBvbmVudCwgQ29tcG9uZW50VHlwZX0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQge0NoaWNrbGV0QnV0dG9uLCBDaGlja2xldFRhZ30gZnJvbSAnLi4vLi4vLi4vY29tbW9uL2l0ZW0tc2VsZWN0b3IvY2hpY2tsZXRlZC1pbnB1dCc7XG5pbXBvcnQge0hhc2gsIERlbGV0ZX0gZnJvbSAnLi4vLi4vLi4vY29tbW9uL2ljb25zJztcbmltcG9ydCBEcm9wZG93bkxpc3QgZnJvbSAnLi4vLi4vLi4vY29tbW9uL2l0ZW0tc2VsZWN0b3IvZHJvcGRvd24tbGlzdCc7XG5pbXBvcnQge0Zvcm1hdHRlZE1lc3NhZ2V9IGZyb20gJ0BrZXBsZXIuZ2wvbG9jYWxpemF0aW9uJztcbmltcG9ydCBvbkNsaWNrT3V0c2lkZSBmcm9tICdyZWFjdC1vbmNsaWNrb3V0c2lkZSc7XG5pbXBvcnQge1xuICBGSUVMRF9PUFRTLFxuICBUT09MVElQX0ZPUk1BVFMsXG4gIFRPT0xUSVBfRk9STUFUX1RZUEVTLFxuICBUT09MVElQX0tFWVxufSBmcm9tICdAa2VwbGVyLmdsL2NvbnN0YW50cyc7XG5pbXBvcnQge2dldEZvcm1hdHRlcn0gZnJvbSAnQGtlcGxlci5nbC91dGlscyc7XG5pbXBvcnQgVGlwcHlUb29sdGlwIGZyb20gJy4uLy4uLy4uL2NvbW1vbi90aXBweS10b29sdGlwJztcblxuaW50ZXJmYWNlIFRvb2x0aXBDaGlja2xldFByb3BzIHtcbiAgZGlzYWJsZWQ6IGJvb2xlYW47XG4gIGl0ZW06IHtuYW1lOiBzdHJpbmd9O1xuICBkaXNwbGF5T3B0aW9uOiBGdW5jdGlvbjtcbiAgcmVtb3ZlOiBhbnk7XG59XG5cbnR5cGUgVG9vbHRpcENvbmZpZyA9IHtcbiAgZmllbGRzVG9TaG93OiB7XG4gICAgW2tleTogc3RyaW5nXToge25hbWU6IHN0cmluZzsgZm9ybWF0OiBzdHJpbmcgfCBudWxsfVtdO1xuICB9O1xuICBjb21wYXJlTW9kZTogYm9vbGVhbjtcbiAgY29tcGFyZVR5cGU6IHN0cmluZ1tdO1xufTtcblxudHlwZSBUb29sdGlwRmllbGRzID0ge1xuICBmb3JtYXQ/OiBzdHJpbmc7XG4gIGlkPzogc3RyaW5nO1xuICBuYW1lPzogc3RyaW5nO1xuICBmaWVsZElkeD86IG51bWJlcjtcbiAgdHlwZT86IG51bWJlcjtcbn07XG5cbnR5cGUgVGltZUxhYmVsRm9ybWF0ID0ge1xuICBpZDogc3RyaW5nO1xuICBmb3JtYXQ6IHN0cmluZyB8IG51bGw7XG4gIHR5cGU6IHN0cmluZztcbiAgbGFiZWw6IHN0cmluZztcbn07XG5cbnR5cGUgSWNvbkRpdlByb3BzID0ge1xuICBzdGF0dXM6IHN0cmluZyB8IG51bGw7XG59O1xuXG5jb25zdCBUSU1FX0RJU1BMQVkgPSAnMjAyMC0wNS0xMSAxNDowMCc7XG5jb25zdCBnZXRWYWx1ZSA9IGZtdCA9PiBmbXRbVE9PTFRJUF9LRVldO1xuXG5jb25zdCBhZGREVGltZUxhYmVsID0gKGZvcm1hdHM6IFRpbWVMYWJlbEZvcm1hdFtdKSA9PlxuICBmb3JtYXRzLm1hcChmID0+ICh7XG4gICAgLi4uZixcbiAgICBsYWJlbDpcbiAgICAgIGYudHlwZSA9PT0gVE9PTFRJUF9GT1JNQVRfVFlQRVMuREFURV9USU1FIHx8IGYudHlwZSA9PT0gVE9PTFRJUF9GT1JNQVRfVFlQRVMuREFURVxuICAgICAgICA/IGdldEZvcm1hdHRlcihnZXRWYWx1ZShmKSkoVElNRV9ESVNQTEFZKVxuICAgICAgICA6IGYubGFiZWxcbiAgfSkpO1xuXG5mdW5jdGlvbiBnZXRGb3JtYXRMYWJlbHMoZmllbGRzOiBhbnksIGZpZWxkTmFtZTogc3RyaW5nKSB7XG4gIGNvbnN0IGZpZWxkVHlwZSA9IGZpZWxkcy5maW5kKChmOiBUb29sdGlwRmllbGRzKSA9PiBmLm5hbWUgPT09IGZpZWxkTmFtZSkudHlwZTtcbiAgY29uc3QgdG9vbHRpcFR5cGVzID0gKGZpZWxkVHlwZSAmJiBGSUVMRF9PUFRTW2ZpZWxkVHlwZV0uZm9ybWF0LnRvb2x0aXApIHx8IFtdO1xuICBjb25zdCBmb3JtYXRMYWJlbHM6IFRpbWVMYWJlbEZvcm1hdFtdID0gT2JqZWN0LnZhbHVlcyhUT09MVElQX0ZPUk1BVFMpLmZpbHRlcih0ID0+XG4gICAgdG9vbHRpcFR5cGVzLmluY2x1ZGVzKHQudHlwZSlcbiAgKTtcbiAgcmV0dXJuIGFkZERUaW1lTGFiZWwoZm9ybWF0TGFiZWxzKTtcbn1cblxuY29uc3QgQ2hpY2tsZXRBZGRvbldyYXBwZXIgPSBzdHlsZWQuZGl2YFxuICBwb3NpdGlvbjogcmVsYXRpdmU7XG5gO1xuXG5jb25zdCBDaGlja2xldEFkZG9uID0gc3R5bGVkLmRpdmBcbiAgbWFyZ2luLXJpZ2h0OiA0cHg7XG5gO1xuXG5jb25zdCBTdHlsZWRQb3BvdmVyID0gc3R5bGVkLmRpdmBcbiAgbWFyZ2luLWxlZnQ6IC02NHB4O1xuICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gIHRvcDogMjBweDtcbiAgd2lkdGg6IDE0MHB4O1xuICB6LWluZGV4OiAxMDE7XG5gO1xuXG5jb25zdCBoYXNoU3R5bGVzID0ge1xuICBTSE9XOiAnU0hPVycsXG4gIEFDVElWRTogJ0FDVElWRSdcbn07XG5cbmNvbnN0IEljb25EaXYgPSBzdHlsZWQuZGl2LmF0dHJzKHtcbiAgY2xhc3NOYW1lOiAndG9vbHRpcC1jaGlja2xldF9faWNvbidcbn0pPEljb25EaXZQcm9wcz5gXG4gIGNvbG9yOiAke3Byb3BzID0+XG4gICAgcHJvcHMuc3RhdHVzID09PSBoYXNoU3R5bGVzLlNIT1dcbiAgICAgID8gcHJvcHMudGhlbWUuc3VidGV4dENvbG9yQWN0aXZlXG4gICAgICA6IHByb3BzLnN0YXR1cyA9PT0gaGFzaFN0eWxlcy5BQ1RJVkVcbiAgICAgID8gcHJvcHMudGhlbWUuYWN0aXZlQ29sb3JcbiAgICAgIDogcHJvcHMudGhlbWUudGV4dENvbG9yfTtcbmA7XG5cbmZ1bmN0aW9uIGdldEZvcm1hdFRvb2x0aXAoZm9ybWF0TGFiZWxzOiBUaW1lTGFiZWxGb3JtYXRbXSwgZm9ybWF0OiBzdHJpbmcgfCBudWxsKSB7XG4gIGlmICghZm9ybWF0KSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgY29uc3QgZm9ybWF0TGFiZWwgPSBmb3JtYXRMYWJlbHMuZmluZChmbCA9PiBnZXRWYWx1ZShmbCkgPT09IGZvcm1hdCk7XG4gIGlmIChmb3JtYXRMYWJlbCkge1xuICAgIHJldHVybiBmb3JtYXRMYWJlbC5sYWJlbDtcbiAgfVxuICByZXR1cm4gdHlwZW9mIGZvcm1hdCA9PT0gJ29iamVjdCcgPyBKU09OLnN0cmluZ2lmeShmb3JtYXQsIG51bGwsIDIpIDogU3RyaW5nKGZvcm1hdCk7XG59XG5cbmZ1bmN0aW9uIFRvb2x0aXBDaGlja2xldEZhY3RvcnkoXG4gIGRhdGFJZDogc3RyaW5nLFxuICBjb25maWc6IFRvb2x0aXBDb25maWcsXG4gIG9uQ2hhbmdlOiAoY2ZnOiBUb29sdGlwQ29uZmlnKSA9PiB2b2lkLFxuICBmaWVsZHM6IFRvb2x0aXBGaWVsZHNbXVxuKTogQ29tcG9uZW50VHlwZTxUb29sdGlwQ2hpY2tsZXRQcm9wcz4ge1xuICBjbGFzcyBUb29sdGlwQ2hpY2tsZXQgZXh0ZW5kcyBDb21wb25lbnQ8VG9vbHRpcENoaWNrbGV0UHJvcHM+IHtcbiAgICBzdGF0ZSA9IHtcbiAgICAgIHNob3c6IGZhbHNlXG4gICAgfTtcbiAgICBwcml2YXRlIG5vZGUhOiBIVE1MRGl2RWxlbWVudDtcblxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgdGhpcy5oYW5kbGVDbGlja091dHNpZGUsIGZhbHNlKTtcbiAgICB9XG5cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHRoaXMuaGFuZGxlQ2xpY2tPdXRzaWRlLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgaGFuZGxlQ2xpY2tPdXRzaWRlID0gKGU6IGFueSkgPT4ge1xuICAgICAgaWYgKHRoaXMubm9kZS5jb250YWlucyhlLnRhcmdldCkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH07XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICBjb25zdCB7ZGlzYWJsZWQsIGl0ZW0sIGRpc3BsYXlPcHRpb24sIHJlbW92ZX0gPSB0aGlzLnByb3BzO1xuICAgICAgY29uc3Qge3Nob3d9ID0gdGhpcy5zdGF0ZTtcbiAgICAgIGNvbnN0IHRvb2x0aXBGaWVsZCA9IGNvbmZpZy5maWVsZHNUb1Nob3dbZGF0YUlkXS5maW5kKFxuICAgICAgICBmaWVsZFRvU2hvdyA9PiBmaWVsZFRvU2hvdy5uYW1lID09PSBpdGVtLm5hbWVcbiAgICAgICk7XG4gICAgICBpZiAoIXRvb2x0aXBGaWVsZCkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGZvcm1hdExhYmVscyA9IGdldEZvcm1hdExhYmVscyhmaWVsZHMsIHRvb2x0aXBGaWVsZC5uYW1lKTtcbiAgICAgIGNvbnN0IGhhc0Zvcm1hdCA9IEJvb2xlYW4odG9vbHRpcEZpZWxkLmZvcm1hdCk7XG4gICAgICBjb25zdCBzZWxlY3Rpb25JbmRleCA9IGZvcm1hdExhYmVscy5maW5kSW5kZXgoZmwgPT4gZ2V0VmFsdWUoZmwpID09PSB0b29sdGlwRmllbGQuZm9ybWF0KTtcbiAgICAgIGNvbnN0IGhhc2hTdHlsZSA9IHNob3cgPyBoYXNoU3R5bGVzLlNIT1cgOiBoYXNGb3JtYXQgPyBoYXNoU3R5bGVzLkFDVElWRSA6IG51bGw7XG5cbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxDaGlja2xldEJ1dHRvbiByZWY9eyhub2RlOiBIVE1MRGl2RWxlbWVudCkgPT4gKHRoaXMubm9kZSA9IG5vZGUpfT5cbiAgICAgICAgICA8Q2hpY2tsZXRUYWc+e2Rpc3BsYXlPcHRpb24oaXRlbSl9PC9DaGlja2xldFRhZz5cbiAgICAgICAgICB7Zm9ybWF0TGFiZWxzLmxlbmd0aCA+IDEgJiYgKFxuICAgICAgICAgICAgPENoaWNrbGV0QWRkb25XcmFwcGVyPlxuICAgICAgICAgICAgICA8VGlwcHlUb29sdGlwXG4gICAgICAgICAgICAgICAgcGxhY2VtZW50PVwidG9wXCJcbiAgICAgICAgICAgICAgICByZW5kZXI9eygpID0+IChcbiAgICAgICAgICAgICAgICAgIDxzcGFuPlxuICAgICAgICAgICAgICAgICAgICB7aGFzRm9ybWF0ID8gKFxuICAgICAgICAgICAgICAgICAgICAgIGdldEZvcm1hdFRvb2x0aXAoZm9ybWF0TGFiZWxzLCB0b29sdGlwRmllbGQuZm9ybWF0KVxuICAgICAgICAgICAgICAgICAgICApIDogKFxuICAgICAgICAgICAgICAgICAgICAgIDxGb3JtYXR0ZWRNZXNzYWdlIGlkPXsnZmllbGRTZWxlY3Rvci5mb3JtYXR0aW5nJ30gLz5cbiAgICAgICAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPENoaWNrbGV0QWRkb24+XG4gICAgICAgICAgICAgICAgICA8SWNvbkRpdiBzdGF0dXM9e2hhc2hTdHlsZX0+XG4gICAgICAgICAgICAgICAgICAgIDxIYXNoXG4gICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0PVwiOHB4XCJcbiAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXtlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtzaG93OiBCb29sZWFuKCFzaG93KX0pO1xuICAgICAgICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgICA8L0ljb25EaXY+XG4gICAgICAgICAgICAgICAgPC9DaGlja2xldEFkZG9uPlxuICAgICAgICAgICAgICA8L1RpcHB5VG9vbHRpcD5cbiAgICAgICAgICAgICAge3Nob3cgJiYgKFxuICAgICAgICAgICAgICAgIDxTdHlsZWRQb3BvdmVyPlxuICAgICAgICAgICAgICAgICAgPERyb3Bkb3duTGlzdFxuICAgICAgICAgICAgICAgICAgICBvcHRpb25zPXtmb3JtYXRMYWJlbHN9XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbkluZGV4PXtzZWxlY3Rpb25JbmRleH1cbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheU9wdGlvbj17KHtsYWJlbH0pID0+IGxhYmVsfVxuICAgICAgICAgICAgICAgICAgICBvbk9wdGlvblNlbGVjdGVkPXsocmVzdWx0LCBlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNob3c6IGZhbHNlXG4gICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvbGRGaWVsZHNUb1Nob3cgPSBjb25maWcuZmllbGRzVG9TaG93W2RhdGFJZF07XG4gICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmllbGRzVG9TaG93ID0gb2xkRmllbGRzVG9TaG93Lm1hcChmaWVsZFRvU2hvdyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmllbGRUb1Nob3cubmFtZSA9PT0gdG9vbHRpcEZpZWxkLm5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiB0b29sdGlwRmllbGQubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdDogZ2V0VmFsdWUocmVzdWx0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgOiBmaWVsZFRvU2hvdztcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdDb25maWcgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5jb25maWcsXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHNUb1Nob3c6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uY29uZmlnLmZpZWxkc1RvU2hvdyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgW2RhdGFJZF06IGZpZWxkc1RvU2hvd1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2UobmV3Q29uZmlnKTtcbiAgICAgICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPC9TdHlsZWRQb3BvdmVyPlxuICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgPC9DaGlja2xldEFkZG9uV3JhcHBlcj5cbiAgICAgICAgICApfVxuICAgICAgICAgIDxEZWxldGUgb25DbGljaz17ZGlzYWJsZWQgPyBudWxsIDogcmVtb3ZlfSAvPlxuICAgICAgICA8L0NoaWNrbGV0QnV0dG9uPlxuICAgICAgKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG9uQ2xpY2tPdXRzaWRlKFRvb2x0aXBDaGlja2xldCk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IFRvb2x0aXBDaGlja2xldEZhY3Rvcnk7XG4iXX0=