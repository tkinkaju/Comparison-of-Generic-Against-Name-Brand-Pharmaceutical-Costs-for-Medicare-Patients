// Copyright (c) 2022 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _localization = require("@kepler.gl/localization");

var _react2 = _interopRequireDefault(require("@tippyjs/react"));

var _icons = require("../../common/icons");

var _styledComponents2 = require("../../common/styled-components");

var _ = require("../..");

var _typeahead = _interopRequireDefault(require("../../common/item-selector/typeahead"));

var _accessor = _interopRequireDefault(require("../../common/item-selector/accessor"));

var _templateObject, _templateObject2, _templateObject3;

var DropdownContainer = _styledComponents["default"].div.attrs({
  className: 'add-layer-menu-dropdown'
})(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  .list-selector {\n    border-top: 1px solid ", ";\n    width: 100%;\n    /* disable scrolling, currently set to 280px internally */\n    max-height: unset;\n  }\n\n  .list__item > div {\n    display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n    line-height: 18px;\n    padding: 0;\n\n    svg {\n      margin-right: 10px;\n    }\n  }\n"])), function (props) {
  return props.theme.secondaryInputBorderColor;
});

var AddLayerMenu = _styledComponents["default"].div.attrs({
  className: 'add-layer-menu'
})(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["\n  display: flex;\n  flex-direction: column;\n  min-width: 240px;\n  max-width: 240px;\n  position: absolute;\n  top: 100%;\n  left: -53px;\n  z-index: 5;\n"])));

var ListItemWrapper = _styledComponents["default"].div.attrs({
  className: 'add-layer-menu-list-item-wrapper'
})(_templateObject3 || (_templateObject3 = (0, _taggedTemplateLiteral2["default"])(["\n  display: flex;\n  color: ", ";\n  font-size: 11px;\n  letter-spacing: 0.2px;\n  overflow: auto;\n\n  .dataset-color {\n    flex-shrink: 0;\n    margin-top: 3px;\n  }\n\n  .dataset-name {\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n"])), function (props) {
  return props.theme.textColor;
});

var TYPEAHEAD_CLASS = 'typeahead';
var TYPEAHEAD_INPUT_CLASS = 'typeahead__input';

function AddLayerButtonFactory() {
  var ListItem = function ListItem(_ref) {
    var value = _ref.value;
    return /*#__PURE__*/_react["default"].createElement(ListItemWrapper, null, /*#__PURE__*/_react["default"].createElement(_.DatasetSquare, {
      className: "dataset-color",
      backgroundColor: value.color
    }), /*#__PURE__*/_react["default"].createElement("div", {
      className: "dataset-name",
      title: value.label
    }, value.label));
  };

  var AddLayerButton = function AddLayerButton(props) {
    var datasets = props.datasets,
        onOptionSelected = props.onOptionSelected,
        typeaheadPlaceholder = props.typeaheadPlaceholder,
        intl = props.intl;

    var _useState = (0, _react.useState)(false),
        _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
        showAddLayerDropdown = _useState2[0],
        setShowAddLayerDropdown = _useState2[1];

    var toggleAddLayerDropdown = (0, _react.useCallback)(function () {
      setShowAddLayerDropdown(!showAddLayerDropdown);
    }, [showAddLayerDropdown, setShowAddLayerDropdown]);

    var _onBlur = (0, _react.useCallback)(function () {
      setShowAddLayerDropdown(false);
    }, []);

    var toggleSelectedOption = (0, _react.useCallback)(function (option) {
      onOptionSelected(option.value);

      _onBlur();
    }, [onOptionSelected, _onBlur]);
    var onButtonBlur = (0, _react.useCallback)(function (event) {
      if ([TYPEAHEAD_CLASS, TYPEAHEAD_INPUT_CLASS].every(function (cls) {
        var _event$relatedTarget;

        return !(event !== null && event !== void 0 && (_event$relatedTarget = event.relatedTarget) !== null && _event$relatedTarget !== void 0 && _event$relatedTarget.classList.contains(cls));
      })) {
        _onBlur();
      }
    }, [_onBlur]);
    var onSearchBlur = (0, _react.useCallback)(function () {
      _onBlur();
    }, [_onBlur]);
    var options = (0, _react.useMemo)(function () {
      return Object.values(datasets).map(function (ds) {
        return {
          label: ds.label,
          value: ds.id,
          color: ds.color
        };
      });
    }, [datasets]);
    return /*#__PURE__*/_react["default"].createElement(_react2["default"], {
      visible: showAddLayerDropdown,
      arrow: false,
      interactive: true,
      placement: "bottom",
      appendTo: "parent",
      duration: 0,
      content: /*#__PURE__*/_react["default"].createElement(AddLayerMenu, null, /*#__PURE__*/_react["default"].createElement(DropdownContainer, null, /*#__PURE__*/_react["default"].createElement(_typeahead["default"], {
        onBlur: onSearchBlur,
        className: TYPEAHEAD_CLASS,
        customClasses: {
          results: 'list-selector',
          input: TYPEAHEAD_INPUT_CLASS,
          listItem: 'list__item'
        },
        placeholder: typeaheadPlaceholder || intl ? intl.formatMessage({
          id: 'placeholder.search'
        }) : 'Search',
        selectedItems: null,
        options: options,
        displayOption: _accessor["default"].generateOptionToStringFor('label'),
        filterOption: 'label',
        searchable: true,
        onOptionSelected: toggleSelectedOption,
        customListItemComponent: ListItem
      })))
    }, /*#__PURE__*/_react["default"].createElement(_styledComponents2.Button, {
      tabIndex: -1,
      onBlur: onButtonBlur,
      className: "add-layer-button",
      width: "105px",
      onClick: toggleAddLayerDropdown
    }, /*#__PURE__*/_react["default"].createElement(_icons.Add, {
      height: "12px"
    }), /*#__PURE__*/_react["default"].createElement(_localization.FormattedMessage, {
      id: 'layerManager.addLayer'
    })));
  };

  return AddLayerButton;
}

var _default = AddLayerButtonFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zaWRlLXBhbmVsL2xheWVyLXBhbmVsL2FkZC1sYXllci1idXR0b24udHN4Il0sIm5hbWVzIjpbIkRyb3Bkb3duQ29udGFpbmVyIiwic3R5bGVkIiwiZGl2IiwiYXR0cnMiLCJjbGFzc05hbWUiLCJwcm9wcyIsInRoZW1lIiwic2Vjb25kYXJ5SW5wdXRCb3JkZXJDb2xvciIsIkFkZExheWVyTWVudSIsIkxpc3RJdGVtV3JhcHBlciIsInRleHRDb2xvciIsIlRZUEVBSEVBRF9DTEFTUyIsIlRZUEVBSEVBRF9JTlBVVF9DTEFTUyIsIkFkZExheWVyQnV0dG9uRmFjdG9yeSIsIkxpc3RJdGVtIiwidmFsdWUiLCJjb2xvciIsImxhYmVsIiwiQWRkTGF5ZXJCdXR0b24iLCJkYXRhc2V0cyIsIm9uT3B0aW9uU2VsZWN0ZWQiLCJ0eXBlYWhlYWRQbGFjZWhvbGRlciIsImludGwiLCJzaG93QWRkTGF5ZXJEcm9wZG93biIsInNldFNob3dBZGRMYXllckRyb3Bkb3duIiwidG9nZ2xlQWRkTGF5ZXJEcm9wZG93biIsIl9vbkJsdXIiLCJ0b2dnbGVTZWxlY3RlZE9wdGlvbiIsIm9wdGlvbiIsIm9uQnV0dG9uQmx1ciIsImV2ZW50IiwiZXZlcnkiLCJjbHMiLCJyZWxhdGVkVGFyZ2V0IiwiY2xhc3NMaXN0IiwiY29udGFpbnMiLCJvblNlYXJjaEJsdXIiLCJvcHRpb25zIiwiT2JqZWN0IiwidmFsdWVzIiwibWFwIiwiZHMiLCJpZCIsInJlc3VsdHMiLCJpbnB1dCIsImxpc3RJdGVtIiwiZm9ybWF0TWVzc2FnZSIsIkFjY2Vzc29yIiwiZ2VuZXJhdGVPcHRpb25Ub1N0cmluZ0ZvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBb0JBOztBQUNBOztBQUNBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBVUEsSUFBTUEsaUJBQWlCLEdBQUdDLDZCQUFPQyxHQUFQLENBQVdDLEtBQVgsQ0FBaUI7QUFDekNDLEVBQUFB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QUEsYUFBYSxFQUFFVSxxQkFBU0MseUJBQVQsQ0FBbUMsT0FBbkMsQ0FmakI7QUFnQkUsUUFBQSxZQUFZLEVBQUUsT0FoQmhCO0FBaUJFLFFBQUEsVUFBVSxNQWpCWjtBQWtCRSxRQUFBLGdCQUFnQixFQUFFckIsb0JBbEJwQjtBQW1CRSxRQUFBLHVCQUF1QixFQUFFYjtBQW5CM0IsUUFERixDQURGO0FBUkosb0JBbUNFLGdDQUFDLHlCQUFEO0FBQ0UsTUFBQSxRQUFRLEVBQUUsQ0FBQyxDQURiO0FBRUUsTUFBQSxNQUFNLEVBQUVlLFlBRlY7QUFHRSxNQUFBLFNBQVMsRUFBQyxrQkFIWjtBQUlFLE1BQUEsS0FBSyxFQUFDLE9BSlI7QUFLRSxNQUFBLE9BQU8sRUFBRUo7QUFMWCxvQkFPRSxnQ0FBQyxVQUFEO0FBQUssTUFBQSxNQUFNLEVBQUM7QUFBWixNQVBGLGVBUUUsZ0NBQUMsOEJBQUQ7QUFBa0IsTUFBQSxFQUFFLEVBQUU7QUFBdEIsTUFSRixDQW5DRixDQURGO0FBZ0RELEdBN0ZEOztBQStGQSxTQUFPUCxjQUFQO0FBQ0Q7O2VBRWNMLHFCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDIyIFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cblxuaW1wb3J0IFJlYWN0LCB7dXNlQ2FsbGJhY2ssIHVzZU1lbW8sIHVzZVN0YXRlfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgc3R5bGVkIGZyb20gJ3N0eWxlZC1jb21wb25lbnRzJztcbmltcG9ydCB7Rm9ybWF0dGVkTWVzc2FnZX0gZnJvbSAnQGtlcGxlci5nbC9sb2NhbGl6YXRpb24nO1xuaW1wb3J0IHtXcmFwcGVkQ29tcG9uZW50UHJvcHN9IGZyb20gJ3JlYWN0LWludGwnO1xuXG5pbXBvcnQgVGlwcHkgZnJvbSAnQHRpcHB5anMvcmVhY3QnO1xuaW1wb3J0IHtBZGR9IGZyb20gJy4uLy4uL2NvbW1vbi9pY29ucyc7XG5pbXBvcnQge0J1dHRvbn0gZnJvbSAnLi4vLi4vY29tbW9uL3N0eWxlZC1jb21wb25lbnRzJztcbmltcG9ydCB7RGF0YXNldFNxdWFyZX0gZnJvbSAnLi4vLi4nO1xuaW1wb3J0IFR5cGVhaGVhZCBmcm9tICcuLi8uLi9jb21tb24vaXRlbS1zZWxlY3Rvci90eXBlYWhlYWQnO1xuaW1wb3J0IEFjY2Vzc29yIGZyb20gJy4uLy4uL2NvbW1vbi9pdGVtLXNlbGVjdG9yL2FjY2Vzc29yJztcbmltcG9ydCB7RGF0YXNldHN9IGZyb20gJ0BrZXBsZXIuZ2wvdGFibGUnO1xuaW1wb3J0IHtSR0JDb2xvcn0gZnJvbSAnQGtlcGxlci5nbC90eXBlcyc7XG5cbnR5cGUgQWRkTGF5ZXJCdXR0b25Qcm9wcyA9IHtcbiAgZGF0YXNldHM6IERhdGFzZXRzO1xuICBvbk9wdGlvblNlbGVjdGVkOiAob3B0OiBzdHJpbmcpID0+IHZvaWQ7XG4gIHR5cGVhaGVhZFBsYWNlaG9sZGVyPzogc3RyaW5nO1xufSAmIFdyYXBwZWRDb21wb25lbnRQcm9wcztcblxuY29uc3QgRHJvcGRvd25Db250YWluZXIgPSBzdHlsZWQuZGl2LmF0dHJzKHtcbiAgY2xhc3NOYW1lOiAnYWRkLWxheWVyLW1lbnUtZHJvcGRvd24nXG59KWBcbiAgLmxpc3Qtc2VsZWN0b3Ige1xuICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCAke3Byb3BzID0+IHByb3BzLnRoZW1lLnNlY29uZGFyeUlucHV0Qm9yZGVyQ29sb3J9O1xuICAgIHdpZHRoOiAxMDAlO1xuICAgIC8qIGRpc2FibGUgc2Nyb2xsaW5nLCBjdXJyZW50bHkgc2V0IHRvIDI4MHB4IGludGVybmFsbHkgKi9cbiAgICBtYXgtaGVpZ2h0OiB1bnNldDtcbiAgfVxuXG4gIC5saXN0X19pdGVtID4gZGl2IHtcbiAgICBkaXNwbGF5OiBmbGV4O1xuICAgIGZsZXgtZGlyZWN0aW9uOiByb3c7XG4gICAganVzdGlmeS1jb250ZW50OiBmbGV4LXN0YXJ0O1xuICAgIGxpbmUtaGVpZ2h0OiAxOHB4O1xuICAgIHBhZGRpbmc6IDA7XG5cbiAgICBzdmcge1xuICAgICAgbWFyZ2luLXJpZ2h0OiAxMHB4O1xuICAgIH1cbiAgfVxuYDtcblxuY29uc3QgQWRkTGF5ZXJNZW51ID0gc3R5bGVkLmRpdi5hdHRycyh7XG4gIGNsYXNzTmFtZTogJ2FkZC1sYXllci1tZW51J1xufSlgXG4gIGRpc3BsYXk6IGZsZXg7XG4gIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47XG4gIG1pbi13aWR0aDogMjQwcHg7XG4gIG1heC13aWR0aDogMjQwcHg7XG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgdG9wOiAxMDAlO1xuICBsZWZ0OiAtNTNweDtcbiAgei1pbmRleDogNTtcbmA7XG5cbmNvbnN0IExpc3RJdGVtV3JhcHBlciA9IHN0eWxlZC5kaXYuYXR0cnMoe1xuICBjbGFzc05hbWU6ICdhZGQtbGF5ZXItbWVudS1saXN0LWl0ZW0td3JhcHBlcidcbn0pYFxuICBkaXNwbGF5OiBmbGV4O1xuICBjb2xvcjogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS50ZXh0Q29sb3J9O1xuICBmb250LXNpemU6IDExcHg7XG4gIGxldHRlci1zcGFjaW5nOiAwLjJweDtcbiAgb3ZlcmZsb3c6IGF1dG87XG5cbiAgLmRhdGFzZXQtY29sb3Ige1xuICAgIGZsZXgtc2hyaW5rOiAwO1xuICAgIG1hcmdpbi10b3A6IDNweDtcbiAgfVxuXG4gIC5kYXRhc2V0LW5hbWUge1xuICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7XG4gICAgb3ZlcmZsb3c6IGhpZGRlbjtcbiAgICB0ZXh0LW92ZXJmbG93OiBlbGxpcHNpcztcbiAgfVxuYDtcblxuY29uc3QgVFlQRUFIRUFEX0NMQVNTID0gJ3R5cGVhaGVhZCc7XG5jb25zdCBUWVBFQUhFQURfSU5QVVRfQ0xBU1MgPSAndHlwZWFoZWFkX19pbnB1dCc7XG5cbmZ1bmN0aW9uIEFkZExheWVyQnV0dG9uRmFjdG9yeSgpIHtcbiAgY29uc3QgTGlzdEl0ZW0gPSAoe3ZhbHVlfSkgPT4gKFxuICAgIDxMaXN0SXRlbVdyYXBwZXI+XG4gICAgICA8RGF0YXNldFNxdWFyZSBjbGFzc05hbWU9XCJkYXRhc2V0LWNvbG9yXCIgYmFja2dyb3VuZENvbG9yPXt2YWx1ZS5jb2xvcn0gLz5cbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZGF0YXNldC1uYW1lXCIgdGl0bGU9e3ZhbHVlLmxhYmVsfT5cbiAgICAgICAge3ZhbHVlLmxhYmVsfVxuICAgICAgPC9kaXY+XG4gICAgPC9MaXN0SXRlbVdyYXBwZXI+XG4gICk7XG5cbiAgY29uc3QgQWRkTGF5ZXJCdXR0b246IFJlYWN0LkZDPEFkZExheWVyQnV0dG9uUHJvcHM+ID0gcHJvcHMgPT4ge1xuICAgIGNvbnN0IHtkYXRhc2V0cywgb25PcHRpb25TZWxlY3RlZCwgdHlwZWFoZWFkUGxhY2Vob2xkZXIsIGludGx9ID0gcHJvcHM7XG4gICAgY29uc3QgW3Nob3dBZGRMYXllckRyb3Bkb3duLCBzZXRTaG93QWRkTGF5ZXJEcm9wZG93bl0gPSB1c2VTdGF0ZShmYWxzZSk7XG5cbiAgICBjb25zdCB0b2dnbGVBZGRMYXllckRyb3Bkb3duID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgICAgc2V0U2hvd0FkZExheWVyRHJvcGRvd24oIXNob3dBZGRMYXllckRyb3Bkb3duKTtcbiAgICB9LCBbc2hvd0FkZExheWVyRHJvcGRvd24sIHNldFNob3dBZGRMYXllckRyb3Bkb3duXSk7XG5cbiAgICBjb25zdCBfb25CbHVyID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgICAgc2V0U2hvd0FkZExheWVyRHJvcGRvd24oZmFsc2UpO1xuICAgIH0sIFtdKTtcblxuICAgIGNvbnN0IHRvZ2dsZVNlbGVjdGVkT3B0aW9uID0gdXNlQ2FsbGJhY2soXG4gICAgICAob3B0aW9uOiB7bGFiZWw6IHN0cmluZzsgdmFsdWU6IHN0cmluZzsgY29sb3I6IFJHQkNvbG9yfSkgPT4ge1xuICAgICAgICBvbk9wdGlvblNlbGVjdGVkKG9wdGlvbi52YWx1ZSk7XG4gICAgICAgIF9vbkJsdXIoKTtcbiAgICAgIH0sXG4gICAgICBbb25PcHRpb25TZWxlY3RlZCwgX29uQmx1cl1cbiAgICApO1xuXG4gICAgY29uc3Qgb25CdXR0b25CbHVyID0gdXNlQ2FsbGJhY2soXG4gICAgICBldmVudCA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBbVFlQRUFIRUFEX0NMQVNTLCBUWVBFQUhFQURfSU5QVVRfQ0xBU1NdLmV2ZXJ5KFxuICAgICAgICAgICAgY2xzID0+ICFldmVudD8ucmVsYXRlZFRhcmdldD8uY2xhc3NMaXN0LmNvbnRhaW5zKGNscylcbiAgICAgICAgICApXG4gICAgICAgICkge1xuICAgICAgICAgIF9vbkJsdXIoKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIFtfb25CbHVyXVxuICAgICk7XG5cbiAgICBjb25zdCBvblNlYXJjaEJsdXIgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgICBfb25CbHVyKCk7XG4gICAgfSwgW19vbkJsdXJdKTtcblxuICAgIGNvbnN0IG9wdGlvbnMgPSB1c2VNZW1vKCgpID0+IHtcbiAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKGRhdGFzZXRzKS5tYXAoZHMgPT4gKHtcbiAgICAgICAgbGFiZWw6IGRzLmxhYmVsLFxuICAgICAgICB2YWx1ZTogZHMuaWQsXG4gICAgICAgIGNvbG9yOiBkcy5jb2xvclxuICAgICAgfSkpO1xuICAgIH0sIFtkYXRhc2V0c10pO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxUaXBweVxuICAgICAgICB2aXNpYmxlPXtzaG93QWRkTGF5ZXJEcm9wZG93bn1cbiAgICAgICAgYXJyb3c9e2ZhbHNlfVxuICAgICAgICBpbnRlcmFjdGl2ZVxuICAgICAgICBwbGFjZW1lbnQ9XCJib3R0b21cIlxuICAgICAgICBhcHBlbmRUbz1cInBhcmVudFwiXG4gICAgICAgIGR1cmF0aW9uPXswfVxuICAgICAgICBjb250ZW50PXtcbiAgICAgICAgICA8QWRkTGF5ZXJNZW51PlxuICAgICAgICAgICAgPERyb3Bkb3duQ29udGFpbmVyPlxuICAgICAgICAgICAgICA8VHlwZWFoZWFkXG4gICAgICAgICAgICAgICAgb25CbHVyPXtvblNlYXJjaEJsdXJ9XG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPXtUWVBFQUhFQURfQ0xBU1N9XG4gICAgICAgICAgICAgICAgY3VzdG9tQ2xhc3Nlcz17e1xuICAgICAgICAgICAgICAgICAgcmVzdWx0czogJ2xpc3Qtc2VsZWN0b3InLFxuICAgICAgICAgICAgICAgICAgaW5wdXQ6IFRZUEVBSEVBRF9JTlBVVF9DTEFTUyxcbiAgICAgICAgICAgICAgICAgIGxpc3RJdGVtOiAnbGlzdF9faXRlbSdcbiAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyPXtcbiAgICAgICAgICAgICAgICAgIHR5cGVhaGVhZFBsYWNlaG9sZGVyIHx8IGludGxcbiAgICAgICAgICAgICAgICAgICAgPyBpbnRsLmZvcm1hdE1lc3NhZ2Uoe2lkOiAncGxhY2Vob2xkZXIuc2VhcmNoJ30pXG4gICAgICAgICAgICAgICAgICAgIDogJ1NlYXJjaCdcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc2VsZWN0ZWRJdGVtcz17bnVsbH1cbiAgICAgICAgICAgICAgICBvcHRpb25zPXtvcHRpb25zfVxuICAgICAgICAgICAgICAgIGRpc3BsYXlPcHRpb249e0FjY2Vzc29yLmdlbmVyYXRlT3B0aW9uVG9TdHJpbmdGb3IoJ2xhYmVsJyl9XG4gICAgICAgICAgICAgICAgZmlsdGVyT3B0aW9uPXsnbGFiZWwnfVxuICAgICAgICAgICAgICAgIHNlYXJjaGFibGVcbiAgICAgICAgICAgICAgICBvbk9wdGlvblNlbGVjdGVkPXt0b2dnbGVTZWxlY3RlZE9wdGlvbn1cbiAgICAgICAgICAgICAgICBjdXN0b21MaXN0SXRlbUNvbXBvbmVudD17TGlzdEl0ZW19XG4gICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICA8L0Ryb3Bkb3duQ29udGFpbmVyPlxuICAgICAgICAgIDwvQWRkTGF5ZXJNZW51PlxuICAgICAgICB9XG4gICAgICA+XG4gICAgICAgIDxCdXR0b25cbiAgICAgICAgICB0YWJJbmRleD17LTF9XG4gICAgICAgICAgb25CbHVyPXtvbkJ1dHRvbkJsdXJ9XG4gICAgICAgICAgY2xhc3NOYW1lPVwiYWRkLWxheWVyLWJ1dHRvblwiXG4gICAgICAgICAgd2lkdGg9XCIxMDVweFwiXG4gICAgICAgICAgb25DbGljaz17dG9nZ2xlQWRkTGF5ZXJEcm9wZG93bn1cbiAgICAgICAgPlxuICAgICAgICAgIDxBZGQgaGVpZ2h0PVwiMTJweFwiIC8+XG4gICAgICAgICAgPEZvcm1hdHRlZE1lc3NhZ2UgaWQ9eydsYXllck1hbmFnZXIuYWRkTGF5ZXInfSAvPlxuICAgICAgICA8L0J1dHRvbj5cbiAgICAgIDwvVGlwcHk+XG4gICAgKTtcbiAgfTtcblxuICByZXR1cm4gQWRkTGF5ZXJCdXR0b247XG59XG5cbmV4cG9ydCBkZWZhdWx0IEFkZExheWVyQnV0dG9uRmFjdG9yeTtcbiJdfQ==