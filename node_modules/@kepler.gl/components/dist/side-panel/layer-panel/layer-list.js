// Copyright (c) 2022 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _classnames = _interopRequireDefault(require("classnames"));

var _reactSortableHoc = require("react-sortable-hoc");

var _layerPanel = _interopRequireDefault(require("./layer-panel"));

var _utils = require("@kepler.gl/utils");

var _templateObject;

// make sure the element is always visible while is being dragged
// item being dragged is appended in body, here to reset its global style
var SortableStyledItem = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  z-index: ", ";\n  &.sorting {\n    pointer-events: none;\n  }\n  &.sorting-layers .layer-panel__header {\n    background-color: ", ";\n    font-family: ", ";\n    font-weight: ", ";\n    font-size: ", ";\n    line-height: ", ";\n    *,\n    *:before,\n    *:after {\n      box-sizing: border-box;\n    }\n    .layer__drag-handle {\n      opacity: 1;\n      color: ", ";\n    }\n  }\n"])), function (props) {
  return props.theme.dropdownWrapperZ + 1;
}, function (props) {
  return props.theme.panelBackgroundHover;
}, function (props) {
  return props.theme.fontFamily;
}, function (props) {
  return props.theme.fontWeight;
}, function (props) {
  return props.theme.fontSize;
}, function (props) {
  return props.theme.lineHeight;
}, function (props) {
  return props.theme.textColorHl;
});

LayerListFactory.deps = [_layerPanel["default"]];

function LayerListFactory(LayerPanel) {
  // By wrapping layer panel using a sortable element we don't have to implement the drag and drop logic into the panel itself;
  // Developers can provide any layer panel implementation and it will still be sortable
  var SortableItem = (0, _reactSortableHoc.SortableElement)(function (_ref) {
    var children = _ref.children,
        isSorting = _ref.isSorting;
    return /*#__PURE__*/_react["default"].createElement(SortableStyledItem, {
      className: (0, _classnames["default"])('sortable-layer-items', {
        sorting: isSorting
      })
    }, children);
  });
  var WrappedSortableContainer = (0, _reactSortableHoc.SortableContainer)(function (_ref2) {
    var children = _ref2.children;
    return /*#__PURE__*/_react["default"].createElement("div", null, children);
  });

  var LayerList = function LayerList(props) {
    var layers = props.layers,
        datasets = props.datasets,
        layerOrder = props.layerOrder,
        uiStateActions = props.uiStateActions,
        visStateActions = props.visStateActions,
        layerClasses = props.layerClasses,
        _props$isSortable = props.isSortable,
        isSortable = _props$isSortable === void 0 ? true : _props$isSortable;
    var openModal = uiStateActions.toggleModal;

    var _useState = (0, _react.useState)(false),
        _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
        isSorting = _useState2[0],
        setIsSorting = _useState2[1];

    var layerTypeOptions = (0, _react.useMemo)(function () {
      return Object.keys(layerClasses).map(function (key) {
        var layer = new layerClasses[key]();
        return {
          id: key,
          label: layer.name,
          icon: layer.layerIcon,
          requireData: layer.requireData
        };
      });
    }, [layerClasses]);
    var layerActions = {
      layerColorUIChange: visStateActions.layerColorUIChange,
      layerConfigChange: visStateActions.layerConfigChange,
      layerVisualChannelConfigChange: visStateActions.layerVisualChannelConfigChange,
      layerTypeChange: visStateActions.layerTypeChange,
      layerVisConfigChange: visStateActions.layerVisConfigChange,
      layerTextLabelChange: visStateActions.layerTextLabelChange,
      removeLayer: visStateActions.removeLayer,
      duplicateLayer: visStateActions.duplicateLayer
    };
    var panelProps = {
      datasets: datasets,
      openModal: openModal,
      layerTypeOptions: layerTypeOptions
    };

    var _handleSort = (0, _react.useCallback)(function (_ref3) {
      var oldIndex = _ref3.oldIndex,
          newIndex = _ref3.newIndex;
      visStateActions.reorderLayer((0, _utils.arrayMove)(props.layerOrder, oldIndex, newIndex));
      setIsSorting(false);
    }, [props.layerOrder, visStateActions]);

    var _onSortStart = (0, _react.useCallback)(function () {
      setIsSorting(true);
    }, []);

    var _updateBeforeSortStart = (0, _react.useCallback)(function () {
      (function (_ref4) {
        var index = _ref4.index;
        var layerIdx = layerOrder[index];

        if (layers[layerIdx].config.isConfigActive) {
          visStateActions.layerConfigChange(layers[layerIdx], {
            isConfigActive: false
          });
        }
      });
    }, [layers, layerOrder, visStateActions]);

    return isSortable ? /*#__PURE__*/_react["default"].createElement(WrappedSortableContainer, {
      onSortEnd: _handleSort,
      onSortStart: _onSortStart,
      updateBeforeSortStart: _updateBeforeSortStart,
      lockAxis: "y",
      helperClass: "sorting-layers",
      useDragHandle: true
    }, layerOrder.map(function (layerIdx, index) {
      return layers[layerIdx] && !layers[layerIdx].config.hidden && /*#__PURE__*/_react["default"].createElement(SortableItem, {
        key: "layer-".concat(layerIdx),
        index: index,
        isSorting: isSorting
      }, /*#__PURE__*/_react["default"].createElement(LayerPanel, (0, _extends2["default"])({}, panelProps, layerActions, {
        key: layers[layerIdx].id,
        idx: layerIdx,
        layer: layers[layerIdx]
      })));
    })) : /*#__PURE__*/_react["default"].createElement(_react["default"].Fragment, null, layerOrder.map(function (layerIdx, index) {
      return layers[layerIdx] && !layers[layerIdx].config.hidden && /*#__PURE__*/_react["default"].createElement(LayerPanel, (0, _extends2["default"])({}, panelProps, layerActions, {
        key: layers[layerIdx].id,
        idx: layerIdx,
        layer: layers[layerIdx],
        isDraggable: false
      }));
    }));
  };

  return LayerList;
}

var _default = LayerListFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zaWRlLXBhbmVsL2xheWVyLXBhbmVsL2xheWVyLWxpc3QudHN4Il0sIm5hbWVzIjpbIlNvcnRhYmxlU3R5bGVkSXRlbSIsInN0eWxlZCIsImRpdiIsInByb3BzIiwidGhlbWUiLCJkcm9wZG93bldyYXBwZXJaIiwicGFuZWxCYWNrZ3JvdW5kSG92ZXIiLCJmb250RmFtaWx5IiwiZm9udFdlaWdodCIsImZvbnRTaXplIiwibGluZUhlaWdodCIsInRleHRDb2xvckhsIiwiTGF5ZXJMaXN0RmFjdG9yeSIsImRlcHMiLCJMYXllclBhbmVsRmFjdG9yeSIsIkxheWVyUGFuZWwiLCJTb3J0YWJsZUl0ZW0iLCJjaGlsZHJlbiIsImlzU29ydGluZyIsInNvcnRpbmciLCJXcmFwcGVkU29ydGFibGVDb250YWluZXIiLCJMYXllckxpc3QiLCJsYXllcnMiLCJkYXRhc2V0cyIsImxheWVyT3JkZXIiLCJ1aVN0YXRlQWN0aW9ucyIsInZpc1N0YXRlQWN0aW9ucyIsImxheWVyQ2xhc3NlcyIsImlzU29ydGFibGUiLCJvcGVuTW9kYWwiLCJ0b2dnbGVNb2RhbCIsInNldElzU29ydGluZyIsImxheWVyVHlwZU9wdGlvbnMiLCJPYmplY3QiLCJrZXlzIiwibWFwIiwia2V5IiwibGF5ZXIiLCJpZCIsImxhYmVsIiwibmFtZSIsImljb24iLCJsYXllckljb24iLCJyZXF1aXJlRGF0YSIsImxheWVyQWN0aW9ucyIsImxheWVyQ29sb3JVSUNoYW5nZSIsImxheWVyQ29uZmlnQ2hhbmdlIiwibGF5ZXJWaXN1YWxDaGFubmVsQ29uZmlnQ2hhbmdlIiwibGF5ZXJUeXBlQ2hhbmdlIiwibGF5ZXJWaXNDb25maWdDaGFuZ2UiLCJsYXllclRleHRMYWJlbENoYW5nZSIsInJlbW92ZUxheWVyIiwiZHVwbGljYXRlTGF5ZXIiLCJwYW5lbFByb3BzIiwiX2hhbmRsZVNvcnQiLCJvbGRJbmRleCIsIm5ld0luZGV4IiwicmVvcmRlckxheWVyIiwiX29uU29ydFN0YXJ0IiwiX3VwZGF0ZUJlZm9yZVNvcnRTdGFydCIsImluZGV4IiwibGF5ZXJJZHgiLCJjb25maWciLCJpc0NvbmZpZ0FjdGl2ZSIsImhpZGRlbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFvQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7Ozs7QUFhQTtBQUNBO0FBQ0EsSUFBTUEsa0JBQWtCLEdBQUdDLDZCQUFPQyxHQUFWLDBkQUNYLFVBQUFDLEtBQUs7QUFBQSxTQUFJQSxLQUFLLENBQUNDLEtBQU4sQ0FBWUMsZ0JBQVosR0FBK0IsQ0FBbkM7QUFBQSxDQURNLEVBTUEsVUFBQUYsS0FBSztBQUFBLFNBQUlBLEtBQUssQ0FBQ0MsS0FBTixDQUFZRSxvQkFBaEI7QUFBQSxDQU5MLEVBT0wsVUFBQUgsS0FBSztBQUFBLFNBQUlBLEtBQUssQ0FBQ0MsS0FBTixDQUFZRyxVQUFoQjtBQUFBLENBUEEsRUFRTCxVQUFBSixLQUFLO0FBQUEsU0FBSUEsS0FBSyxDQUFDQyxLQUFOLENBQVlJLFVBQWhCO0FBQUEsQ0FSQSxFQVNQLFVBQUFMLEtBQUs7QUFBQSxTQUFJQSxLQUFLLENBQUNDLEtBQU4sQ0FBWUssUUFBaEI7QUFBQSxDQVRFLEVBVUwsVUFBQU4sS0FBSztBQUFBLFNBQUlBLEtBQUssQ0FBQ0MsS0FBTixDQUFZTSxVQUFoQjtBQUFBLENBVkEsRUFrQlQsVUFBQVAsS0FBSztBQUFBLFNBQUlBLEtBQUssQ0FBQ0MsS0FBTixDQUFZTyxXQUFoQjtBQUFBLENBbEJJLENBQXhCOztBQXVCQUMsZ0JBQWdCLENBQUNDLElBQWpCLEdBQXdCLENBQUNDLHNCQUFELENBQXhCOztBQUVBLFNBQVNGLGdCQUFULENBQTBCRyxVQUExQixFQUE0RTtBQUMxRTtBQUNBO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLHVDQUFnQixnQkFBMkI7QUFBQSxRQUF6QkMsUUFBeUIsUUFBekJBLFFBQXlCO0FBQUEsUUFBZkMsU0FBZSxRQUFmQSxTQUFlO0FBQzlELHdCQUNFLGdDQUFDLGtCQUFEO0FBQW9CLE1BQUEsU0FB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Q0FBQyxZQUFEO0FBQWMsUUFBQSxHQUFHLGtCQUFXSCxRQUFYLENBQWpCO0FBQXdDLFFBQUEsS0FBSyxFQUFFRCxLQUEvQztBQUFzRCxRQUFBLFNBQVMsRUFBRTFDO0FBQWpFLHNCQUNFLGdDQUFDLFVBQUQsZ0NBQ01tQyxVQUROLEVBRU1ULFlBRk47QUFHRSxRQUFBLEdBQUcsRUFBRXRCLE1BQU0sQ0FBQ3VDLFFBQUQsQ0FBTixDQUFpQnZCLEVBSHhCO0FBSUUsUUFBQSxHQUFHLEVBQUV1QixRQUpQO0FBS0UsUUFBQSxLQUFLLEVBQUV2QyxNQUFNLENBQUN1QyxRQUFEO0FBTGYsU0FERixDQUhKO0FBQUEsS0FERCxDQVJILENBRGUsZ0JBMEJmLGtFQUNHckMsVUFBVSxDQUFDVyxHQUFYLENBQ0MsVUFBQzBCLFFBQUQsRUFBV0QsS0FBWDtBQUFBLGFBQ0V0QyxNQUFNLENBQUN1QyxRQUFELENBQU4sSUFDQSxDQUFDdkMsTUFBTSxDQUFDdUMsUUFBRCxDQUFOLENBQWlCQyxNQUFqQixDQUF3QkUsTUFEekIsaUJBRUUsZ0NBQUMsVUFBRCxnQ0FDTVgsVUFETixFQUVNVCxZQUZOO0FBR0UsUUFBQSxHQUFHLEVBQUV0QixNQUFNLENBQUN1QyxRQUFELENBQU4sQ0FBaUJ2QixFQUh4QjtBQUlFLFFBQUEsR0FBRyxFQUFFdUIsUUFKUDtBQUtFLFFBQUEsS0FBSyxFQUFFdkMsTUFBTSxDQUFDdUMsUUFBRCxDQUxmO0FBTUUsUUFBQSxXQUFXLEVBQUU7QUFOZixTQUhKO0FBQUEsS0FERCxDQURILENBMUJGO0FBMkNELEdBeEdEOztBQXlHQSxTQUFPeEMsU0FBUDtBQUNEOztlQUNjVCxnQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgMjAyMiBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbmltcG9ydCBSZWFjdCwge3VzZUNhbGxiYWNrLCB1c2VNZW1vLCB1c2VTdGF0ZX0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQgY2xhc3NuYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCB7U29ydGFibGVDb250YWluZXIsIFNvcnRhYmxlRWxlbWVudH0gZnJvbSAncmVhY3Qtc29ydGFibGUtaG9jJztcbmltcG9ydCBMYXllclBhbmVsRmFjdG9yeSBmcm9tICcuL2xheWVyLXBhbmVsJztcbmltcG9ydCB7TGF5ZXIsIExheWVyQ2xhc3Nlc1R5cGV9IGZyb20gJ0BrZXBsZXIuZ2wvbGF5ZXJzJztcbmltcG9ydCB7RGF0YXNldHN9IGZyb20gJ0BrZXBsZXIuZ2wvdGFibGUnO1xuaW1wb3J0IHthcnJheU1vdmV9IGZyb20gJ0BrZXBsZXIuZ2wvdXRpbHMnO1xuaW1wb3J0IHtVSVN0YXRlQWN0aW9ucywgVmlzU3RhdGVBY3Rpb25zfSBmcm9tICdAa2VwbGVyLmdsL2FjdGlvbnMnO1xuXG50eXBlIExheWVyTGlzdFByb3BzID0ge1xuICBkYXRhc2V0czogRGF0YXNldHM7XG4gIGxheWVyczogTGF5ZXJbXTtcbiAgbGF5ZXJPcmRlcjogbnVtYmVyW107XG4gIGxheWVyQ2xhc3NlczogTGF5ZXJDbGFzc2VzVHlwZTtcbiAgaXNTb3J0YWJsZT86IGJvb2xlYW47XG4gIHVpU3RhdGVBY3Rpb25zOiB0eXBlb2YgVUlTdGF0ZUFjdGlvbnM7XG4gIHZpc1N0YXRlQWN0aW9uczogdHlwZW9mIFZpc1N0YXRlQWN0aW9ucztcbn07XG5cbi8vIG1ha2Ugc3VyZSB0aGUgZWxlbWVudCBpcyBhbHdheXMgdmlzaWJsZSB3aGlsZSBpcyBiZWluZyBkcmFnZ2VkXG4vLyBpdGVtIGJlaW5nIGRyYWdnZWQgaXMgYXBwZW5kZWQgaW4gYm9keSwgaGVyZSB0byByZXNldCBpdHMgZ2xvYmFsIHN0eWxlXG5jb25zdCBTb3J0YWJsZVN0eWxlZEl0ZW0gPSBzdHlsZWQuZGl2YFxuICB6LWluZGV4OiAke3Byb3BzID0+IHByb3BzLnRoZW1lLmRyb3Bkb3duV3JhcHBlclogKyAxfTtcbiAgJi5zb3J0aW5nIHtcbiAgICBwb2ludGVyLWV2ZW50czogbm9uZTtcbiAgfVxuICAmLnNvcnRpbmctbGF5ZXJzIC5sYXllci1wYW5lbF9faGVhZGVyIHtcbiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLnBhbmVsQmFja2dyb3VuZEhvdmVyfTtcbiAgICBmb250LWZhbWlseTogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5mb250RmFtaWx5fTtcbiAgICBmb250LXdlaWdodDogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5mb250V2VpZ2h0fTtcbiAgICBmb250LXNpemU6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuZm9udFNpemV9O1xuICAgIGxpbmUtaGVpZ2h0OiAke3Byb3BzID0+IHByb3BzLnRoZW1lLmxpbmVIZWlnaHR9O1xuICAgICosXG4gICAgKjpiZWZvcmUsXG4gICAgKjphZnRlciB7XG4gICAgICBib3gtc2l6aW5nOiBib3JkZXItYm94O1xuICAgIH1cbiAgICAubGF5ZXJfX2RyYWctaGFuZGxlIHtcbiAgICAgIG9wYWNpdHk6IDE7XG4gICAgICBjb2xvcjogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS50ZXh0Q29sb3JIbH07XG4gICAgfVxuICB9XG5gO1xuXG5MYXllckxpc3RGYWN0b3J5LmRlcHMgPSBbTGF5ZXJQYW5lbEZhY3RvcnldO1xuXG5mdW5jdGlvbiBMYXllckxpc3RGYWN0b3J5KExheWVyUGFuZWw6IFJldHVyblR5cGU8dHlwZW9mIExheWVyUGFuZWxGYWN0b3J5Pikge1xuICAvLyBCeSB3cmFwcGluZyBsYXllciBwYW5lbCB1c2luZyBhIHNvcnRhYmxlIGVsZW1lbnQgd2UgZG9uJ3QgaGF2ZSB0byBpbXBsZW1lbnQgdGhlIGRyYWcgYW5kIGRyb3AgbG9naWMgaW50byB0aGUgcGFuZWwgaXRzZWxmO1xuICAvLyBEZXZlbG9wZXJzIGNhbiBwcm92aWRlIGFueSBsYXllciBwYW5lbCBpbXBsZW1lbnRhdGlvbiBhbmQgaXQgd2lsbCBzdGlsbCBiZSBzb3J0YWJsZVxuICBjb25zdCBTb3J0YWJsZUl0ZW0gPSBTb3J0YWJsZUVsZW1lbnQoKHtjaGlsZHJlbiwgaXNTb3J0aW5nfSkgPT4ge1xuICAgIHJldHVybiAoXG4gICAgICA8U29ydGFibGVTdHlsZWRJdGVtIGNsYXNzTmFtZT17Y2xhc3NuYW1lcygnc29ydGFibGUtbGF5ZXItaXRlbXMnLCB7c29ydGluZzogaXNTb3J0aW5nfSl9PlxuICAgICAgICB7Y2hpbGRyZW59XG4gICAgICA8L1NvcnRhYmxlU3R5bGVkSXRlbT5cbiAgICApO1xuICB9KTtcblxuICBjb25zdCBXcmFwcGVkU29ydGFibGVDb250YWluZXIgPSBTb3J0YWJsZUNvbnRhaW5lcigoe2NoaWxkcmVufSkgPT4ge1xuICAgIHJldHVybiA8ZGl2PntjaGlsZHJlbn08L2Rpdj47XG4gIH0pO1xuXG4gIGNvbnN0IExheWVyTGlzdDogUmVhY3QuRkM8TGF5ZXJMaXN0UHJvcHM+ID0gcHJvcHMgPT4ge1xuICAgIGNvbnN0IHtcbiAgICAgIGxheWVycyxcbiAgICAgIGRhdGFzZXRzLFxuICAgICAgbGF5ZXJPcmRlcixcbiAgICAgIHVpU3RhdGVBY3Rpb25zLFxuICAgICAgdmlzU3RhdGVBY3Rpb25zLFxuICAgICAgbGF5ZXJDbGFzc2VzLFxuICAgICAgaXNTb3J0YWJsZSA9IHRydWVcbiAgICB9ID0gcHJvcHM7XG4gICAgY29uc3Qge3RvZ2dsZU1vZGFsOiBvcGVuTW9kYWx9ID0gdWlTdGF0ZUFjdGlvbnM7XG4gICAgY29uc3QgW2lzU29ydGluZywgc2V0SXNTb3J0aW5nXSA9IHVzZVN0YXRlKGZhbHNlKTtcbiAgICBjb25zdCBsYXllclR5cGVPcHRpb25zID0gdXNlTWVtbyhcbiAgICAgICgpID0+XG4gICAgICAgIE9iamVjdC5rZXlzKGxheWVyQ2xhc3NlcykubWFwKGtleSA9PiB7XG4gICAgICAgICAgY29uc3QgbGF5ZXIgPSBuZXcgbGF5ZXJDbGFzc2VzW2tleV0oKTtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaWQ6IGtleSxcbiAgICAgICAgICAgIGxhYmVsOiBsYXllci5uYW1lLFxuICAgICAgICAgICAgaWNvbjogbGF5ZXIubGF5ZXJJY29uLFxuICAgICAgICAgICAgcmVxdWlyZURhdGE6IGxheWVyLnJlcXVpcmVEYXRhXG4gICAgICAgICAgfTtcbiAgICAgICAgfSksXG4gICAgICBbbGF5ZXJDbGFzc2VzXVxuICAgICk7XG5cbiAgICBjb25zdCBsYXllckFjdGlvbnMgPSB7XG4gICAgICBsYXllckNvbG9yVUlDaGFuZ2U6IHZpc1N0YXRlQWN0aW9ucy5sYXllckNvbG9yVUlDaGFuZ2UsXG4gICAgICBsYXllckNvbmZpZ0NoYW5nZTogdmlzU3RhdGVBY3Rpb25zLmxheWVyQ29uZmlnQ2hhbmdlLFxuICAgICAgbGF5ZXJWaXN1YWxDaGFubmVsQ29uZmlnQ2hhbmdlOiB2aXNTdGF0ZUFjdGlvbnMubGF5ZXJWaXN1YWxDaGFubmVsQ29uZmlnQ2hhbmdlLFxuICAgICAgbGF5ZXJUeXBlQ2hhbmdlOiB2aXNTdGF0ZUFjdGlvbnMubGF5ZXJUeXBlQ2hhbmdlLFxuICAgICAgbGF5ZXJWaXNDb25maWdDaGFuZ2U6IHZpc1N0YXRlQWN0aW9ucy5sYXllclZpc0NvbmZpZ0NoYW5nZSxcbiAgICAgIGxheWVyVGV4dExhYmVsQ2hhbmdlOiB2aXNTdGF0ZUFjdGlvbnMubGF5ZXJUZXh0TGFiZWxDaGFuZ2UsXG4gICAgICByZW1vdmVMYXllcjogdmlzU3RhdGVBY3Rpb25zLnJlbW92ZUxheWVyLFxuICAgICAgZHVwbGljYXRlTGF5ZXI6IHZpc1N0YXRlQWN0aW9ucy5kdXBsaWNhdGVMYXllclxuICAgIH07XG5cbiAgICBjb25zdCBwYW5lbFByb3BzID0ge1xuICAgICAgZGF0YXNldHMsXG4gICAgICBvcGVuTW9kYWwsXG4gICAgICBsYXllclR5cGVPcHRpb25zXG4gICAgfTtcblxuICAgIGNvbnN0IF9oYW5kbGVTb3J0ID0gdXNlQ2FsbGJhY2soXG4gICAgICAoe29sZEluZGV4LCBuZXdJbmRleH0pID0+IHtcbiAgICAgICAgdmlzU3RhdGVBY3Rpb25zLnJlb3JkZXJMYXllcihhcnJheU1vdmUocHJvcHMubGF5ZXJPcmRlciwgb2xkSW5kZXgsIG5ld0luZGV4KSk7XG4gICAgICAgIHNldElzU29ydGluZyhmYWxzZSk7XG4gICAgICB9LFxuICAgICAgW3Byb3BzLmxheWVyT3JkZXIsIHZpc1N0YXRlQWN0aW9uc11cbiAgICApO1xuICAgIGNvbnN0IF9vblNvcnRTdGFydCA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICAgIHNldElzU29ydGluZyh0cnVlKTtcbiAgICB9LCBbXSk7XG4gICAgY29uc3QgX3VwZGF0ZUJlZm9yZVNvcnRTdGFydCA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICAgICh7aW5kZXh9KSA9PiB7XG4gICAgICAgIGNvbnN0IGxheWVySWR4ID0gbGF5ZXJPcmRlcltpbmRleF07XG4gICAgICAgIGlmIChsYXllcnNbbGF5ZXJJZHhdLmNvbmZpZy5pc0NvbmZpZ0FjdGl2ZSkge1xuICAgICAgICAgIHZpc1N0YXRlQWN0aW9ucy5sYXllckNvbmZpZ0NoYW5nZShsYXllcnNbbGF5ZXJJZHhdLCB7aXNDb25maWdBY3RpdmU6IGZhbHNlfSk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfSwgW2xheWVycywgbGF5ZXJPcmRlciwgdmlzU3RhdGVBY3Rpb25zXSk7XG4gICAgcmV0dXJuIGlzU29ydGFibGUgPyAoXG4gICAgICA8V3JhcHBlZFNvcnRhYmxlQ29udGFpbmVyXG4gICAgICAgIG9uU29ydEVuZD17X2hhbmRsZVNvcnR9XG4gICAgICAgIG9uU29ydFN0YXJ0PXtfb25Tb3J0U3RhcnR9XG4gICAgICAgIHVwZGF0ZUJlZm9yZVNvcnRTdGFydD17X3VwZGF0ZUJlZm9yZVNvcnRTdGFydH1cbiAgICAgICAgbG9ja0F4aXM9XCJ5XCJcbiAgICAgICAgaGVscGVyQ2xhc3M9XCJzb3J0aW5nLWxheWVyc1wiXG4gICAgICAgIHVzZURyYWdIYW5kbGVcbiAgICAgID5cbiAgICAgICAge2xheWVyT3JkZXIubWFwKFxuICAgICAgICAgIChsYXllcklkeCwgaW5kZXgpID0+XG4gICAgICAgICAgICBsYXllcnNbbGF5ZXJJZHhdICYmXG4gICAgICAgICAgICAhbGF5ZXJzW2xheWVySWR4XS5jb25maWcuaGlkZGVuICYmIChcbiAgICAgICAgICAgICAgPFNvcnRhYmxlSXRlbSBrZXk9e2BsYXllci0ke2xheWVySWR4fWB9IGluZGV4PXtpbmRleH0gaXNTb3J0aW5nPXtpc1NvcnRpbmd9PlxuICAgICAgICAgICAgICAgIDxMYXllclBhbmVsXG4gICAgICAgICAgICAgICAgICB7Li4ucGFuZWxQcm9wc31cbiAgICAgICAgICAgICAgICAgIHsuLi5sYXllckFjdGlvbnN9XG4gICAgICAgICAgICAgICAgICBrZXk9e2xheWVyc1tsYXllcklkeF0uaWR9XG4gICAgICAgICAgICAgICAgICBpZHg9e2xheWVySWR4fVxuICAgICAgICAgICAgICAgICAgbGF5ZXI9e2xheWVyc1tsYXllcklkeF19XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgPC9Tb3J0YWJsZUl0ZW0+XG4gICAgICAgICAgICApXG4gICAgICAgICl9XG4gICAgICA8L1dyYXBwZWRTb3J0YWJsZUNvbnRhaW5lcj5cbiAgICApIDogKFxuICAgICAgPD5cbiAgICAgICAge2xheWVyT3JkZXIubWFwKFxuICAgICAgICAgIChsYXllcklkeCwgaW5kZXgpID0+XG4gICAgICAgICAgICBsYXllcnNbbGF5ZXJJZHhdICYmXG4gICAgICAgICAgICAhbGF5ZXJzW2xheWVySWR4XS5jb25maWcuaGlkZGVuICYmIChcbiAgICAgICAgICAgICAgPExheWVyUGFuZWxcbiAgICAgICAgICAgICAgICB7Li4ucGFuZWxQcm9wc31cbiAgICAgICAgICAgICAgICB7Li4ubGF5ZXJBY3Rpb25zfVxuICAgICAgICAgICAgICAgIGtleT17bGF5ZXJzW2xheWVySWR4XS5pZH1cbiAgICAgICAgICAgICAgICBpZHg9e2xheWVySWR4fVxuICAgICAgICAgICAgICAgIGxheWVyPXtsYXllcnNbbGF5ZXJJZHhdfVxuICAgICAgICAgICAgICAgIGlzRHJhZ2dhYmxlPXtmYWxzZX1cbiAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgIClcbiAgICAgICAgKX1cbiAgICAgIDwvPlxuICAgICk7XG4gIH07XG4gIHJldHVybiBMYXllckxpc3Q7XG59XG5leHBvcnQgZGVmYXVsdCBMYXllckxpc3RGYWN0b3J5O1xuIl19