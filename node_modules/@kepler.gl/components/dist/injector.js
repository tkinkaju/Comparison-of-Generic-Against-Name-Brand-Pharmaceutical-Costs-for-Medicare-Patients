// Copyright (c) 2022 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.injector = injector;
exports.flattenDeps = flattenDeps;
exports.provideRecipesToInjector = provideRecipesToInjector;
exports.typeCheckRecipe = typeCheckRecipe;
exports.withState = withState;
exports.ERROR_MSG = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _react = _interopRequireDefault(require("react"));

var _reactRedux = require("react-redux");

var _redux = require("redux");

var _window = require("global/window");

var _context = _interopRequireDefault(require("./context"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var MissingComp = function MissingComp() {
  return /*#__PURE__*/_react["default"].createElement("div", null);
};

var ERROR_MSG = {
  wrongRecipeType: "injectComponents takes an array of factories replacement pairs as input, " + "each pair be a array as [originalFactory, replacement].",
  noDep: function noDep(fac, parent) {
    return "".concat(fac.name, " is required as a dependency of ").concat(parent.name, ", ") + "but is not provided to injectComponents. It will not be rendered.";
  },
  notFunc: 'factory and its replacement should be a function'
};
exports.ERROR_MSG = ERROR_MSG;

function injector() {
  var map = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : new Map();
  var cache = new Map(); // map<factory, factory -> ?>

  var get = function get(fac, parent) {
    var factory = map.get(fac); // factory is not injected

    if (!factory) {
      _window.console.error(ERROR_MSG.noDep(fac, parent));

      return MissingComp;
    } // check if custom factory deps is declared


    var instances = cache.get(factory) || factory.apply(void 0, (0, _toConsumableArray2["default"])(factory.deps ? factory.deps.map(function (dep) {
      return get(dep, factory);
    }) : []));
    cache.set(fac, instances);
    return instances;
  }; // if you have two functions that happen to have the exactly same text
  // it will be override: 2018-02-05


  return {
    provide: function provide(factory, replacement) {
      if (!typeCheckRecipe([factory, replacement])) {
        return injector(map);
      }

      return injector(new Map(map).set(factory, replacement));
    },
    get: get
  };
} // entryPoint


function flattenDeps(allDeps, factory) {
  var addToDeps = allDeps.concat([factory]);
  return Array.isArray(factory.deps) && factory.deps.length ? factory.deps.reduce(function (accu, dep) {
    return flattenDeps(accu, dep);
  }, addToDeps) : addToDeps;
}

function provideRecipesToInjector(recipes, appInjector) {
  var provided = new Map();
  return recipes.reduce(function (inj, recipe) {
    var _inj;

    if (!typeCheckRecipe(recipe)) {
      return inj;
    } // collect dependencies of custom factories, if there is any.
    // Add them to the appInjector


    var customDependencies = flattenDeps([], recipe[1]);
    inj = customDependencies.reduce(function (ij, factory) {
      if (provided.get(factory)) {
        _window.console.warn("".concat(factory.name, " already injected from ").concat(provided.get(factory).name, ", injecting ").concat(recipe[0].name, " after ").concat(provided.get(factory).name, " will override it"));
      }

      return ij.provide(factory, factory);
    }, inj);
    provided.set(recipe[0], recipe[1]);
    return (_inj = inj).provide.apply(_inj, (0, _toConsumableArray2["default"])(recipe));
  }, appInjector);
}

function typeCheckRecipe(recipe) {
  if (!Array.isArray(recipe) || recipe.length < 2) {
    _window.console.error('Error injecting [factory, replacement]', recipe);

    _window.console.error(ERROR_MSG.wrongRecipeType);

    return false;
  }

  var _recipe = (0, _slicedToArray2["default"])(recipe, 2),
      factory = _recipe[0],
      replacement = _recipe[1];

  if (typeof factory !== 'function') {
    _window.console.error('Error injecting factory: ', factory);

    _window.console.error(ERROR_MSG.notFunc);

    return false;
  } else if (typeof replacement !== 'function') {
    _window.console.error('Error injecting replacement for: ', factory);

    _window.console.error(ERROR_MSG.notFunc);

    return false;
  }

  return true;
}

var identity = function identity(state) {
  return state;
}; // Helper to add reducer state to custom component


function withState() {
  var lenses = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var mapStateToProps = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : identity;
  var actions = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};
  return function (Component) {
    var WrappedComponent = function WrappedComponent(_ref) {
      var state = _ref.state,
          props = (0, _objectWithoutProperties2["default"])(_ref, ["state"]);
      return /*#__PURE__*/_react["default"].createElement(_context["default"].Consumer, null, function (context) {
        return /*#__PURE__*/_react["default"].createElement(Component, lenses.reduce(function (totalState, lens) {
          return _objectSpread(_objectSpread({}, totalState), lens(context.selector(state)));
        }, props));
      });
    };

    return (0, _reactRedux.connect)(function (state) {
      return _objectSpread(_objectSpread({}, mapStateToProps(state)), {}, {
        state: state
      });
    }, function (dispatch) {
      return Object.keys(actions).reduce(function (accu, key) {
        return _objectSpread(_objectSpread({}, accu), {}, (0, _defineProperty2["default"])({}, key, (0, _redux.bindActionCreators)(actions[key], dispatch)));
      }, {});
    })(WrappedComponent);
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmplY3Rvci50c3giXSwibmFtZXMiOlsiTWlzc2luZ0NvbXAiLCJFUlJPUl9NU0ciLCJ3cm9uZ1JlY2lwZVR5cGUiLCJub0RlcCIsImZhYyIsInBhcmVudCIsIm5hbWUiLCJub3RGdW5jIiwiaW5qZWN0b3IiLCJtYXAiLCJNYXAiLCJjYWNoZSIsImdldCIsImZhY3RvcnkiLCJDb25zb2xlIiwiZXJyb3IiLCJpbnN0YW5jZXMiLCJkZXBzIiwiZGVwIiwic2V0IiwicHJvdmlkZSIsInJlcGxhY2VtZW50IiwidHlwZUNoZWNrUmVjaXBlIiwiZmxhdHRlbkRlcHMiLCJhbGxEZXBzIiwiYWRkVG9EZXBzIiwiY29uY2F0IiwiQXJyYXkiLCJpc0FycmF5IiwibGVuZ3RoIiwicmVkdWNlIiwiYWNjdSIsInByb3ZpZGVSZWNpcGVzVG9JbmplY3RvciIsInJlY2lwZXMiLCJhcHBJbmplY3RvciIsInByb3ZpZGVkIiwiaW5qIiwicmVjaXBlIiwiY3VzdG9tRGVwZW5kZW5jaWVzIiwiaWoiLCJ3YXJuIiwiaWRlbnRpdHkiLCJzdGF0ZSIsIndpdGhTdGF0ZSIsImxlbnNlcyIsIm1hcFN0YXRlVG9Qcm9wcyIsImFjdGlvbnMiLCJDb21wb25lbnQiLCJXcmFwcGVkQ29tcG9uZW50IiwicHJvcHMiLCJjb250ZXh0IiwidG90YWxTdGF0ZSIsImxlbnMiLCJzZWxlY3RvciIsImRpc3BhdGNoIiwiT2JqZWN0Iiwia2V5cyIsImtleSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW9CQTs7QUFDQTs7QUFDQTs7QUFNQTs7QUFDQTs7Ozs7O0FBWUEsSUFBTUEsV0FBVyxHQUFHLFNBQWRBLFdBQWM7QUFBQSxzQkFBTSw0Q0FBTjtBQUFBLENBQXBCOztBQUVPLElBQU1DLFNBQVMsR0FBRztBQUN2QkMsRUFBQUEsZUFBZSxFQUNiLHVJQUZxQjtBQUt2QkMsRUFBQUEsS0FBSyxFQUFFLGVBQUNDLEdBQUQsRUFBTUMsTUFBTjtBQUFBLFdBQ0wsVUFBR0Qs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LEVBRUwsVUFBQVksUUFBUTtBQUFBLGFBQ05DLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZVixPQUFaLEVBQXFCaEIsTUFBckIsQ0FDRSxVQUFDQyxJQUFELEVBQU8wQixHQUFQO0FBQUEsK0NBQ0sxQixJQURMLDRDQUVHMEIsR0FGSCxFQUVTLCtCQUFtQlgsT0FBTyxDQUFDVyxHQUFELENBQTFCLEVBQWlDSCxRQUFqQyxDQUZUO0FBQUEsT0FERixFQUtFLEVBTEYsQ0FETTtBQUFBLEtBRkgsRUFVTE4sZ0JBVkssQ0FBUDtBQVdELEdBNUJEO0FBNkJEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDIyIFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7Y29ubmVjdH0gZnJvbSAncmVhY3QtcmVkdXgnO1xuaW1wb3J0IHtiaW5kQWN0aW9uQ3JlYXRvcnN9IGZyb20gJ3JlZHV4JztcbmltcG9ydCB7XG4gIE1hcFN0YXRlVG9Qcm9wc1BhcmFtLFxuICBNYXBEaXNwYXRjaFRvUHJvcHNQYXJhbSxcbiAgSW5mZXJhYmxlQ29tcG9uZW50RW5oYW5jZXJXaXRoUHJvcHNcbn0gZnJvbSAncmVhY3QtcmVkdXgnO1xuaW1wb3J0IHtjb25zb2xlIGFzIENvbnNvbGV9IGZyb20gJ2dsb2JhbC93aW5kb3cnO1xuaW1wb3J0IEtlcGxlckdsQ29udGV4dCBmcm9tICcuL2NvbnRleHQnO1xuXG5leHBvcnQgdHlwZSBGYWN0b3J5RWxlbWVudCA9ICguLi5hcmdzKSA9PiBSZWFjdC5Db21wb25lbnRUeXBlO1xuZXhwb3J0IHR5cGUgRmFjdG9yeSA9IEZhY3RvcnlFbGVtZW50ICYge1xuICBkZXBzOiBGYWN0b3J5RWxlbWVudFtdO1xufTtcblxuZXhwb3J0IHR5cGUgSW5qZWN0b3JUeXBlID0ge1xuICBwcm92aWRlOiAoZmFjdG9yeTogYW55LCByZXBsYWNlbWVudDogYW55KSA9PiBJbmplY3RvclR5cGU7XG4gIGdldDogKGZhYzogYW55LCBwYXJlbnQ/OiBhbnkpID0+IGFueTtcbn07XG5cbmNvbnN0IE1pc3NpbmdDb21wID0gKCkgPT4gPGRpdiAvPjtcblxuZXhwb3J0IGNvbnN0IEVSUk9SX01TRyA9IHtcbiAgd3JvbmdSZWNpcGVUeXBlOlxuICAgIGBpbmplY3RDb21wb25lbnRzIHRha2VzIGFuIGFycmF5IG9mIGZhY3RvcmllcyByZXBsYWNlbWVudCBwYWlycyBhcyBpbnB1dCwgYCArXG4gICAgYGVhY2ggcGFpciBiZSBhIGFycmF5IGFzIFtvcmlnaW5hbEZhY3RvcnksIHJlcGxhY2VtZW50XS5gLFxuXG4gIG5vRGVwOiAoZmFjLCBwYXJlbnQpID0+XG4gICAgYCR7ZmFjLm5hbWV9IGlzIHJlcXVpcmVkIGFzIGEgZGVwZW5kZW5jeSBvZiAke3BhcmVudC5uYW1lfSwgYCArXG4gICAgYGJ1dCBpcyBub3QgcHJvdmlkZWQgdG8gaW5qZWN0Q29tcG9uZW50cy4gSXQgd2lsbCBub3QgYmUgcmVuZGVyZWQuYCxcblxuICBub3RGdW5jOiAnZmFjdG9yeSBhbmQgaXRzIHJlcGxhY2VtZW50IHNob3VsZCBiZSBhIGZ1bmN0aW9uJ1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGluamVjdG9yKG1hcCA9IG5ldyBNYXAoKSk6IEluamVjdG9yVHlwZSB7XG4gIGNvbnN0IGNhY2hlID0gbmV3IE1hcCgpOyAvLyBtYXA8ZmFjdG9yeSwgZmFjdG9yeSAtPiA/PlxuICBjb25zdCBnZXQgPSAoZmFjLCBwYXJlbnQpID0+IHtcbiAgICBjb25zdCBmYWN0b3J5ID0gbWFwLmdldChmYWMpO1xuICAgIC8vIGZhY3RvcnkgaXMgbm90IGluamVjdGVkXG4gICAgaWYgKCFmYWN0b3J5KSB7XG4gICAgICBDb25zb2xlLmVycm9yKEVSUk9SX01TRy5ub0RlcChmYWMsIHBhcmVudCkpO1xuICAgICAgcmV0dXJuIE1pc3NpbmdDb21wO1xuICAgIH1cblxuICAgIC8vIGNoZWNrIGlmIGN1c3RvbSBmYWN0b3J5IGRlcHMgaXMgZGVjbGFyZWRcbiAgICBjb25zdCBpbnN0YW5jZXMgPVxuICAgICAgY2FjaGUuZ2V0KGZhY3RvcnkpIHx8XG4gICAgICBmYWN0b3J5KC4uLihmYWN0b3J5LmRlcHMgPyBmYWN0b3J5LmRlcHMubWFwKGRlcCA9PiBnZXQoZGVwLCBmYWN0b3J5KSkgOiBbXSkpO1xuXG4gICAgY2FjaGUuc2V0KGZhYywgaW5zdGFuY2VzKTtcbiAgICByZXR1cm4gaW5zdGFuY2VzO1xuICB9O1xuXG4gIC8vIGlmIHlvdSBoYXZlIHR3byBmdW5jdGlvbnMgdGhhdCBoYXBwZW4gdG8gaGF2ZSB0aGUgZXhhY3RseSBzYW1lIHRleHRcbiAgLy8gaXQgd2lsbCBiZSBvdmVycmlkZTogMjAxOC0wMi0wNVxuICByZXR1cm4ge1xuICAgIHByb3ZpZGU6IChmYWN0b3J5LCByZXBsYWNlbWVudCkgPT4ge1xuICAgICAgaWYgKCF0eXBlQ2hlY2tSZWNpcGUoW2ZhY3RvcnksIHJlcGxhY2VtZW50XSkpIHtcbiAgICAgICAgcmV0dXJuIGluamVjdG9yKG1hcCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gaW5qZWN0b3IobmV3IE1hcChtYXApLnNldChmYWN0b3J5LCByZXBsYWNlbWVudCkpO1xuICAgIH0sXG4gICAgZ2V0XG4gIH07XG59XG5cbi8vIGVudHJ5UG9pbnRcbmV4cG9ydCBmdW5jdGlvbiBmbGF0dGVuRGVwcyhhbGxEZXBzOiBGYWN0b3J5W10sIGZhY3Rvcnk6IGFueSk6IEZhY3RvcnlbXSB7XG4gIGNvbnN0IGFkZFRvRGVwcyA9IGFsbERlcHMuY29uY2F0KFtmYWN0b3J5XSk7XG4gIHJldHVybiBBcnJheS5pc0FycmF5KGZhY3RvcnkuZGVwcykgJiYgZmFjdG9yeS5kZXBzLmxlbmd0aFxuICAgID8gZmFjdG9yeS5kZXBzLnJlZHVjZSgoYWNjdSwgZGVwKSA9PiBmbGF0dGVuRGVwcyhhY2N1LCBkZXApLCBhZGRUb0RlcHMpXG4gICAgOiBhZGRUb0RlcHM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcm92aWRlUmVjaXBlc1RvSW5qZWN0b3IocmVjaXBlczogW0ZhY3RvcnksIEZhY3RvcnldW10sIGFwcEluamVjdG9yOiBJbmplY3RvclR5cGUpIHtcbiAgY29uc3QgcHJvdmlkZWQgPSBuZXcgTWFwKCk7XG5cbiAgcmV0dXJuIHJlY2lwZXMucmVkdWNlKChpbmosIHJlY2lwZSkgPT4ge1xuICAgIGlmICghdHlwZUNoZWNrUmVjaXBlKHJlY2lwZSkpIHtcbiAgICAgIHJldHVybiBpbmo7XG4gICAgfVxuXG4gICAgLy8gY29sbGVjdCBkZXBlbmRlbmNpZXMgb2YgY3VzdG9tIGZhY3RvcmllcywgaWYgdGhlcmUgaXMgYW55LlxuICAgIC8vIEFkZCB0aGVtIHRvIHRoZSBhcHBJbmplY3RvclxuICAgIGNvbnN0IGN1c3RvbURlcGVuZGVuY2llcyA9IGZsYXR0ZW5EZXBzKFtdLCByZWNpcGVbMV0pO1xuICAgIGluaiA9IGN1c3RvbURlcGVuZGVuY2llcy5yZWR1Y2UoKGlqLCBmYWN0b3J5KSA9PiB7XG4gICAgICBpZiAocHJvdmlkZWQuZ2V0KGZhY3RvcnkpKSB7XG4gICAgICAgIENvbnNvbGUud2FybihcbiAgICAgICAgICBgJHtmYWN0b3J5Lm5hbWV9IGFscmVhZHkgaW5qZWN0ZWQgZnJvbSAke3Byb3ZpZGVkLmdldChmYWN0b3J5KS5uYW1lfSwgaW5qZWN0aW5nICR7XG4gICAgICAgICAgICByZWNpcGVbMF0ubmFtZVxuICAgICAgICAgIH0gYWZ0ZXIgJHtwcm92aWRlZC5nZXQoZmFjdG9yeSkubmFtZX0gd2lsbCBvdmVycmlkZSBpdGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBpai5wcm92aWRlKGZhY3RvcnksIGZhY3RvcnkpO1xuICAgIH0sIGluaik7XG5cbiAgICBwcm92aWRlZC5zZXQocmVjaXBlWzBdLCByZWNpcGVbMV0pO1xuICAgIHJldHVybiBpbmoucHJvdmlkZSguLi5yZWNpcGUpO1xuICB9LCBhcHBJbmplY3Rvcik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0eXBlQ2hlY2tSZWNpcGUocmVjaXBlKSB7XG4gIGlmICghQXJyYXkuaXNBcnJheShyZWNpcGUpIHx8IHJlY2lwZS5sZW5ndGggPCAyKSB7XG4gICAgQ29uc29sZS5lcnJvcignRXJyb3IgaW5qZWN0aW5nIFtmYWN0b3J5LCByZXBsYWNlbWVudF0nLCByZWNpcGUpO1xuICAgIENvbnNvbGUuZXJyb3IoRVJST1JfTVNHLndyb25nUmVjaXBlVHlwZSk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgY29uc3QgW2ZhY3RvcnksIHJlcGxhY2VtZW50XSA9IHJlY2lwZTtcbiAgaWYgKHR5cGVvZiBmYWN0b3J5ICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgQ29uc29sZS5lcnJvcignRXJyb3IgaW5qZWN0aW5nIGZhY3Rvcnk6ICcsIGZhY3RvcnkpO1xuICAgIENvbnNvbGUuZXJyb3IoRVJST1JfTVNHLm5vdEZ1bmMpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfSBlbHNlIGlmICh0eXBlb2YgcmVwbGFjZW1lbnQgIT09ICdmdW5jdGlvbicpIHtcbiAgICBDb25zb2xlLmVycm9yKCdFcnJvciBpbmplY3RpbmcgcmVwbGFjZW1lbnQgZm9yOiAnLCBmYWN0b3J5KTtcbiAgICBDb25zb2xlLmVycm9yKEVSUk9SX01TRy5ub3RGdW5jKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBXaXRoU3RhdGU8Um9vdFN0YXRlPiB7XG4gIDxUU3RhdGVQcm9wcyA9IHt9LCBURGlzcGF0Y2hQcm9wcyA9IHt9LCBUT3duUHJvcHMgPSB7fSwgU3RhdGUgPSBSb290U3RhdGU+KFxuICAgIGxlbnNlczogYW55W10sXG4gICAgbWFwU3RhdGVUb1Byb3BzOiBNYXBTdGF0ZVRvUHJvcHNQYXJhbTxUU3RhdGVQcm9wcywgVE93blByb3BzLCBTdGF0ZT4sXG4gICAgbWFwRGlzcGF0Y2hUb1Byb3BzPzogTWFwRGlzcGF0Y2hUb1Byb3BzUGFyYW08VERpc3BhdGNoUHJvcHMsIFRPd25Qcm9wcz5cbiAgKTogSW5mZXJhYmxlQ29tcG9uZW50RW5oYW5jZXJXaXRoUHJvcHM8VFN0YXRlUHJvcHMgJiBURGlzcGF0Y2hQcm9wcywgVE93blByb3BzPjtcbn1cblxuY29uc3QgaWRlbnRpdHkgPSBzdGF0ZSA9PiBzdGF0ZTtcbi8vIEhlbHBlciB0byBhZGQgcmVkdWNlciBzdGF0ZSB0byBjdXN0b20gY29tcG9uZW50XG5leHBvcnQgZnVuY3Rpb24gd2l0aFN0YXRlKGxlbnNlczogYW55W10gPSBbXSwgbWFwU3RhdGVUb1Byb3BzID0gaWRlbnRpdHksIGFjdGlvbnMgPSB7fSkge1xuICByZXR1cm4gQ29tcG9uZW50ID0+IHtcbiAgICBjb25zdCBXcmFwcGVkQ29tcG9uZW50ID0gKHtzdGF0ZSwgLi4ucHJvcHN9KSA9PiAoXG4gICAgICA8S2VwbGVyR2xDb250ZXh0LkNvbnN1bWVyPlxuICAgICAgICB7Y29udGV4dCA9PiAoXG4gICAgICAgICAgPENvbXBvbmVudFxuICAgICAgICAgICAgey4uLmxlbnNlcy5yZWR1Y2UoXG4gICAgICAgICAgICAgICh0b3RhbFN0YXRlLCBsZW5zKSA9PiAoe1xuICAgICAgICAgICAgICAgIC4uLnRvdGFsU3RhdGUsXG4gICAgICAgICAgICAgICAgLi4ubGVucyhjb250ZXh0LnNlbGVjdG9yKHN0YXRlKSlcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIHByb3BzXG4gICAgICAgICAgICApfVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICA8L0tlcGxlckdsQ29udGV4dC5Db25zdW1lcj5cbiAgICApO1xuXG4gICAgcmV0dXJuIGNvbm5lY3QoXG4gICAgICBzdGF0ZSA9PiAoey4uLm1hcFN0YXRlVG9Qcm9wcyhzdGF0ZSksIHN0YXRlfSksXG4gICAgICBkaXNwYXRjaCA9PlxuICAgICAgICBPYmplY3Qua2V5cyhhY3Rpb25zKS5yZWR1Y2UoXG4gICAgICAgICAgKGFjY3UsIGtleSkgPT4gKHtcbiAgICAgICAgICAgIC4uLmFjY3UsXG4gICAgICAgICAgICBba2V5XTogYmluZEFjdGlvbkNyZWF0b3JzKGFjdGlvbnNba2V5XSwgZGlzcGF0Y2gpXG4gICAgICAgICAgfSksXG4gICAgICAgICAge31cbiAgICAgICAgKVxuICAgICkoV3JhcHBlZENvbXBvbmVudCk7XG4gIH07XG59XG4iXX0=