// Copyright (c) 2022 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.LayerLegendHeaderFactory = LayerLegendHeaderFactory;
exports.LayerLegendContentFactory = LayerLegendContentFactory;
exports["default"] = exports.LayerColorLegend = exports.SingleColorLegend = exports.LayerSizeLegend = exports.VisualChannelMetric = exports.StyledMapControlLegend = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireDefault(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _d3Color = require("d3-color");

var _colorLegend = _interopRequireDefault(require("../common/color-legend"));

var _constants = require("@kepler.gl/constants");

var _localization = require("@kepler.gl/localization");

var _templateObject;

var StyledMapControlLegend = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  padding: 10px ", "px 10px\n    ", "px;\n  font-size: 11px;\n  font-family: ", ";\n  border-bottom-color: ", ";\n  border-bottom-style: solid;\n  border-bottom-width: ", ";\n  width: ", "px;\n  box-sizing: border-box;\n\n  .legend--layer_name {\n    font-size: 12px;\n    padding-right: ", "px;\n    color: ", ";\n    font-weight: 500;\n  }\n  .legend--layer_type {\n    color: ", ";\n    font-weight: 500;\n    font-size: 11px;\n    padding-right: ", "px;\n  }\n\n  .legend--layer__title {\n    padding-right: ", "px;\n  }\n\n  .legend--layer_by {\n    color: ", ";\n  }\n\n  .legend--layer_color_field {\n    color: ", ";\n    font-weight: 500;\n  }\n\n  .legend--layer_color-legend {\n    margin-top: 6px;\n  }\n"])), function (props) {
  return props.theme.mapControl.padding;
}, function (props) {
  return props.theme.mapControl.padding;
}, function (props) {
  return props.theme.fontFamily;
}, function (props) {
  return props.theme.panelBorderColor;
}, function (props) {
  return props.last ? 0 : '1px';
}, function (props) {
  return props.width;
}, function (props) {
  return props.theme.mapControl.padding;
}, function (props) {
  return props.theme.textColor;
}, function (props) {
  return props.theme.subtextColor;
}, function (props) {
  return props.theme.mapControl.padding;
}, function (props) {
  return props.theme.mapControl.padding;
}, function (props) {
  return props.theme.subtextColor;
}, function (props) {
  return props.theme.textColorHl;
});

exports.StyledMapControlLegend = StyledMapControlLegend;

var VisualChannelMetric = function VisualChannelMetric(_ref) {
  var name = _ref.name;
  return /*#__PURE__*/_react["default"].createElement("div", {
    className: "legend--layer__title"
  }, /*#__PURE__*/_react["default"].createElement("span", {
    className: "legend--layer_color_field"
  }, /*#__PURE__*/_react["default"].createElement(_localization.FormattedMessage, {
    id: name
  })));
};

exports.VisualChannelMetric = VisualChannelMetric;

/** @type {typeof import('./map-legend').LayerSizeLegend} */
var LayerSizeLegend = function LayerSizeLegend(_ref2) {
  var label = _ref2.label,
      name = _ref2.name;
  return label ? /*#__PURE__*/_react["default"].createElement("div", {
    className: "legend--layer_size-schema"
  }, /*#__PURE__*/_react["default"].createElement("p", null, /*#__PURE__*/_react["default"].createElement("span", {
    className: "legend--layer_by"
  }, label ? /*#__PURE__*/_react["default"].createElement(_localization.FormattedMessage, {
    id: label
  }) : null), /*#__PURE__*/_react["default"].createElement("span", {
    className: "legend--layer_by"
  }, " by ")), name && /*#__PURE__*/_react["default"].createElement(VisualChannelMetric, {
    name: name
  })) : null;
};

exports.LayerSizeLegend = LayerSizeLegend;
var SINGLE_COLOR_DOMAIN = [''];

/** @type {typeof import('./map-legend').SingleColorLegend} */
var SingleColorLegend = /*#__PURE__*/_react["default"].memo(function (_ref3) {
  var width = _ref3.width,
      color = _ref3.color;
  return /*#__PURE__*/_react["default"].createElement(_colorLegend["default"], {
    scaleType: "ordinal",
    displayLabel: false,
    domain: SINGLE_COLOR_DOMAIN,
    fieldType: null,
    range: {
      colors: [_d3Color.rgb.apply(void 0, (0, _toConsumableArray2["default"])(color)).toString()]
    },
    width: width
  });
});

exports.SingleColorLegend = SingleColorLegend;
SingleColorLegend.displayName = 'SingleColorLegend';

/** @type {typeof import('./map-legend').LayerColorLegend} */
var LayerColorLegend = /*#__PURE__*/_react["default"].memo(function (_ref4) {
  var description = _ref4.description,
      config = _ref4.config,
      width = _ref4.width,
      colorChannel = _ref4.colorChannel;
  var enableColorBy = description.measure;
  var scale = colorChannel.scale,
      field = colorChannel.field,
      domain = colorChannel.domain,
      range = colorChannel.range,
      property = colorChannel.property;

  var _map = [scale, field, domain].map(function (k) {
    return config[k];
  }),
      _map2 = (0, _slicedToArray2["default"])(_map, 3),
      colorScale = _map2[0],
      colorField = _map2[1],
      colorDomain = _map2[2];

  var colorRange = config.visConfig[range];
  return /*#__PURE__*/_react["default"].createElement("div", null, /*#__PURE__*/_react["default"].createElement("div", {
    className: "legend--layer_color-schema"
  }, /*#__PURE__*/_react["default"].createElement("div", null, enableColorBy ? /*#__PURE__*/_react["default"].createElement(VisualChannelMetric, {
    name: enableColorBy
  }) : null, /*#__PURE__*/_react["default"].createElement("div", {
    className: "legend--layer_color-legend"
  }, enableColorBy ? /*#__PURE__*/_react["default"].createElement(_colorLegend["default"], {
    scaleType: colorScale,
    displayLabel: true,
    domain: colorDomain,
    fieldType: colorField && colorField.type || 'real',
    range: colorRange,
    width: width
  }) : /*#__PURE__*/_react["default"].createElement(SingleColorLegend, {
    color: config.visConfig[property] || config[property] || config.color,
    width: width
  })))));
}); // eslint-disable-next-line react/display-name


exports.LayerColorLegend = LayerColorLegend;
LayerColorLegend.displayName = 'LayerColorLegend';

var isColorChannel = function isColorChannel(visualChannel) {
  return [_constants.CHANNEL_SCALES.color, _constants.CHANNEL_SCALES.colorAggr].includes(visualChannel.channelScaleType);
};

function LayerLegendHeaderFactory() {
  /** @type {typeof import('./map-legend').LayerLegendHeader }> */
  var LayerLegendHeader = function LayerLegendHeader(_ref5) {
    var options = _ref5.options,
        layer = _ref5.layer;
    return (options === null || options === void 0 ? void 0 : options.showLayerName) !== false ? /*#__PURE__*/_react["default"].createElement("div", {
      className: "legend--layer_name"
    }, layer.config.label) : null;
  };

  return LayerLegendHeader;
}

function LayerLegendContentFactory() {
  /** @type {typeof import('./map-legend').LayerLegendContent }> */
  var LayerLegendContent = function LayerLegendContent(_ref6) {
    var layer = _ref6.layer,
        containerW = _ref6.containerW;
    var colorChannels = Object.values(layer.visualChannels).filter(isColorChannel);
    var nonColorChannels = Object.values(layer.visualChannels).filter(function (vc) {
      return !isColorChannel(vc);
    });
    return /*#__PURE__*/_react["default"].createElement(_react["default"].Fragment, null, colorChannels.map(function (colorChannel) {
      return !colorChannel.condition || colorChannel.condition(layer.config) ? /*#__PURE__*/_react["default"].createElement(LayerColorLegend, {
        key: colorChannel.key,
        description: layer.getVisualChannelDescription(colorChannel.key),
        config: layer.config,
        width: containerW - 2 * _constants.DIMENSIONS.mapControl.padding,
        colorChannel: colorChannel
      }) : null;
    }), nonColorChannels.map(function (visualChannel) {
      var matchCondition = !visualChannel.condition || visualChannel.condition(layer.config);
      var enabled = layer.config[visualChannel.field] || visualChannel.defaultMeasure;
      var description = layer.getVisualChannelDescription(visualChannel.key);
      return matchCondition && enabled ? /*#__PURE__*/_react["default"].createElement(LayerSizeLegend, {
        key: visualChannel.key,
        label: description.label,
        name: description.measure
      }) : null;
    }));
  };

  return LayerLegendContent;
}

MapLegendFactory.deps = [LayerLegendHeaderFactory, LayerLegendContentFactory];

function MapLegendFactory(LayerLegendHeader, LayerLegendContent) {
  /** @type {typeof import('./map-legend').MapLegend }> */
  var MapLegend = function MapLegend(_ref7) {
    var _ref7$layers = _ref7.layers,
        layers = _ref7$layers === void 0 ? [] : _ref7$layers,
        width = _ref7.width,
        mapHeight = _ref7.mapHeight,
        options = _ref7.options;
    return /*#__PURE__*/_react["default"].createElement("div", (0, _extends2["default"])({
      className: "map-legend"
    }, mapHeight && {
      style: {
        /* subtracting rough size of 4 map control buttons and padding */
        maxHeight: mapHeight - 250
      }
    }), layers.map(function (layer, index) {
      if (!layer.isValidToSave() || layer.config.hidden) {
        return null;
      }

      var containerW = width || _constants.DIMENSIONS.mapControl.width;
      return /*#__PURE__*/_react["default"].createElement(StyledMapControlLegend, {
        className: "legend--layer",
        last: index === layers.length - 1,
        key: index,
        width: containerW
      }, /*#__PURE__*/_react["default"].createElement(LayerLegendHeader, {
        options: options,
        layer: layer
      }), /*#__PURE__*/_react["default"].createElement(LayerLegendContent, {
        containerW: containerW,
        layer: layer
      }));
    }));
  };

  MapLegend.displayName = 'MapLegend';
  return MapLegend;
}

var _default = MapLegendFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXAvbWFwLWxlZ2VuZC50c3giXSwibmFtZXMiOlsiU3R5bGVkTWFwQ29udHJvbExlZ2VuZCIsInN0eWxlZCIsImRpdiIsInByb3BzIiwidGhlbWUiLCJtYXBDb250cm9sIiwicGFkZGluZyIsImZvbnRGYW1pbHkiLCJwYW5lbEJvcmRlckNvbG9yIiwibGFzdCIsIndpZHRoIiwidGV4dENvbG9yIiwic3VidGV4dENvbG9yIiwidGV4dENvbG9ySGwiLCJWaXN1YWxDaGFubmVsTWV0cmljIiwibmFtZSIsIkxheWVyU2l6ZUxlZ2VuZCIsImxhYmVsIiwiU0lOR0xFX0NPTE9SX0RPTUFJTiIsIlNpbmdsZUNvbG9yTGVnZW5kIiwiUmVhY3QiLCJtZW1vIiwiY29sb3IiLCJjb2xvcnMiLCJyZ2IiLCJ0b1N0cmluZyIsImRpc3BsYXlOYW1lIiwiTGF5ZXJDb2xvckxlZ2VuZCIsImRlc2NyaXB0aW9uIiwiY29uZmlnIiwiY29sb3JDaGFubmVsIiwiZW5hYmxlQ29sb3JCeSIsIm1lYXN1cmUiLCJzY2FsZSIsImZpZWxkIiwiZG9tYWluIiwicmFuZ2UiLCJwcm9wZXJ0eSIsIm1hcCIsImsiLCJjb2xvclNjYWxlIiwiY29sb3JGaWVsZCIsImNvbG9yRG9tYWluIiwiY29sb3JSYW5nZSIsInZpc0NvbmZpZyIsInR5cGUiLCJpc0NvbG9yQ2hhbm5lbCIsInZpc3VhbENoYW5uZWwiLCJDSEFOTkVMX1NDQUxFUyIsImNvbG9yQWdnciIsImluY2x1ZGVzIiwiY2hhbm5lbFNjYWxlVHlwZSIsIkxheWVyTGVnZW5kSGVhZGVyRmFjdG9yeSIsIkxheWVyTGVnZW5kSGVhZGVyIiwib3B0aW9ucyIsImxheWVyIiwic2hvd0xheWVyTmFtZSIsIkxheWVyTGVnZW5kQ29udGVudEZhY3RvcnkiLCJMYXllckxlZ2VuZENvbnRlbnQiLCJjb250YWluZXJXIiwiY29sb3JDaGFubmVscyIsIk9iamVjdCIsInZhbHVlcyIsInZpc3VhbENoYW5uZWxzIiwiZmlsdGVyIiwibm9uQ29sb3JDaGFubmVscyIsInZjIiwiY29uZGl0aW9uIiwia2V5IiwiZ2V0VmlzdWFsQ2hhbm5lbERlc2NyaXB0aW9uIiwiRElNRU5TSU9OUyIsIm1hdGNoQ29uZGl0aW9uIiwiZW5hYmxlZCIsImRlZmF1bHRNZWFzdXJlIiwiTWFwTGVnZW5kRmFjdG9yeSIsImRlcHMiLCJNYXBMZWdlbmQiLCJsYXllcnMiLCJtYXBIZWlnaHQiLCJzdHlsZSIsIm1heEhlaWdodCIsImluZGV4IiwiaXNWYWxpZFRvU2F2ZSIsImhpZGRlbiIsImxlbmd0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW9CQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQWFPLElBQU1BLHNCQUFzQixHQUFHQyw2QkFBT0MsR0FBVixxeUJBQ2pCLFVBQUFDLEtBQUs7QUFBQSxTQUFJQSxLQUFLLENBQUNDLEtBQU4sQ0FBWUMsVUFBWixDQUF1QkMsT0FBM0I7QUFBQSxDQURZLEVBRTdCLFVBQUFILEtBQUs7QUFBQSxTQUFJQSxLQUFLLENBQUNDLEtBQU4sQ0FBWUMsVUFBWixDQUF1QkMsT0FBM0I7QUFBQSxDQUZ3QixFQUlsQixVQUFBSCxLQUFLO0FBQUEsU0FBSUEsS0FBSyxDQUFDQyxLQUFOLENBQVlHLFVBQWhCO0FBQUEsQ0FKYSxFQUtWLFVBQUFKLEtBQUs7QUFBQSxTQUFJQSxLQUFLLENBQUNDLEtBQU4sQ0FBWUksZ0JBQWhCO0FBQUEsQ0FMSyxFQU9WLFVBQUFMLEtBQUs7QUFBQSxTQUFLQSxLQUFLLENBQUNNLElBQU4sR0FBYSxDQUFiLEdBQWlCLEtBQXRCO0FBQUEsQ0FQSyxFQVF4QixVQUFBTixLQUFLO0FBQUEsU0FBSUEsS0FBSyxDQUFDTyxLQUFWO0FBQUEsQ0FSbUIsRUFhZCxVQUFBUCxLQUFLO0FBQUEsU0FBSUEsS0FBSyxDQUFDQyxLQUFOLENBQVlDLFVBQVosQ0FBdUJDLE9BQTNCO0FBQUEsQ0FiUyxFQWN0QixVQUFBSCxLQUFLO0FBQUEsU0FBSUEsS0FBSyxDQUFDQyxLQUFOLENBQVlP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QixRQUFBLE9BQU8sRUFBRUwsT0FBNUI7QUFBcUMsUUFBQSxLQUFLLEVBQUVDO0FBQTVDLFFBTkYsZUFPRSxnQ0FBQyxrQkFBRDtBQUFvQixRQUFBLFVBQVUsRUFBRUksVUFBaEM7QUFBNEMsUUFBQSxLQUFLLEVBQUVKO0FBQW5ELFFBUEYsQ0FERjtBQVdELEtBakJBLENBVEgsQ0FEMEM7QUFBQSxHQUE1Qzs7QUErQkFxQixFQUFBQSxTQUFTLENBQUNsRCxXQUFWLEdBQXdCLFdBQXhCO0FBRUEsU0FBT2tELFNBQVA7QUFDRDs7ZUFFY0YsZ0IiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIDIwMjIgVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQge3JnYn0gZnJvbSAnZDMtY29sb3InO1xuaW1wb3J0IENvbG9yTGVnZW5kIGZyb20gJy4uL2NvbW1vbi9jb2xvci1sZWdlbmQnO1xuaW1wb3J0IHtDSEFOTkVMX1NDQUxFUywgRElNRU5TSU9OU30gZnJvbSAnQGtlcGxlci5nbC9jb25zdGFudHMnO1xuaW1wb3J0IHtGb3JtYXR0ZWRNZXNzYWdlfSBmcm9tICdAa2VwbGVyLmdsL2xvY2FsaXphdGlvbic7XG5pbXBvcnQge1xuICBMYXllcixcbiAgTGF5ZXJCYXNlQ29uZmlnLFxuICBWaXN1YWxDaGFubmVsLFxuICBWaXN1YWxDaGFubmVsRGVzY3JpcHRpb25cbn0gZnJvbSAnQGtlcGxlci5nbC9sYXllcnMnO1xuXG5pbnRlcmZhY2UgU3R5bGVkTWFwQ29udHJvbExlZ2VuZFByb3BzIHtcbiAgd2lkdGg/OiBudW1iZXI7XG4gIGxhc3Q/OiBib29sZWFuO1xufVxuXG5leHBvcnQgY29uc3QgU3R5bGVkTWFwQ29udHJvbExlZ2VuZCA9IHN0eWxlZC5kaXY8U3R5bGVkTWFwQ29udHJvbExlZ2VuZFByb3BzPmBcbiAgcGFkZGluZzogMTBweCAke3Byb3BzID0+IHByb3BzLnRoZW1lLm1hcENvbnRyb2wucGFkZGluZ31weCAxMHB4XG4gICAgJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5tYXBDb250cm9sLnBhZGRpbmd9cHg7XG4gIGZvbnQtc2l6ZTogMTFweDtcbiAgZm9udC1mYW1pbHk6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuZm9udEZhbWlseX07XG4gIGJvcmRlci1ib3R0b20tY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUucGFuZWxCb3JkZXJDb2xvcn07XG4gIGJvcmRlci1ib3R0b20tc3R5bGU6IHNvbGlkO1xuICBib3JkZXItYm90dG9tLXdpZHRoOiAke3Byb3BzID0+IChwcm9wcy5sYXN0ID8gMCA6ICcxcHgnKX07XG4gIHdpZHRoOiAke3Byb3BzID0+IHByb3BzLndpZHRofXB4O1xuICBib3gtc2l6aW5nOiBib3JkZXItYm94O1xuXG4gIC5sZWdlbmQtLWxheWVyX25hbWUge1xuICAgIGZvbnQtc2l6ZTogMTJweDtcbiAgICBwYWRkaW5nLXJpZ2h0OiAke3Byb3BzID0+IHByb3BzLnRoZW1lLm1hcENvbnRyb2wucGFkZGluZ31weDtcbiAgICBjb2xvcjogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS50ZXh0Q29sb3J9O1xuICAgIGZvbnQtd2VpZ2h0OiA1MDA7XG4gIH1cbiAgLmxlZ2VuZC0tbGF5ZXJfdHlwZSB7XG4gICAgY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuc3VidGV4dENvbG9yfTtcbiAgICBmb250LXdlaWdodDogNTAwO1xuICAgIGZvbnQtc2l6ZTogMTFweDtcbiAgICBwYWRkaW5nLXJpZ2h0OiAke3Byb3BzID0+IHByb3BzLnRoZW1lLm1hcENvbnRyb2wucGFkZGluZ31weDtcbiAgfVxuXG4gIC5sZWdlbmQtLWxheWVyX190aXRsZSB7XG4gICAgcGFkZGluZy1yaWdodDogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5tYXBDb250cm9sLnBhZGRpbmd9cHg7XG4gIH1cblxuICAubGVnZW5kLS1sYXllcl9ieSB7XG4gICAgY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuc3VidGV4dENvbG9yfTtcbiAgfVxuXG4gIC5sZWdlbmQtLWxheWVyX2NvbG9yX2ZpZWxkIHtcbiAgICBjb2xvcjogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS50ZXh0Q29sb3JIbH07XG4gICAgZm9udC13ZWlnaHQ6IDUwMDtcbiAgfVxuXG4gIC5sZWdlbmQtLWxheWVyX2NvbG9yLWxlZ2VuZCB7XG4gICAgbWFyZ2luLXRvcDogNnB4O1xuICB9XG5gO1xuXG5leHBvcnQgY29uc3QgVmlzdWFsQ2hhbm5lbE1ldHJpYyA9ICh7bmFtZX0pID0+IHtcbiAgcmV0dXJuIChcbiAgICA8ZGl2IGNsYXNzTmFtZT1cImxlZ2VuZC0tbGF5ZXJfX3RpdGxlXCI+XG4gICAgICA8c3BhbiBjbGFzc05hbWU9XCJsZWdlbmQtLWxheWVyX2NvbG9yX2ZpZWxkXCI+XG4gICAgICAgIDxGb3JtYXR0ZWRNZXNzYWdlIGlkPXtuYW1lfSAvPlxuICAgICAgPC9zcGFuPlxuICAgIDwvZGl2PlxuICApO1xufTtcblxuZXhwb3J0IHR5cGUgTGF5ZXJTaXplTGVnZW5kUHJvcHMgPSB7XG4gIGxhYmVsOiBzdHJpbmc7XG4gIG5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZDtcbn07XG5cbi8qKiBAdHlwZSB7dHlwZW9mIGltcG9ydCgnLi9tYXAtbGVnZW5kJykuTGF5ZXJTaXplTGVnZW5kfSAqL1xuZXhwb3J0IGNvbnN0IExheWVyU2l6ZUxlZ2VuZDogUmVhY3QuRkM8TGF5ZXJTaXplTGVnZW5kUHJvcHM+ID0gKHtsYWJlbCwgbmFtZX0pID0+XG4gIGxhYmVsID8gKFxuICAgIDxkaXYgY2xhc3NOYW1lPVwibGVnZW5kLS1sYXllcl9zaXplLXNjaGVtYVwiPlxuICAgICAgPHA+XG4gICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cImxlZ2VuZC0tbGF5ZXJfYnlcIj57bGFiZWwgPyA8Rm9ybWF0dGVkTWVzc2FnZSBpZD17bGFiZWx9IC8+IDogbnVsbH08L3NwYW4+XG4gICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cImxlZ2VuZC0tbGF5ZXJfYnlcIj4gYnkgPC9zcGFuPlxuICAgICAgPC9wPlxuICAgICAge25hbWUgJiYgPFZpc3VhbENoYW5uZWxNZXRyaWMgbmFtZT17bmFtZX0gLz59XG4gICAgPC9kaXY+XG4gICkgOiBudWxsO1xuXG5jb25zdCBTSU5HTEVfQ09MT1JfRE9NQUlOID0gWycnXTtcblxuZXhwb3J0IHR5cGUgU2luZ2xlQ29sb3JMZWdlbmRQcm9wcyA9IHtcbiAgd2lkdGg6IG51bWJlcjtcbiAgY29sb3I6IHN0cmluZztcbn07XG5cbi8qKiBAdHlwZSB7dHlwZW9mIGltcG9ydCgnLi9tYXAtbGVnZW5kJykuU2luZ2xlQ29sb3JMZWdlbmR9ICovXG5leHBvcnQgY29uc3QgU2luZ2xlQ29sb3JMZWdlbmQ6IFJlYWN0LkZDPFNpbmdsZUNvbG9yTGVnZW5kUHJvcHM+ID0gUmVhY3QubWVtbygoe3dpZHRoLCBjb2xvcn0pID0+IChcbiAgPENvbG9yTGVnZW5kXG4gICAgc2NhbGVUeXBlPVwib3JkaW5hbFwiXG4gICAgZGlzcGxheUxhYmVsPXtmYWxzZX1cbiAgICBkb21haW49e1NJTkdMRV9DT0xPUl9ET01BSU59XG4gICAgZmllbGRUeXBlPXtudWxsfVxuICAgIHJhbmdlPXt7Y29sb3JzOiBbcmdiKC4uLmNvbG9yKS50b1N0cmluZygpXX19XG4gICAgd2lkdGg9e3dpZHRofVxuICAvPlxuKSk7XG5cblNpbmdsZUNvbG9yTGVnZW5kLmRpc3BsYXlOYW1lID0gJ1NpbmdsZUNvbG9yTGVnZW5kJztcblxuZXhwb3J0IHR5cGUgTGF5ZXJDb2xvckxlZ2VuZFByb3BzID0ge1xuICBkZXNjcmlwdGlvbjogVmlzdWFsQ2hhbm5lbERlc2NyaXB0aW9uO1xuICBjb25maWc6IExheWVyQmFzZUNvbmZpZztcbiAgd2lkdGg6IG51bWJlcjtcbiAgY29sb3JDaGFubmVsOiBWaXN1YWxDaGFubmVsO1xufTtcblxuLyoqIEB0eXBlIHt0eXBlb2YgaW1wb3J0KCcuL21hcC1sZWdlbmQnKS5MYXllckNvbG9yTGVnZW5kfSAqL1xuZXhwb3J0IGNvbnN0IExheWVyQ29sb3JMZWdlbmQ6IFJlYWN0LkZDPExheWVyQ29sb3JMZWdlbmRQcm9wcz4gPSBSZWFjdC5tZW1vKFxuICAoe2Rlc2NyaXB0aW9uLCBjb25maWcsIHdpZHRoLCBjb2xvckNoYW5uZWx9KSA9PiB7XG4gICAgY29uc3QgZW5hYmxlQ29sb3JCeSA9IGRlc2NyaXB0aW9uLm1lYXN1cmU7XG4gICAgY29uc3Qge3NjYWxlLCBmaWVsZCwgZG9tYWluLCByYW5nZSwgcHJvcGVydHl9ID0gY29sb3JDaGFubmVsO1xuICAgIGNvbnN0IFtjb2xvclNjYWxlLCBjb2xvckZpZWxkLCBjb2xvckRvbWFpbl0gPSBbc2NhbGUsIGZpZWxkLCBkb21haW5dLm1hcChrID0+IGNvbmZpZ1trXSk7XG4gICAgY29uc3QgY29sb3JSYW5nZSA9IGNvbmZpZy52aXNDb25maWdbcmFuZ2VdO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXY+XG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibGVnZW5kLS1sYXllcl9jb2xvci1zY2hlbWFcIj5cbiAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAge2VuYWJsZUNvbG9yQnkgPyA8VmlzdWFsQ2hhbm5lbE1ldHJpYyBuYW1lPXtlbmFibGVDb2xvckJ5fSAvPiA6IG51bGx9XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImxlZ2VuZC0tbGF5ZXJfY29sb3ItbGVnZW5kXCI+XG4gICAgICAgICAgICAgIHtlbmFibGVDb2xvckJ5ID8gKFxuICAgICAgICAgICAgICAgIDxDb2xvckxlZ2VuZFxuICAgICAgICAgICAgICAgICAgc2NhbGVUeXBlPXtjb2xvclNjYWxlfVxuICAgICAgICAgICAgICAgICAgZGlzcGxheUxhYmVsXG4gICAgICAgICAgICAgICAgICBkb21haW49e2NvbG9yRG9tYWlufVxuICAgICAgICAgICAgICAgICAgZmllbGRUeXBlPXsoY29sb3JGaWVsZCAmJiBjb2xvckZpZWxkLnR5cGUpIHx8ICdyZWFsJ31cbiAgICAgICAgICAgICAgICAgIHJhbmdlPXtjb2xvclJhbmdlfVxuICAgICAgICAgICAgICAgICAgd2lkdGg9e3dpZHRofVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICkgOiAoXG4gICAgICAgICAgICAgICAgPFNpbmdsZUNvbG9yTGVnZW5kXG4gICAgICAgICAgICAgICAgICBjb2xvcj17Y29uZmlnLnZpc0NvbmZpZ1twcm9wZXJ0eV0gfHwgY29uZmlnW3Byb3BlcnR5XSB8fCBjb25maWcuY29sb3J9XG4gICAgICAgICAgICAgICAgICB3aWR0aD17d2lkdGh9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuICAgICk7XG4gIH1cbik7XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC9kaXNwbGF5LW5hbWVcbkxheWVyQ29sb3JMZWdlbmQuZGlzcGxheU5hbWUgPSAnTGF5ZXJDb2xvckxlZ2VuZCc7XG5cbmNvbnN0IGlzQ29sb3JDaGFubmVsID0gdmlzdWFsQ2hhbm5lbCA9PlxuICBbQ0hBTk5FTF9TQ0FMRVMuY29sb3IsIENIQU5ORUxfU0NBTEVTLmNvbG9yQWdncl0uaW5jbHVkZXModmlzdWFsQ2hhbm5lbC5jaGFubmVsU2NhbGVUeXBlKTtcblxuZXhwb3J0IHR5cGUgTGF5ZXJMZWdlbmRIZWFkZXJQcm9wcyA9IHtcbiAgbGF5ZXI6IExheWVyO1xuICBvcHRpb25zPzoge1xuICAgIHNob3dMYXllck5hbWU/OiBib29sZWFuO1xuICB9O1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIExheWVyTGVnZW5kSGVhZGVyRmFjdG9yeSgpIHtcbiAgLyoqIEB0eXBlIHt0eXBlb2YgaW1wb3J0KCcuL21hcC1sZWdlbmQnKS5MYXllckxlZ2VuZEhlYWRlciB9PiAqL1xuICBjb25zdCBMYXllckxlZ2VuZEhlYWRlcjogUmVhY3QuRkM8TGF5ZXJMZWdlbmRIZWFkZXJQcm9wcz4gPSAoe29wdGlvbnMsIGxheWVyfSkgPT4ge1xuICAgIHJldHVybiBvcHRpb25zPy5zaG93TGF5ZXJOYW1lICE9PSBmYWxzZSA/IChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwibGVnZW5kLS1sYXllcl9uYW1lXCI+e2xheWVyLmNvbmZpZy5sYWJlbH08L2Rpdj5cbiAgICApIDogbnVsbDtcbiAgfTtcbiAgcmV0dXJuIExheWVyTGVnZW5kSGVhZGVyO1xufVxuXG5leHBvcnQgdHlwZSBMYXllckxlZ2VuZENvbnRlbnRQcm9wcyA9IHtcbiAgbGF5ZXI6IExheWVyO1xuICBjb250YWluZXJXOiBudW1iZXI7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gTGF5ZXJMZWdlbmRDb250ZW50RmFjdG9yeSgpIHtcbiAgLyoqIEB0eXBlIHt0eXBlb2YgaW1wb3J0KCcuL21hcC1sZWdlbmQnKS5MYXllckxlZ2VuZENvbnRlbnQgfT4gKi9cbiAgY29uc3QgTGF5ZXJMZWdlbmRDb250ZW50OiBSZWFjdC5GQzxMYXllckxlZ2VuZENvbnRlbnRQcm9wcz4gPSAoe2xheWVyLCBjb250YWluZXJXfSkgPT4ge1xuICAgIGNvbnN0IGNvbG9yQ2hhbm5lbHMgPSBPYmplY3QudmFsdWVzKGxheWVyLnZpc3VhbENoYW5uZWxzKS5maWx0ZXIoaXNDb2xvckNoYW5uZWwpO1xuICAgIGNvbnN0IG5vbkNvbG9yQ2hhbm5lbHMgPSBPYmplY3QudmFsdWVzKGxheWVyLnZpc3VhbENoYW5uZWxzKS5maWx0ZXIodmMgPT4gIWlzQ29sb3JDaGFubmVsKHZjKSk7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPD5cbiAgICAgICAge2NvbG9yQ2hhbm5lbHMubWFwKGNvbG9yQ2hhbm5lbCA9PlxuICAgICAgICAgICFjb2xvckNoYW5uZWwuY29uZGl0aW9uIHx8IGNvbG9yQ2hhbm5lbC5jb25kaXRpb24obGF5ZXIuY29uZmlnKSA/IChcbiAgICAgICAgICAgIDxMYXllckNvbG9yTGVnZW5kXG4gICAgICAgICAgICAgIGtleT17Y29sb3JDaGFubmVsLmtleX1cbiAgICAgICAgICAgICAgZGVzY3JpcHRpb249e2xheWVyLmdldFZpc3VhbENoYW5uZWxEZXNjcmlwdGlvbihjb2xvckNoYW5uZWwua2V5KX1cbiAgICAgICAgICAgICAgY29uZmlnPXtsYXllci5jb25maWd9XG4gICAgICAgICAgICAgIHdpZHRoPXtjb250YWluZXJXIC0gMiAqIERJTUVOU0lPTlMubWFwQ29udHJvbC5wYWRkaW5nfVxuICAgICAgICAgICAgICBjb2xvckNoYW5uZWw9e2NvbG9yQ2hhbm5lbH1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgKSA6IG51bGxcbiAgICAgICAgKX1cbiAgICAgICAge25vbkNvbG9yQ2hhbm5lbHMubWFwKHZpc3VhbENoYW5uZWwgPT4ge1xuICAgICAgICAgIGNvbnN0IG1hdGNoQ29uZGl0aW9uID0gIXZpc3VhbENoYW5uZWwuY29uZGl0aW9uIHx8IHZpc3VhbENoYW5uZWwuY29uZGl0aW9uKGxheWVyLmNvbmZpZyk7XG4gICAgICAgICAgY29uc3QgZW5hYmxlZCA9IGxheWVyLmNvbmZpZ1t2aXN1YWxDaGFubmVsLmZpZWxkXSB8fCB2aXN1YWxDaGFubmVsLmRlZmF1bHRNZWFzdXJlO1xuXG4gICAgICAgICAgY29uc3QgZGVzY3JpcHRpb24gPSBsYXllci5nZXRWaXN1YWxDaGFubmVsRGVzY3JpcHRpb24odmlzdWFsQ2hhbm5lbC5rZXkpO1xuXG4gICAgICAgICAgcmV0dXJuIG1hdGNoQ29uZGl0aW9uICYmIGVuYWJsZWQgPyAoXG4gICAgICAgICAgICA8TGF5ZXJTaXplTGVnZW5kXG4gICAgICAgICAgICAgIGtleT17dmlzdWFsQ2hhbm5lbC5rZXl9XG4gICAgICAgICAgICAgIGxhYmVsPXtkZXNjcmlwdGlvbi5sYWJlbH1cbiAgICAgICAgICAgICAgbmFtZT17ZGVzY3JpcHRpb24ubWVhc3VyZX1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgKSA6IG51bGw7XG4gICAgICAgIH0pfVxuICAgICAgPC8+XG4gICAgKTtcbiAgfTtcblxuICByZXR1cm4gTGF5ZXJMZWdlbmRDb250ZW50O1xufVxuXG5leHBvcnQgdHlwZSBNYXBMZWdlbmRQcm9wcyA9IHtcbiAgbGF5ZXJzPzogUmVhZG9ubHlBcnJheTxMYXllcj47XG4gIHdpZHRoPzogbnVtYmVyO1xuICBtYXBIZWlnaHQ/OiBudW1iZXI7XG4gIG9wdGlvbnM/OiB7XG4gICAgc2hvd0xheWVyTmFtZT86IGJvb2xlYW47XG4gIH07XG59O1xuXG5NYXBMZWdlbmRGYWN0b3J5LmRlcHMgPSBbTGF5ZXJMZWdlbmRIZWFkZXJGYWN0b3J5LCBMYXllckxlZ2VuZENvbnRlbnRGYWN0b3J5XTtcbmZ1bmN0aW9uIE1hcExlZ2VuZEZhY3RvcnkoTGF5ZXJMZWdlbmRIZWFkZXIsIExheWVyTGVnZW5kQ29udGVudCkge1xuICAvKiogQHR5cGUge3R5cGVvZiBpbXBvcnQoJy4vbWFwLWxlZ2VuZCcpLk1hcExlZ2VuZCB9PiAqL1xuICBjb25zdCBNYXBMZWdlbmQ6IFJlYWN0LkZDPE1hcExlZ2VuZFByb3BzPiA9ICh7bGF5ZXJzID0gW10sIHdpZHRoLCBtYXBIZWlnaHQsIG9wdGlvbnN9KSA9PiAoXG4gICAgPGRpdlxuICAgICAgY2xhc3NOYW1lPVwibWFwLWxlZ2VuZFwiXG4gICAgICB7Li4uKG1hcEhlaWdodCAmJiB7XG4gICAgICAgIHN0eWxlOiB7XG4gICAgICAgICAgLyogc3VidHJhY3Rpbmcgcm91Z2ggc2l6ZSBvZiA0IG1hcCBjb250cm9sIGJ1dHRvbnMgYW5kIHBhZGRpbmcgKi9cbiAgICAgICAgICBtYXhIZWlnaHQ6IG1hcEhlaWdodCAtIDI1MFxuICAgICAgICB9XG4gICAgICB9KX1cbiAgICA+XG4gICAgICB7bGF5ZXJzLm1hcCgobGF5ZXIsIGluZGV4KSA9PiB7XG4gICAgICAgIGlmICghbGF5ZXIuaXNWYWxpZFRvU2F2ZSgpIHx8IGxheWVyLmNvbmZpZy5oaWRkZW4pIHtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjb250YWluZXJXID0gd2lkdGggfHwgRElNRU5TSU9OUy5tYXBDb250cm9sLndpZHRoO1xuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgPFN0eWxlZE1hcENvbnRyb2xMZWdlbmRcbiAgICAgICAgICAgIGNsYXNzTmFtZT1cImxlZ2VuZC0tbGF5ZXJcIlxuICAgICAgICAgICAgbGFzdD17aW5kZXggPT09IGxheWVycy5sZW5ndGggLSAxfVxuICAgICAgICAgICAga2V5PXtpbmRleH1cbiAgICAgICAgICAgIHdpZHRoPXtjb250YWluZXJXfVxuICAgICAgICAgID5cbiAgICAgICAgICAgIDxMYXllckxlZ2VuZEhlYWRlciBvcHRpb25zPXtvcHRpb25zfSBsYXllcj17bGF5ZXJ9IC8+XG4gICAgICAgICAgICA8TGF5ZXJMZWdlbmRDb250ZW50IGNvbnRhaW5lclc9e2NvbnRhaW5lcld9IGxheWVyPXtsYXllcn0gLz5cbiAgICAgICAgICA8L1N0eWxlZE1hcENvbnRyb2xMZWdlbmQ+XG4gICAgICAgICk7XG4gICAgICB9KX1cbiAgICA8L2Rpdj5cbiAgKTtcblxuICBNYXBMZWdlbmQuZGlzcGxheU5hbWUgPSAnTWFwTGVnZW5kJztcblxuICByZXR1cm4gTWFwTGVnZW5kO1xufVxuXG5leHBvcnQgZGVmYXVsdCBNYXBMZWdlbmRGYWN0b3J5O1xuIl19