{"version":3,"sources":["../../../src/hexagon-layer/hexagon-layer.js"],"names":["nop","defaultProps","colorDomain","colorRange","defaultColorRange","getColorValue","type","value","getColorWeight","colorAggregation","lowerPercentile","min","max","upperPercentile","colorScaleType","onSetColorDomain","elevationDomain","elevationRange","getElevationValue","getElevationWeight","elevationAggregation","elevationLowerPercentile","elevationUpperPercentile","elevationScale","elevationScaleType","onSetElevationDomain","radius","coverage","extruded","hexagonAggregator","pointToHexbin","getPosition","x","position","material","_filterData","optional","HexagonLayer","cpuAggregator","CPUAggregator","getAggregator","props","getCellSize","state","aggregatorState","vertices","attributeManager","getAttributeManager","add","positions","size","accessor","opts","changeFlags","propsOrDataChanged","updateState","viewport","context","attributes","getAttributes","layerData","hexagonVertices","setState","convertLatLngToMeterOffset","Array","isArray","length","vertex0","vertex3","centroid","centroidFlat","projectFlat","getDistanceScales","metersPerUnit","map","vt","vtFlat","log","error","info","getPickingInfo","cell","getAccessor","getUpdateTriggers","transitions","SubLayerClass","getSubLayerClass","ColumnLayer","updateTriggers","_getSublayerUpdateTriggers","geometry","radiusCommon","radiusUnits","angle","diskResolution","getFillColor","_onGetSublayerColor","bind","getElevation","_onGetSublayerElevation","getSubLayerProps","id","data","AggregationLayer","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {log} from '@deck.gl/core';\nimport {ColumnLayer} from '@deck.gl/layers';\n\nimport {defaultColorRange} from '../utils/color-utils';\n\nimport {pointToHexbin} from './hexagon-aggregator';\nimport CPUAggregator from '../utils/cpu-aggregator';\nimport AggregationLayer from '../aggregation-layer';\n\nfunction nop() {}\n\nconst defaultProps = {\n  // color\n  colorDomain: null,\n  colorRange: defaultColorRange,\n  getColorValue: {type: 'accessor', value: null}, // default value is calcuated from `getColorWeight` and `colorAggregation`\n  getColorWeight: {type: 'accessor', value: 1},\n  colorAggregation: 'SUM',\n  lowerPercentile: {type: 'number', value: 0, min: 0, max: 100},\n  upperPercentile: {type: 'number', value: 100, min: 0, max: 100},\n  colorScaleType: 'quantize',\n  onSetColorDomain: nop,\n\n  // elevation\n  elevationDomain: null,\n  elevationRange: [0, 1000],\n  getElevationValue: {type: 'accessor', value: null}, // default value is calcuated from `getElevationWeight` and `elevationAggregation`\n  getElevationWeight: {type: 'accessor', value: 1},\n  elevationAggregation: 'SUM',\n  elevationLowerPercentile: {type: 'number', value: 0, min: 0, max: 100},\n  elevationUpperPercentile: {type: 'number', value: 100, min: 0, max: 100},\n  elevationScale: {type: 'number', min: 0, value: 1},\n  elevationScaleType: 'linear',\n  onSetElevationDomain: nop,\n\n  radius: {type: 'number', value: 1000, min: 1},\n  coverage: {type: 'number', min: 0, max: 1, value: 1},\n  extruded: false,\n  hexagonAggregator: pointToHexbin,\n  getPosition: {type: 'accessor', value: x => x.position},\n  // Optional material for 'lighting' shader module\n  material: true,\n\n  // data filter\n  _filterData: {type: 'function', value: null, optional: true}\n};\n\nexport default class HexagonLayer extends AggregationLayer {\n  initializeState() {\n    const cpuAggregator = new CPUAggregator({\n      getAggregator: props => props.hexagonAggregator,\n      getCellSize: props => props.radius\n    });\n\n    this.state = {\n      cpuAggregator,\n      aggregatorState: cpuAggregator.state,\n      vertices: null\n    };\n    const attributeManager = this.getAttributeManager();\n    attributeManager.add({\n      positions: {size: 3, accessor: 'getPosition'}\n    });\n    // color and elevation attributes can't be added as attributes\n    // they are calculated using 'getValue' accessor that takes an array of pints.\n  }\n\n  updateState(opts) {\n    super.updateState(opts);\n\n    if (opts.changeFlags.propsOrDataChanged) {\n      const aggregatorState = this.state.cpuAggregator.updateState(opts, {\n        viewport: this.context.viewport,\n        attributes: this.getAttributes()\n      });\n      if (this.state.aggregatorState.layerData !== aggregatorState.layerData) {\n        // if user provided custom aggregator and returns hexagonVertices,\n        // Need to recalculate radius and angle based on vertices\n        const {hexagonVertices} = aggregatorState.layerData || {};\n        this.setState({\n          vertices: hexagonVertices && this.convertLatLngToMeterOffset(hexagonVertices)\n        });\n      }\n\n      this.setState({\n        // make a copy of the internal state of cpuAggregator for testing\n        aggregatorState\n      });\n    }\n  }\n\n  convertLatLngToMeterOffset(hexagonVertices) {\n    const {viewport} = this.context;\n    if (Array.isArray(hexagonVertices) && hexagonVertices.length === 6) {\n      // get centroid of hexagons\n      const vertex0 = hexagonVertices[0];\n      const vertex3 = hexagonVertices[3];\n\n      const centroid = [(vertex0[0] + vertex3[0]) / 2, (vertex0[1] + vertex3[1]) / 2];\n      const centroidFlat = viewport.projectFlat(centroid);\n\n      const {metersPerUnit} = viewport.getDistanceScales(centroid);\n\n      // offset all points by centroid to meter offset\n      const vertices = hexagonVertices.map(vt => {\n        const vtFlat = viewport.projectFlat(vt);\n\n        return [\n          (vtFlat[0] - centroidFlat[0]) * metersPerUnit[0],\n          (vtFlat[1] - centroidFlat[1]) * metersPerUnit[1]\n        ];\n      });\n\n      return vertices;\n    }\n\n    log.error('HexagonLayer: hexagonVertices needs to be an array of 6 points')();\n    return null;\n  }\n\n  getPickingInfo({info}) {\n    return this.state.cpuAggregator.getPickingInfo({info});\n  }\n\n  // create a method for testing\n  _onGetSublayerColor(cell) {\n    return this.state.cpuAggregator.getAccessor('fillColor')(cell);\n  }\n\n  // create a method for testing\n  _onGetSublayerElevation(cell) {\n    return this.state.cpuAggregator.getAccessor('elevation')(cell);\n  }\n\n  _getSublayerUpdateTriggers() {\n    return this.state.cpuAggregator.getUpdateTriggers(this.props);\n  }\n\n  renderLayers() {\n    const {elevationScale, extruded, coverage, material, transitions} = this.props;\n    const {aggregatorState, vertices} = this.state;\n\n    const SubLayerClass = this.getSubLayerClass('hexagon-cell', ColumnLayer);\n    const updateTriggers = this._getSublayerUpdateTriggers();\n\n    const geometry = vertices\n      ? {vertices, radius: 1}\n      : {\n          // default geometry\n          radius: aggregatorState.layerData.radiusCommon || 1,\n          radiusUnits: 'common',\n          angle: 90\n        };\n    return new SubLayerClass(\n      {\n        ...geometry,\n        diskResolution: 6,\n        elevationScale,\n        extruded,\n        coverage,\n        material,\n\n        getFillColor: this._onGetSublayerColor.bind(this),\n        getElevation: this._onGetSublayerElevation.bind(this),\n        transitions: transitions && {\n          getFillColor: transitions.getColorValue || transitions.getColorWeight,\n          getElevation: transitions.getElevationValue || transitions.getElevationWeight\n        }\n      },\n      this.getSubLayerProps({\n        id: 'hexagon-cell',\n        updateTriggers\n      }),\n      {\n        data: aggregatorState.layerData.data\n      }\n    );\n  }\n}\n\nHexagonLayer.layerName = 'HexagonLayer';\nHexagonLayer.defaultProps = defaultProps;\n"],"file":"hexagon-layer.js"}