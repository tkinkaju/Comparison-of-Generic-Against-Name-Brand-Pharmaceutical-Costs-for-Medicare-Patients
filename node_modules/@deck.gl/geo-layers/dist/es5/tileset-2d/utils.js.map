{"version":3,"sources":["../../../src/tileset-2d/utils.ts"],"names":["TILE_SIZE","DEFAULT_EXTENT","Infinity","urlType","type","value","validate","propType","optional","Array","isArray","every","url","equal","value1","value2","len","length","i","transformBox","bbox","modelMatrix","transformedCoords","transformAsPoint","transformedBox","Math","min","map","max","stringHash","s","abs","split","reduce","a","b","charCodeAt","getURLFromTemplate","template","tile","index","id","Object","keys","key","regex","RegExp","replace","String","Number","isInteger","y","z","pow","getBoundingBox","viewport","zRange","extent","bounds","minZ","maxZ","bounds0","getBounds","bounds1","isGeospatial","getCullBounds","cullRect","subViewports","v","getCullBoundsInViewport","x","width","height","unprojectOption","targetZ","topLeft","unproject","topRight","bottomLeft","bottomRight","getIndexingCoords","scale","modelMatrixInverse","transformedTileIndex","getScale","tileSize","osmTile2lngLat","lng","n","PI","lat","atan","exp","tile2XY","tileToBoundingBox","west","north","east","south","left","top","right","bottom","getIdentityTileIndices","minX","minY","maxX","maxY","indices","floor","push","getTileIndices","maxZoom","minZoom","zoomOffset","round","zoom","log2","ceil","isFinite","transformedExtent","isURLTemplate","test","isGeoBoundingBox"],"mappings":"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","sourcesContent":["import {Viewport} from '@deck.gl/core';\nimport {Matrix4} from '@math.gl/core';\nimport {getOSMTileIndices} from './tile-2d-traversal';\nimport {Bounds, GeoBoundingBox, TileBoundingBox, TileIndex, ZRange} from './types';\n\nconst TILE_SIZE = 512;\nconst DEFAULT_EXTENT: Bounds = [-Infinity, -Infinity, Infinity, Infinity];\n\nexport type URLTemplate = string | string[] | null;\n\nexport const urlType = {\n  type: 'object' as const,\n  value: null as URLTemplate,\n  validate: (value, propType) =>\n    (propType.optional && value === null) ||\n    typeof value === 'string' ||\n    (Array.isArray(value) && value.every(url => typeof url === 'string')),\n  equal: (value1, value2) => {\n    if (value1 === value2) {\n      return true;\n    }\n    if (!Array.isArray(value1) || !Array.isArray(value2)) {\n      return false;\n    }\n    const len = value1.length;\n    if (len !== value2.length) {\n      return false;\n    }\n    for (let i = 0; i < len; i++) {\n      if (value1[i] !== value2[i]) {\n        return false;\n      }\n    }\n    return true;\n  }\n};\n\nfunction transformBox(bbox: Bounds, modelMatrix: Matrix4): Bounds {\n  const transformedCoords = [\n    // top-left\n    modelMatrix.transformAsPoint([bbox[0], bbox[1]]),\n    // top-right\n    modelMatrix.transformAsPoint([bbox[2], bbox[1]]),\n    // bottom-left\n    modelMatrix.transformAsPoint([bbox[0], bbox[3]]),\n    // bottom-right\n    modelMatrix.transformAsPoint([bbox[2], bbox[3]])\n  ];\n  const transformedBox: Bounds = [\n    // Minimum x coord\n    Math.min(...transformedCoords.map(i => i[0])),\n    // Minimum y coord\n    Math.min(...transformedCoords.map(i => i[1])),\n    // Max x coord\n    Math.max(...transformedCoords.map(i => i[0])),\n    // Max y coord\n    Math.max(...transformedCoords.map(i => i[1]))\n  ];\n  return transformedBox;\n}\n\nfunction stringHash(s: string): number {\n  return Math.abs(s.split('').reduce((a, b) => ((a << 5) - a + b.charCodeAt(0)) | 0, 0));\n}\n\nexport function getURLFromTemplate(\n  template: URLTemplate,\n  tile: {\n    index: TileIndex;\n    id: string;\n  }\n): string | null {\n  if (!template || !template.length) {\n    return null;\n  }\n  const {index, id} = tile;\n\n  if (Array.isArray(template)) {\n    const i = stringHash(id) % template.length;\n    template = template[i];\n  }\n\n  let url = template;\n  for (const key of Object.keys(index)) {\n    const regex = new RegExp(`{${key}}`, 'g');\n    url = url.replace(regex, String(index[key]));\n  }\n\n  // Back-compatible support for {-y}\n  if (Number.isInteger(index.y) && Number.isInteger(index.z)) {\n    url = url.replace(/\\{-y\\}/g, String(Math.pow(2, index.z) - index.y - 1));\n  }\n  return url;\n}\n\n/**\n * gets the bounding box of a viewport\n */\nfunction getBoundingBox(viewport: Viewport, zRange: number[] | null, extent: Bounds): Bounds {\n  let bounds;\n  if (zRange && zRange.length === 2) {\n    const [minZ, maxZ] = zRange;\n    const bounds0 = viewport.getBounds({z: minZ});\n    const bounds1 = viewport.getBounds({z: maxZ});\n    bounds = [\n      Math.min(bounds0[0], bounds1[0]),\n      Math.min(bounds0[1], bounds1[1]),\n      Math.max(bounds0[2], bounds1[2]),\n      Math.max(bounds0[3], bounds1[3])\n    ];\n  } else {\n    bounds = viewport.getBounds();\n  }\n  if (!viewport.isGeospatial) {\n    return [\n      // Top corner should not be more then bottom corner in either direction\n      Math.max(Math.min(bounds[0], extent[2]), extent[0]),\n      Math.max(Math.min(bounds[1], extent[3]), extent[1]),\n      // Bottom corner should not be less then top corner in either direction\n      Math.min(Math.max(bounds[2], extent[0]), extent[2]),\n      Math.min(Math.max(bounds[3], extent[1]), extent[3])\n    ];\n  }\n  return [\n    Math.max(bounds[0], extent[0]),\n    Math.max(bounds[1], extent[1]),\n    Math.min(bounds[2], extent[2]),\n    Math.min(bounds[3], extent[3])\n  ];\n}\n\n/** Get culling bounds in world space */\nexport function getCullBounds({\n  viewport,\n  z = 0,\n  cullRect\n}: {\n  /** Current viewport */\n  viewport: Viewport;\n  /** Current z range */\n  z: ZRange | number | undefined;\n  /** Culling rectangle in screen space */\n  cullRect: {x: number; y: number; width: number; height: number};\n}): [number, number, number, number][] {\n  const subViewports = viewport.subViewports || [viewport];\n  return subViewports.map(v => getCullBoundsInViewport(v, z, cullRect));\n}\n\nfunction getCullBoundsInViewport(\n  /** Current viewport */\n  viewport: Viewport,\n  /** At altitude */\n  z: ZRange | number,\n  /** Culling rectangle in screen space */\n  cullRect: {x: number; y: number; width: number; height: number}\n): [number, number, number, number] {\n  if (!Array.isArray(z)) {\n    const x = cullRect.x - viewport.x;\n    const y = cullRect.y - viewport.y;\n    const {width, height} = cullRect;\n\n    const unprojectOption = {targetZ: z};\n\n    const topLeft = viewport.unproject([x, y], unprojectOption);\n    const topRight = viewport.unproject([x + width, y], unprojectOption);\n    const bottomLeft = viewport.unproject([x, y + height], unprojectOption);\n    const bottomRight = viewport.unproject([x + width, y + height], unprojectOption);\n\n    return [\n      Math.min(topLeft[0], topRight[0], bottomLeft[0], bottomRight[0]),\n      Math.min(topLeft[1], topRight[1], bottomLeft[1], bottomRight[1]),\n      Math.max(topLeft[0], topRight[0], bottomLeft[0], bottomRight[0]),\n      Math.max(topLeft[1], topRight[1], bottomLeft[1], bottomRight[1])\n    ];\n  }\n\n  const bounds0 = getCullBoundsInViewport(viewport, z[0], cullRect);\n  const bounds1 = getCullBoundsInViewport(viewport, z[1], cullRect);\n\n  return [\n    Math.min(bounds0[0], bounds1[0]),\n    Math.min(bounds0[1], bounds1[1]),\n    Math.max(bounds0[2], bounds1[2]),\n    Math.max(bounds0[3], bounds1[3])\n  ];\n}\n\nfunction getIndexingCoords(bbox: Bounds, scale: number, modelMatrixInverse?: Matrix4): Bounds {\n  if (modelMatrixInverse) {\n    const transformedTileIndex = transformBox(bbox, modelMatrixInverse).map(\n      i => (i * scale) / TILE_SIZE\n    );\n    return transformedTileIndex as Bounds;\n  }\n  return bbox.map(i => (i * scale) / TILE_SIZE) as Bounds;\n}\n\nfunction getScale(z: number, tileSize: number): number {\n  return (Math.pow(2, z) * TILE_SIZE) / tileSize;\n}\n\n// https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames#Lon..2Flat._to_tile_numbers_2\nexport function osmTile2lngLat(x: number, y: number, z: number): [number, number] {\n  const scale = getScale(z, TILE_SIZE);\n  const lng = (x / scale) * 360 - 180;\n  const n = Math.PI - (2 * Math.PI * y) / scale;\n  const lat = (180 / Math.PI) * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n)));\n  return [lng, lat];\n}\n\nfunction tile2XY(x: number, y: number, z: number, tileSize: number): [number, number] {\n  const scale = getScale(z, tileSize);\n  return [(x / scale) * TILE_SIZE, (y / scale) * TILE_SIZE];\n}\nexport function tileToBoundingBox(\n  viewport: Viewport,\n  x: number,\n  y: number,\n  z: number,\n  tileSize: number = TILE_SIZE\n): TileBoundingBox {\n  if (viewport.isGeospatial) {\n    const [west, north] = osmTile2lngLat(x, y, z);\n    const [east, south] = osmTile2lngLat(x + 1, y + 1, z);\n    return {west, north, east, south};\n  }\n  const [left, top] = tile2XY(x, y, z, tileSize);\n  const [right, bottom] = tile2XY(x + 1, y + 1, z, tileSize);\n  return {left, top, right, bottom};\n}\n\nfunction getIdentityTileIndices(\n  viewport: Viewport,\n  z: number,\n  tileSize: number,\n  extent: Bounds,\n  modelMatrixInverse?: Matrix4\n) {\n  const bbox = getBoundingBox(viewport, null, extent);\n  const scale = getScale(z, tileSize);\n  const [minX, minY, maxX, maxY] = getIndexingCoords(bbox, scale, modelMatrixInverse);\n  const indices: TileIndex[] = [];\n\n  /*\n      |  TILE  |  TILE  |  TILE  |\n        |(minX)            |(maxX)\n   */\n  for (let x = Math.floor(minX); x < maxX; x++) {\n    for (let y = Math.floor(minY); y < maxY; y++) {\n      indices.push({x, y, z});\n    }\n  }\n  return indices;\n}\n\n/**\n * Returns all tile indices in the current viewport. If the current zoom level is smaller\n * than minZoom, return an empty array. If the current zoom level is greater than maxZoom,\n * return tiles that are on maxZoom.\n */\n// eslint-disable-next-line complexity\nexport function getTileIndices({\n  viewport,\n  maxZoom,\n  minZoom,\n  zRange,\n  extent,\n  tileSize = TILE_SIZE,\n  modelMatrix,\n  modelMatrixInverse,\n  zoomOffset = 0\n}: {\n  viewport: Viewport;\n  maxZoom?: number;\n  minZoom?: number;\n  zRange: ZRange | undefined;\n  extent?: Bounds;\n  tileSize?: number;\n  modelMatrix?: Matrix4;\n  modelMatrixInverse?: Matrix4;\n  zoomOffset?: number;\n}) {\n  let z = viewport.isGeospatial\n    ? Math.round(viewport.zoom + Math.log2(TILE_SIZE / tileSize)) + zoomOffset\n    : Math.ceil(viewport.zoom) + zoomOffset;\n  if (typeof minZoom === 'number' && Number.isFinite(minZoom) && z < minZoom) {\n    if (!extent) {\n      return [];\n    }\n    z = minZoom;\n  }\n  if (typeof maxZoom === 'number' && Number.isFinite(maxZoom) && z > maxZoom) {\n    z = maxZoom;\n  }\n  let transformedExtent = extent;\n  if (modelMatrix && modelMatrixInverse && extent && !viewport.isGeospatial) {\n    transformedExtent = transformBox(extent, modelMatrix);\n  }\n  return viewport.isGeospatial\n    ? getOSMTileIndices(viewport, z, zRange, extent)\n    : getIdentityTileIndices(\n        viewport,\n        z,\n        tileSize,\n        transformedExtent || DEFAULT_EXTENT,\n        modelMatrixInverse\n      );\n}\n\n/**\n * Returns true if s is a valid URL template\n */\nexport function isURLTemplate(s: string): boolean {\n  return /(?=.*{z})(?=.*{x})(?=.*({y}|{-y}))/.test(s);\n}\n\nexport function isGeoBoundingBox(v: any): v is GeoBoundingBox {\n  return (\n    Number.isFinite(v.west) &&\n    Number.isFinite(v.north) &&\n    Number.isFinite(v.east) &&\n    Number.isFinite(v.south)\n  );\n}\n"],"file":"utils.js"}