{"version":3,"sources":["../../../src/lifecycle/component-state.ts"],"names":["EMPTY_PROPS","Object","freeze","ComponentState","component","asyncProps","onAsyncPropUpdated","oldProps","oldAsyncProps","propName","asyncProp","type","release","resolvedValue","resetOldProps","props","Boolean","pendingLoadCount","resolvedLoadCount","key","isAsyncPropLoading","value","_watchPromise","Promise","resolve","COMPONENT_SYMBOL","resolvedValues","ASYNC_RESOLVED_SYMBOL","originalValues","ASYNC_ORIGINAL_SYMBOL","defaultValues","ASYNC_DEFAULTS_SYMBOL","_createAsyncPropData","_updateAsyncProp","getAsyncProp","url","error","_didAsyncInputValueChange","_fetch","_resolveAsyncIterable","_setPropValue","create","defineProperty","enumerable","lastValue","_freezeAsyncOldProps","_postProcessValue","loadCount","undefined","promise","then","data","_setAsyncPropValue","_onResolve","catch","_onError","iterable","count","chunk","dataTransform","concat","startRow","endRow","length","propType","transform","defaultValue","propTypes","PROP_TYPES_SYMBOL"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {isAsyncIterable} from '../utils/iterable-utils';\nimport {\n  COMPONENT_SYMBOL,\n  PROP_TYPES_SYMBOL,\n  ASYNC_ORIGINAL_SYMBOL,\n  ASYNC_RESOLVED_SYMBOL,\n  ASYNC_DEFAULTS_SYMBOL\n} from './constants';\nimport type Component from './component';\nimport {PropType} from './prop-types';\n\nconst EMPTY_PROPS = Object.freeze({});\n\n/** Internal state of an async prop */\ntype AsyncPropState = {\n  /** The prop type definition from component.defaultProps, if exists */\n  type: PropType | null;\n  /** Supplied prop value (can be url/promise, not visible to the component) */\n  lastValue: any;\n  /** Resolved prop value (valid data, can be \"shown\" to the component) */\n  resolvedValue: any;\n  /** How many loads have been issued */\n  pendingLoadCount: number;\n  /** Latest resolved load, (earlier loads will be ignored) */\n  resolvedLoadCount: number;\n};\n\nexport default class ComponentState<ComponentT extends Component> {\n  /** The component that this state instance belongs to. `null` if this state has been finalized. */\n  component: ComponentT | null;\n  onAsyncPropUpdated: (propName: string, value: any) => void;\n\n  private asyncProps: Partial<Record<string, AsyncPropState>>;\n  private oldProps: ComponentT['props'] | null;\n  private oldAsyncProps: ComponentT['props'] | null;\n\n  constructor(component: ComponentT) {\n    this.component = component;\n    this.asyncProps = {}; // Prop values that the layer sees\n    this.onAsyncPropUpdated = () => {};\n    this.oldProps = null; // Last props before update\n    this.oldAsyncProps = null; // Last props before update, with async values copied.\n  }\n\n  finalize() {\n    for (const propName in this.asyncProps) {\n      const asyncProp = this.asyncProps[propName];\n      if (asyncProp && asyncProp.type && asyncProp.type.release) {\n        // Release any resources created by transforms\n        asyncProp.type.release(\n          asyncProp.resolvedValue,\n          asyncProp.type,\n          this.component as Component\n        );\n      }\n    }\n    this.asyncProps = {};\n    this.component = null;\n    this.resetOldProps();\n  }\n\n  /* Layer-facing props API */\n\n  getOldProps(): ComponentT['props'] | typeof EMPTY_PROPS {\n    return this.oldAsyncProps || this.oldProps || EMPTY_PROPS;\n  }\n\n  resetOldProps() {\n    this.oldAsyncProps = null;\n    this.oldProps = this.component ? this.component.props : null;\n  }\n\n  // Checks if a prop is overridden\n  hasAsyncProp(propName: string): boolean {\n    return propName in this.asyncProps;\n  }\n\n  // Returns value of an overriden prop\n  getAsyncProp(propName: string): any {\n    const asyncProp = this.asyncProps[propName];\n    return asyncProp && asyncProp.resolvedValue;\n  }\n\n  isAsyncPropLoading(propName?: string): boolean {\n    if (propName) {\n      const asyncProp = this.asyncProps[propName];\n      return Boolean(\n        asyncProp &&\n          asyncProp.pendingLoadCount > 0 &&\n          asyncProp.pendingLoadCount !== asyncProp.resolvedLoadCount\n      );\n    }\n    for (const key in this.asyncProps) {\n      if (this.isAsyncPropLoading(key)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  // Without changing the original prop value, swap out the data resolution under the hood\n  reloadAsyncProp(propName: string, value: any) {\n    this._watchPromise(propName, Promise.resolve(value));\n  }\n\n  // Updates all async/overridden props (when new props come in)\n  // Checks if urls have changed, starts loading, or removes override\n  setAsyncProps(props: ComponentT['props']) {\n    this.component = (props[COMPONENT_SYMBOL] as ComponentT) || this.component;\n\n    // NOTE: prop param and default values are only support for testing\n    const resolvedValues = props[ASYNC_RESOLVED_SYMBOL] || {};\n    const originalValues = props[ASYNC_ORIGINAL_SYMBOL] || props;\n    const defaultValues = props[ASYNC_DEFAULTS_SYMBOL] || {};\n\n    // TODO - use async props from the layer's prop types\n    for (const propName in resolvedValues) {\n      const value = resolvedValues[propName];\n      this._createAsyncPropData(propName, defaultValues[propName]);\n      this._updateAsyncProp(propName, value);\n      // Use transformed value\n      resolvedValues[propName] = this.getAsyncProp(propName);\n    }\n\n    for (const propName in originalValues) {\n      const value = originalValues[propName];\n      // Makes sure a record exists for this prop\n      this._createAsyncPropData(propName, defaultValues[propName]);\n      this._updateAsyncProp(propName, value);\n    }\n  }\n\n  /* Placeholder methods for subclassing */\n\n  protected _fetch(propName: string, url: string): any {\n    return null;\n  }\n\n  protected _onResolve(propName: string, value: any) {} // eslint-disable-line @typescript-eslint/no-empty-function\n\n  protected _onError(propName: string, error: Error) {} // eslint-disable-line @typescript-eslint/no-empty-function\n\n  // Intercept strings (URLs) and Promises and activates loading and prop rewriting\n  private _updateAsyncProp(propName: string, value: any) {\n    if (!this._didAsyncInputValueChange(propName, value)) {\n      return;\n    }\n\n    // interpret value string as url and start a new load tracked by a promise\n    if (typeof value === 'string') {\n      value = this._fetch(propName, value);\n    }\n\n    // interprets promise and track the \"loading\"\n    if (value instanceof Promise) {\n      this._watchPromise(propName, value);\n      return;\n    }\n\n    if (isAsyncIterable(value)) {\n      this._resolveAsyncIterable(propName, value); // eslint-disable-line @typescript-eslint/no-floating-promises\n      return;\n    }\n\n    // else, normal, non-async value. Just store value for now\n    this._setPropValue(propName, value);\n  }\n\n  // Whenever async props are changing, we need to make a copy of oldProps\n  // otherwise the prop rewriting will affect the value both in props and oldProps.\n  // While the copy is relatively expensive, this only happens on load completion.\n  private _freezeAsyncOldProps() {\n    if (!this.oldAsyncProps && this.oldProps) {\n      // 1. inherit all synchronous props from oldProps\n      // 2. reconfigure the async prop descriptors to fixed values\n      this.oldAsyncProps = Object.create(this.oldProps);\n      for (const propName in this.asyncProps) {\n        Object.defineProperty(this.oldAsyncProps, propName, {\n          enumerable: true,\n          value: this.oldProps[propName]\n        });\n      }\n    }\n  }\n\n  // Checks if an input value actually changed (to avoid reloading/rewatching promises/urls)\n  private _didAsyncInputValueChange(propName: string, value: any): boolean {\n    // @ts-ignore\n    const asyncProp: AsyncPropState = this.asyncProps[propName];\n    if (value === asyncProp.resolvedValue || value === asyncProp.lastValue) {\n      return false;\n    }\n    asyncProp.lastValue = value;\n    return true;\n  }\n\n  // Set normal, non-async value\n  private _setPropValue(propName: string, value: any) {\n    // Save the current value before overwriting so that diffProps can access both\n    this._freezeAsyncOldProps();\n\n    const asyncProp = this.asyncProps[propName];\n    if (asyncProp) {\n      value = this._postProcessValue(asyncProp, value);\n      asyncProp.resolvedValue = value;\n      asyncProp.pendingLoadCount++;\n      asyncProp.resolvedLoadCount = asyncProp.pendingLoadCount;\n    }\n  }\n\n  // Set a just resolved async value, calling onAsyncPropUpdates if value changes asynchronously\n  private _setAsyncPropValue(propName: string, value: any, loadCount: number) {\n    // Only update if loadCount is larger or equal to resolvedLoadCount\n    // otherwise a more recent load has already completed\n    const asyncProp = this.asyncProps[propName];\n    if (asyncProp && loadCount >= asyncProp.resolvedLoadCount && value !== undefined) {\n      // Save the current value before overwriting so that diffProps can access both\n      this._freezeAsyncOldProps();\n\n      asyncProp.resolvedValue = value;\n      asyncProp.resolvedLoadCount = loadCount;\n\n      // Call callback to inform listener\n      this.onAsyncPropUpdated(propName, value);\n    }\n  }\n\n  // Tracks a promise, sets the prop when loaded, handles load count\n  private _watchPromise(propName: string, promise: Promise<any>) {\n    const asyncProp = this.asyncProps[propName];\n    if (asyncProp) {\n      asyncProp.pendingLoadCount++;\n      const loadCount = asyncProp.pendingLoadCount;\n      promise\n        .then(data => {\n          if (!this.component) {\n            // This component state has been finalized\n            return;\n          }\n          data = this._postProcessValue(asyncProp, data);\n          this._setAsyncPropValue(propName, data, loadCount);\n          this._onResolve(propName, data);\n        })\n        .catch(error => {\n          this._onError(propName, error);\n        });\n    }\n  }\n\n  private async _resolveAsyncIterable(\n    propName: string,\n    iterable: AsyncIterable<any>\n  ): Promise<void> {\n    if (propName !== 'data') {\n      // we only support data as async iterable\n      this._setPropValue(propName, iterable);\n      return;\n    }\n\n    const asyncProp = this.asyncProps[propName];\n    if (!asyncProp) {\n      return;\n    }\n\n    asyncProp.pendingLoadCount++;\n    const loadCount = asyncProp.pendingLoadCount;\n    let data: any[] = [];\n    let count = 0;\n\n    for await (const chunk of iterable) {\n      if (!this.component) {\n        // This component state has been finalized\n        return;\n      }\n\n      // @ts-expect-error (2339) dataTransform is not decared in base component props\n      const {dataTransform} = this.component.props;\n      if (dataTransform) {\n        data = dataTransform(chunk, data) as any[];\n      } else {\n        data = data.concat(chunk);\n      }\n\n      // Used by the default _dataDiff function\n      Object.defineProperty(data, '__diff', {\n        enumerable: false,\n        value: [{startRow: count, endRow: data.length}]\n      });\n\n      count = data.length;\n      this._setAsyncPropValue(propName, data, loadCount);\n    }\n\n    this._onResolve(propName, data);\n  }\n\n  // Give the app a chance to post process the loaded data\n  private _postProcessValue(asyncProp: AsyncPropState, value: any) {\n    const propType = asyncProp.type;\n    if (propType && this.component) {\n      if (propType.release) {\n        propType.release(asyncProp.resolvedValue, propType, this.component);\n      }\n      if (propType.transform) {\n        return propType.transform(value, propType, this.component);\n      }\n    }\n    return value;\n  }\n\n  // Creating an asyncProp record if needed\n  private _createAsyncPropData(propName: string, defaultValue: any) {\n    const asyncProp = this.asyncProps[propName];\n    if (!asyncProp) {\n      const propTypes = this.component && this.component.props[PROP_TYPES_SYMBOL];\n      // assert(defaultValue !== undefined);\n      this.asyncProps[propName] = {\n        type: propTypes && propTypes[propName],\n        lastValue: null,\n        resolvedValue: defaultValue,\n        pendingLoadCount: 0,\n        resolvedLoadCount: 0\n      };\n    }\n  }\n}\n"],"file":"component-state.js"}