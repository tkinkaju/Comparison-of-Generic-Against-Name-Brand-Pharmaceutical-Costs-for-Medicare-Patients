{"version":3,"sources":["../../../src/passes/layers-pass.ts"],"names":["LayersPass","options","gl","framebuffer","target","_drawLayers","moduleParameters","viewports","views","onViewportActive","clearStack","clearCanvas","pass","clearGLCanvas","_lastRenderIndex","renderStats","viewport","view","id","drawLayerParams","_getDrawLayerParams","subViewports","subViewport","stats","_drawLayersInViewport","layers","push","isPicking","layerFilter","cullRect","effects","evaluateShouldDrawOnly","indexResolver","layerIndexResolver","drawContext","layer","renderPass","layerFilterCache","layerIndex","length","shouldDrawLayer","_shouldDrawLayer","layerParam","layerRenderIndex","_getModuleParameters","layerParameters","getLayerParameters","globalModuleParameters","glViewport","getGLViewport","props","clear","clearOpts","color","depth","scissorTest","scissor","renderStatus","totalCount","visibleCount","compositeCount","pickableCount","pickable","isComposite","Math","max","_drawLayer","uniforms","parameters","err","raiseError","visible","parent","filterSubLayer","rootLayerId","activateViewport","overrides","Object","assign","create","internalState","propsInTransition","autoWrapLongitude","wrapLongitude","context","mousePosition","pickingActive","devicePixelRatio","effect","getModuleParameters","Pass","startIndex","layerIndices","resolvers","resolveLayerIndex","isDrawn","indexOverride","_offset","layerId","parentId","index","resolver","Number","isFinite","useTarget","pixelRatio","height","drawingBufferHeight","dimensions","x","y","width","targetFramebuffer","drawingBufferWidth"],"mappings":"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","sourcesContent":["import GL from '@luma.gl/constants';\nimport Pass from './pass';\nimport {clear, setParameters, withParameters, cssToDeviceRatio} from '@luma.gl/core';\n\nimport type {Framebuffer} from '@luma.gl/core';\nimport type Viewport from '../viewports/viewport';\nimport type View from '../views/view';\nimport type Layer from '../lib/layer';\nimport type {Effect} from '../lib/effect';\n\nexport type Rect = {x: number; y: number; width: number; height: number};\n\nexport type LayersPassRenderOptions = {\n  target?: Framebuffer;\n  isPicking?: boolean;\n  pass: string;\n  layers: Layer[];\n  viewports: Viewport[];\n  onViewportActive?: (viewport: Viewport) => void;\n  cullRect?: Rect;\n  views?: Record<string, View>;\n  effects?: Effect[];\n  /** If true, recalculates render index (z) from 0. Set to false if a stack of layers are rendered in multiple passes. */\n  clearStack?: boolean;\n  clearCanvas?: boolean;\n  layerFilter?: ((context: FilterContext) => boolean) | null;\n  moduleParameters?: any;\n  /** Stores returned results from Effect.preRender, for use downstream in the render pipeline */\n  preRenderStats?: Record<string, any>;\n};\n\ntype DrawLayerParameters = {\n  shouldDrawLayer: boolean;\n  layerRenderIndex?: number;\n  moduleParameters?: any;\n  layerParameters?: any;\n};\n\nexport type FilterContext = {\n  layer: Layer;\n  viewport: Viewport;\n  isPicking: boolean;\n  renderPass: string;\n  cullRect?: Rect;\n};\n\nexport type RenderStats = {\n  totalCount: number;\n  visibleCount: number;\n  compositeCount: number;\n  pickableCount: number;\n};\n\nexport default class LayersPass extends Pass {\n  _lastRenderIndex: number = -1;\n\n  render(options: LayersPassRenderOptions): any {\n    const gl = this.gl;\n\n    setParameters(gl, {framebuffer: options.target});\n    return this._drawLayers(options);\n  }\n\n  // Draw a list of layers in a list of viewports\n  private _drawLayers(options: LayersPassRenderOptions) {\n    const {\n      target,\n      moduleParameters,\n      viewports,\n      views,\n      onViewportActive,\n      clearStack = true,\n      clearCanvas = true\n    } = options;\n    options.pass = options.pass || 'unknown';\n\n    const gl = this.gl;\n    if (clearCanvas) {\n      clearGLCanvas(gl, target);\n    }\n\n    if (clearStack) {\n      this._lastRenderIndex = -1;\n    }\n\n    const renderStats: RenderStats[] = [];\n\n    for (const viewport of viewports) {\n      const view = views && views[viewport.id];\n\n      // Update context to point to this viewport\n      onViewportActive?.(viewport);\n\n      const drawLayerParams = this._getDrawLayerParams(viewport, options);\n\n      // render this viewport\n      const subViewports = viewport.subViewports || [viewport];\n      for (const subViewport of subViewports) {\n        const stats = this._drawLayersInViewport(\n          gl,\n          {\n            target,\n            moduleParameters,\n            viewport: subViewport,\n            view,\n            pass: options.pass,\n            layers: options.layers\n          },\n          drawLayerParams\n        );\n        renderStats.push(stats);\n      }\n    }\n    return renderStats;\n  }\n\n  // When a viewport contains multiple subviewports (e.g. repeated web mercator map),\n  // this is only done once for the parent viewport\n  /* Resolve the parameters needed to draw each layer */\n  protected _getDrawLayerParams(\n    viewport: Viewport,\n    {\n      layers,\n      pass,\n      isPicking = false,\n      layerFilter,\n      cullRect,\n      effects,\n      moduleParameters\n    }: LayersPassRenderOptions,\n    /** Internal flag, true if only used to determine whether each layer should be drawn */\n    evaluateShouldDrawOnly: boolean = false\n  ): DrawLayerParameters[] {\n    const drawLayerParams: DrawLayerParameters[] = [];\n    const indexResolver = layerIndexResolver(this._lastRenderIndex + 1);\n    const drawContext: FilterContext = {\n      layer: layers[0],\n      viewport,\n      isPicking,\n      renderPass: pass,\n      cullRect\n    };\n    const layerFilterCache = {};\n    for (let layerIndex = 0; layerIndex < layers.length; layerIndex++) {\n      const layer = layers[layerIndex];\n      // Check if we should draw layer\n      const shouldDrawLayer = this._shouldDrawLayer(\n        layer,\n        drawContext,\n        layerFilter,\n        layerFilterCache\n      );\n\n      const layerParam: DrawLayerParameters = {\n        shouldDrawLayer\n      };\n\n      if (shouldDrawLayer && !evaluateShouldDrawOnly) {\n        // This is the \"logical\" index for ordering this layer in the stack\n        // used to calculate polygon offsets\n        // It can be the same as another layer\n        layerParam.layerRenderIndex = indexResolver(layer, shouldDrawLayer);\n\n        layerParam.moduleParameters = this._getModuleParameters(\n          layer,\n          effects,\n          pass,\n          moduleParameters\n        );\n        layerParam.layerParameters = this.getLayerParameters(layer, layerIndex, viewport);\n      }\n      drawLayerParams[layerIndex] = layerParam;\n    }\n    return drawLayerParams;\n  }\n\n  // Draws a list of layers in one viewport\n  // TODO - when picking we could completely skip rendering viewports that dont\n  // intersect with the picking rect\n  /* eslint-disable max-depth, max-statements */\n  private _drawLayersInViewport(\n    gl,\n    {layers, moduleParameters: globalModuleParameters, pass, target, viewport, view},\n    drawLayerParams\n  ): RenderStats {\n    const glViewport = getGLViewport(gl, {\n      moduleParameters: globalModuleParameters,\n      target,\n      viewport\n    });\n\n    if (view && view.props.clear) {\n      const clearOpts = view.props.clear === true ? {color: true, depth: true} : view.props.clear;\n      withParameters(\n        gl,\n        {\n          scissorTest: true,\n          scissor: glViewport\n        },\n        () => clear(gl, clearOpts)\n      );\n    }\n\n    // render layers in normal colors\n    const renderStatus = {\n      totalCount: layers.length,\n      visibleCount: 0,\n      compositeCount: 0,\n      pickableCount: 0\n    };\n\n    setParameters(gl, {viewport: glViewport});\n\n    // render layers in normal colors\n    for (let layerIndex = 0; layerIndex < layers.length; layerIndex++) {\n      const layer = layers[layerIndex];\n      const {shouldDrawLayer, layerRenderIndex, moduleParameters, layerParameters} =\n        drawLayerParams[layerIndex];\n\n      // Calculate stats\n      if (shouldDrawLayer && layer.props.pickable) {\n        renderStatus.pickableCount++;\n      }\n      if (layer.isComposite) {\n        renderStatus.compositeCount++;\n      } else if (shouldDrawLayer) {\n        // Draw the layer\n        renderStatus.visibleCount++;\n\n        this._lastRenderIndex = Math.max(this._lastRenderIndex, layerRenderIndex);\n\n        // overwrite layer.context.viewport with the sub viewport\n        moduleParameters.viewport = viewport;\n\n        try {\n          layer._drawLayer({\n            moduleParameters,\n            uniforms: {layerIndex: layerRenderIndex},\n            parameters: layerParameters\n          });\n        } catch (err) {\n          layer.raiseError(err, `drawing ${layer} to ${pass}`);\n        }\n      }\n    }\n\n    return renderStatus;\n  }\n  /* eslint-enable max-depth, max-statements */\n\n  /* Methods for subclass overrides */\n  shouldDrawLayer(layer: Layer): boolean {\n    return true;\n  }\n\n  protected getModuleParameters(layer: Layer, effects?: Effect[]): any {\n    return null;\n  }\n\n  protected getLayerParameters(layer: Layer, layerIndex: number, viewport: Viewport): any {\n    return layer.props.parameters;\n  }\n\n  /* Private */\n  private _shouldDrawLayer(\n    layer: Layer,\n    drawContext: FilterContext,\n    layerFilter: ((params: FilterContext) => boolean) | undefined | null,\n    layerFilterCache: Record<string, boolean>\n  ) {\n    const shouldDrawLayer = layer.props.visible && this.shouldDrawLayer(layer);\n\n    if (!shouldDrawLayer) {\n      return false;\n    }\n\n    drawContext.layer = layer;\n\n    let parent = layer.parent as Layer;\n    while (parent) {\n      // @ts-ignore\n      if (!parent.props.visible || !parent.filterSubLayer(drawContext)) {\n        return false;\n      }\n      drawContext.layer = parent;\n      parent = parent.parent as Layer;\n    }\n\n    if (layerFilter) {\n      const rootLayerId = drawContext.layer.id;\n      if (!(rootLayerId in layerFilterCache)) {\n        layerFilterCache[rootLayerId] = layerFilter(drawContext);\n      }\n      if (!layerFilterCache[rootLayerId]) {\n        return false;\n      }\n    }\n\n    // If a layer is drawn, update its viewportChanged flag\n    layer.activateViewport(drawContext.viewport);\n\n    return true;\n  }\n\n  private _getModuleParameters(\n    layer: Layer,\n    effects: Effect[] | undefined,\n    pass: string,\n    overrides: any\n  ): any {\n    const moduleParameters = Object.assign(\n      Object.create(layer.internalState?.propsInTransition || layer.props),\n      {\n        autoWrapLongitude: layer.wrapLongitude,\n        // @ts-ignore\n        viewport: layer.context.viewport,\n        // @ts-ignore\n        mousePosition: layer.context.mousePosition,\n        pickingActive: 0,\n        devicePixelRatio: cssToDeviceRatio(this.gl)\n      }\n    );\n\n    if (effects) {\n      for (const effect of effects) {\n        Object.assign(moduleParameters, effect.getModuleParameters?.(layer));\n      }\n    }\n\n    return Object.assign(moduleParameters, this.getModuleParameters(layer, effects), overrides);\n  }\n}\n\n// If the _index prop is defined, return a layer index that's relative to its parent\n// Otherwise return the index of the layer among all rendered layers\n// This is done recursively, i.e. if the user overrides a layer's default index,\n// all its descendants will be resolved relative to that index.\n// This implementation assumes that parent layers always appear before its children\n// which is true if the layer array comes from the LayerManager\nexport function layerIndexResolver(\n  startIndex: number = 0,\n  layerIndices: Record<string, number> = {}\n): (layer: Layer, isDrawn: boolean) => number {\n  const resolvers = {};\n\n  const resolveLayerIndex = (layer, isDrawn) => {\n    const indexOverride = layer.props._offset;\n    const layerId = layer.id;\n    const parentId = layer.parent && layer.parent.id;\n\n    let index;\n\n    if (parentId && !(parentId in layerIndices)) {\n      // Populate layerIndices with the parent layer's index\n      resolveLayerIndex(layer.parent, false);\n    }\n\n    if (parentId in resolvers) {\n      const resolver = (resolvers[parentId] =\n        resolvers[parentId] || layerIndexResolver(layerIndices[parentId], layerIndices));\n      index = resolver(layer, isDrawn);\n      resolvers[layerId] = resolver;\n    } else if (Number.isFinite(indexOverride)) {\n      index = indexOverride + (layerIndices[parentId] || 0);\n      // Mark layer as needing its own resolver\n      // We don't actually create it until it's used for the first time\n      resolvers[layerId] = null;\n    } else {\n      index = startIndex;\n    }\n\n    if (isDrawn && index >= startIndex) {\n      startIndex = index + 1;\n    }\n\n    layerIndices[layerId] = index;\n    return index;\n  };\n  return resolveLayerIndex;\n}\n\n// Convert viewport top-left CSS coordinates to bottom up WebGL coordinates\nfunction getGLViewport(\n  gl,\n  {\n    moduleParameters,\n    target,\n    viewport\n  }: {\n    moduleParameters: any;\n    target?: Framebuffer;\n    viewport: Viewport;\n  }\n): [number, number, number, number] {\n  const useTarget = target && target.id !== 'default-framebuffer';\n  const pixelRatio =\n    (moduleParameters && moduleParameters.devicePixelRatio) || cssToDeviceRatio(gl);\n\n  // Default framebuffer is used when writing to canvas\n  const height = useTarget ? target.height : gl.drawingBufferHeight;\n\n  // Convert viewport top-left CSS coordinates to bottom up WebGL coordinates\n  const dimensions = viewport;\n  return [\n    dimensions.x * pixelRatio,\n    height - (dimensions.y + dimensions.height) * pixelRatio,\n    dimensions.width * pixelRatio,\n    dimensions.height * pixelRatio\n  ];\n}\n\nfunction clearGLCanvas(gl: WebGLRenderingContext, targetFramebuffer?: Framebuffer) {\n  const width = targetFramebuffer ? targetFramebuffer.width : gl.drawingBufferWidth;\n  const height = targetFramebuffer ? targetFramebuffer.height : gl.drawingBufferHeight;\n  // clear depth and color buffers, restoring transparency\n  setParameters(gl, {viewport: [0, 0, width, height]});\n  gl.clear(GL.COLOR_BUFFER_BIT | GL.DEPTH_BUFFER_BIT);\n}\n"],"file":"layers-pass.js"}