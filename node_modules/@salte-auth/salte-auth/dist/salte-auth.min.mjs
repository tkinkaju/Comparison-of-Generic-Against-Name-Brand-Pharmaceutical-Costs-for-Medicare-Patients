/**
 * @salte-auth/salte-auth JavaScript Library v3.0.0-rc.8
 *
 * @license MIT (https://github.com/salte-auth/salte-auth/blob/master/LICENSE)
 *
 * Made with â™¥ by Nick Woodward <nick@salte.io>, Dave Woodward <dave@salte.io>
 */
function e(e,t,n,r,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}var t=function(t){return function(){var n=this,r=arguments;return new Promise(function(i,s){var o=t.apply(n,r);function a(t){e(o,i,s,a,c,"next",t)}function c(t){e(o,i,s,a,c,"throw",t)}a(void 0)})}};var n=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e};class r extends Error{constructor(e){let t=e.message,r=e.code;super(t),n(this,"code",void 0),this.code=r}}class i{constructor(e){this.config=e||{}}required(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=t.filter(e=>void 0===this.config[e]);if(i.length>0)throw new r({code:"missing_required_properties",message:"Missing the following required fields. (".concat(i.join(", "),")")})}}class s{static setup(e){this.hasSetup&&!e||(this.hasSetup=!0,this.interceptors=[],this.real||(this.real=window.fetch),window.fetch&&(window.fetch=function(){var e=t(function*(e,t){const n=e instanceof Request?e:new Request(e,t);for(let e=0;e<s.interceptors.length;e++){const t=s.interceptors[e];yield Promise.resolve(t(n))}return s.real.call(this,n)});return function(t,n){return e.apply(this,arguments)}}()))}static add(e){this.setup(),this.interceptors.push(e)}}n(s,"real",void 0),n(s,"hasSetup",!1),n(s,"interceptors",void 0);let o=!1;const a=[];function c(){a.forEach(e=>e())}class l{static route(e){o||(window.addEventListener("popstate",c,{passive:!0}),window.addEventListener("click",c,{passive:!0}),setTimeout(c),o=!0),a.push(e)}static create(e,t){const n=document.createEvent("Event");return n.initEvent(e,t.bubbles||!1,t.cancelable||!0),n.detail=t.detail,n}static isCrossDomainError(e){return e instanceof DOMException||"Permission denied"===e.message}}class h{static setup(e){if(this.hasSetup&&!e)return;this.hasSetup=!0,this.interceptors=[],this.realOpen||(this.realOpen=XMLHttpRequest.prototype.open),this.realSend||(this.realSend=XMLHttpRequest.prototype.send);const t=XMLHttpRequest.prototype;t.open=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=t[1];return this.$url=r,h.realOpen.apply(this,t)},t.send=function(e){const t=[];for(let n=0;n<h.interceptors.length;n++){const r=h.interceptors[n];t.push(r(this,e))}Promise.all(t).then(()=>{h.realSend.call(this,e)}).catch(e=>{this.dispatchEvent(l.create("error",{detail:e}))})}}static add(e){this.setup(),this.interceptors.push(e)}}n(h,"realOpen",void 0),n(h,"realSend",void 0),n(h,"hasSetup",!1),n(h,"interceptors",void 0);var d=Object.freeze({Fetch:s,XHR:h});var u=function(e){if(Array.isArray(e))return e};var p=function(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(r=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){i=!0,s=e}finally{try{r||null==a.return||a.return()}finally{if(i)throw s}}return n};var f=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")};var g=function(e,t){return u(e)||p(e,t)||f()};let v,m,y;class w{static get origin(){return"".concat(location.protocol,"//").concat(location.host)}static resolve(e){return v||(v=document.implementation.createHTMLDocument("url"),m=v.createElement("base"),y=v.createElement("a"),v.head.appendChild(m)),m.href=window.location.protocol+"//"+window.location.host,y.href=e.replace(/ /g,"%20"),y.href.replace(/\/$/,"")}static match(e,t){if(t instanceof Array){const n=this.resolve(e);return!!x.find(t,e=>e instanceof RegExp?!!n.match(e):0===n.indexOf(this.resolve(e)))}return!0===t}static parse(e){let t=e.search,n=e.hash,r=[];t&&(r=r.concat(t.replace("?","").split("&"))),n&&(r=r.concat(n.replace("#","").split("&")));const i={};return x.forEach(r,e=>{const t=e.split("="),n=g(t,2),r=n[0],s=n[1];i[r]=s}),i}}const k={};class x{static includes(e,t){return-1!==e.indexOf(t)}static forEach(e,t){if(Array.isArray(e))for(let n=0;n<e.length;n++)t(e[n],n);else for(let n in e)t(e[n],n)}static find(e,t){if(Array.isArray(e))for(let n=0;n<e.length;n++){const r=e[n];if(t(r,n))return r}else for(let n in e){const r=e[n];if(t(r,n))return r}return null}static assign(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return this.forEach(n,t=>{for(const n in t)e[n]=t[n]}),e}static defaults(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return this.forEach(n,t=>{for(const n in t)this.isObject(e[n])&&this.isObject(t[n])?e[n]=this.defaults(e[n],t[n]):void 0===e[n]&&(e[n]=t[n])}),e}static isObject(e){return"object"==typeof e&&!Array.isArray(e)}static iframe(e){var n=this;return t(function*(){let t=e.url,r=e.redirectUrl,i=e.visible;const s=document.createElement("iframe");return s.setAttribute("owner","@salte-auth/salte-auth"),i?(n.assign(s.style,{border:"none",bottom:0,height:"100%",left:0,position:"fixed",right:0,top:0,width:"100%",zIndex:9999,opacity:0,transition:"0.5s opacity"}),setTimeout(()=>s.style.opacity="1")):s.style.display="none",s.src=t,document.body.appendChild(s),new Promise((e,t)=>{const n=setInterval(()=>{try{const i=s.contentWindow.location;if(0!==i.href.indexOf(r))return;const o=w.parse(i);s.parentElement&&s.parentElement.removeChild(s),clearInterval(n),e(o)}catch(e){if(l.isCrossDomainError(e))return;s.parentElement&&s.parentElement.removeChild(s),clearInterval(n),t(e)}})})})()}static debounce(e,t,n){clearTimeout(k[e]),k[e]=window.setTimeout(()=>{delete k[e],t()},n)}}class b{constructor(e,t,r){n(this,"raw",void 0),n(this,"expiration",void 0),n(this,"type",void 0),this.raw=e,this.expiration=x.includes([void 0,null],t)?null:Number(t),this.type=r}get expired(){return!this.raw||this.expiration<=Date.now()}}class _{constructor(e){n(this,"raw",void 0),n(this,"user",void 0),this.raw=e,this.user=_.parse(this.raw)}get expired(){return!this.user||1e3*this.user.exp<=Date.now()}static parse(e){try{const t=e.split(".");if(3!==t.length)throw new r({code:"invalid_id_token",message:"ID Token didn't match the desired format. ({header}.{payload}.{validation})"});return JSON.parse(atob(t[1].replace(/-/g,"+").replace(/_/g,"/")))}catch(e){return null}}}class T{constructor(e,t){n(this,"name",void 0),n(this,"level",void 0),this.name=e,this.level="string"==typeof t?this.toLevel(t):t}trace(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log("trace",e,...n)}info(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log("info",e,...n)}warn(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log("warn",e,...n)}error(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log("error",e,...n)}log(e,t){if(this.enabled(e)){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];console.log("".concat(e,": ").concat(t),...r)}}enabled(e){return!1!==this.level&&(!0===this.level||this.level<=this.toLevel(e))}toLevel(e){return x.find(T.levels,(t,n)=>n===e)}}n(T,"levels",{trace:0,info:1,warn:2,error:3});var $=Object.freeze({Interceptors:d,AccessToken:b,IDToken:_,Common:x,Events:l,URL:w,Logger:T});class E extends i{constructor(e){super(e),this.config=x.defaults(this.config,{storage:"session"})}get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.storage.getItem(this.key(e))||t}set(e,t){x.includes([void 0,null],t)?this.clear(e):this.storage.setItem(this.key(e),t)}clear(e){this.storage.removeItem(this.key(e))}reset(){const e=this.key("");for(const t in localStorage)0===t.indexOf(e)&&localStorage.removeItem(t);for(const t in sessionStorage)0===t.indexOf(e)&&sessionStorage.removeItem(t)}key(e){return"salte.auth.".concat(e)}get storage(){const e=this.config&&this.config.storage;switch(e){case"local":return localStorage;case"session":return sessionStorage}throw new r({code:"invalid_storage",message:"Storage doesn't exist for the given value. (".concat(e,")")})}}class U extends E{constructor(){super(...arguments),n(this,"listeners",new Map)}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(!this.listeners.has(e))return;const n=this.listeners.get(e);if(!n.length)return;const r=n.indexOf(t);-1!==r&&n.splice(r,1)}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(!this.listeners.has(e))return;const i=this.listeners.get(e);x.forEach(i,e=>e(...n))}}class A extends U{constructor(e){super(e),this.config=x.defaults(this.config,{redirectUrl:location.origin,level:"warn"})}redirectUrl(e){return"string"==typeof this.config.redirectUrl?this.config.redirectUrl:this.config.redirectUrl[e]}}var q=self.crypto||self.msCrypto,O=function(e){e=e||21;for(var t="",n=q.getRandomValues(new Uint8Array(e));0<e--;)t+="Uint8ArdomValuesObj012345679BCDEFGHIJKLMNPQRSTWXYZ_cfghkpqvwxyz-"[63&n[e]];return t};class S extends A{constructor(e){super(e),n(this,"logger",void 0),this.config=x.defaults(this.config,{validation:!0,level:"warn"}),this.logger=new T("@salte-auth/salte-auth:providers/".concat(this.$name),this.config.level)}validation(e){return"object"==typeof this.config.validation?!0===this.config.validation[e]:!0===this.config.validation}get $name(){return this.config.name||this.name}key(e){return"salte.auth.provider.".concat(this.$name,".").concat(e)}url(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e;return x.forEach(t,(e,t)=>{x.includes([void 0,null,""],e)||(n+="".concat(-1===n.indexOf("?")?"?":"&").concat(t,"=").concat(encodeURIComponent(e)))}),n}get logout(){throw new r({code:"logout_not_supported",message:"This provider doesn't support logout."})}}class I extends S{constructor(e){super(e),n(this,"accessToken",void 0),this.sync()}connected(){this.required("clientID","responseType")}secure(e){var n=this;return t(function*(){if("token"===n.config.responseType){if(n.accessToken.expired)return n.$login();if(e)if(e instanceof Request)e.headers.set("Authorization","Bearer ".concat(n.accessToken.raw));else{if(!(e instanceof XMLHttpRequest))throw new r({code:"unknown_request",message:"Unknown request type. (".concat(e,")")});e.setRequestHeader("Authorization","Bearer ".concat(n.accessToken.raw))}}return!0})()}$validate(e){try{if(!e)throw new r({code:"empty_response",message:"The response provided was empty, this is most likely due to the configured handler not providing it."});if(e.error)throw new r({code:e.error,message:"".concat(e.error_description?e.error_description:e.error).concat(e.error_uri?" (".concat(e.error_uri,")"):"")});const t=e.code,n=e.access_token,i=e.state,s=e.expires_in,o=e.token_type;if(this.validation("state")&&this.get("state")!==i)throw new r({code:"invalid_state",message:"State provided by identity provider did not match local state."});const a=this.get("response-type","").split(" ");if(x.includes(a,"code")){if(!t)throw new r({code:"invalid_code",message:"Expected a code to be returned by the Provider."})}else if(x.includes(a,"token")&&!n)throw new r({code:"invalid_access_token",message:"Expected an access token to be returned by the Provider."});t?(this.set("code.raw",t),this.clear("access-token.raw"),this.clear("access-token.expiration"),this.clear("access-token.type")):n&&(this.set("access-token.raw",n),this.set("access-token.expiration",Date.now()+1e3*Number(s)),this.set("access-token.type",o),this.clear("code.raw"))}finally{this.clear("state")}}validate(e){try{this.$validate(e)}catch(e){throw this.emit("login",e),e}finally{this.sync()}this.emit("login",null,this.code||this.accessToken)}get code(){return this.get("code.raw")}$login(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t="".concat(this.$name,"-state-").concat(O()),n=e.responseType||this.config.responseType;return this.set("state",t),this.set("response-type",n),this.url(this.login,{client_id:this.config.clientID,response_type:n,redirect_uri:this.config.redirectUrl,scope:this.config.scope,state:t})}sync(){this.accessToken=new b(this.get("access-token.raw"),this.get("access-token.expiration"),this.get("access-token.type"))}}class R extends I{constructor(e){super(e),n(this,"idToken",void 0),this.config.renewal="object"==typeof this.config.renewal?this.config.renewal:{type:this.config.renewal},this.config=x.defaults(this.config,{responseType:"id_token",scope:"openid",renewal:{type:"auto",buffer:6e4}}),this.sync()}secure(e){var n=this;return t(function*(){if(x.includes(["id_token","id_token token","token"],n.config.responseType)){if(n.idToken.expired)return n.$login();if(n.accessToken.expired){const e=yield x.iframe({redirectUrl:n.redirectUrl("login"),url:n.$login({prompt:"none",responseType:"token"})});n.validate(e)}if(e)if(e instanceof Request)e.headers.set("Authorization","Bearer ".concat(n.accessToken.raw));else{if(!(e instanceof XMLHttpRequest))throw new r({code:"unknown_request",message:"Unknown request type. (".concat(e,")")});e.setRequestHeader("Authorization","Bearer ".concat(n.accessToken.raw))}}return!0})()}$validate(e){try{super.$validate(e);const t=this.get("response-type","").split(" ");if(x.includes(t,"id_token")){const t=e.id_token,n=_.parse(t);if(!n)throw new r({code:"invalid_id_token",message:"Failed to parse user information due to invalid id token."});if(this.validation("nonce")&&this.get("nonce")!==n.nonce)throw new r({code:"invalid_nonce",message:"Nonce provided by identity provider did not match the local nonce."});this.set("id-token.raw",t)}else x.includes(t,"code")&&this.clear("id-token.raw")}finally{this.clear("nonce")}}validate(e){try{this.$validate(e)}catch(e){throw this.emit("login",e),e}finally{this.sync()}const t=this.get("response-type",""),n=t.split(" ");if(x.includes(n,"id_token"))this.emit("login",null,this.idToken);else if(x.includes(n,"token"))this.emit("login",null,this.accessToken);else{if(!x.includes(n,"code"))throw new r({code:"invalid_response_type",message:"Unknown Response Type (".concat(t,")")});this.emit("login",null,this.code)}}$login(e){const t="".concat(this.$name,"-nonce-").concat(O());return this.set("nonce",t),this.url(super.$login(e),{prompt:e&&e.prompt,nonce:t})}sync(){super.sync(),this.idToken=new _(this.get("id-token.raw"))}}var L=Object.freeze({OAuth2:class extends I{constructor(e){super(e),this.required("login")}get name(){return"generic.oauth2"}get login(){return this.config.login.apply(this)}},OpenID:class extends R{constructor(e){super(e),this.required("login","logout")}get name(){return"generic.openid"}get login(){return this.config.login.apply(this)}get logout(){return this.config.logout.apply(this)}}});class D extends E{constructor(e){super(e),n(this,"logger",void 0),this.config=x.defaults(this.config,{navigate:"reload",level:"warn"}),this.logger=new T("@salte-auth/salte-auth:handlers/".concat(this.$name),this.config.level)}get $name(){return this.config.name||this.name}key(e){return"salte.auth.handler.".concat(this.$name,".").concat(e)}navigate(e){"history"===this.config.navigate&&0===e.indexOf(w.origin)&&history.pushState("",document.title,e),location.href=e}}class j extends A{constructor(e){var i;super(e),i=this,n(this,"logger",void 0),n(this,"mixin",void 0),this.required("providers","handlers"),this.config=x.defaults(this.config,{validation:!0,level:"warn"}),this.logger=new T("@salte-auth/salte-auth:core",this.config.level),x.forEach(this.config.providers,e=>{e.connected&&e.connected(),e.on("login",(e,t)=>{this.emit("login",e,t)}),e.on("logout",e=>{this.emit("logout",e)})});const o=this.get("action"),a=o?this.provider(this.get("provider")):null,c=o?this.get("handler"):null;if(!x.includes([void 0,null,"login","logout"],o))throw new r({code:"unknown_action",message:"Unable to finish redirect due to an unknown action! (".concat(o,")")});var d;x.forEach(this.config.handlers,e=>{if(!e.connected)return;const t=e.$name===c;setTimeout(()=>{const n=e.connected({action:t?o:null});t&&("login"===o?a.validate(n):(a.reset(),a.sync(),a.emit("logout")))})}),this.clear("action"),this.clear("provider"),this.clear("handler"),s.add(function(){var e=t(function*(e){for(let t=0;t<i.config.providers.length;t++){const n=i.config.providers[t];w.match(e.url,n.config.endpoints)&&n.secure&&(yield n.secure(e))}});return function(t){return e.apply(this,arguments)}}()),h.add(function(){var e=t(function*(e){for(let t=0;t<i.config.providers.length;t++){const n=i.config.providers[t];w.match(e.$url,n.config.endpoints)&&n.secure&&(yield n.secure(e))}});return function(t){return e.apply(this,arguments)}}()),l.route(t(function*(){try{const e=i.handler();for(let t=0;t<i.config.providers.length;t++){const n=i.config.providers[t];if(w.match(location.href,n.config.routes)){let t=null;for(;!0!==t;)if("string"==typeof(t=yield n.secure())){if(!e.auto)throw new r({code:"auto_unsupported",message:"The default handler doesn't support automatic authentication! (".concat(e.$name,")")});i.set("action","login"),i.set("provider",n.$name),i.set("handler",e.$name);const s=yield e.open({redirectUrl:n.redirectUrl("login"),url:t});n.validate(s),i.clear("action"),i.clear("provider"),i.clear("handler")}}}}catch(e){throw i.clear("action"),i.clear("provider"),i.clear("handler"),e}})),this.mixin=(d=this,function(e){return class extends e{constructor(){super(...arguments),n(this,"auth",void 0),this.auth=d,this.auth.on("login",()=>{this.requestUpdate&&this.requestUpdate("auth")}),this.auth.on("logout",()=>{this.requestUpdate&&this.requestUpdate("auth")})}}})}login(e){var n=this;return t(function*(){e="string"==typeof e?{provider:e}:e;try{const t=n.provider(e.provider),r=n.handler(e.handler);n.set("action","login"),n.set("provider",t.$name),n.set("handler",r.$name);const i=yield r.open({redirectUrl:t.redirectUrl("login"),url:t.$login()});t.validate(i)}finally{n.clear("action"),n.clear("provider"),n.clear("handler")}})()}logout(e){var n=this;return t(function*(){e="string"==typeof e?{provider:e}:e;const t=n.provider(e.provider);try{const r=n.handler(e.handler);n.set("action","logout"),n.set("provider",t.$name),n.set("handler",r.$name),yield r.open({redirectUrl:t.redirectUrl("logout"),url:t.logout}),t.reset(),t.emit("logout")}catch(e){throw t.emit("logout",e),e}finally{n.clear("action"),n.clear("provider"),n.clear("handler")}})()}provider(e){const t=x.find(this.config.providers,t=>t.$name===e);if(!t)throw new r({code:"invalid_provider",message:"Unable to locate provider with the given name. (".concat(e,")")});return t}handler(e){const t=void 0===e?x.find(this.config.handlers,e=>!!e.config.default):x.find(this.config.handlers,t=>t.$name===e);if(!t)throw new r({code:"invalid_handler",message:"Unable to locate handler with the given name. (".concat(e,")")});return t}}export{L as Generic,D as Handler,I as OAuth2Provider,R as OpenIDProvider,j as SalteAuth,r as SalteAuthError,$ as Utils};
//# sourceMappingURL=salte-auth.min.mjs.map
