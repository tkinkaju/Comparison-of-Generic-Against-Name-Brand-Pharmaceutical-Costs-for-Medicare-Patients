import{Credentials as e}from"@carto/toolkit-core";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,r)};function r(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}function n(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{a(n.next(e))}catch(e){o(e)}}function u(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(s,u)}a((n=n.apply(e,t||[])).next())}))}function i(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}}var o={TOO_MANY_REQUESTS:429,SERVICE_UNAVAILABLE:503},s=Object.freeze({__proto__:null,QUERY_LIMIT:1024,DEFAULT_MAX_API_REQUESTS_RETRIES:0,HTTP_ERRORS:o}),u=function(){function e(e,t,r){var n=(void 0===r?{}:r).maxApiRequestsRetries;this._callsLeft=-1,this._retryAfter=-1,this._retryTimeoutId=-1,this._fetching=!1,this._scheduleDebounce=-1,this._maxApiRequestsRetries=0,this._credentials=e,this._endpointServerURL=t,this._queue=[],Number.isFinite(n)&&n>=0&&(this._maxApiRequestsRetries=n)}return Object.defineProperty(e.prototype,"apiKey",{get:function(){return this._credentials.apiKey},set:function(e){this._credentials.apiKey=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"endpointServerURL",{get:function(){return this._endpointServerURL},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"callsLeft",{get:function(){return this._callsLeft},set:function(e){this._callsLeft=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxApiRequestsRetries",{set:function(e){this._maxApiRequestsRetries=e},enumerable:!0,configurable:!0}),e.prototype._scheduleRequest=function(e,t,r,n){var i=this;this._queue.push({resolve:e,reject:t,requestInfo:r,requestInit:n,retries_count:-1}),clearTimeout(this._scheduleDebounce),this._scheduleDebounce=window.setTimeout((function(){i._scheduler()}),0)},e.prototype.addHeadersTo=function(e,t){void 0===t&&(t=[]),void 0!==e&&(e.headers||(e.headers=new Headers),t.length>0&&t.forEach((function(t){e.headers.append(t[0],t[1])})))},e.prototype._scheduler=function(){var e=this;if(0!==this._queue.length&&-1===this._retryTimeoutId&&!this._fetching)if(-1===this._retryAfter){for(var t=-1!==this._callsLeft?Math.min(Math.max(1,this._callsLeft),this._queue.length):1,r=[],n=0;n<t;n++)this._fetching=!0,r.push(this._fetch(this._queue[n],n));Promise.all(r).then((function(t){e._queue=e._queue.filter((function(e,r){return-1===t.indexOf(r)})),e._fetching=!1,e._queue.length>0&&e._scheduler()}))}else this._retryTimeoutId=window.setTimeout((function(){e._retryTimeoutId=-1,e._retryAfter=-1,e._callsLeft+=1,e._scheduler()}),1e3*this._retryAfter)},e.prototype._fetch=function(e,t){var r=this,s=e.resolve,u=e.reject,c=e.requestInfo,p=e.requestInit,h=e.retries_count;return fetch(c,p).then((function(t){return n(r,void 0,void 0,(function(){var r,n,s;return i(this,(function(i){switch(i.label){case 0:return this._retryAfter=this._getRateLimitHeader(t.headers,"Retry-After",this._retryAfter),this._callsLeft=this._getRateLimitHeader(t.headers,"Carto-Rate-Limit-Remaining",this._callsLeft),[4,a(t)];case 1:if(r=i.sent(),n=t.status===o.TOO_MANY_REQUESTS&&("datasource"===r.detail||"rate-limit"===r.detail),(t.status===o.SERVICE_UNAVAILABLE||n)&&(e.retries_count=-1!==h?h-1:this._maxApiRequestsRetries,s=.5*(this._maxApiRequestsRetries-e.retries_count)+.5,this._retryAfter=Math.max(this._retryAfter,s)),0===e.retries_count)throw new Error("Too many retries");return t.status===o.TOO_MANY_REQUESTS||t.status===o.SERVICE_UNAVAILABLE?(this._scheduler(),[2,null]):[2,r]}}))}))})).then((function(e){var r,n;if(null!==e){if(e.error){var i=(null===(n=null===(r=e)||void 0===r?void 0:r.error)||void 0===n?void 0:n.length)?e.error[0]:"Unknown error";u(new Error(i))}else s(e);return t}})).catch((function(e){return u(e),t}))},e.prototype._getRateLimitHeader=function(e,t,r){var n=e.get(t);return null!==n?parseInt(n,10):r},Object.defineProperty(e.prototype,"queued",{get:function(){return this._queue.length},enumerable:!0,configurable:!0}),e}();function a(e){return n(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return(e.headers.get("content-type")||"").includes("application/json")?[4,e.json()]:[3,2];case 1:return t=r.sent(),[3,4];case 2:return[4,e.text()];case 3:t=r.sent(),r.label=4;case 4:return[2,t]}}))}))}var c=function(e){function t(t,r){void 0===r&&(r={});var n=t.serverURL+"api/v2/sql/copyfrom";return e.call(this,t,n,r)||this}return r(t,e),t.prototype.copy=function(e,t,r,n){var i=this;void 0===n&&(n={});var o="COPY "+t+" ("+r+") FROM STDIN WITH (FORMAT csv, HEADER true);",s=this.endpointServerURL+"?api_key="+this.apiKey+"&q="+o,u={method:"POST",body:new Blob([e])},a=n.event?n.event.getHeaders():[];return this.addHeadersTo(u,a),new Promise((function(e,t){i._scheduleRequest(e,t,s,u)}))},t}(u),p=function(e){function t(t,r){void 0===r&&(r={});var n=t.serverURL+"api/v2/sql/copyto";return e.call(this,t,n,r)||this}return r(t,e),t.prototype.copyUrl=function(e,t,r){void 0===t&&(t="carto_copyto.csv"),void 0===r&&(r="FORMAT csv, HEADER true");var n="COPY ("+e+") TO stdout WITH("+r+")";return this.endpointServerURL+"?api_key="+this.apiKey+"&q="+n+"&filename="+t},t.prototype.copy=function(e,t,r){var n=this,i=this.copyUrl(e,t,r);return new Promise((function(e,t){n._scheduleRequest(e,t,i)}))},t}(u),h={string:"text",integer:"numeric",geojson:"json"},l=function(){function e(){}return e.drop=function(e,t){return t&&t.ifExists?"DROP TABLE IF EXISTS "+e+";":"DROP TABLE "+e+";"},e.create=function(e,t,r){var n="CREATE TABLE "+e+" ({rows});";r&&r.ifNotExists&&(n="CREATE TABLE IF NOT EXISTS "+e+" ({rows});");var i=t.map((function(e){if("string"==typeof e)return e;var t;e.type=(t=e.type,h[t]||t);var r='"'+e.name+'" '+e.type;return e.extra?r+" "+e.extra:r})).join(", ");return n.replace(/{rows}/,i)},e}();var f=function(e){function t(t,r){void 0===r&&(r={});var n=t.serverURL+"api/v2/sql";return e.call(this,t,n,r)||this}return r(t,e),t.prototype.query=function(e,t){void 0===t&&(t={});var r=[["api_key",this.apiKey],["q",e]];t.extraParams&&r.push.apply(r,t.extraParams);var n=t.event?t.event.getHeaders():[];return e.length<1024?this.prepareGetRequest(r,n):this.preparePostRequest(r,n)},t.prototype.prepareGetRequest=function(e,t){var r=this;void 0===t&&(t=[]);var n=encodeURI(e.map((function(e){return e[0]+"="+e[1]})).join("&")),i={method:"GET"};return this.addHeadersTo(i,t),new Promise((function(e,t){r._scheduleRequest(e,t,r.endpointServerURL+"?"+n,i)}))},t.prototype.preparePostRequest=function(e,t){var r=this;void 0===t&&(t=[]);var n=new FormData;e.forEach((function(e){return n.set(e[0],e[1])}));var i={method:"POST",body:n};return this.addHeadersTo(i,t),new Promise((function(e,t){r._scheduleRequest(e,t,""+r.endpointServerURL,i)}))},t}(u),d=function(){function t(t,r){var n=(void 0===r?{}:r).maxApiRequestsRetries;this._credentials=t,this._copyToManager=new p(this._credentials,{maxApiRequestsRetries:n}),this._queryManager=new f(this._credentials,{maxApiRequestsRetries:n}),this._copyFromManager=new c(this._credentials,{maxApiRequestsRetries:n});var i=new e(t.username,e.DEFAULT_PUBLIC_API_KEY,t.serverUrlTemplate);this._publicQueryManager=new f(i,{maxApiRequestsRetries:n})}return Object.defineProperty(t,"DDL",{get:function(){return l},enumerable:!0,configurable:!0}),t.prototype.copyFrom=function(e,t,r,n){return void 0===n&&(n={}),this._copyFromManager.copy(e,t,r,n)},t.prototype.exportURL=function(e){return this._copyToManager.copyUrl(e)},t.prototype.query=function(e,t){void 0===t&&(t={});var r=e.replace(/\s+/g," ").trim();return this._queryManager.query(r,t)},t.prototype.truncate=function(e){return this._queryManager.query("TRUNCATE "+e+";")},t.prototype.create=function(e,t,r){void 0===r&&(r={});var n=l.create(e,t,r.createOptions);return this._queryManager.query(n,{event:r.event})},t.prototype.drop=function(e,t){void 0===t&&(t={});var r=l.drop(e,t.dropOptions);return this._queryManager.query(r,{event:t.event})},t.prototype.grantPublicRead=function(e,t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var r,n;return i(this,(function(i){switch(i.label){case 0:return(n=this._publicRole)?[3,2]:[4,this.getRole(t)];case 1:n=i.sent(),i.label=2;case 2:return r=n,[2,this.grantReadToRole(e,r,t)]}}))}))},t.prototype.grantReadToRole=function(e,t,r){void 0===t&&(t="publicuser"),void 0===r&&(r={});var n="GRANT SELECT on "+e+' TO "'+t+'"';return this.query(n,r)},t.prototype.transaction=function(e){var t="\n      BEGIN;\n        "+e.join("\n")+"\n      COMMIT;\n    ";return this._queryManager.query(t)},t.prototype.setApiKey=function(e){this._credentials.apiKey=e,this._queryManager.apiKey=e,this._copyToManager.apiKey=e,this._copyFromManager.apiKey=e},t.prototype.getRole=function(e){var t=this;return void 0===e&&(e={}),this._publicQueryManager.query("SELECT current_user as rolename",e).then((function(e){if(e.error)throw new Error(e.error);if(0===e.rows.length)throw new Error("Cannot grant: got no current_user data");var r=e.rows[0].rolename;return t._publicRole=r,r}))},t}();export{s as Constants,d as SQL};
//# sourceMappingURL=sql.esm.js.map
