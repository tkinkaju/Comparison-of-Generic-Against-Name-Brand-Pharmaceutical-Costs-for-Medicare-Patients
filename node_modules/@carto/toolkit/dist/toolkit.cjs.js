"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@carto/toolkit-auth"),e=require("@carto/toolkit-core"),r=require("@carto/toolkit-custom-storage"),n=require("@carto/toolkit-sql"),o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};var i=function(){return(i=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function s(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function u(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){t.done?o(t.value):new r((function(e){e(t.value)})).then(s,u)}a((n=n.apply(t,e||[])).next())}))}function u(t,e){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}var a={namespace:"toolkit",serverUrlTemplate:e.Credentials.DEFAULT_SERVER_URL_TEMPLATE,maxApiRequestsRetries:n.Constants.DEFAULT_MAX_API_REQUESTS_RETRIES},l=function(){function t(t){void 0===t&&(t=a),this._customStorage=null,this._sql=null,this._serverUrlTemplate=e.Credentials.DEFAULT_SERVER_URL_TEMPLATE,this._apiKey=null,this._username=null,this._maxApiRequestsRetries=n.Constants.DEFAULT_MAX_API_REQUESTS_RETRIES,this._initPromise=null;var o=i(i({},a),t),s=o.namespace,u=o.serverUrlTemplate,l=o.maxApiRequestsRetries;this._namespace=s,this._serverUrlTemplate=u,this._maxApiRequestsRetries=l,this._publicStorageReader=new r.PublicStorageReader(s,u)}return t.prototype.setCredentials=function(t,n){return s(this,void 0,void 0,(function(){var o,i=this;return u(this,(function(s){return this._customStorage&&this._sql?[2,{SQL:this._sql,CustomStorage:this._customStorage}]:(this._apiKey=t,this._username=n,o=new e.Credentials(this._username,this._apiKey,this._serverUrlTemplate),this._customStorage=new r.CustomStorage(this._namespace,o,{maxApiRequestsRetries:this._maxApiRequestsRetries}),this._sql=this._customStorage.getSQLClient(),this._initPromise=this._customStorage.init().then((function(){if(null===i._sql||null===i._customStorage)throw new Error("Something went wrong setting the credentials");return{SQL:i._sql,CustomStorage:i._customStorage}})).catch((function(){throw new Error("Something went wrong initializing custom storage")})),[2,this._initPromise])}))}))},t.prototype.getCustomStorage=function(){if(null===this._initPromise)throw new Error("No auth has been set yet");return this._initPromise.then((function(t){return t.CustomStorage}))},t.prototype.getSQL=function(){if(null===this._initPromise)throw new Error("No auth has been set yet");return this._initPromise.then((function(t){return t.SQL}))},t.prototype.setApiKey=function(t){if(null===this._sql||null===this._customStorage)throw new Error("Cannot update api key if auth not set yet.");return this._apiKey=t,this._sql.setApiKey(t),this._customStorage.setApiKey(t),this._initPromise},Object.defineProperty(t.prototype,"PublicStorageReader",{get:function(){return this._publicStorageReader},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"username",{get:function(){return this._username},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"serverUrlTemplate",{get:function(){return this._serverUrlTemplate},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"namespace",{get:function(){return this._namespace},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"apiKey",{get:function(){return this._apiKey},enumerable:!0,configurable:!0}),t}(),c=function(e){function r(t,r){void 0===r&&(r=a);var n=e.call(this,r)||this;return n._oauth=null,n._oauthOptions=t,t.clientID&&n.initOauth(t),n}return function(t,e){function r(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(r,e),r.prototype.login=function(){return s(this,void 0,void 0,(function(){var t,e,r,n=this;return u(this,(function(o){switch(o.label){case 0:if(t=this.oauth,e=t.token,!t.expired)return[3,5];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,t.login()];case 2:return o.sent(),[3,4];case 3:throw r=o.sent(),new Error("Failed to login ("+r.error+"): "+r.message);case 4:e=t.token,o.label=5;case 5:if(null===e)throw new Error("Failed to login, token is null");return[2,new Promise((function(r,o){n.postLogin(t,e).then((function(t){r(t)})).catch((function(t){o(t)}))}))]}}))}))},Object.defineProperty(r.prototype,"oauth",{get:function(){if(null===this._oauth)throw new Error("No client ID has been specified");return this._oauth},enumerable:!0,configurable:!0}),r.prototype.setClientID=function(t){if(this._oauth)throw new Error("Cannot set the client ID more than once");void 0!==t&&this.initOauth(i({clientID:t},this._oauthOptions))},r.prototype.initOauth=function(e){this._oauth=new t.OAuth(e)},r.prototype.postLogin=function(t,e){return s(this,void 0,void 0,(function(){var r,n,o,i;return u(this,(function(s){switch(s.label){case 0:if(null===(r=t.userInfo))throw new Error("Failed to get user info");n=null,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,r.info];case 2:return o=s.sent(),n=o.username,this.setupEvents(t),[3,4];case 3:throw i=s.sent(),new Error("Failed to get user info: "+i.message);case 4:return[2,this.setCredentials(e,n)]}}))}))},r.prototype.setupEvents=function(t){var e=this;t.on("tokenUpdated",(function(){if(null===t.token)throw new Error("Got a null token after refreshing it");e.setApiKey(t.token)}))},r}(l);Object.defineProperty(exports,"OAuth",{enumerable:!0,get:function(){return t.OAuth}}),Object.defineProperty(exports,"Credentials",{enumerable:!0,get:function(){return e.Credentials}}),Object.defineProperty(exports,"CustomStorage",{enumerable:!0,get:function(){return r.CustomStorage}}),Object.defineProperty(exports,"SQL",{enumerable:!0,get:function(){return n.SQL}}),exports.App=l,exports.OAuthApp=c;
//# sourceMappingURL=toolkit.cjs.js.map
