!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).cartoToolkit={})}(this,(function(e){"use strict";class t{constructor(e,t,i="https://{user}.carto.com"){if(!e)throw new Error("Username is required");if(!t)throw new Error("Api key is required");this._username=e,this._apiKey=t,this._serverUrlTemplate=i}static get DEFAULT_SERVER_URL_TEMPLATE(){return"https://{user}.carto.com"}static get DEFAULT_PUBLIC_API_KEY(){return"default_public"}get username(){return this._username}set username(e){this._username=e}get apiKey(){return this._apiKey}set apiKey(e){this._apiKey=e}get serverUrlTemplate(){return this._serverUrlTemplate}set serverUrlTemplate(e){this._serverUrlTemplate=e}get serverURL(){let e=this._serverUrlTemplate.replace("{user}",this._username);return e.endsWith("/")||(e+="/"),e}}new t("username","default_public");class i{constructor(e,t,i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})){this.source=e,this.name=t,this.groupId=i}getHeaders(){return[["Carto-Event-Source",this.source],["Carto-Event",this.name],["Carto-Event-Group-Id",this.groupId]]}}
/**
	 * @salte-auth/salte-auth JavaScript Library v3.0.0-rc.8
	 *
	 * @license MIT (https://github.com/salte-auth/salte-auth/blob/master/LICENSE)
	 *
	 * Made with ♥ by Nick Woodward <nick@salte.io>, Dave Woodward <dave@salte.io>
	 */function r(e,t,i,r,n,s,o){try{var a=e[s](o),c=a.value}catch(e){return void i(e)}a.done?t(c):Promise.resolve(c).then(r,n)}var n=function(e){return function(){var t=this,i=arguments;return new Promise((function(n,s){var o=e.apply(t,i);function a(e){r(o,n,s,a,c,"next",e)}function c(e){r(o,n,s,a,c,"throw",e)}a(void 0)}))}},s=function(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e};class o extends Error{constructor(e){let t=e.message,i=e.code;super(t),s(this,"code",void 0),this.code=i}}class a{static setup(e){this.hasSetup&&!e||(this.hasSetup=!0,this.interceptors=[],this.real||(this.real=window.fetch),window.fetch&&(window.fetch=function(){var e=n((function*(e,t){const i=e instanceof Request?e:new Request(e,t);for(let e=0;e<a.interceptors.length;e++){const t=a.interceptors[e];yield Promise.resolve(t(i))}return a.real.call(this,i)}));return function(t,i){return e.apply(this,arguments)}}()))}static add(e){this.setup(),this.interceptors.push(e)}}s(a,"real",void 0),s(a,"hasSetup",!1),s(a,"interceptors",void 0);let c=!1;const l=[];function u(){l.forEach(e=>e())}class h{static route(e){c||(window.addEventListener("popstate",u,{passive:!0}),window.addEventListener("click",u,{passive:!0}),setTimeout(u),c=!0),l.push(e)}static create(e,t){const i=document.createEvent("Event");return i.initEvent(e,t.bubbles||!1,t.cancelable||!0),i.detail=t.detail,i}static isCrossDomainError(e){return e instanceof DOMException||"Permission denied"===e.message}}class d{static setup(e){if(this.hasSetup&&!e)return;this.hasSetup=!0,this.interceptors=[],this.realOpen||(this.realOpen=XMLHttpRequest.prototype.open),this.realSend||(this.realSend=XMLHttpRequest.prototype.send);const t=XMLHttpRequest.prototype;t.open=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const r=t[1];return this.$url=r,d.realOpen.apply(this,t)},t.send=function(e){const t=[];for(let i=0;i<d.interceptors.length;i++){const r=d.interceptors[i];t.push(r(this,e))}Promise.all(t).then(()=>{d.realSend.call(this,e)}).catch(e=>{this.dispatchEvent(h.create("error",{detail:e}))})}}static add(e){this.setup(),this.interceptors.push(e)}}s(d,"realOpen",void 0),s(d,"realSend",void 0),s(d,"hasSetup",!1),s(d,"interceptors",void 0);var p=Object.freeze({Fetch:a,XHR:d}),f=function(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=[],r=!0,n=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(r=(o=a.next()).done)&&(i.push(o.value),!t||i.length!==t);r=!0);}catch(e){n=!0,s=e}finally{try{r||null==a.return||a.return()}finally{if(n)throw s}}return i}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()};let _,v,g;class m{static get origin(){return"".concat(location.protocol,"//").concat(location.host)}static resolve(e){return _||(_=document.implementation.createHTMLDocument("url"),v=_.createElement("base"),g=_.createElement("a"),_.head.appendChild(v)),v.href=window.location.protocol+"//"+window.location.host,g.href=e.replace(/ /g,"%20"),g.href.replace(/\/$/,"")}static match(e,t){if(t instanceof Array){const i=this.resolve(e);return!!w.find(t,e=>e instanceof RegExp?!!i.match(e):0===i.indexOf(this.resolve(e)))}return!0===t}static parse(e){let t=e.search,i=e.hash,r=[];t&&(r=r.concat(t.replace("?","").split("&"))),i&&(r=r.concat(i.replace("#","").split("&")));const n={};return w.forEach(r,e=>{const t=e.split("="),i=f(t,2),r=i[0],s=i[1];n[r]=s}),n}}const y={};class w{static includes(e,t){return-1!==e.indexOf(t)}static forEach(e,t){if(Array.isArray(e))for(let i=0;i<e.length;i++)t(e[i],i);else for(let i in e)t(e[i],i)}static find(e,t){if(Array.isArray(e))for(let i=0;i<e.length;i++){const r=e[i];if(t(r,i))return r}else for(let i in e){const r=e[i];if(t(r,i))return r}return null}static assign(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return this.forEach(i,t=>{for(const i in t)e[i]=t[i]}),e}static defaults(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return this.forEach(i,t=>{for(const i in t)this.isObject(e[i])&&this.isObject(t[i])?e[i]=this.defaults(e[i],t[i]):void 0===e[i]&&(e[i]=t[i])}),e}static isObject(e){return"object"==typeof e&&!Array.isArray(e)}static iframe(e){var t=this;return n((function*(){let i=e.url,r=e.redirectUrl,n=e.visible;const s=document.createElement("iframe");return s.setAttribute("owner","@salte-auth/salte-auth"),n?(t.assign(s.style,{border:"none",bottom:0,height:"100%",left:0,position:"fixed",right:0,top:0,width:"100%",zIndex:9999,opacity:0,transition:"0.5s opacity"}),setTimeout(()=>s.style.opacity="1")):s.style.display="none",s.src=i,document.body.appendChild(s),new Promise((e,t)=>{const i=setInterval(()=>{try{const t=s.contentWindow.location;if(0!==t.href.indexOf(r))return;const n=m.parse(t);s.parentElement&&s.parentElement.removeChild(s),clearInterval(i),e(n)}catch(e){if(h.isCrossDomainError(e))return;s.parentElement&&s.parentElement.removeChild(s),clearInterval(i),t(e)}})})}))()}static debounce(e,t,i){clearTimeout(y[e]),y[e]=window.setTimeout(()=>{delete y[e],t()},i)}}class E{constructor(e,t,i){s(this,"raw",void 0),s(this,"expiration",void 0),s(this,"type",void 0),this.raw=e,this.expiration=w.includes([void 0,null],t)?null:Number(t),this.type=i}get expired(){return!this.raw||this.expiration<=Date.now()}}class T{constructor(e){s(this,"raw",void 0),s(this,"user",void 0),this.raw=e,this.user=T.parse(this.raw)}get expired(){return!this.user||1e3*this.user.exp<=Date.now()}static parse(e){try{const t=e.split(".");if(3!==t.length)throw new o({code:"invalid_id_token",message:"ID Token didn't match the desired format. ({header}.{payload}.{validation})"});return JSON.parse(atob(t[1].replace(/-/g,"+").replace(/_/g,"/")))}catch(e){return null}}}class b{constructor(e,t){s(this,"name",void 0),s(this,"level",void 0),this.name=e,this.level="string"==typeof t?this.toLevel(t):t}trace(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];this.log("trace",e,...i)}info(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];this.log("info",e,...i)}warn(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];this.log("warn",e,...i)}error(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];this.log("error",e,...i)}log(e,t){if(this.enabled(e)){for(var i=arguments.length,r=new Array(i>2?i-2:0),n=2;n<i;n++)r[n-2]=arguments[n];console.log("".concat(e,": ").concat(t),...r)}}enabled(e){return!1!==this.level&&(!0===this.level||this.level<=this.toLevel(e))}toLevel(e){return w.find(b.levels,(t,i)=>i===e)}}s(b,"levels",{trace:0,info:1,warn:2,error:3});var S=Object.freeze({Interceptors:p,AccessToken:E,IDToken:T,Common:w,Events:h,URL:m,Logger:b});class R extends class{constructor(e){this.config=e||{}}required(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const r=t.filter(e=>void 0===this.config[e]);if(r.length>0)throw new o({code:"missing_required_properties",message:"Missing the following required fields. (".concat(r.join(", "),")")})}}{constructor(e){super(e),this.config=w.defaults(this.config,{storage:"session"})}get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.storage.getItem(this.key(e))||t}set(e,t){w.includes([void 0,null],t)?this.clear(e):this.storage.setItem(this.key(e),t)}clear(e){this.storage.removeItem(this.key(e))}reset(){const e=this.key("");for(const t in localStorage)0===t.indexOf(e)&&localStorage.removeItem(t);for(const t in sessionStorage)0===t.indexOf(e)&&sessionStorage.removeItem(t)}key(e){return"salte.auth.".concat(e)}get storage(){const e=this.config&&this.config.storage;switch(e){case"local":return localStorage;case"session":return sessionStorage}throw new o({code:"invalid_storage",message:"Storage doesn't exist for the given value. (".concat(e,")")})}}class L extends R{constructor(){super(...arguments),s(this,"listeners",new Map)}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(!this.listeners.has(e))return;const i=this.listeners.get(e);if(!i.length)return;const r=i.indexOf(t);-1!==r&&i.splice(r,1)}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];if(!this.listeners.has(e))return;const n=this.listeners.get(e);w.forEach(n,e=>e(...i))}}class A extends L{constructor(e){super(e),this.config=w.defaults(this.config,{redirectUrl:location.origin,level:"warn"})}redirectUrl(e){return"string"==typeof this.config.redirectUrl?this.config.redirectUrl:this.config.redirectUrl[e]}}var I=self.crypto||self.msCrypto,q=function(e){e=e||21;for(var t="",i=I.getRandomValues(new Uint8Array(e));0<e--;)t+="Uint8ArdomValuesObj012345679BCDEFGHIJKLMNPQRSTWXYZ_cfghkpqvwxyz-"[63&i[e]];return t};class x extends A{constructor(e){super(e),s(this,"logger",void 0),this.config=w.defaults(this.config,{validation:!0,level:"warn"}),this.logger=new b("@salte-auth/salte-auth:providers/".concat(this.$name),this.config.level)}validation(e){return"object"==typeof this.config.validation?!0===this.config.validation[e]:!0===this.config.validation}get $name(){return this.config.name||this.name}key(e){return"salte.auth.provider.".concat(this.$name,".").concat(e)}url(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=e;return w.forEach(t,(e,t)=>{w.includes([void 0,null,""],e)||(i+="".concat(-1===i.indexOf("?")?"?":"&").concat(t,"=").concat(encodeURIComponent(e)))}),i}get logout(){throw new o({code:"logout_not_supported",message:"This provider doesn't support logout."})}}class O extends x{constructor(e){super(e),s(this,"accessToken",void 0),this.sync()}connected(){this.required("clientID","responseType")}secure(e){var t=this;return n((function*(){if("token"===t.config.responseType){if(t.accessToken.expired)return t.$login();if(e)if(e instanceof Request)e.headers.set("Authorization","Bearer ".concat(t.accessToken.raw));else{if(!(e instanceof XMLHttpRequest))throw new o({code:"unknown_request",message:"Unknown request type. (".concat(e,")")});e.setRequestHeader("Authorization","Bearer ".concat(t.accessToken.raw))}}return!0}))()}$validate(e){try{if(!e)throw new o({code:"empty_response",message:"The response provided was empty, this is most likely due to the configured handler not providing it."});if(e.error)throw new o({code:e.error,message:"".concat(e.error_description?e.error_description:e.error).concat(e.error_uri?" (".concat(e.error_uri,")"):"")});const t=e.code,i=e.access_token,r=e.state,n=e.expires_in,s=e.token_type;if(this.validation("state")&&this.get("state")!==r)throw new o({code:"invalid_state",message:"State provided by identity provider did not match local state."});const a=this.get("response-type","").split(" ");if(w.includes(a,"code")){if(!t)throw new o({code:"invalid_code",message:"Expected a code to be returned by the Provider."})}else if(w.includes(a,"token")&&!i)throw new o({code:"invalid_access_token",message:"Expected an access token to be returned by the Provider."});t?(this.set("code.raw",t),this.clear("access-token.raw"),this.clear("access-token.expiration"),this.clear("access-token.type")):i&&(this.set("access-token.raw",i),this.set("access-token.expiration",Date.now()+1e3*Number(n)),this.set("access-token.type",s),this.clear("code.raw"))}finally{this.clear("state")}}validate(e){try{this.$validate(e)}catch(e){throw this.emit("login",e),e}finally{this.sync()}this.emit("login",null,this.code||this.accessToken)}get code(){return this.get("code.raw")}$login(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t="".concat(this.$name,"-state-").concat(q()),i=e.responseType||this.config.responseType;return this.set("state",t),this.set("response-type",i),this.url(this.login,{client_id:this.config.clientID,response_type:i,redirect_uri:this.config.redirectUrl,scope:this.config.scope,state:t})}sync(){this.accessToken=new E(this.get("access-token.raw"),this.get("access-token.expiration"),this.get("access-token.type"))}}class U extends O{constructor(e){super(e),s(this,"idToken",void 0),this.config.renewal="object"==typeof this.config.renewal?this.config.renewal:{type:this.config.renewal},this.config=w.defaults(this.config,{responseType:"id_token",scope:"openid",renewal:{type:"auto",buffer:6e4}}),this.sync()}secure(e){var t=this;return n((function*(){if(w.includes(["id_token","id_token token","token"],t.config.responseType)){if(t.idToken.expired)return t.$login();if(t.accessToken.expired){const e=yield w.iframe({redirectUrl:t.redirectUrl("login"),url:t.$login({prompt:"none",responseType:"token"})});t.validate(e)}if(e)if(e instanceof Request)e.headers.set("Authorization","Bearer ".concat(t.accessToken.raw));else{if(!(e instanceof XMLHttpRequest))throw new o({code:"unknown_request",message:"Unknown request type. (".concat(e,")")});e.setRequestHeader("Authorization","Bearer ".concat(t.accessToken.raw))}}return!0}))()}$validate(e){try{super.$validate(e);const t=this.get("response-type","").split(" ");if(w.includes(t,"id_token")){const t=e.id_token,i=T.parse(t);if(!i)throw new o({code:"invalid_id_token",message:"Failed to parse user information due to invalid id token."});if(this.validation("nonce")&&this.get("nonce")!==i.nonce)throw new o({code:"invalid_nonce",message:"Nonce provided by identity provider did not match the local nonce."});this.set("id-token.raw",t)}else w.includes(t,"code")&&this.clear("id-token.raw")}finally{this.clear("nonce")}}validate(e){try{this.$validate(e)}catch(e){throw this.emit("login",e),e}finally{this.sync()}const t=this.get("response-type",""),i=t.split(" ");if(w.includes(i,"id_token"))this.emit("login",null,this.idToken);else if(w.includes(i,"token"))this.emit("login",null,this.accessToken);else{if(!w.includes(i,"code"))throw new o({code:"invalid_response_type",message:"Unknown Response Type (".concat(t,")")});this.emit("login",null,this.code)}}$login(e){const t="".concat(this.$name,"-nonce-").concat(q());return this.set("nonce",t),this.url(super.$login(e),{prompt:e&&e.prompt,nonce:t})}sync(){super.sync(),this.idToken=new T(this.get("id-token.raw"))}}Object.freeze({OAuth2:class extends O{constructor(e){super(e),this.required("login")}get name(){return"generic.oauth2"}get login(){return this.config.login.apply(this)}},OpenID:class extends U{constructor(e){super(e),this.required("login","logout")}get name(){return"generic.openid"}get login(){return this.config.login.apply(this)}get logout(){return this.config.logout.apply(this)}}});class k extends R{constructor(e){super(e),s(this,"logger",void 0),this.config=w.defaults(this.config,{navigate:"reload",level:"warn"}),this.logger=new b("@salte-auth/salte-auth:handlers/".concat(this.$name),this.config.level)}get $name(){return this.config.name||this.name}key(e){return"salte.auth.handler.".concat(this.$name,".").concat(e)}navigate(e){"history"===this.config.navigate&&0===e.indexOf(m.origin)&&history.pushState("",document.title,e),location.href=e}}class D extends A{constructor(e){var t;super(e),t=this,s(this,"logger",void 0),s(this,"mixin",void 0),this.required("providers","handlers"),this.config=w.defaults(this.config,{validation:!0,level:"warn"}),this.logger=new b("@salte-auth/salte-auth:core",this.config.level),w.forEach(this.config.providers,e=>{e.connected&&e.connected(),e.on("login",(e,t)=>{this.emit("login",e,t)}),e.on("logout",e=>{this.emit("logout",e)})});const i=this.get("action"),r=i?this.provider(this.get("provider")):null,c=i?this.get("handler"):null;if(!w.includes([void 0,null,"login","logout"],i))throw new o({code:"unknown_action",message:"Unable to finish redirect due to an unknown action! (".concat(i,")")});var l;w.forEach(this.config.handlers,e=>{if(!e.connected)return;const t=e.$name===c;setTimeout(()=>{const n=e.connected({action:t?i:null});t&&("login"===i?r.validate(n):(r.reset(),r.sync(),r.emit("logout")))})}),this.clear("action"),this.clear("provider"),this.clear("handler"),a.add(function(){var e=n((function*(e){for(let i=0;i<t.config.providers.length;i++){const r=t.config.providers[i];m.match(e.url,r.config.endpoints)&&r.secure&&(yield r.secure(e))}}));return function(t){return e.apply(this,arguments)}}()),d.add(function(){var e=n((function*(e){for(let i=0;i<t.config.providers.length;i++){const r=t.config.providers[i];m.match(e.$url,r.config.endpoints)&&r.secure&&(yield r.secure(e))}}));return function(t){return e.apply(this,arguments)}}()),h.route(n((function*(){try{const e=t.handler();for(let i=0;i<t.config.providers.length;i++){const r=t.config.providers[i];if(m.match(location.href,r.config.routes)){let i=null;for(;!0!==i;)if("string"==typeof(i=yield r.secure())){if(!e.auto)throw new o({code:"auto_unsupported",message:"The default handler doesn't support automatic authentication! (".concat(e.$name,")")});t.set("action","login"),t.set("provider",r.$name),t.set("handler",e.$name);const n=yield e.open({redirectUrl:r.redirectUrl("login"),url:i});r.validate(n),t.clear("action"),t.clear("provider"),t.clear("handler")}}}}catch(e){throw t.clear("action"),t.clear("provider"),t.clear("handler"),e}}))),this.mixin=(l=this,function(e){return class extends e{constructor(){super(...arguments),s(this,"auth",void 0),this.auth=l,this.auth.on("login",()=>{this.requestUpdate&&this.requestUpdate("auth")}),this.auth.on("logout",()=>{this.requestUpdate&&this.requestUpdate("auth")})}}})}login(e){var t=this;return n((function*(){e="string"==typeof e?{provider:e}:e;try{const i=t.provider(e.provider),r=t.handler(e.handler);t.set("action","login"),t.set("provider",i.$name),t.set("handler",r.$name);const n=yield r.open({redirectUrl:i.redirectUrl("login"),url:i.$login()});i.validate(n)}finally{t.clear("action"),t.clear("provider"),t.clear("handler")}}))()}logout(e){var t=this;return n((function*(){e="string"==typeof e?{provider:e}:e;const i=t.provider(e.provider);try{const r=t.handler(e.handler);t.set("action","logout"),t.set("provider",i.$name),t.set("handler",r.$name),yield r.open({redirectUrl:i.redirectUrl("logout"),url:i.logout}),i.reset(),i.emit("logout")}catch(e){throw i.emit("logout",e),e}finally{t.clear("action"),t.clear("provider"),t.clear("handler")}}))()}provider(e){const t=w.find(this.config.providers,t=>t.$name===e);if(!t)throw new o({code:"invalid_provider",message:"Unable to locate provider with the given name. (".concat(e,")")});return t}handler(e){const t=void 0===e?w.find(this.config.handlers,e=>!!e.config.default):w.find(this.config.handlers,t=>t.$name===e);if(!t)throw new o({code:"invalid_handler",message:"Unable to locate handler with the given name. (".concat(e,")")});return t}}
/**
	 * @salte-auth/popup JavaScript Library v1.0.0-rc.1
	 *
	 * @license MIT (https://github.com/salte-auth/popup/blob/master/LICENSE)
	 *
	 * Made with ♥ by Nick Woodward <nick@salte.io>, Dave Woodward <dave@salte.io>
	 */function N(e,t,i,r,n,s,o){try{var a=e[s](o),c=a.value}catch(e){return void i(e)}a.done?t(c):Promise.resolve(c).then(r,n)}class $ extends k{constructor(e){super(e),this.config=S.Common.defaults(this.config,{window:{name:"@salte-auth/tab",height:600,width:600}})}get name(){return"popup"}get auto(){return!1}open(e){var t=this;return function(e){return function(){var t=this,i=arguments;return new Promise((function(r,n){var s=e.apply(t,i);function o(e){N(s,r,n,o,a,"next",e)}function a(e){N(s,r,n,o,a,"throw",e)}o(void 0)}))}}((function*(){const i=window.innerHeight/2-t.config.window.height/2+window.screenTop,r=window.innerWidth/2-t.config.window.width/2+window.screenLeft,n=window.open(e.url,t.config.window.name,"height=".concat(t.config.window.height,", width=").concat(t.config.window.width,", status=yes, toolbar=no, menubar=no, location=no, top=").concat(i,", left=").concat(r));if(!n)throw new o({message:"We were unable to open the popup window, its likely that the request was blocked.",code:"popup_blocked"});return n.focus(),new Promise(t=>{const i=setInterval(()=>{try{if(!n.closed){if(0!==n.location.href.indexOf(e.redirectUrl))return;const i=S.URL.parse(n.location);n.close(),setTimeout(()=>t(i))}clearInterval(i)}catch(e){}},100)})}))()}}const P=[/offline/,/dataservices:geocoding/,/dataservices:isolines/,/dataservices:routing/,/dataservices:observatory/,/datasets:r:.+/,/datasets:w:.+/,/datasets:rw:.+/,/schemas:c/,/datasets:metadata/];class C extends O{constructor(){super(...arguments),this._userInfo=this.get("user_info")}get name(){return"carto"}get login(){return`${this.config.url}/authorize`}get logout(){return`${this.config.url}/logout`}get userInfo(){return this._userInfo}$validate(e){super.$validate(e),this._userInfo=decodeURIComponent(e.user_info_url),this.set("user_info",this._userInfo)}sync(){super.sync(),this._userInfo=this.get("user_info")}get expired(){return this.accessToken&&this.accessToken.expired}get expiresIn(){return void 0===this.accessToken?-1:this.accessToken.expiration}}class M{constructor(e){this._params=e}refresh(e){const t=[["client_id",this._params.clientID],["response_type","token"],["prompt","none"],["scopes",this._params.scopes],["state",e]];this._params.redirectURI&&t.push(["redirect_uri",this._params.redirectURI]);const i=`https://carto.com/oauth2/authorize?${function(e){return encodeURI(e.map(e=>`${e[0]}=${e[1]}`).join("&"))}(t)}`;return S.Common.iframe({url:i,redirectUrl:this._params.redirectURI||window.location.href,visible:!1})}}class F{constructor(e,t){this._apiKey=e,this._url=t}get info(){return fetch(`${this._url}?api_key=${this._apiKey}`).then(e=>e.json())}}class V{constructor(e,t){if(this._refreshTimeout=-1,null==e)throw new Error("Missing OAuth parameters");var i;e.authorization=e.authorization||"https://carto.com/oauth2",e.scopes=e.scopes||"",this._emitter=(i=i||Object.create(null),{on:function(e,t){(i[e]||(i[e]=[])).push(t)},off:function(e,t){i[e]&&i[e].splice(i[e].indexOf(t)>>>0,1)},emit:function(e,t){(i[e]||[]).slice().map((function(e){e(t)})),(i["*"]||[]).slice().map((function(i){i(e,t)}))}}),this._client=new D({providers:[new C({storage:"local",level:"trace",url:e.authorization,redirectUrl:e.redirectURI,clientID:e.clientID,responseType:"token",scope:e.scopes})],handlers:[new $({default:!0})]}),this._refresher=new M({authorization:e.authorization,redirectURI:t||e.redirectURI,clientID:e.clientID,scopes:e.scopes}),this._carto=this._client.provider("carto"),this._carto.expired||this._scheduleRefresh(),e.scopes&&this._checkScopes(e.scopes)}login(){return new Promise((e,t)=>{const i=(r,n)=>{if(r){const e={error:r.code,message:decodeURIComponent(r.message.replace(/\+/g,"%20"))};return t(e),void this._emitter.emit("error",e)}e(n),this._emitter.emit("tokenUpdated",n),this._carto.off("login",i),this._scheduleRefresh()};this._client.on("login",i),this._client.login("carto").catch(e=>{t(e)})})}get client(){return this._client}get expired(){return this._carto.accessToken&&this._carto.accessToken.expired}get credentials(){return this._carto.accessToken?new t(this._carto.userInfo,this._carto.accessToken.raw):null}get token(){return null==this._carto.accessToken?null:this._carto.accessToken.raw}get userInfo(){return null===this.token?null:new F(this.token,this._carto.userInfo)}clear(){this._carto.reset()}on(e,t){this._emitter.on(e,t)}_scheduleRefresh(){clearTimeout(this._refreshTimeout),this._refreshTimeout=window.setTimeout(()=>{this._refresh()},this._carto.expiresIn-Date.now()-3e5)}_refresh(){if(this._carto.expired)return;const e=Date.now();this._carto.set("state",`6574686572766f69642d74726169746f72-${e}`),this._refresher.refresh(`6574686572766f69642d74726169746f72-${e}`).then(e=>{e.error?this._emitter.emit("error",{error:e.error,message:e.error_description.replace(/\+/g," ")}):(this._carto.validate(e),this._emitter.emit("tokenUpdated",e.access_token))}).catch(e=>{this._emitter.emit("error",e)})}_checkScopes(e){const t=new Set,i=e.split(" ");e&&function(e){return e.filter(e=>!function(e){return P.some(t=>null!==t.exec(e))}(e))}(i||[]).forEach(e=>t.add(e)),t.forEach(e=>{console.warn(`Unknown scope ${e}`)})}}
/*! *****************************************************************************
	Copyright (c) Microsoft Corporation. All rights reserved.
	Licensed under the Apache License, Version 2.0 (the "License"); you may not use
	this file except in compliance with the License. You may obtain a copy of the
	License at http://www.apache.org/licenses/LICENSE-2.0

	THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
	KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
	WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
	MERCHANTABLITY OR NON-INFRINGEMENT.

	See the Apache Version 2.0 License for specific language governing permissions
	and limitations under the License.
	***************************************************************************** */var j=function(e,t){return(j=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function z(e,t){function i(){this.constructor=e}j(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}function Q(e,t,i,r){return new(i||(i=Promise))((function(n,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){e.done?n(e.value):new i((function(t){t(e.value)})).then(o,a)}c((r=r.apply(e,t||[])).next())}))}function H(e,t){var i,r,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,r&&(n=2&s[0]?r.return:s[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,s[1])).done)return n;switch(r=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(n=(n=o.trys).length>0&&n[n.length-1])&&(6===s[0]||2===s[0])){o=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){o.label=s[1];break}if(6===s[0]&&o.label<n[1]){o.label=n[1],n=s;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(s);break}n[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{i=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}var K={TOO_MANY_REQUESTS:429,SERVICE_UNAVAILABLE:503},B=Object.freeze({__proto__:null,QUERY_LIMIT:1024,DEFAULT_MAX_API_REQUESTS_RETRIES:0,HTTP_ERRORS:K}),W=function(){function e(e,t,i){var r=(void 0===i?{}:i).maxApiRequestsRetries;this._callsLeft=-1,this._retryAfter=-1,this._retryTimeoutId=-1,this._fetching=!1,this._scheduleDebounce=-1,this._maxApiRequestsRetries=0,this._credentials=e,this._endpointServerURL=t,this._queue=[],Number.isFinite(r)&&r>=0&&(this._maxApiRequestsRetries=r)}return Object.defineProperty(e.prototype,"apiKey",{get:function(){return this._credentials.apiKey},set:function(e){this._credentials.apiKey=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"endpointServerURL",{get:function(){return this._endpointServerURL},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"callsLeft",{get:function(){return this._callsLeft},set:function(e){this._callsLeft=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxApiRequestsRetries",{set:function(e){this._maxApiRequestsRetries=e},enumerable:!0,configurable:!0}),e.prototype._scheduleRequest=function(e,t,i,r){var n=this;this._queue.push({resolve:e,reject:t,requestInfo:i,requestInit:r,retries_count:-1}),clearTimeout(this._scheduleDebounce),this._scheduleDebounce=window.setTimeout((function(){n._scheduler()}),0)},e.prototype.addHeadersTo=function(e,t){void 0===t&&(t=[]),void 0!==e&&(e.headers||(e.headers=new Headers),t.length>0&&t.forEach((function(t){e.headers.append(t[0],t[1])})))},e.prototype._scheduler=function(){var e=this;if(0!==this._queue.length&&-1===this._retryTimeoutId&&!this._fetching)if(-1===this._retryAfter){for(var t=-1!==this._callsLeft?Math.min(Math.max(1,this._callsLeft),this._queue.length):1,i=[],r=0;r<t;r++)this._fetching=!0,i.push(this._fetch(this._queue[r],r));Promise.all(i).then((function(t){e._queue=e._queue.filter((function(e,i){return-1===t.indexOf(i)})),e._fetching=!1,e._queue.length>0&&e._scheduler()}))}else this._retryTimeoutId=window.setTimeout((function(){e._retryTimeoutId=-1,e._retryAfter=-1,e._callsLeft+=1,e._scheduler()}),1e3*this._retryAfter)},e.prototype._fetch=function(e,t){var i=this,r=e.resolve,n=e.reject,s=e.requestInfo,o=e.requestInit,a=e.retries_count;return fetch(s,o).then((function(t){return Q(i,void 0,void 0,(function(){var i,r,n;return H(this,(function(s){switch(s.label){case 0:return this._retryAfter=this._getRateLimitHeader(t.headers,"Retry-After",this._retryAfter),this._callsLeft=this._getRateLimitHeader(t.headers,"Carto-Rate-Limit-Remaining",this._callsLeft),[4,G(t)];case 1:if(i=s.sent(),r=t.status===K.TOO_MANY_REQUESTS&&("datasource"===i.detail||"rate-limit"===i.detail),(t.status===K.SERVICE_UNAVAILABLE||r)&&(e.retries_count=-1!==a?a-1:this._maxApiRequestsRetries,n=.5*(this._maxApiRequestsRetries-e.retries_count)+.5,this._retryAfter=Math.max(this._retryAfter,n)),0===e.retries_count)throw new Error("Too many retries");return t.status===K.TOO_MANY_REQUESTS||t.status===K.SERVICE_UNAVAILABLE?(this._scheduler(),[2,null]):[2,i]}}))}))})).then((function(e){var i,s;if(null!==e){if(e.error){var o=(null===(s=null===(i=e)||void 0===i?void 0:i.error)||void 0===s?void 0:s.length)?e.error[0]:"Unknown error";n(new Error(o))}else r(e);return t}})).catch((function(e){return n(e),t}))},e.prototype._getRateLimitHeader=function(e,t,i){var r=e.get(t);return null!==r?parseInt(r,10):i},Object.defineProperty(e.prototype,"queued",{get:function(){return this._queue.length},enumerable:!0,configurable:!0}),e}();function G(e){return Q(this,void 0,void 0,(function(){var t;return H(this,(function(i){switch(i.label){case 0:return(e.headers.get("content-type")||"").includes("application/json")?[4,e.json()]:[3,2];case 1:return t=i.sent(),[3,4];case 2:return[4,e.text()];case 3:t=i.sent(),i.label=4;case 4:return[2,t]}}))}))}var X=function(e){function t(t,i){void 0===i&&(i={});var r=t.serverURL+"api/v2/sql/copyfrom";return e.call(this,t,r,i)||this}return z(t,e),t.prototype.copy=function(e,t,i,r){var n=this;void 0===r&&(r={});var s="COPY "+t+" ("+i+") FROM STDIN WITH (FORMAT csv, HEADER true);",o=this.endpointServerURL+"?api_key="+this.apiKey+"&q="+s,a={method:"POST",body:new Blob([e])},c=r.event?r.event.getHeaders():[];return this.addHeadersTo(a,c),new Promise((function(e,t){n._scheduleRequest(e,t,o,a)}))},t}(W),Y=function(e){function t(t,i){void 0===i&&(i={});var r=t.serverURL+"api/v2/sql/copyto";return e.call(this,t,r,i)||this}return z(t,e),t.prototype.copyUrl=function(e,t,i){void 0===t&&(t="carto_copyto.csv"),void 0===i&&(i="FORMAT csv, HEADER true");var r="COPY ("+e+") TO stdout WITH("+i+")";return this.endpointServerURL+"?api_key="+this.apiKey+"&q="+r+"&filename="+t},t.prototype.copy=function(e,t,i){var r=this,n=this.copyUrl(e,t,i);return new Promise((function(e,t){r._scheduleRequest(e,t,n)}))},t}(W),J={string:"text",integer:"numeric",geojson:"json"},Z=function(){function e(){}return e.drop=function(e,t){return t&&t.ifExists?"DROP TABLE IF EXISTS "+e+";":"DROP TABLE "+e+";"},e.create=function(e,t,i){var r="CREATE TABLE "+e+" ({rows});";i&&i.ifNotExists&&(r="CREATE TABLE IF NOT EXISTS "+e+" ({rows});");var n=t.map((function(e){if("string"==typeof e)return e;var t;e.type=(t=e.type,J[t]||t);var i='"'+e.name+'" '+e.type;return e.extra?i+" "+e.extra:i})).join(", ");return r.replace(/{rows}/,n)},e}(),ee=function(e){function t(t,i){void 0===i&&(i={});var r=t.serverURL+"api/v2/sql";return e.call(this,t,r,i)||this}return z(t,e),t.prototype.query=function(e,t){void 0===t&&(t={});var i=[["api_key",this.apiKey],["q",e]];t.extraParams&&i.push.apply(i,t.extraParams);var r=t.event?t.event.getHeaders():[];return e.length<1024?this.prepareGetRequest(i,r):this.preparePostRequest(i,r)},t.prototype.prepareGetRequest=function(e,t){var i=this;void 0===t&&(t=[]);var r=encodeURI(e.map((function(e){return e[0]+"="+e[1]})).join("&")),n={method:"GET"};return this.addHeadersTo(n,t),new Promise((function(e,t){i._scheduleRequest(e,t,i.endpointServerURL+"?"+r,n)}))},t.prototype.preparePostRequest=function(e,t){var i=this;void 0===t&&(t=[]);var r=new FormData;e.forEach((function(e){return r.set(e[0],e[1])}));var n={method:"POST",body:r};return this.addHeadersTo(n,t),new Promise((function(e,t){i._scheduleRequest(e,t,""+i.endpointServerURL,n)}))},t}(W),te=function(){function e(e,i){var r=(void 0===i?{}:i).maxApiRequestsRetries;this._credentials=e,this._copyToManager=new Y(this._credentials,{maxApiRequestsRetries:r}),this._queryManager=new ee(this._credentials,{maxApiRequestsRetries:r}),this._copyFromManager=new X(this._credentials,{maxApiRequestsRetries:r});var n=new t(e.username,t.DEFAULT_PUBLIC_API_KEY,e.serverUrlTemplate);this._publicQueryManager=new ee(n,{maxApiRequestsRetries:r})}return Object.defineProperty(e,"DDL",{get:function(){return Z},enumerable:!0,configurable:!0}),e.prototype.copyFrom=function(e,t,i,r){return void 0===r&&(r={}),this._copyFromManager.copy(e,t,i,r)},e.prototype.exportURL=function(e){return this._copyToManager.copyUrl(e)},e.prototype.query=function(e,t){void 0===t&&(t={});var i=e.replace(/\s+/g," ").trim();return this._queryManager.query(i,t)},e.prototype.truncate=function(e){return this._queryManager.query("TRUNCATE "+e+";")},e.prototype.create=function(e,t,i){void 0===i&&(i={});var r=Z.create(e,t,i.createOptions);return this._queryManager.query(r,{event:i.event})},e.prototype.drop=function(e,t){void 0===t&&(t={});var i=Z.drop(e,t.dropOptions);return this._queryManager.query(i,{event:t.event})},e.prototype.grantPublicRead=function(e,t){return void 0===t&&(t={}),Q(this,void 0,void 0,(function(){var i,r;return H(this,(function(n){switch(n.label){case 0:return(r=this._publicRole)?[3,2]:[4,this.getRole(t)];case 1:r=n.sent(),n.label=2;case 2:return i=r,[2,this.grantReadToRole(e,i,t)]}}))}))},e.prototype.grantReadToRole=function(e,t,i){void 0===t&&(t="publicuser"),void 0===i&&(i={});var r="GRANT SELECT on "+e+' TO "'+t+'"';return this.query(r,i)},e.prototype.transaction=function(e){var t="\n      BEGIN;\n        "+e.join("\n")+"\n      COMMIT;\n    ";return this._queryManager.query(t)},e.prototype.setApiKey=function(e){this._credentials.apiKey=e,this._queryManager.apiKey=e,this._copyToManager.apiKey=e,this._copyFromManager.apiKey=e},e.prototype.getRole=function(e){var t=this;return void 0===e&&(e={}),this._publicQueryManager.query("SELECT current_user as rolename",e).then((function(e){if(e.error)throw new Error(e.error);if(0===e.rows.length)throw new Error("Cannot grant: got no current_user data");var i=e.rows[0].rolename;return t._publicRole=i,i}))},e}();
/*! *****************************************************************************
	Copyright (c) Microsoft Corporation. All rights reserved.
	Licensed under the Apache License, Version 2.0 (the "License"); you may not use
	this file except in compliance with the License. You may obtain a copy of the
	License at http://www.apache.org/licenses/LICENSE-2.0

	THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
	KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
	WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
	MERCHANTABLITY OR NON-INFRINGEMENT.

	See the Apache Version 2.0 License for specific language governing permissions
	and limitations under the License.
	***************************************************************************** */
function ie(e,t,i,r){return new(i||(i=Promise))((function(n,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){e.done?n(e.value):new i((function(t){t(e.value)})).then(o,a)}c((r=r.apply(e,t||[])).next())}))}class re extends class{constructor(e,t){this.errorCode=e,this.message=t}}{constructor(e){super("DUPLICATED_DATASETS","Some datasets are duplicated"),this.datasets=e}}function ne(e){return{id:e.id,name:e.name,description:e.description,thumbnail:e.thumbnail,isprivate:e.isprivate,config:e.config,lastmodified:e.lastmodified}}function se(e,t,i,r={}){return ie(this,void 0,void 0,(function*(){const n={extraParams:[["format","csv"]],event:r.event},s=yield i.query(`SELECT * FROM ${t}`,n);if("string"!=typeof s)throw new Error(s.error);return{name:e,file:s}}))}function oe(e,t,i,r={}){return ie(this,void 0,void 0,(function*(){const n=yield i.query(`SELECT * FROM ${e.vis} WHERE id = '${t}'`,r);if(n.error)throw new Error(n.error);if(0===n.rows.length)return null;const s=ne(n.rows[0]),o=yield function(e,t,i,r={}){return ie(this,void 0,void 0,(function*(){const n=yield i.query(`\n    WITH datasets AS (SELECT dataset FROM ${e.visToDatasets} WHERE vis = '${t}')\n    SELECT t.id, t.name, t.tablename FROM ${e.datasets} t, datasets u\n    WHERE t.id = u.dataset\n  `,r);if(n.error)throw new Error(n.error);return n.rows}))}(e,t,i,r);return 0===o.length?{vis:s,datasets:[]}:{vis:s,datasets:yield Promise.all(o.map(e=>se(e.name,e.tablename,i,r)))}}))}function ae(e,t,i){return`${e}_${t?"public":"private"}_v${i}`}function ce(e){return`${e}_datasets`}function le(e){return`${e}_datasets_vis`}class ue{constructor(e,t,i,r){this._isReady=!1,this._namespace=e,this._tableName=ae(e,r,i),this._datasetsTableName=ce(this._tableName),this._datasetsVisTableName=le(this._tableName),this._isPublic=r,this.VIS_FIELDS={id:{name:"id",type:"uuid",extra:`PRIMARY KEY DEFAULT ${this._namespace}_create_uuid()`,omitOnInsert:!0},name:{name:"name",type:"text",extra:"NOT NULL",format:this.escapeOrNull},description:{name:"description",type:"text",format:this.escapeOrNull},thumbnail:{name:"thumbnail",type:"text",format:this.escapeOrNull},isprivate:{name:"isprivate",type:"boolean",format:e=>void 0!==e&&e},config:{name:"config",type:"json",format:this.escapeOrNull},lastmodified:{name:"lastmodified",type:"timestamp",extra:"NOT NULL DEFAULT now()",omitOnInsert:!0}},this.DATASET_COLUMNS=[`"id" uuid PRIMARY KEY DEFAULT ${this._namespace}_create_uuid()`,'"tablename" text UNIQUE NOT NULL','"name" text UNIQUE NOT NULL'],this.DATASET_VIS_COLUMNS=['"vis" uuid NOT NULL','"dataset" uuid NOT NULL'],this.FIELD_NAMES=Object.values(this.VIS_FIELDS).map(e=>e.name),this.FIELD_NAMES_INSERT=Object.values(this.VIS_FIELDS).filter(e=>!e.omitOnInsert).map(e=>e.name),this._sql=t}init(e={}){return ie(this,void 0,void 0,(function*(){const t=yield this._checkMissingTables();return t&&(yield this._initTables({event:e.event})),this._isReady=!0,t}))}isInitialized(){return ie(this,void 0,void 0,(function*(){const e=yield this._checkMissingTables();return this._isReady=!e,this._isReady}))}getVisualizations(e={}){return this._sql.query(`\n      SELECT ${this.FIELD_NAMES.filter(e=>"config"!==e).map(e=>`"${e}"`).join(", ")}\n      FROM ${this._tableName}\n      `,e).then(e=>{if(e.error)throw new Error(e.error);return 0===e.rows.length?[]:e.rows.map(ne)})}getVisualization(e,t={}){return ie(this,void 0,void 0,(function*(){return oe({vis:this._tableName,datasets:this._datasetsTableName,visToDatasets:this._datasetsVisTableName},e,this._sql,t)}))}getDatasetData(e,t){return ie(this,void 0,void 0,(function*(){return se(e,t,this._sql)}))}getDataset(e,t={}){return ie(this,void 0,void 0,(function*(){const i=yield this._sql.query(`\n      SELECT * FROM ${this._datasetsTableName} WHERE "name"='${e}'\n    `,t);if(i.error)throw new Error(`Failed to get dataset ${e}`);return i.rows[0]||null}))}getDatasets(){return ie(this,void 0,void 0,(function*(){const e=yield this._sql.query(`\n      SELECT * FROM ${this._datasetsTableName}\n    `);if(e.error)throw new Error("Failed to read datasets");return e.rows}))}getVisForDataset(e){return ie(this,void 0,void 0,(function*(){const t=yield this._sql.query(`\n      WITH dataset_vis as (SELECT * FROM ${this._datasetsVisTableName} WHERE "dataset" = '${e}')\n\n      SELECT t."name", t."id", t."thumbnail", t."isprivate"\n      FROM ${this._tableName} t, dataset_vis u WHERE t."id" = u."vis"\n    `);if(t.error)throw new Error("Failed to read visualizations");return t.rows.map(ne)}))}deleteVisualization(e,t={}){return ie(this,void 0,void 0,(function*(){yield this._sql.query(`DELETE FROM ${this._datasetsVisTableName} WHERE "vis"='${e}'`,t),yield this._sql.query(`DELETE FROM ${this._tableName} WHERE "id"='${e}'`,t),yield this.deleteOrphanDatasets(t)}))}deleteDataset(){return ie(this,void 0,void 0,(function*(){throw new Error("deleteDataset Not implemented yet")}))}createVisualization(e,t,i={}){return ie(this,void 0,void 0,(function*(){yield this.preventAccidentalDatasetsOverwrite(i.overwriteDatasets,t);const r=yield this.insertVisTable(e,{event:i.event});return null===r?null:(yield this.uploadAndLinkDatasetsTo(r.id,t,e.isprivate,i),Object.assign(Object.assign({},r),e))}))}uploadDataset(e,t={overwrite:!1}){return ie(this,void 0,void 0,(function*(){const i=`${this._tableName}_${e.name}`;if(!e.columns)throw new Error("Need dataset column information");const r=yield this.getDataset(e.name,{event:t.event});t.overwrite&&null!==r&&(yield this._sql.query(`DROP TABLE IF EXISTS ${i}`,{event:t.event}));const n={createOptions:{ifNotExists:!1},event:t.event},s=yield this._sql.create(i,e.columns,n);if(s.error)throw new Error(`Failed to create table for dataset ${e.name}: ${s.error}`);let o;try{const r=e.columns.map(e=>"string"==typeof e?`"${e}"`:`"${e.name}"`);o=yield this._sql.copyFrom(e.file,i,r,{event:t.event})}catch(e){throw new Error(`Failed to copy to ${i}: ${e.message}`)}if(o.error)throw new Error(`Failed to copy to ${i}: ${o.error}`);if(null===r){const r=yield this._sql.query(`\n        INSERT INTO ${this._datasetsTableName} ("id", "name", "tablename")\n        VALUES (${this._namespace}_create_uuid(), '${e.name}', '${i}')\n        RETURNING *\n      `,{event:t.event});if(r.error)throw new Error(`Failed to register dataset ${i} ${r.error}`);return r.rows[0]}return r}))}shareDataset(e,t={}){return this._sql.grantPublicRead(e,t)}updateVisualization(e,t,i={}){return ie(this,void 0,void 0,(function*(){const r=yield this.updateVisTable(e,i);return null===r?null:(yield this.cleanVisAndDatasetLinks(r.id,i),yield this.uploadAndLinkDatasetsTo(r.id,t,e.isprivate,{overwriteDatasets:!0,event:i.event}),yield this.deleteOrphanDatasets(i),Object.assign(Object.assign({},e),r))}))}get isReady(){return this._isReady}setApiKey(e){this._sql.setApiKey(e)}destroy(){return ie(this,void 0,void 0,(function*(){const e=(yield this.getDatasets()).map(e=>e.name);return this._sql.query(`\n      BEGIN;\n        ${e.map(e=>`DROP TABLE IF EXISTS ${e};`).join("\n")}\n        DROP TABLE IF EXISTS ${this._tableName} CASCADE;\n        DROP TABLE IF EXISTS ${this._datasetsTableName} CASCADE;\n        DROP TABLE IF EXISTS ${this._datasetsVisTableName} CASCADE;\n      COMMIT;\n    `)}))}checkIfDatasetExists(e){return ie(this,void 0,void 0,(function*(){const t="string"==typeof e?e:e.name,i=yield this._sql.query(`SELECT * FROM ${this._datasetsTableName} WHERE "name" = '${t}'`);if(i.error)throw new Error(i.error);return 0===i.rows.length?null:i.rows[0]}))}preventAccidentalDatasetsOverwrite(e=!1,t){return ie(this,void 0,void 0,(function*(){const i=t.filter(e=>"string"!=typeof e),r=yield this.checkExistingDataset(i);if(!e&&r.length>0)throw new re(r.map(e=>e.name))}))}deleteOrphanDatasets(e={}){return ie(this,void 0,void 0,(function*(){const t=yield this._sql.query(`\n      SELECT * FROM ${this._datasetsTableName} WHERE "id" NOT IN (SELECT distinct("dataset") FROM ${this._datasetsVisTableName})\n    `,e),i={dropOptions:{ifExists:!0},event:e.event},r=t.rows.map(e=>{this._sql.drop(e.tablename,i)});yield Promise.all(r),yield this._sql.query(`DELETE FROM ${this._datasetsTableName} WHERE "id" NOT IN (SELECT distinct("dataset") FROM ${this._datasetsVisTableName})`,e)}))}insertVisTable(e,t={}){return ie(this,void 0,void 0,(function*(){const i=`INSERT INTO ${this._tableName}\n     (${this.FIELD_NAMES_INSERT.map(e=>`"${e}"`).join(", ")})\n     VALUES\n     (\n       ${this.FIELD_NAMES_INSERT.map(t=>{const i=this.VIS_FIELDS[t],r=e[t],n=i&&i.format?i.format(r):r;return null===n?"null":n}).join()}\n     )\n     RETURNING "id", "lastmodified"\n   `,r=yield this._sql.query(i,t);if(r.error)throw new Error(r.error);const n=r.rows[0];return{id:n.id,lastmodified:n.lastmodified}}))}updateVisTable(e,t={}){return ie(this,void 0,void 0,(function*(){const i=`UPDATE ${this._tableName}\n      SET\n        ${this.FIELD_NAMES_INSERT.map(t=>{const i=this.VIS_FIELDS[t],r=e[t],n=i&&i.format?i.format(r):r;return`"${t}" = ${null===n?"null":n}`}).join()}\n        ,${this.VIS_FIELDS.lastmodified.name}=NOW()\n      WHERE ${this.VIS_FIELDS.id.name} = '${e.id}'\n      RETURNING "${this.VIS_FIELDS.id.name}", "${this.VIS_FIELDS.lastmodified.name}"\n    `,r=yield this._sql.query(i,t);if(r.error)throw new Error(r.error);return{id:e.id,lastmodified:r.rows.length?r.rows[0].lastmodified:e.lastmodified}}))}uploadAndLinkDatasetsTo(e,t,i,r={}){return ie(this,void 0,void 0,(function*(){for(const n of t){let t;if("string"==typeof n){const i=yield this.getDataset(n);if(null===i)continue;t=i.tablename,yield this.linkVisAndDataset(e,i.id,{event:r.event})}else{const i=yield this.uploadDataset(n,{overwrite:r.overwriteDatasets||!1,event:r.event});t=i.tablename,yield this.linkVisAndDataset(e,i.id,{event:r.event})}i||(yield this.shareDataset(t,{event:r.event}))}}))}checkExistingDataset(e){return ie(this,void 0,void 0,(function*(){return(yield Promise.all(e.map(e=>this.checkIfDatasetExists(e)))).filter(e=>null!==e)}))}escapeOrNull(e){return null===e?null:`E'${e=e.replace(/\'/gi,"\\'")}'`}cleanVisAndDatasetLinks(e,t={}){return ie(this,void 0,void 0,(function*(){if((yield this._sql.query(`\n      DELETE FROM ${this._datasetsVisTableName}\n      WHERE vis='${e}'\n    `,t)).error)throw new Error(`Failed to clean vis-dataset links for visualization '${e}'`)}))}linkVisAndDataset(e,t,i={}){return ie(this,void 0,void 0,(function*(){const r=`\n      INSERT INTO ${this._datasetsVisTableName} ("vis", "dataset")\n      VALUES ('${e}', '${t}')\n    `;if((yield this._sql.query(r,i)).error)throw new Error("Failed to link dataset id to vis id")}))}_checkMissingTables(){return new Promise((e,t)=>ie(this,void 0,void 0,(function*(){try{const t=[this._tableName,this._datasetsTableName,this._datasetsVisTableName].map(e=>this._sql.query(`SELECT to_regclass('${e}')`)),i=(yield Promise.all(t)).some(e=>null===e.rows[0].to_regclass);e(i)}catch(e){t(e)}})))}_initTables(e={}){return ie(this,void 0,void 0,(function*(){const t=[...Object.values(this.VIS_FIELDS)],i={createConfig:{ifNotExists:!0},event:e.event};yield this._sql.create(this._tableName,t,i),yield this._sql.create(this._datasetsTableName,this.DATASET_COLUMNS,i),yield this._sql.create(this._datasetsVisTableName,this.DATASET_VIS_COLUMNS,i),this._isPublic&&(yield this._sql.grantPublicRead(this._tableName,e),yield this._sql.grantPublicRead(this._datasetsTableName,e),yield this._sql.grantPublicRead(this._datasetsVisTableName,e))}))}}class he{constructor(e,t,i={}){const r=Object.assign({client:"keplergl",maxApiRequestsRetries:B.DEFAULT_MAX_API_REQUESTS_RETRIES},i);this.client=r.client,this._sqlClient=new te(t,{maxApiRequestsRetries:r.maxApiRequestsRetries}),this._checkNamespace(e),this._namespace=e,this._publicSQLStorage=new ue(this._namespace,this._sqlClient,this.getVersion(),!0),this._privateSQLStorage=new ue(this._namespace,this._sqlClient,this.getVersion(),!1)}init(){return ie(this,void 0,void 0,(function*(){if(yield this.isInitialized())return!0;yield this._sqlClient.query(`\n      BEGIN;\n        CREATE OR REPLACE FUNCTION ${this._namespace}_create_uuid()\n        RETURNS UUID AS\n        $$\n        DECLARE\n          _output UUID;\n        BEGIN\n          SELECT uuid_in(md5(random()::text || clock_timestamp()::text)::cstring) INTO _output;\n          RETURN _output;\n        END\n        $$ LANGUAGE plpgsql PARALLEL SAFE;\n      COMMIT;\n    `);const e=new i(this.client,"custom_storage_init"),t=yield Promise.all([this._publicSQLStorage.init({event:e}),this._privateSQLStorage.init({event:e})]);return t[0]||t[1]}))}getVisualizations(){this._checkReady();const e=new i(this.client,"custom_storage_visualization_list_load");return Promise.all([this._privateSQLStorage.getVisualizations({event:e}),this._publicSQLStorage.getVisualizations({event:e})]).then(e=>[...e[0],...e[1]])}getPublicVisualizations(){this._checkReady();const e=new i(this.client,"custom_storage_public_visualizations_load");return this._publicSQLStorage.getVisualizations({event:e})}getPrivateVisualizations(){this._checkReady();const e=new i(this.client,"custom_storage_private_visualizations_load");return this._privateSQLStorage.getVisualizations({event:e})}getVisualization(e){this._checkReady();const t=new i(this.client,"custom_storage_visualization_load");return Promise.all([this._publicSQLStorage.getVisualization(e,{event:t}),this._privateSQLStorage.getVisualization(e,{event:t})]).then(e=>e[0]||e[1])}deleteVisualization(e){this._checkReady();const t=new i(this.client,"custom_storage_visualization_delete");return Promise.all([this._publicSQLStorage.deleteVisualization(e,{event:t}),this._privateSQLStorage.deleteVisualization(e,{event:t})]).then(()=>!0).catch(()=>!1)}createVisualization(e,t,r){this._checkReady();const n=e.isprivate?this._privateSQLStorage:this._publicSQLStorage,s=e.isprivate?"custom_storage_private_visualization_create":"custom_storage_public_visualization_create",o=new i(this.client,s);return n.createVisualization(e,t,{overwriteDatasets:r,event:o})}updateVisualization(e,t){this._checkReady();const r=e.isprivate?this._privateSQLStorage:this._publicSQLStorage,n=new i(this.client,"custom_storage_visualization_update");return r.updateVisualization(e,t,{event:n})}getDatasets(){return Promise.all([this._publicSQLStorage.getDatasets(),this._privateSQLStorage.getDatasets()]).then(e=>[...e[0],...e[1]])}getVisForDataset(e){return Promise.all([this._publicSQLStorage.getVisForDataset(e),this._privateSQLStorage.getVisForDataset(e)]).then(e=>[...e[0],...e[1]])}uploadPublicDataset(e,t=!1){return this._uploadDataset(e,this._publicSQLStorage,!0,t)}uploadPrivateDataset(e,t=!1){return this._uploadDataset(e,this._privateSQLStorage,!1,t)}getVersion(){return he.version}migrate(){return Promise.resolve()}getSQLClient(){return this._sqlClient}setApiKey(e){this._sqlClient.setApiKey(e),this._privateSQLStorage.setApiKey(e),this._publicSQLStorage.setApiKey(e)}destroy(){return ie(this,void 0,void 0,(function*(){yield this._sqlClient.query(`DROP FUNCTION ${this._namespace}_create_uuid CASCADE;`),yield this._privateSQLStorage.destroy(),yield this._publicSQLStorage.destroy()}))}isInitialized(){return ie(this,void 0,void 0,(function*(){const e=yield Promise.all([this._publicSQLStorage.isInitialized(),this._privateSQLStorage.isInitialized()]);return e[0]||e[1]}))}_checkNamespace(e){if(e.split(" ").length>1)throw new Error("Namespace for custom-storage must be 1 word")}_checkReady(){if(!this._privateSQLStorage.isReady||!this._publicSQLStorage.isReady)throw new Error(".init has not finished")}_uploadDataset(e,t,i,r){return ie(this,void 0,void 0,(function*(){const n=yield t.uploadDataset(e,{overwrite:r});return i&&(yield t.shareDataset(n.tablename)),n}))}}he.version=0;class de extends class{constructor(e,i=t.DEFAULT_SERVER_URL_TEMPLATE,r={}){this._client=r.client?r.client:"keplergl",this._clientMap={},this._serverUrlTemplate=i,this._tableName=ae(e,!0,he.version),this._datasetTableName=ce(this._tableName),this._datasetsVisTableName=le(this._tableName)}getVisualization(e,r){if(void 0===this._clientMap[e]){const i=new t(e,t.DEFAULT_PUBLIC_API_KEY,this._serverUrlTemplate);this._clientMap[e]=new te(i)}const n={vis:this._tableName,datasets:this._datasetTableName,visToDatasets:this._datasetsVisTableName},s=new i(this._client,"public_sql_reader_visualization_load");return oe(n,r,this._clientMap[e],{event:s})}}{}
/*! *****************************************************************************
	Copyright (c) Microsoft Corporation. All rights reserved.
	Licensed under the Apache License, Version 2.0 (the "License"); you may not use
	this file except in compliance with the License. You may obtain a copy of the
	License at http://www.apache.org/licenses/LICENSE-2.0

	THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
	KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
	WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
	MERCHANTABLITY OR NON-INFRINGEMENT.

	See the Apache Version 2.0 License for specific language governing permissions
	and limitations under the License.
	***************************************************************************** */var pe=function(e,t){return(pe=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};var fe=function(){return(fe=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function _e(e,t,i,r){return new(i||(i=Promise))((function(n,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){e.done?n(e.value):new i((function(t){t(e.value)})).then(o,a)}c((r=r.apply(e,t||[])).next())}))}function ve(e,t){var i,r,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,r&&(n=2&s[0]?r.return:s[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,s[1])).done)return n;switch(r=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(n=(n=o.trys).length>0&&n[n.length-1])&&(6===s[0]||2===s[0])){o=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){o.label=s[1];break}if(6===s[0]&&o.label<n[1]){o.label=n[1],n=s;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(s);break}n[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{i=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}var ge={namespace:"toolkit",serverUrlTemplate:t.DEFAULT_SERVER_URL_TEMPLATE,maxApiRequestsRetries:B.DEFAULT_MAX_API_REQUESTS_RETRIES},me=function(){function e(e){void 0===e&&(e=ge),this._customStorage=null,this._sql=null,this._serverUrlTemplate=t.DEFAULT_SERVER_URL_TEMPLATE,this._apiKey=null,this._username=null,this._maxApiRequestsRetries=B.DEFAULT_MAX_API_REQUESTS_RETRIES,this._initPromise=null;var i=fe(fe({},ge),e),r=i.namespace,n=i.serverUrlTemplate,s=i.maxApiRequestsRetries;this._namespace=r,this._serverUrlTemplate=n,this._maxApiRequestsRetries=s,this._publicStorageReader=new de(r,n)}return e.prototype.setCredentials=function(e,i){return _e(this,void 0,void 0,(function(){var r,n=this;return ve(this,(function(s){return this._customStorage&&this._sql?[2,{SQL:this._sql,CustomStorage:this._customStorage}]:(this._apiKey=e,this._username=i,r=new t(this._username,this._apiKey,this._serverUrlTemplate),this._customStorage=new he(this._namespace,r,{maxApiRequestsRetries:this._maxApiRequestsRetries}),this._sql=this._customStorage.getSQLClient(),this._initPromise=this._customStorage.init().then((function(){if(null===n._sql||null===n._customStorage)throw new Error("Something went wrong setting the credentials");return{SQL:n._sql,CustomStorage:n._customStorage}})).catch((function(){throw new Error("Something went wrong initializing custom storage")})),[2,this._initPromise])}))}))},e.prototype.getCustomStorage=function(){if(null===this._initPromise)throw new Error("No auth has been set yet");return this._initPromise.then((function(e){return e.CustomStorage}))},e.prototype.getSQL=function(){if(null===this._initPromise)throw new Error("No auth has been set yet");return this._initPromise.then((function(e){return e.SQL}))},e.prototype.setApiKey=function(e){if(null===this._sql||null===this._customStorage)throw new Error("Cannot update api key if auth not set yet.");return this._apiKey=e,this._sql.setApiKey(e),this._customStorage.setApiKey(e),this._initPromise},Object.defineProperty(e.prototype,"PublicStorageReader",{get:function(){return this._publicStorageReader},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"username",{get:function(){return this._username},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"serverUrlTemplate",{get:function(){return this._serverUrlTemplate},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"namespace",{get:function(){return this._namespace},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"apiKey",{get:function(){return this._apiKey},enumerable:!0,configurable:!0}),e}(),ye=function(e){function t(t,i){void 0===i&&(i=ge);var r=e.call(this,i)||this;return r._oauth=null,r._oauthOptions=t,t.clientID&&r.initOauth(t),r}return function(e,t){function i(){this.constructor=e}pe(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}(t,e),t.prototype.login=function(){return _e(this,void 0,void 0,(function(){var e,t,i,r=this;return ve(this,(function(n){switch(n.label){case 0:if(e=this.oauth,t=e.token,!e.expired)return[3,5];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,e.login()];case 2:return n.sent(),[3,4];case 3:throw i=n.sent(),new Error("Failed to login ("+i.error+"): "+i.message);case 4:t=e.token,n.label=5;case 5:if(null===t)throw new Error("Failed to login, token is null");return[2,new Promise((function(i,n){r.postLogin(e,t).then((function(e){i(e)})).catch((function(e){n(e)}))}))]}}))}))},Object.defineProperty(t.prototype,"oauth",{get:function(){if(null===this._oauth)throw new Error("No client ID has been specified");return this._oauth},enumerable:!0,configurable:!0}),t.prototype.setClientID=function(e){if(this._oauth)throw new Error("Cannot set the client ID more than once");void 0!==e&&this.initOauth(fe({clientID:e},this._oauthOptions))},t.prototype.initOauth=function(e){this._oauth=new V(e)},t.prototype.postLogin=function(e,t){return _e(this,void 0,void 0,(function(){var i,r,n,s;return ve(this,(function(o){switch(o.label){case 0:if(null===(i=e.userInfo))throw new Error("Failed to get user info");r=null,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,i.info];case 2:return n=o.sent(),r=n.username,this.setupEvents(e),[3,4];case 3:throw s=o.sent(),new Error("Failed to get user info: "+s.message);case 4:return[2,this.setCredentials(t,r)]}}))}))},t.prototype.setupEvents=function(e){var t=this;e.on("tokenUpdated",(function(){if(null===e.token)throw new Error("Got a null token after refreshing it");t.setApiKey(e.token)}))},t}(me);e.App=me,e.Credentials=t,e.CustomStorage=he,e.OAuth=V,e.OAuthApp=ye,e.SQL=te,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=toolkit.umd.js.map
