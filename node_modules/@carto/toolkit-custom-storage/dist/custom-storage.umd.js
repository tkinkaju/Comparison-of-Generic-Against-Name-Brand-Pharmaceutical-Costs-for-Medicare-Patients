!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).cartoToolkitCustomStorage={})}(this,(function(e){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function t(e,t,i,r){return new(i||(i=Promise))((function(s,n){function a(e){try{u(r.next(e))}catch(e){n(e)}}function o(e){try{u(r.throw(e))}catch(e){n(e)}}function u(e){e.done?s(e.value):new i((function(t){t(e.value)})).then(a,o)}u((r=r.apply(e,t||[])).next())}))}class i{constructor(e,t,i="https://{user}.carto.com"){if(!e)throw new Error("Username is required");if(!t)throw new Error("Api key is required");this._username=e,this._apiKey=t,this._serverUrlTemplate=i}static get DEFAULT_SERVER_URL_TEMPLATE(){return"https://{user}.carto.com"}static get DEFAULT_PUBLIC_API_KEY(){return"default_public"}get username(){return this._username}set username(e){this._username=e}get apiKey(){return this._apiKey}set apiKey(e){this._apiKey=e}get serverUrlTemplate(){return this._serverUrlTemplate}set serverUrlTemplate(e){this._serverUrlTemplate=e}get serverURL(){let e=this._serverUrlTemplate.replace("{user}",this._username);return e.endsWith("/")||(e+="/"),e}}new i("username","default_public");class r{constructor(e,t,i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})){this.source=e,this.name=t,this.groupId=i}getHeaders(){return[["Carto-Event-Source",this.source],["Carto-Event",this.name],["Carto-Event-Group-Id",this.groupId]]}}
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function n(e,t){function i(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}function a(e,t,i,r){return new(i||(i=Promise))((function(s,n){function a(e){try{u(r.next(e))}catch(e){n(e)}}function o(e){try{u(r.throw(e))}catch(e){n(e)}}function u(e){e.done?s(e.value):new i((function(t){t(e.value)})).then(a,o)}u((r=r.apply(e,t||[])).next())}))}function o(e,t){var i,r,s,n,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return n={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function o(n){return function(o){return function(n){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(s=2&n[0]?r.return:n[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,n[1])).done)return s;switch(r=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(!(s=(s=a.trys).length>0&&s[s.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){a.label=n[1];break}if(6===n[0]&&a.label<s[1]){a.label=s[1],s=n;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(n);break}s[2]&&a.ops.pop(),a.trys.pop();continue}n=t.call(e,a)}catch(e){n=[6,e],r=0}finally{i=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,o])}}}var u={TOO_MANY_REQUESTS:429,SERVICE_UNAVAILABLE:503},l=Object.freeze({__proto__:null,QUERY_LIMIT:1024,DEFAULT_MAX_API_REQUESTS_RETRIES:0,HTTP_ERRORS:u}),c=function(){function e(e,t,i){var r=(void 0===i?{}:i).maxApiRequestsRetries;this._callsLeft=-1,this._retryAfter=-1,this._retryTimeoutId=-1,this._fetching=!1,this._scheduleDebounce=-1,this._maxApiRequestsRetries=0,this._credentials=e,this._endpointServerURL=t,this._queue=[],Number.isFinite(r)&&r>=0&&(this._maxApiRequestsRetries=r)}return Object.defineProperty(e.prototype,"apiKey",{get:function(){return this._credentials.apiKey},set:function(e){this._credentials.apiKey=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"endpointServerURL",{get:function(){return this._endpointServerURL},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"callsLeft",{get:function(){return this._callsLeft},set:function(e){this._callsLeft=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxApiRequestsRetries",{set:function(e){this._maxApiRequestsRetries=e},enumerable:!0,configurable:!0}),e.prototype._scheduleRequest=function(e,t,i,r){var s=this;this._queue.push({resolve:e,reject:t,requestInfo:i,requestInit:r,retries_count:-1}),clearTimeout(this._scheduleDebounce),this._scheduleDebounce=window.setTimeout((function(){s._scheduler()}),0)},e.prototype.addHeadersTo=function(e,t){void 0===t&&(t=[]),void 0!==e&&(e.headers||(e.headers=new Headers),t.length>0&&t.forEach((function(t){e.headers.append(t[0],t[1])})))},e.prototype._scheduler=function(){var e=this;if(0!==this._queue.length&&-1===this._retryTimeoutId&&!this._fetching)if(-1===this._retryAfter){for(var t=-1!==this._callsLeft?Math.min(Math.max(1,this._callsLeft),this._queue.length):1,i=[],r=0;r<t;r++)this._fetching=!0,i.push(this._fetch(this._queue[r],r));Promise.all(i).then((function(t){e._queue=e._queue.filter((function(e,i){return-1===t.indexOf(i)})),e._fetching=!1,e._queue.length>0&&e._scheduler()}))}else this._retryTimeoutId=window.setTimeout((function(){e._retryTimeoutId=-1,e._retryAfter=-1,e._callsLeft+=1,e._scheduler()}),1e3*this._retryAfter)},e.prototype._fetch=function(e,t){var i=this,r=e.resolve,s=e.reject,n=e.requestInfo,l=e.requestInit,c=e.retries_count;return fetch(n,l).then((function(t){return a(i,void 0,void 0,(function(){var i,r,s;return o(this,(function(n){switch(n.label){case 0:return this._retryAfter=this._getRateLimitHeader(t.headers,"Retry-After",this._retryAfter),this._callsLeft=this._getRateLimitHeader(t.headers,"Carto-Rate-Limit-Remaining",this._callsLeft),[4,h(t)];case 1:if(i=n.sent(),r=t.status===u.TOO_MANY_REQUESTS&&("datasource"===i.detail||"rate-limit"===i.detail),(t.status===u.SERVICE_UNAVAILABLE||r)&&(e.retries_count=-1!==c?c-1:this._maxApiRequestsRetries,s=.5*(this._maxApiRequestsRetries-e.retries_count)+.5,this._retryAfter=Math.max(this._retryAfter,s)),0===e.retries_count)throw new Error("Too many retries");return t.status===u.TOO_MANY_REQUESTS||t.status===u.SERVICE_UNAVAILABLE?(this._scheduler(),[2,null]):[2,i]}}))}))})).then((function(e){var i,n;if(null!==e){if(e.error){var a=(null===(n=null===(i=e)||void 0===i?void 0:i.error)||void 0===n?void 0:n.length)?e.error[0]:"Unknown error";s(new Error(a))}else r(e);return t}})).catch((function(e){return s(e),t}))},e.prototype._getRateLimitHeader=function(e,t,i){var r=e.get(t);return null!==r?parseInt(r,10):i},Object.defineProperty(e.prototype,"queued",{get:function(){return this._queue.length},enumerable:!0,configurable:!0}),e}();function h(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(i){switch(i.label){case 0:return(e.headers.get("content-type")||"").includes("application/json")?[4,e.json()]:[3,2];case 1:return t=i.sent(),[3,4];case 2:return[4,e.text()];case 3:t=i.sent(),i.label=4;case 4:return[2,t]}}))}))}var d=function(e){function t(t,i){void 0===i&&(i={});var r=t.serverURL+"api/v2/sql/copyfrom";return e.call(this,t,r,i)||this}return n(t,e),t.prototype.copy=function(e,t,i,r){var s=this;void 0===r&&(r={});var n="COPY "+t+" ("+i+") FROM STDIN WITH (FORMAT csv, HEADER true);",a=this.endpointServerURL+"?api_key="+this.apiKey+"&q="+n,o={method:"POST",body:new Blob([e])},u=r.event?r.event.getHeaders():[];return this.addHeadersTo(o,u),new Promise((function(e,t){s._scheduleRequest(e,t,a,o)}))},t}(c),_=function(e){function t(t,i){void 0===i&&(i={});var r=t.serverURL+"api/v2/sql/copyto";return e.call(this,t,r,i)||this}return n(t,e),t.prototype.copyUrl=function(e,t,i){void 0===t&&(t="carto_copyto.csv"),void 0===i&&(i="FORMAT csv, HEADER true");var r="COPY ("+e+") TO stdout WITH("+i+")";return this.endpointServerURL+"?api_key="+this.apiKey+"&q="+r+"&filename="+t},t.prototype.copy=function(e,t,i){var r=this,s=this.copyUrl(e,t,i);return new Promise((function(e,t){r._scheduleRequest(e,t,s)}))},t}(c),p={string:"text",integer:"numeric",geojson:"json"},v=function(){function e(){}return e.drop=function(e,t){return t&&t.ifExists?"DROP TABLE IF EXISTS "+e+";":"DROP TABLE "+e+";"},e.create=function(e,t,i){var r="CREATE TABLE "+e+" ({rows});";i&&i.ifNotExists&&(r="CREATE TABLE IF NOT EXISTS "+e+" ({rows});");var s=t.map((function(e){if("string"==typeof e)return e;var t;e.type=(t=e.type,p[t]||t);var i='"'+e.name+'" '+e.type;return e.extra?i+" "+e.extra:i})).join(", ");return r.replace(/{rows}/,s)},e}(),f=function(e){function t(t,i){void 0===i&&(i={});var r=t.serverURL+"api/v2/sql";return e.call(this,t,r,i)||this}return n(t,e),t.prototype.query=function(e,t){void 0===t&&(t={});var i=[["api_key",this.apiKey],["q",e]];t.extraParams&&i.push.apply(i,t.extraParams);var r=t.event?t.event.getHeaders():[];return e.length<1024?this.prepareGetRequest(i,r):this.preparePostRequest(i,r)},t.prototype.prepareGetRequest=function(e,t){var i=this;void 0===t&&(t=[]);var r=encodeURI(e.map((function(e){return e[0]+"="+e[1]})).join("&")),s={method:"GET"};return this.addHeadersTo(s,t),new Promise((function(e,t){i._scheduleRequest(e,t,i.endpointServerURL+"?"+r,s)}))},t.prototype.preparePostRequest=function(e,t){var i=this;void 0===t&&(t=[]);var r=new FormData;e.forEach((function(e){return r.set(e[0],e[1])}));var s={method:"POST",body:r};return this.addHeadersTo(s,t),new Promise((function(e,t){i._scheduleRequest(e,t,""+i.endpointServerURL,s)}))},t}(c),m=function(){function e(e,t){var r=(void 0===t?{}:t).maxApiRequestsRetries;this._credentials=e,this._copyToManager=new _(this._credentials,{maxApiRequestsRetries:r}),this._queryManager=new f(this._credentials,{maxApiRequestsRetries:r}),this._copyFromManager=new d(this._credentials,{maxApiRequestsRetries:r});var s=new i(e.username,i.DEFAULT_PUBLIC_API_KEY,e.serverUrlTemplate);this._publicQueryManager=new f(s,{maxApiRequestsRetries:r})}return Object.defineProperty(e,"DDL",{get:function(){return v},enumerable:!0,configurable:!0}),e.prototype.copyFrom=function(e,t,i,r){return void 0===r&&(r={}),this._copyFromManager.copy(e,t,i,r)},e.prototype.exportURL=function(e){return this._copyToManager.copyUrl(e)},e.prototype.query=function(e,t){void 0===t&&(t={});var i=e.replace(/\s+/g," ").trim();return this._queryManager.query(i,t)},e.prototype.truncate=function(e){return this._queryManager.query("TRUNCATE "+e+";")},e.prototype.create=function(e,t,i){void 0===i&&(i={});var r=v.create(e,t,i.createOptions);return this._queryManager.query(r,{event:i.event})},e.prototype.drop=function(e,t){void 0===t&&(t={});var i=v.drop(e,t.dropOptions);return this._queryManager.query(i,{event:t.event})},e.prototype.grantPublicRead=function(e,t){return void 0===t&&(t={}),a(this,void 0,void 0,(function(){var i,r;return o(this,(function(s){switch(s.label){case 0:return(r=this._publicRole)?[3,2]:[4,this.getRole(t)];case 1:r=s.sent(),s.label=2;case 2:return i=r,[2,this.grantReadToRole(e,i,t)]}}))}))},e.prototype.grantReadToRole=function(e,t,i){void 0===t&&(t="publicuser"),void 0===i&&(i={});var r="GRANT SELECT on "+e+' TO "'+t+'"';return this.query(r,i)},e.prototype.transaction=function(e){var t="\n      BEGIN;\n        "+e.join("\n")+"\n      COMMIT;\n    ";return this._queryManager.query(t)},e.prototype.setApiKey=function(e){this._credentials.apiKey=e,this._queryManager.apiKey=e,this._copyToManager.apiKey=e,this._copyFromManager.apiKey=e},e.prototype.getRole=function(e){var t=this;return void 0===e&&(e={}),this._publicQueryManager.query("SELECT current_user as rolename",e).then((function(e){if(e.error)throw new Error(e.error);if(0===e.rows.length)throw new Error("Cannot grant: got no current_user data");var i=e.rows[0].rolename;return t._publicRole=i,i}))},e}();class y extends class{constructor(e,t){this.errorCode=e,this.message=t}}{constructor(e){super("DUPLICATED_DATASETS","Some datasets are duplicated"),this.datasets=e}}function E(e){return{id:e.id,name:e.name,description:e.description,thumbnail:e.thumbnail,isprivate:e.isprivate,config:e.config,lastmodified:e.lastmodified}}function T(e,i,r,s={}){return t(this,void 0,void 0,(function*(){const t={extraParams:[["format","csv"]],event:s.event},n=yield r.query(`SELECT * FROM ${i}`,t);if("string"!=typeof n)throw new Error(n.error);return{name:e,file:n}}))}function g(e,i,r,s={}){return t(this,void 0,void 0,(function*(){const n=yield r.query(`SELECT * FROM ${e.vis} WHERE id = '${i}'`,s);if(n.error)throw new Error(n.error);if(0===n.rows.length)return null;const a=E(n.rows[0]),o=yield function(e,i,r,s={}){return t(this,void 0,void 0,(function*(){const t=yield r.query(`\n    WITH datasets AS (SELECT dataset FROM ${e.visToDatasets} WHERE vis = '${i}')\n    SELECT t.id, t.name, t.tablename FROM ${e.datasets} t, datasets u\n    WHERE t.id = u.dataset\n  `,s);if(t.error)throw new Error(t.error);return t.rows}))}(e,i,r,s);return 0===o.length?{vis:a,datasets:[]}:{vis:a,datasets:yield Promise.all(o.map(e=>T(e.name,e.tablename,r,s)))}}))}function S(e,t,i){return`${e}_${t?"public":"private"}_v${i}`}function R(e){return`${e}_datasets`}function b(e){return`${e}_datasets_vis`}class L{constructor(e,t,i,r){this._isReady=!1,this._namespace=e,this._tableName=S(e,r,i),this._datasetsTableName=R(this._tableName),this._datasetsVisTableName=b(this._tableName),this._isPublic=r,this.VIS_FIELDS={id:{name:"id",type:"uuid",extra:`PRIMARY KEY DEFAULT ${this._namespace}_create_uuid()`,omitOnInsert:!0},name:{name:"name",type:"text",extra:"NOT NULL",format:this.escapeOrNull},description:{name:"description",type:"text",format:this.escapeOrNull},thumbnail:{name:"thumbnail",type:"text",format:this.escapeOrNull},isprivate:{name:"isprivate",type:"boolean",format:e=>void 0!==e&&e},config:{name:"config",type:"json",format:this.escapeOrNull},lastmodified:{name:"lastmodified",type:"timestamp",extra:"NOT NULL DEFAULT now()",omitOnInsert:!0}},this.DATASET_COLUMNS=[`"id" uuid PRIMARY KEY DEFAULT ${this._namespace}_create_uuid()`,'"tablename" text UNIQUE NOT NULL','"name" text UNIQUE NOT NULL'],this.DATASET_VIS_COLUMNS=['"vis" uuid NOT NULL','"dataset" uuid NOT NULL'],this.FIELD_NAMES=Object.values(this.VIS_FIELDS).map(e=>e.name),this.FIELD_NAMES_INSERT=Object.values(this.VIS_FIELDS).filter(e=>!e.omitOnInsert).map(e=>e.name),this._sql=t}init(e={}){return t(this,void 0,void 0,(function*(){const t=yield this._checkMissingTables();return t&&(yield this._initTables({event:e.event})),this._isReady=!0,t}))}isInitialized(){return t(this,void 0,void 0,(function*(){const e=yield this._checkMissingTables();return this._isReady=!e,this._isReady}))}getVisualizations(e={}){return this._sql.query(`\n      SELECT ${this.FIELD_NAMES.filter(e=>"config"!==e).map(e=>`"${e}"`).join(", ")}\n      FROM ${this._tableName}\n      `,e).then(e=>{if(e.error)throw new Error(e.error);return 0===e.rows.length?[]:e.rows.map(E)})}getVisualization(e,i={}){return t(this,void 0,void 0,(function*(){return g({vis:this._tableName,datasets:this._datasetsTableName,visToDatasets:this._datasetsVisTableName},e,this._sql,i)}))}getDatasetData(e,i){return t(this,void 0,void 0,(function*(){return T(e,i,this._sql)}))}getDataset(e,i={}){return t(this,void 0,void 0,(function*(){const t=yield this._sql.query(`\n      SELECT * FROM ${this._datasetsTableName} WHERE "name"='${e}'\n    `,i);if(t.error)throw new Error(`Failed to get dataset ${e}`);return t.rows[0]||null}))}getDatasets(){return t(this,void 0,void 0,(function*(){const e=yield this._sql.query(`\n      SELECT * FROM ${this._datasetsTableName}\n    `);if(e.error)throw new Error("Failed to read datasets");return e.rows}))}getVisForDataset(e){return t(this,void 0,void 0,(function*(){const t=yield this._sql.query(`\n      WITH dataset_vis as (SELECT * FROM ${this._datasetsVisTableName} WHERE "dataset" = '${e}')\n\n      SELECT t."name", t."id", t."thumbnail", t."isprivate"\n      FROM ${this._tableName} t, dataset_vis u WHERE t."id" = u."vis"\n    `);if(t.error)throw new Error("Failed to read visualizations");return t.rows.map(E)}))}deleteVisualization(e,i={}){return t(this,void 0,void 0,(function*(){yield this._sql.query(`DELETE FROM ${this._datasetsVisTableName} WHERE "vis"='${e}'`,i),yield this._sql.query(`DELETE FROM ${this._tableName} WHERE "id"='${e}'`,i),yield this.deleteOrphanDatasets(i)}))}deleteDataset(){return t(this,void 0,void 0,(function*(){throw new Error("deleteDataset Not implemented yet")}))}createVisualization(e,i,r={}){return t(this,void 0,void 0,(function*(){yield this.preventAccidentalDatasetsOverwrite(r.overwriteDatasets,i);const t=yield this.insertVisTable(e,{event:r.event});return null===t?null:(yield this.uploadAndLinkDatasetsTo(t.id,i,e.isprivate,r),Object.assign(Object.assign({},t),e))}))}uploadDataset(e,i={overwrite:!1}){return t(this,void 0,void 0,(function*(){const t=`${this._tableName}_${e.name}`;if(!e.columns)throw new Error("Need dataset column information");const r=yield this.getDataset(e.name,{event:i.event});i.overwrite&&null!==r&&(yield this._sql.query(`DROP TABLE IF EXISTS ${t}`,{event:i.event}));const s={createOptions:{ifNotExists:!1},event:i.event},n=yield this._sql.create(t,e.columns,s);if(n.error)throw new Error(`Failed to create table for dataset ${e.name}: ${n.error}`);let a;try{const r=e.columns.map(e=>"string"==typeof e?`"${e}"`:`"${e.name}"`);a=yield this._sql.copyFrom(e.file,t,r,{event:i.event})}catch(e){throw new Error(`Failed to copy to ${t}: ${e.message}`)}if(a.error)throw new Error(`Failed to copy to ${t}: ${a.error}`);if(null===r){const r=yield this._sql.query(`\n        INSERT INTO ${this._datasetsTableName} ("id", "name", "tablename")\n        VALUES (${this._namespace}_create_uuid(), '${e.name}', '${t}')\n        RETURNING *\n      `,{event:i.event});if(r.error)throw new Error(`Failed to register dataset ${t} ${r.error}`);return r.rows[0]}return r}))}shareDataset(e,t={}){return this._sql.grantPublicRead(e,t)}updateVisualization(e,i,r={}){return t(this,void 0,void 0,(function*(){const t=yield this.updateVisTable(e,r);return null===t?null:(yield this.cleanVisAndDatasetLinks(t.id,r),yield this.uploadAndLinkDatasetsTo(t.id,i,e.isprivate,{overwriteDatasets:!0,event:r.event}),yield this.deleteOrphanDatasets(r),Object.assign(Object.assign({},e),t))}))}get isReady(){return this._isReady}setApiKey(e){this._sql.setApiKey(e)}destroy(){return t(this,void 0,void 0,(function*(){const e=(yield this.getDatasets()).map(e=>e.name);return this._sql.query(`\n      BEGIN;\n        ${e.map(e=>`DROP TABLE IF EXISTS ${e};`).join("\n")}\n        DROP TABLE IF EXISTS ${this._tableName} CASCADE;\n        DROP TABLE IF EXISTS ${this._datasetsTableName} CASCADE;\n        DROP TABLE IF EXISTS ${this._datasetsVisTableName} CASCADE;\n      COMMIT;\n    `)}))}checkIfDatasetExists(e){return t(this,void 0,void 0,(function*(){const t="string"==typeof e?e:e.name,i=yield this._sql.query(`SELECT * FROM ${this._datasetsTableName} WHERE "name" = '${t}'`);if(i.error)throw new Error(i.error);return 0===i.rows.length?null:i.rows[0]}))}preventAccidentalDatasetsOverwrite(e=!1,i){return t(this,void 0,void 0,(function*(){const t=i.filter(e=>"string"!=typeof e),r=yield this.checkExistingDataset(t);if(!e&&r.length>0)throw new y(r.map(e=>e.name))}))}deleteOrphanDatasets(e={}){return t(this,void 0,void 0,(function*(){const t=yield this._sql.query(`\n      SELECT * FROM ${this._datasetsTableName} WHERE "id" NOT IN (SELECT distinct("dataset") FROM ${this._datasetsVisTableName})\n    `,e),i={dropOptions:{ifExists:!0},event:e.event},r=t.rows.map(e=>{this._sql.drop(e.tablename,i)});yield Promise.all(r),yield this._sql.query(`DELETE FROM ${this._datasetsTableName} WHERE "id" NOT IN (SELECT distinct("dataset") FROM ${this._datasetsVisTableName})`,e)}))}insertVisTable(e,i={}){return t(this,void 0,void 0,(function*(){const t=`INSERT INTO ${this._tableName}\n     (${this.FIELD_NAMES_INSERT.map(e=>`"${e}"`).join(", ")})\n     VALUES\n     (\n       ${this.FIELD_NAMES_INSERT.map(t=>{const i=this.VIS_FIELDS[t],r=e[t],s=i&&i.format?i.format(r):r;return null===s?"null":s}).join()}\n     )\n     RETURNING "id", "lastmodified"\n   `,r=yield this._sql.query(t,i);if(r.error)throw new Error(r.error);const s=r.rows[0];return{id:s.id,lastmodified:s.lastmodified}}))}updateVisTable(e,i={}){return t(this,void 0,void 0,(function*(){const t=`UPDATE ${this._tableName}\n      SET\n        ${this.FIELD_NAMES_INSERT.map(t=>{const i=this.VIS_FIELDS[t],r=e[t],s=i&&i.format?i.format(r):r;return`"${t}" = ${null===s?"null":s}`}).join()}\n        ,${this.VIS_FIELDS.lastmodified.name}=NOW()\n      WHERE ${this.VIS_FIELDS.id.name} = '${e.id}'\n      RETURNING "${this.VIS_FIELDS.id.name}", "${this.VIS_FIELDS.lastmodified.name}"\n    `,r=yield this._sql.query(t,i);if(r.error)throw new Error(r.error);return{id:e.id,lastmodified:r.rows.length?r.rows[0].lastmodified:e.lastmodified}}))}uploadAndLinkDatasetsTo(e,i,r,s={}){return t(this,void 0,void 0,(function*(){for(const t of i){let i;if("string"==typeof t){const r=yield this.getDataset(t);if(null===r)continue;i=r.tablename,yield this.linkVisAndDataset(e,r.id,{event:s.event})}else{const r=yield this.uploadDataset(t,{overwrite:s.overwriteDatasets||!1,event:s.event});i=r.tablename,yield this.linkVisAndDataset(e,r.id,{event:s.event})}r||(yield this.shareDataset(i,{event:s.event}))}}))}checkExistingDataset(e){return t(this,void 0,void 0,(function*(){return(yield Promise.all(e.map(e=>this.checkIfDatasetExists(e)))).filter(e=>null!==e)}))}escapeOrNull(e){return null===e?null:`E'${e=e.replace(/\'/gi,"\\'")}'`}cleanVisAndDatasetLinks(e,i={}){return t(this,void 0,void 0,(function*(){if((yield this._sql.query(`\n      DELETE FROM ${this._datasetsVisTableName}\n      WHERE vis='${e}'\n    `,i)).error)throw new Error(`Failed to clean vis-dataset links for visualization '${e}'`)}))}linkVisAndDataset(e,i,r={}){return t(this,void 0,void 0,(function*(){const t=`\n      INSERT INTO ${this._datasetsVisTableName} ("vis", "dataset")\n      VALUES ('${e}', '${i}')\n    `;if((yield this._sql.query(t,r)).error)throw new Error("Failed to link dataset id to vis id")}))}_checkMissingTables(){return new Promise((e,i)=>t(this,void 0,void 0,(function*(){try{const t=[this._tableName,this._datasetsTableName,this._datasetsVisTableName].map(e=>this._sql.query(`SELECT to_regclass('${e}')`)),i=(yield Promise.all(t)).some(e=>null===e.rows[0].to_regclass);e(i)}catch(e){i(e)}})))}_initTables(e={}){return t(this,void 0,void 0,(function*(){const t=[...Object.values(this.VIS_FIELDS)],i={createConfig:{ifNotExists:!0},event:e.event};yield this._sql.create(this._tableName,t,i),yield this._sql.create(this._datasetsTableName,this.DATASET_COLUMNS,i),yield this._sql.create(this._datasetsVisTableName,this.DATASET_VIS_COLUMNS,i),this._isPublic&&(yield this._sql.grantPublicRead(this._tableName,e),yield this._sql.grantPublicRead(this._datasetsTableName,e),yield this._sql.grantPublicRead(this._datasetsVisTableName,e))}))}}class w{constructor(e,t,i={}){const r=Object.assign({client:"keplergl",maxApiRequestsRetries:l.DEFAULT_MAX_API_REQUESTS_RETRIES},i);this.client=r.client,this._sqlClient=new m(t,{maxApiRequestsRetries:r.maxApiRequestsRetries}),this._checkNamespace(e),this._namespace=e,this._publicSQLStorage=new L(this._namespace,this._sqlClient,this.getVersion(),!0),this._privateSQLStorage=new L(this._namespace,this._sqlClient,this.getVersion(),!1)}init(){return t(this,void 0,void 0,(function*(){if(yield this.isInitialized())return!0;yield this._sqlClient.query(`\n      BEGIN;\n        CREATE OR REPLACE FUNCTION ${this._namespace}_create_uuid()\n        RETURNS UUID AS\n        $$\n        DECLARE\n          _output UUID;\n        BEGIN\n          SELECT uuid_in(md5(random()::text || clock_timestamp()::text)::cstring) INTO _output;\n          RETURN _output;\n        END\n        $$ LANGUAGE plpgsql PARALLEL SAFE;\n      COMMIT;\n    `);const e=new r(this.client,"custom_storage_init"),t=yield Promise.all([this._publicSQLStorage.init({event:e}),this._privateSQLStorage.init({event:e})]);return t[0]||t[1]}))}getVisualizations(){this._checkReady();const e=new r(this.client,"custom_storage_visualization_list_load");return Promise.all([this._privateSQLStorage.getVisualizations({event:e}),this._publicSQLStorage.getVisualizations({event:e})]).then(e=>[...e[0],...e[1]])}getPublicVisualizations(){this._checkReady();const e=new r(this.client,"custom_storage_public_visualizations_load");return this._publicSQLStorage.getVisualizations({event:e})}getPrivateVisualizations(){this._checkReady();const e=new r(this.client,"custom_storage_private_visualizations_load");return this._privateSQLStorage.getVisualizations({event:e})}getVisualization(e){this._checkReady();const t=new r(this.client,"custom_storage_visualization_load");return Promise.all([this._publicSQLStorage.getVisualization(e,{event:t}),this._privateSQLStorage.getVisualization(e,{event:t})]).then(e=>e[0]||e[1])}deleteVisualization(e){this._checkReady();const t=new r(this.client,"custom_storage_visualization_delete");return Promise.all([this._publicSQLStorage.deleteVisualization(e,{event:t}),this._privateSQLStorage.deleteVisualization(e,{event:t})]).then(()=>!0).catch(()=>!1)}createVisualization(e,t,i){this._checkReady();const s=e.isprivate?this._privateSQLStorage:this._publicSQLStorage,n=e.isprivate?"custom_storage_private_visualization_create":"custom_storage_public_visualization_create",a=new r(this.client,n);return s.createVisualization(e,t,{overwriteDatasets:i,event:a})}updateVisualization(e,t){this._checkReady();const i=e.isprivate?this._privateSQLStorage:this._publicSQLStorage,s=new r(this.client,"custom_storage_visualization_update");return i.updateVisualization(e,t,{event:s})}getDatasets(){return Promise.all([this._publicSQLStorage.getDatasets(),this._privateSQLStorage.getDatasets()]).then(e=>[...e[0],...e[1]])}getVisForDataset(e){return Promise.all([this._publicSQLStorage.getVisForDataset(e),this._privateSQLStorage.getVisForDataset(e)]).then(e=>[...e[0],...e[1]])}uploadPublicDataset(e,t=!1){return this._uploadDataset(e,this._publicSQLStorage,!0,t)}uploadPrivateDataset(e,t=!1){return this._uploadDataset(e,this._privateSQLStorage,!1,t)}getVersion(){return w.version}migrate(){return Promise.resolve()}getSQLClient(){return this._sqlClient}setApiKey(e){this._sqlClient.setApiKey(e),this._privateSQLStorage.setApiKey(e),this._publicSQLStorage.setApiKey(e)}destroy(){return t(this,void 0,void 0,(function*(){yield this._sqlClient.query(`DROP FUNCTION ${this._namespace}_create_uuid CASCADE;`),yield this._privateSQLStorage.destroy(),yield this._publicSQLStorage.destroy()}))}isInitialized(){return t(this,void 0,void 0,(function*(){const e=yield Promise.all([this._publicSQLStorage.isInitialized(),this._privateSQLStorage.isInitialized()]);return e[0]||e[1]}))}_checkNamespace(e){if(e.split(" ").length>1)throw new Error("Namespace for custom-storage must be 1 word")}_checkReady(){if(!this._privateSQLStorage.isReady||!this._publicSQLStorage.isReady)throw new Error(".init has not finished")}_uploadDataset(e,i,r,s){return t(this,void 0,void 0,(function*(){const t=yield i.uploadDataset(e,{overwrite:s});return r&&(yield i.shareDataset(t.tablename)),t}))}}w.version=0;e.CustomStorage=w,e.PublicStorageReader=class extends class{constructor(e,t=i.DEFAULT_SERVER_URL_TEMPLATE,r={}){this._client=r.client?r.client:"keplergl",this._clientMap={},this._serverUrlTemplate=t,this._tableName=S(e,!0,w.version),this._datasetTableName=R(this._tableName),this._datasetsVisTableName=b(this._tableName)}getVisualization(e,t){if(void 0===this._clientMap[e]){const t=new i(e,i.DEFAULT_PUBLIC_API_KEY,this._serverUrlTemplate);this._clientMap[e]=new m(t)}const s={vis:this._tableName,datasets:this._datasetTableName,visToDatasets:this._datasetsVisTableName},n=new r(this._client,"public_sql_reader_visualization_load");return g(s,t,this._clientMap[e],{event:n})}}{},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=custom-storage.umd.js.map
