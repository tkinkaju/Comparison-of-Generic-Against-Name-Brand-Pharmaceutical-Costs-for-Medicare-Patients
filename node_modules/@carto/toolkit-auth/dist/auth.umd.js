!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).cartoToolkitAuth={})}(this,(function(e){"use strict";class t{constructor(e,t,r="https://{user}.carto.com"){if(!e)throw new Error("Username is required");if(!t)throw new Error("Api key is required");this._username=e,this._apiKey=t,this._serverUrlTemplate=r}static get DEFAULT_SERVER_URL_TEMPLATE(){return"https://{user}.carto.com"}static get DEFAULT_PUBLIC_API_KEY(){return"default_public"}get username(){return this._username}set username(e){this._username=e}get apiKey(){return this._apiKey}set apiKey(e){this._apiKey=e}get serverUrlTemplate(){return this._serverUrlTemplate}set serverUrlTemplate(e){this._serverUrlTemplate=e}get serverURL(){let e=this._serverUrlTemplate.replace("{user}",this._username);return e.endsWith("/")||(e+="/"),e}}new t("username","default_public");
/**
	 * @salte-auth/salte-auth JavaScript Library v3.0.0-rc.8
	 *
	 * @license MIT (https://github.com/salte-auth/salte-auth/blob/master/LICENSE)
	 *
	 * Made with ♥ by Nick Woodward <nick@salte.io>, Dave Woodward <dave@salte.io>
	 */function r(e,t,r,n,i,s,o){try{var c=e[s](o),a=c.value}catch(e){return void r(e)}c.done?t(a):Promise.resolve(a).then(n,i)}var n=function(e){return function(){var t=this,n=arguments;return new Promise((function(i,s){var o=e.apply(t,n);function c(e){r(o,i,s,c,a,"next",e)}function a(e){r(o,i,s,c,a,"throw",e)}c(void 0)}))}},i=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e};class s extends Error{constructor(e){let t=e.message,r=e.code;super(t),i(this,"code",void 0),this.code=r}}class o{static setup(e){this.hasSetup&&!e||(this.hasSetup=!0,this.interceptors=[],this.real||(this.real=window.fetch),window.fetch&&(window.fetch=function(){var e=n((function*(e,t){const r=e instanceof Request?e:new Request(e,t);for(let e=0;e<o.interceptors.length;e++){const t=o.interceptors[e];yield Promise.resolve(t(r))}return o.real.call(this,r)}));return function(t,r){return e.apply(this,arguments)}}()))}static add(e){this.setup(),this.interceptors.push(e)}}i(o,"real",void 0),i(o,"hasSetup",!1),i(o,"interceptors",void 0);let c=!1;const a=[];function l(){a.forEach(e=>e())}class h{static route(e){c||(window.addEventListener("popstate",l,{passive:!0}),window.addEventListener("click",l,{passive:!0}),setTimeout(l),c=!0),a.push(e)}static create(e,t){const r=document.createEvent("Event");return r.initEvent(e,t.bubbles||!1,t.cancelable||!0),r.detail=t.detail,r}static isCrossDomainError(e){return e instanceof DOMException||"Permission denied"===e.message}}class u{static setup(e){if(this.hasSetup&&!e)return;this.hasSetup=!0,this.interceptors=[],this.realOpen||(this.realOpen=XMLHttpRequest.prototype.open),this.realSend||(this.realSend=XMLHttpRequest.prototype.send);const t=XMLHttpRequest.prototype;t.open=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];const n=t[1];return this.$url=n,u.realOpen.apply(this,t)},t.send=function(e){const t=[];for(let r=0;r<u.interceptors.length;r++){const n=u.interceptors[r];t.push(n(this,e))}Promise.all(t).then(()=>{u.realSend.call(this,e)}).catch(e=>{this.dispatchEvent(h.create("error",{detail:e}))})}}static add(e){this.setup(),this.interceptors.push(e)}}i(u,"realOpen",void 0),i(u,"realSend",void 0),i(u,"hasSetup",!1),i(u,"interceptors",void 0);var d=Object.freeze({Fetch:o,XHR:u}),p=function(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=[],n=!0,i=!1,s=void 0;try{for(var o,c=e[Symbol.iterator]();!(n=(o=c.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==c.return||c.return()}finally{if(i)throw s}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()};let f,g,v;class m{static get origin(){return"".concat(location.protocol,"//").concat(location.host)}static resolve(e){return f||(f=document.implementation.createHTMLDocument("url"),g=f.createElement("base"),v=f.createElement("a"),f.head.appendChild(g)),g.href=window.location.protocol+"//"+window.location.host,v.href=e.replace(/ /g,"%20"),v.href.replace(/\/$/,"")}static match(e,t){if(t instanceof Array){const r=this.resolve(e);return!!y.find(t,e=>e instanceof RegExp?!!r.match(e):0===r.indexOf(this.resolve(e)))}return!0===t}static parse(e){let t=e.search,r=e.hash,n=[];t&&(n=n.concat(t.replace("?","").split("&"))),r&&(n=n.concat(r.replace("#","").split("&")));const i={};return y.forEach(n,e=>{const t=e.split("="),r=p(t,2),n=r[0],s=r[1];i[n]=s}),i}}const w={};class y{static includes(e,t){return-1!==e.indexOf(t)}static forEach(e,t){if(Array.isArray(e))for(let r=0;r<e.length;r++)t(e[r],r);else for(let r in e)t(e[r],r)}static find(e,t){if(Array.isArray(e))for(let r=0;r<e.length;r++){const n=e[r];if(t(n,r))return n}else for(let r in e){const n=e[r];if(t(n,r))return n}return null}static assign(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return this.forEach(r,t=>{for(const r in t)e[r]=t[r]}),e}static defaults(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return this.forEach(r,t=>{for(const r in t)this.isObject(e[r])&&this.isObject(t[r])?e[r]=this.defaults(e[r],t[r]):void 0===e[r]&&(e[r]=t[r])}),e}static isObject(e){return"object"==typeof e&&!Array.isArray(e)}static iframe(e){var t=this;return n((function*(){let r=e.url,n=e.redirectUrl,i=e.visible;const s=document.createElement("iframe");return s.setAttribute("owner","@salte-auth/salte-auth"),i?(t.assign(s.style,{border:"none",bottom:0,height:"100%",left:0,position:"fixed",right:0,top:0,width:"100%",zIndex:9999,opacity:0,transition:"0.5s opacity"}),setTimeout(()=>s.style.opacity="1")):s.style.display="none",s.src=r,document.body.appendChild(s),new Promise((e,t)=>{const r=setInterval(()=>{try{const t=s.contentWindow.location;if(0!==t.href.indexOf(n))return;const i=m.parse(t);s.parentElement&&s.parentElement.removeChild(s),clearInterval(r),e(i)}catch(e){if(h.isCrossDomainError(e))return;s.parentElement&&s.parentElement.removeChild(s),clearInterval(r),t(e)}})})}))()}static debounce(e,t,r){clearTimeout(w[e]),w[e]=window.setTimeout(()=>{delete w[e],t()},r)}}class _{constructor(e,t,r){i(this,"raw",void 0),i(this,"expiration",void 0),i(this,"type",void 0),this.raw=e,this.expiration=y.includes([void 0,null],t)?null:Number(t),this.type=r}get expired(){return!this.raw||this.expiration<=Date.now()}}class k{constructor(e){i(this,"raw",void 0),i(this,"user",void 0),this.raw=e,this.user=k.parse(this.raw)}get expired(){return!this.user||1e3*this.user.exp<=Date.now()}static parse(e){try{const t=e.split(".");if(3!==t.length)throw new s({code:"invalid_id_token",message:"ID Token didn't match the desired format. ({header}.{payload}.{validation})"});return JSON.parse(atob(t[1].replace(/-/g,"+").replace(/_/g,"/")))}catch(e){return null}}}class T{constructor(e,t){i(this,"name",void 0),i(this,"level",void 0),this.name=e,this.level="string"==typeof t?this.toLevel(t):t}trace(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.log("trace",e,...r)}info(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.log("info",e,...r)}warn(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.log("warn",e,...r)}error(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.log("error",e,...r)}log(e,t){if(this.enabled(e)){for(var r=arguments.length,n=new Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];console.log("".concat(e,": ").concat(t),...n)}}enabled(e){return!1!==this.level&&(!0===this.level||this.level<=this.toLevel(e))}toLevel(e){return y.find(T.levels,(t,r)=>r===e)}}i(T,"levels",{trace:0,info:1,warn:2,error:3});var x=Object.freeze({Interceptors:d,AccessToken:_,IDToken:k,Common:y,Events:h,URL:m,Logger:T});class U extends class{constructor(e){this.config=e||{}}required(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];const n=t.filter(e=>void 0===this.config[e]);if(n.length>0)throw new s({code:"missing_required_properties",message:"Missing the following required fields. (".concat(n.join(", "),")")})}}{constructor(e){super(e),this.config=y.defaults(this.config,{storage:"session"})}get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.storage.getItem(this.key(e))||t}set(e,t){y.includes([void 0,null],t)?this.clear(e):this.storage.setItem(this.key(e),t)}clear(e){this.storage.removeItem(this.key(e))}reset(){const e=this.key("");for(const t in localStorage)0===t.indexOf(e)&&localStorage.removeItem(t);for(const t in sessionStorage)0===t.indexOf(e)&&sessionStorage.removeItem(t)}key(e){return"salte.auth.".concat(e)}get storage(){const e=this.config&&this.config.storage;switch(e){case"local":return localStorage;case"session":return sessionStorage}throw new s({code:"invalid_storage",message:"Storage doesn't exist for the given value. (".concat(e,")")})}}class b extends U{constructor(){super(...arguments),i(this,"listeners",new Map)}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(!this.listeners.has(e))return;const r=this.listeners.get(e);if(!r.length)return;const n=r.indexOf(t);-1!==n&&r.splice(n,1)}emit(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];if(!this.listeners.has(e))return;const i=this.listeners.get(e);y.forEach(i,e=>e(...r))}}class I extends b{constructor(e){super(e),this.config=y.defaults(this.config,{redirectUrl:location.origin,level:"warn"})}redirectUrl(e){return"string"==typeof this.config.redirectUrl?this.config.redirectUrl:this.config.redirectUrl[e]}}var $=self.crypto||self.msCrypto,E=function(e){e=e||21;for(var t="",r=$.getRandomValues(new Uint8Array(e));0<e--;)t+="Uint8ArdomValuesObj012345679BCDEFGHIJKLMNPQRSTWXYZ_cfghkpqvwxyz-"[63&r[e]];return t};class A extends I{constructor(e){super(e),i(this,"logger",void 0),this.config=y.defaults(this.config,{validation:!0,level:"warn"}),this.logger=new T("@salte-auth/salte-auth:providers/".concat(this.$name),this.config.level)}validation(e){return"object"==typeof this.config.validation?!0===this.config.validation[e]:!0===this.config.validation}get $name(){return this.config.name||this.name}key(e){return"salte.auth.provider.".concat(this.$name,".").concat(e)}url(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e;return y.forEach(t,(e,t)=>{y.includes([void 0,null,""],e)||(r+="".concat(-1===r.indexOf("?")?"?":"&").concat(t,"=").concat(encodeURIComponent(e)))}),r}get logout(){throw new s({code:"logout_not_supported",message:"This provider doesn't support logout."})}}class R extends A{constructor(e){super(e),i(this,"accessToken",void 0),this.sync()}connected(){this.required("clientID","responseType")}secure(e){var t=this;return n((function*(){if("token"===t.config.responseType){if(t.accessToken.expired)return t.$login();if(e)if(e instanceof Request)e.headers.set("Authorization","Bearer ".concat(t.accessToken.raw));else{if(!(e instanceof XMLHttpRequest))throw new s({code:"unknown_request",message:"Unknown request type. (".concat(e,")")});e.setRequestHeader("Authorization","Bearer ".concat(t.accessToken.raw))}}return!0}))()}$validate(e){try{if(!e)throw new s({code:"empty_response",message:"The response provided was empty, this is most likely due to the configured handler not providing it."});if(e.error)throw new s({code:e.error,message:"".concat(e.error_description?e.error_description:e.error).concat(e.error_uri?" (".concat(e.error_uri,")"):"")});const t=e.code,r=e.access_token,n=e.state,i=e.expires_in,o=e.token_type;if(this.validation("state")&&this.get("state")!==n)throw new s({code:"invalid_state",message:"State provided by identity provider did not match local state."});const c=this.get("response-type","").split(" ");if(y.includes(c,"code")){if(!t)throw new s({code:"invalid_code",message:"Expected a code to be returned by the Provider."})}else if(y.includes(c,"token")&&!r)throw new s({code:"invalid_access_token",message:"Expected an access token to be returned by the Provider."});t?(this.set("code.raw",t),this.clear("access-token.raw"),this.clear("access-token.expiration"),this.clear("access-token.type")):r&&(this.set("access-token.raw",r),this.set("access-token.expiration",Date.now()+1e3*Number(i)),this.set("access-token.type",o),this.clear("code.raw"))}finally{this.clear("state")}}validate(e){try{this.$validate(e)}catch(e){throw this.emit("login",e),e}finally{this.sync()}this.emit("login",null,this.code||this.accessToken)}get code(){return this.get("code.raw")}$login(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t="".concat(this.$name,"-state-").concat(E()),r=e.responseType||this.config.responseType;return this.set("state",t),this.set("response-type",r),this.url(this.login,{client_id:this.config.clientID,response_type:r,redirect_uri:this.config.redirectUrl,scope:this.config.scope,state:t})}sync(){this.accessToken=new _(this.get("access-token.raw"),this.get("access-token.expiration"),this.get("access-token.type"))}}class q extends R{constructor(e){super(e),i(this,"idToken",void 0),this.config.renewal="object"==typeof this.config.renewal?this.config.renewal:{type:this.config.renewal},this.config=y.defaults(this.config,{responseType:"id_token",scope:"openid",renewal:{type:"auto",buffer:6e4}}),this.sync()}secure(e){var t=this;return n((function*(){if(y.includes(["id_token","id_token token","token"],t.config.responseType)){if(t.idToken.expired)return t.$login();if(t.accessToken.expired){const e=yield y.iframe({redirectUrl:t.redirectUrl("login"),url:t.$login({prompt:"none",responseType:"token"})});t.validate(e)}if(e)if(e instanceof Request)e.headers.set("Authorization","Bearer ".concat(t.accessToken.raw));else{if(!(e instanceof XMLHttpRequest))throw new s({code:"unknown_request",message:"Unknown request type. (".concat(e,")")});e.setRequestHeader("Authorization","Bearer ".concat(t.accessToken.raw))}}return!0}))()}$validate(e){try{super.$validate(e);const t=this.get("response-type","").split(" ");if(y.includes(t,"id_token")){const t=e.id_token,r=k.parse(t);if(!r)throw new s({code:"invalid_id_token",message:"Failed to parse user information due to invalid id token."});if(this.validation("nonce")&&this.get("nonce")!==r.nonce)throw new s({code:"invalid_nonce",message:"Nonce provided by identity provider did not match the local nonce."});this.set("id-token.raw",t)}else y.includes(t,"code")&&this.clear("id-token.raw")}finally{this.clear("nonce")}}validate(e){try{this.$validate(e)}catch(e){throw this.emit("login",e),e}finally{this.sync()}const t=this.get("response-type",""),r=t.split(" ");if(y.includes(r,"id_token"))this.emit("login",null,this.idToken);else if(y.includes(r,"token"))this.emit("login",null,this.accessToken);else{if(!y.includes(r,"code"))throw new s({code:"invalid_response_type",message:"Unknown Response Type (".concat(t,")")});this.emit("login",null,this.code)}}$login(e){const t="".concat(this.$name,"-nonce-").concat(E());return this.set("nonce",t),this.url(super.$login(e),{prompt:e&&e.prompt,nonce:t})}sync(){super.sync(),this.idToken=new k(this.get("id-token.raw"))}}Object.freeze({OAuth2:class extends R{constructor(e){super(e),this.required("login")}get name(){return"generic.oauth2"}get login(){return this.config.login.apply(this)}},OpenID:class extends q{constructor(e){super(e),this.required("login","logout")}get name(){return"generic.openid"}get login(){return this.config.login.apply(this)}get logout(){return this.config.logout.apply(this)}}});class O extends U{constructor(e){super(e),i(this,"logger",void 0),this.config=y.defaults(this.config,{navigate:"reload",level:"warn"}),this.logger=new T("@salte-auth/salte-auth:handlers/".concat(this.$name),this.config.level)}get $name(){return this.config.name||this.name}key(e){return"salte.auth.handler.".concat(this.$name,".").concat(e)}navigate(e){"history"===this.config.navigate&&0===e.indexOf(m.origin)&&history.pushState("",document.title,e),location.href=e}}class S extends I{constructor(e){var t;super(e),t=this,i(this,"logger",void 0),i(this,"mixin",void 0),this.required("providers","handlers"),this.config=y.defaults(this.config,{validation:!0,level:"warn"}),this.logger=new T("@salte-auth/salte-auth:core",this.config.level),y.forEach(this.config.providers,e=>{e.connected&&e.connected(),e.on("login",(e,t)=>{this.emit("login",e,t)}),e.on("logout",e=>{this.emit("logout",e)})});const r=this.get("action"),c=r?this.provider(this.get("provider")):null,a=r?this.get("handler"):null;if(!y.includes([void 0,null,"login","logout"],r))throw new s({code:"unknown_action",message:"Unable to finish redirect due to an unknown action! (".concat(r,")")});var l;y.forEach(this.config.handlers,e=>{if(!e.connected)return;const t=e.$name===a;setTimeout(()=>{const n=e.connected({action:t?r:null});t&&("login"===r?c.validate(n):(c.reset(),c.sync(),c.emit("logout")))})}),this.clear("action"),this.clear("provider"),this.clear("handler"),o.add(function(){var e=n((function*(e){for(let r=0;r<t.config.providers.length;r++){const n=t.config.providers[r];m.match(e.url,n.config.endpoints)&&n.secure&&(yield n.secure(e))}}));return function(t){return e.apply(this,arguments)}}()),u.add(function(){var e=n((function*(e){for(let r=0;r<t.config.providers.length;r++){const n=t.config.providers[r];m.match(e.$url,n.config.endpoints)&&n.secure&&(yield n.secure(e))}}));return function(t){return e.apply(this,arguments)}}()),h.route(n((function*(){try{const e=t.handler();for(let r=0;r<t.config.providers.length;r++){const n=t.config.providers[r];if(m.match(location.href,n.config.routes)){let r=null;for(;!0!==r;)if("string"==typeof(r=yield n.secure())){if(!e.auto)throw new s({code:"auto_unsupported",message:"The default handler doesn't support automatic authentication! (".concat(e.$name,")")});t.set("action","login"),t.set("provider",n.$name),t.set("handler",e.$name);const i=yield e.open({redirectUrl:n.redirectUrl("login"),url:r});n.validate(i),t.clear("action"),t.clear("provider"),t.clear("handler")}}}}catch(e){throw t.clear("action"),t.clear("provider"),t.clear("handler"),e}}))),this.mixin=(l=this,function(e){return class extends e{constructor(){super(...arguments),i(this,"auth",void 0),this.auth=l,this.auth.on("login",()=>{this.requestUpdate&&this.requestUpdate("auth")}),this.auth.on("logout",()=>{this.requestUpdate&&this.requestUpdate("auth")})}}})}login(e){var t=this;return n((function*(){e="string"==typeof e?{provider:e}:e;try{const r=t.provider(e.provider),n=t.handler(e.handler);t.set("action","login"),t.set("provider",r.$name),t.set("handler",n.$name);const i=yield n.open({redirectUrl:r.redirectUrl("login"),url:r.$login()});r.validate(i)}finally{t.clear("action"),t.clear("provider"),t.clear("handler")}}))()}logout(e){var t=this;return n((function*(){e="string"==typeof e?{provider:e}:e;const r=t.provider(e.provider);try{const n=t.handler(e.handler);t.set("action","logout"),t.set("provider",r.$name),t.set("handler",n.$name),yield n.open({redirectUrl:r.redirectUrl("logout"),url:r.logout}),r.reset(),r.emit("logout")}catch(e){throw r.emit("logout",e),e}finally{t.clear("action"),t.clear("provider"),t.clear("handler")}}))()}provider(e){const t=y.find(this.config.providers,t=>t.$name===e);if(!t)throw new s({code:"invalid_provider",message:"Unable to locate provider with the given name. (".concat(e,")")});return t}handler(e){const t=void 0===e?y.find(this.config.handlers,e=>!!e.config.default):y.find(this.config.handlers,t=>t.$name===e);if(!t)throw new s({code:"invalid_handler",message:"Unable to locate handler with the given name. (".concat(e,")")});return t}}
/**
	 * @salte-auth/popup JavaScript Library v1.0.0-rc.1
	 *
	 * @license MIT (https://github.com/salte-auth/popup/blob/master/LICENSE)
	 *
	 * Made with ♥ by Nick Woodward <nick@salte.io>, Dave Woodward <dave@salte.io>
	 */function D(e,t,r,n,i,s,o){try{var c=e[s](o),a=c.value}catch(e){return void r(e)}c.done?t(a):Promise.resolve(a).then(n,i)}class L extends O{constructor(e){super(e),this.config=x.Common.defaults(this.config,{window:{name:"@salte-auth/tab",height:600,width:600}})}get name(){return"popup"}get auto(){return!1}open(e){var t=this;return function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var s=e.apply(t,r);function o(e){D(s,n,i,o,c,"next",e)}function c(e){D(s,n,i,o,c,"throw",e)}o(void 0)}))}}((function*(){const r=window.innerHeight/2-t.config.window.height/2+window.screenTop,n=window.innerWidth/2-t.config.window.width/2+window.screenLeft,i=window.open(e.url,t.config.window.name,"height=".concat(t.config.window.height,", width=").concat(t.config.window.width,", status=yes, toolbar=no, menubar=no, location=no, top=").concat(r,", left=").concat(n));if(!i)throw new s({message:"We were unable to open the popup window, its likely that the request was blocked.",code:"popup_blocked"});return i.focus(),new Promise(t=>{const r=setInterval(()=>{try{if(!i.closed){if(0!==i.location.href.indexOf(e.redirectUrl))return;const r=x.URL.parse(i.location);i.close(),setTimeout(()=>t(r))}clearInterval(r)}catch(e){}},100)})}))()}}const P=[/offline/,/dataservices:geocoding/,/dataservices:isolines/,/dataservices:routing/,/dataservices:observatory/,/datasets:r:.+/,/datasets:w:.+/,/datasets:rw:.+/,/schemas:c/,/datasets:metadata/];class j extends R{constructor(){super(...arguments),this._userInfo=this.get("user_info")}get name(){return"carto"}get login(){return`${this.config.url}/authorize`}get logout(){return`${this.config.url}/logout`}get userInfo(){return this._userInfo}$validate(e){super.$validate(e),this._userInfo=decodeURIComponent(e.user_info_url),this.set("user_info",this._userInfo)}sync(){super.sync(),this._userInfo=this.get("user_info")}get expired(){return this.accessToken&&this.accessToken.expired}get expiresIn(){return void 0===this.accessToken?-1:this.accessToken.expiration}}function z(e){return e.filter(e=>!function(e){return P.some(t=>null!==t.exec(e))}(e))}class C{constructor(e){this._params=e}refresh(e){const t=[["client_id",this._params.clientID],["response_type","token"],["prompt","none"],["scopes",this._params.scopes],["state",e]];this._params.redirectURI&&t.push(["redirect_uri",this._params.redirectURI]);const r=`https://carto.com/oauth2/authorize?${function(e){return encodeURI(e.map(e=>`${e[0]}=${e[1]}`).join("&"))}(t)}`;return x.Common.iframe({url:r,redirectUrl:this._params.redirectURI||window.location.href,visible:!1})}}class M{constructor(e,t){this._apiKey=e,this._url=t}get info(){return fetch(`${this._url}?api_key=${this._apiKey}`).then(e=>e.json())}}e.OAuth=class{constructor(e,t){if(this._refreshTimeout=-1,null==e)throw new Error("Missing OAuth parameters");var r;e.authorization=e.authorization||"https://carto.com/oauth2",e.scopes=e.scopes||"",this._emitter=(r=r||Object.create(null),{on:function(e,t){(r[e]||(r[e]=[])).push(t)},off:function(e,t){r[e]&&r[e].splice(r[e].indexOf(t)>>>0,1)},emit:function(e,t){(r[e]||[]).slice().map((function(e){e(t)})),(r["*"]||[]).slice().map((function(r){r(e,t)}))}}),this._client=new S({providers:[new j({storage:"local",level:"trace",url:e.authorization,redirectUrl:e.redirectURI,clientID:e.clientID,responseType:"token",scope:e.scopes})],handlers:[new L({default:!0})]}),this._refresher=new C({authorization:e.authorization,redirectURI:t||e.redirectURI,clientID:e.clientID,scopes:e.scopes}),this._carto=this._client.provider("carto"),this._carto.expired||this._scheduleRefresh(),e.scopes&&this._checkScopes(e.scopes)}login(){return new Promise((e,t)=>{const r=(n,i)=>{if(n){const e={error:n.code,message:decodeURIComponent(n.message.replace(/\+/g,"%20"))};return t(e),void this._emitter.emit("error",e)}e(i),this._emitter.emit("tokenUpdated",i),this._carto.off("login",r),this._scheduleRefresh()};this._client.on("login",r),this._client.login("carto").catch(e=>{t(e)})})}get client(){return this._client}get expired(){return this._carto.accessToken&&this._carto.accessToken.expired}get credentials(){return this._carto.accessToken?new t(this._carto.userInfo,this._carto.accessToken.raw):null}get token(){return null==this._carto.accessToken?null:this._carto.accessToken.raw}get userInfo(){return null===this.token?null:new M(this.token,this._carto.userInfo)}clear(){this._carto.reset()}on(e,t){this._emitter.on(e,t)}_scheduleRefresh(){clearTimeout(this._refreshTimeout),this._refreshTimeout=window.setTimeout(()=>{this._refresh()},this._carto.expiresIn-Date.now()-3e5)}_refresh(){if(this._carto.expired)return;const e=Date.now();this._carto.set("state",`6574686572766f69642d74726169746f72-${e}`),this._refresher.refresh(`6574686572766f69642d74726169746f72-${e}`).then(e=>{e.error?this._emitter.emit("error",{error:e.error,message:e.error_description.replace(/\+/g," ")}):(this._carto.validate(e),this._emitter.emit("tokenUpdated",e.access_token))}).catch(e=>{this._emitter.emit("error",e)})}_checkScopes(e){const t=new Set,r=e.split(" ");e&&z(r||[]).forEach(e=>t.add(e)),t.forEach(e=>{console.warn(`Unknown scope ${e}`)})}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=auth.umd.js.map
