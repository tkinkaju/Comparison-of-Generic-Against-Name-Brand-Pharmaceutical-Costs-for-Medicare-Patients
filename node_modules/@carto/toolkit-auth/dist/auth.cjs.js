"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("@carto/toolkit-core"),r=require("@salte-auth/popup"),s=require("@salte-auth/salte-auth"),i=(e=require("mitt"))&&"object"==typeof e&&"default"in e?e.default:e;const o=[/offline/,/dataservices:geocoding/,/dataservices:isolines/,/dataservices:routing/,/dataservices:observatory/,/datasets:r:.+/,/datasets:w:.+/,/datasets:rw:.+/,/schemas:c/,/datasets:metadata/];class n extends s.OAuth2Provider{constructor(){super(...arguments),this._userInfo=this.get("user_info")}get name(){return"carto"}get login(){return`${this.config.url}/authorize`}get logout(){return`${this.config.url}/logout`}get userInfo(){return this._userInfo}$validate(e){super.$validate(e),this._userInfo=decodeURIComponent(e.user_info_url),this.set("user_info",this._userInfo)}sync(){super.sync(),this._userInfo=this.get("user_info")}get expired(){return this.accessToken&&this.accessToken.expired}get expiresIn(){return void 0===this.accessToken?-1:this.accessToken.expiration}}function c(e){return e.filter(e=>!function(e){return o.some(t=>null!==t.exec(e))}(e))}class a{constructor(e){this._params=e}refresh(e){const t=[["client_id",this._params.clientID],["response_type","token"],["prompt","none"],["scopes",this._params.scopes],["state",e]];this._params.redirectURI&&t.push(["redirect_uri",this._params.redirectURI]);const r=`https://carto.com/oauth2/authorize?${function(e){return encodeURI(e.map(e=>`${e[0]}=${e[1]}`).join("&"))}(t)}`;return s.Utils.Common.iframe({url:r,redirectUrl:this._params.redirectURI||window.location.href,visible:!1})}}class h{constructor(e,t){this._apiKey=e,this._url=t}get info(){return fetch(`${this._url}?api_key=${this._apiKey}`).then(e=>e.json())}}exports.OAuth=class{constructor(e,t){if(this._refreshTimeout=-1,null==e)throw new Error("Missing OAuth parameters");e.authorization=e.authorization||"https://carto.com/oauth2",e.scopes=e.scopes||"",this._emitter=i(),this._client=new s.SalteAuth({providers:[new n({storage:"local",level:"trace",url:e.authorization,redirectUrl:e.redirectURI,clientID:e.clientID,responseType:"token",scope:e.scopes})],handlers:[new r.Popup({default:!0})]}),this._refresher=new a({authorization:e.authorization,redirectURI:t||e.redirectURI,clientID:e.clientID,scopes:e.scopes}),this._carto=this._client.provider("carto"),this._carto.expired||this._scheduleRefresh(),e.scopes&&this._checkScopes(e.scopes)}login(){return new Promise((e,t)=>{const r=(s,i)=>{if(s){const e={error:s.code,message:decodeURIComponent(s.message.replace(/\+/g,"%20"))};return t(e),void this._emitter.emit("error",e)}e(i),this._emitter.emit("tokenUpdated",i),this._carto.off("login",r),this._scheduleRefresh()};this._client.on("login",r),this._client.login("carto").catch(e=>{t(e)})})}get client(){return this._client}get expired(){return this._carto.accessToken&&this._carto.accessToken.expired}get credentials(){return this._carto.accessToken?new t.Credentials(this._carto.userInfo,this._carto.accessToken.raw):null}get token(){return null==this._carto.accessToken?null:this._carto.accessToken.raw}get userInfo(){return null===this.token?null:new h(this.token,this._carto.userInfo)}clear(){this._carto.reset()}on(e,t){this._emitter.on(e,t)}_scheduleRefresh(){clearTimeout(this._refreshTimeout),this._refreshTimeout=window.setTimeout(()=>{this._refresh()},this._carto.expiresIn-Date.now()-3e5)}_refresh(){if(this._carto.expired)return;const e=Date.now();this._carto.set("state",`6574686572766f69642d74726169746f72-${e}`),this._refresher.refresh(`6574686572766f69642d74726169746f72-${e}`).then(e=>{e.error?this._emitter.emit("error",{error:e.error,message:e.error_description.replace(/\+/g," ")}):(this._carto.validate(e),this._emitter.emit("tokenUpdated",e.access_token))}).catch(e=>{this._emitter.emit("error",e)})}_checkScopes(e){const t=new Set,r=e.split(" ");e&&c(r||[]).forEach(e=>t.add(e)),t.forEach(e=>{console.warn(`Unknown scope ${e}`)})}};
//# sourceMappingURL=auth.cjs.js.map
